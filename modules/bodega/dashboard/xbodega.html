<div style="display: flex; flex-direction: column; gap: 20px; height: 100%;">

  <!-- FILTROS + RESUMEN + EXPORTAR -->
  <div class="bodega-filtros" style="display: flex; align-items: flex-end; gap: 16px; flex-wrap: wrap;">

    <div class="bodega-filtro-grupo">
      <label for="filtro-bodega-principal">Bodega Principal</label>
      <select id="filtro-bodega-principal" class="dashboard-select">
        <option value="todas">Todas</option>
      </select>
    </div>

    <div class="bodega-filtro-grupo">
      <label for="filtro-bodega-secundaria">Bodega Secundaria</label>
      <select id="filtro-bodega-secundaria" class="dashboard-select">
        <option value="todas">Todas</option>
      </select>
    </div>

    <!-- KPIs EN FILA -->
    <div style="display: flex; gap: 12px;">
      <div class="bodega-resumen-card">
        <div>Materiales</div>
        <div class="valor" id="kpi-unicos">‚Äì</div>
      </div>
      <div class="bodega-resumen-card">
        <div>Unidades</div>
        <div class="valor" id="kpi-unidades">‚Äì</div>
      </div>
      <div class="bodega-resumen-card">
        <div>Agotados</div>
        <div class="valor" id="kpi-agotados">‚Äì</div>
      </div>
    </div>

    <button id="btn-exportar-xbodega" class="bodega-export-pdf-btn">
      üìÑ Exportar Inventario
    </button>
  </div>

  <!-- CONTENEDOR PRINCIPAL CON DOS COLUMNAS -->
  <div style="display: flex; gap: 20px; flex: 1; overflow: hidden;">
    <!-- TABLA DE INVENTARIO -->
    <div style="flex: 2; display: flex; flex-direction: column;">
      <h3 style="color: #cbd5e1; margin-bottom: 10px; font-size: 16px;">üì¶ Inventario Actual</h3>
      <div id="tabla-inventario-bodega" style="flex: 1; overflow: auto; border: 1px solid rgba(99, 102, 241, 0.2); border-radius: 8px; padding: 10px; background: rgba(20, 30, 60, 0.3);"></div>
    </div>

    <!-- MOVIMIENTOS RECIENTES -->
    <div style="flex: 1; display: flex; flex-direction: column;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <h3 style="color: #cbd5e1; font-size: 16px; margin: 0;">üîÑ Actividad Reciente</h3>
        <div style="display: flex; gap: 8px; align-items: center;">
          <button id="btn-refresh-movimientos" style="background: rgba(59, 130, 246, 0.2); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 4px; color: #cbd5e1; padding: 4px 8px; font-size: 11px; cursor: pointer;">‚Üª</button>
          <div style="font-size: 11px; color: #64748b;">
            <span id="movimientos-status">üîÑ Auto-actualizaci√≥n</span>
          </div>
        </div>
      </div>
      <div id="panel-movimientos" style="flex: 1; overflow: auto; border: 1px solid rgba(99, 102, 241, 0.2); border-radius: 8px; padding: 10px; background: rgba(20, 30, 60, 0.3);">
        <div style="text-align: center; color: #888; margin-top: 20px; font-size: 12px;">
          <div>Cargando actividad de bodegas...</div>
          <div style="font-size: 10px; margin-top: 4px; color: #666;">üé• Audiovisual ‚Ä¢ üîß Hierros ‚Ä¢ üõ†Ô∏è Consumibles</div>
        </div>
      </div>
    </div>
  </div>

  <!-- INDICADOR DE ESTADO -->
  <div id="estado-conexion" style="position: absolute; top: 10px; right: 10px; padding: 8px 12px; border-radius: 6px; font-size: 11px; font-weight: bold; z-index: 1000; background: rgba(20, 30, 60, 0.9); border: 1px solid rgba(99, 102, 241, 0.3);">
    <div style="display: flex; align-items: center; gap: 6px;">
      <div id="estado-icono">üîÑ</div>
      <div id="estado-texto">Conectando...</div>
    </div>
    <div id="estado-detalle" style="font-size: 9px; margin-top: 2px; opacity: 0.8;"></div>
  </div>

</div>

<style>
.bodega-resumen-card {
  background: rgba(20, 30, 60, 0.6);
  border: 1px solid rgba(99, 102, 241, 0.2);
  border-radius: 10px;
  padding: 10px 14px;
  min-width: 120px;
  text-align: center;
  color: #cbd5e1;
}

.bodega-resumen-card .valor {
  font-size: 22px;
  font-weight: bold;
  color: #64b5f6;
}

#btn-refresh-movimientos {
  transition: all 0.2s;
}

#btn-refresh-movimientos:hover:not(:disabled) {
  background: rgba(59, 130, 246, 0.4);
  border-color: rgba(59, 130, 246, 0.5);
}

#btn-refresh-movimientos:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}
</style>


<script>
// --- L√≥gica aut√≥noma para xbodega.html ---
(function() {
  const supa = window.supabaseClient;
  if (!supa) {
    console.error('‚ùå Supabase no est√° inicializado (window.supabaseClient).');
  }

  const estado = {
    inventario: [],
    movimientos: [],
    bodegasPrincipales: [],
    bodegasSecundarias: [],
    secundariasPorPrincipal: new Map(),
    autoRefreshInterval: null
  };

  function normalizarBodega(b) {
    return (b || '').toString().trim();
  }

  async function cargarInventarioDesdeSupabase() {
    if (!supa) return;

    const cont = document.getElementById('tabla-inventario-bodega');
    cont.innerHTML = '<p style="color:#cbd5e1; text-align:center; margin-top: 40px;">Cargando inventario‚Ä¶</p>';

    const [{ data: movAudioData, error: movAudioError }, { data: movHierroData, error: movHierroError }, { data: movConsumibleData, error: movConsumibleError }, { data: catAudioData, error: catAudioError }, { data: catHierroData, error: catHierroError }, { data: catConsumibleData, error: catConsumibleError }] = await Promise.all([
      supa
        .from('movimientos_bodega_audiovisual')
        .select('material_codigo, bodega_principal, bodega_secundaria, cantidad, signo')
        .not('cantidad', 'is', null)
        .not('signo', 'is', null),
      supa
        .from('movimientos_bodega_hierros')
        .select('material_codigo, bodega_principal, bodega_secundaria, cantidad, signo')
        .not('cantidad', 'is', null)
        .not('signo', 'is', null),
      supa
        .from('movimientos_bodega_consumibles')
        .select('material_codigo, bodega_principal, bodega_secundaria, cantidad, signo')
        .not('cantidad', 'is', null)
        .not('signo', 'is', null),
      supa
        .from('catalogo_audiovisual')
        .select('codigo, nombre, bodega_principal, bodega_secundaria, tipo_material, color')
        .eq('es_contenedor', false),
      supa
        .from('catalogo_hierros')
        .select('codigo, nombre, bodega_principal, bodega_secundaria, tipo_material, color')
        .eq('es_contenedor', false),
      supa
        .from('catalogo_consumibles')
        .select('codigo, nombre, bodega_principal, bodega_secundaria, tipo_material, color')
        .eq('es_contenedor', false)
    ]);

    // Verificar errores en movimientos
    if (movAudioError && movHierroError && movConsumibleError) {
      console.error('Error cargando movimientos:', movAudioError, movHierroError, movConsumibleError);
      cont.innerHTML = `<p style="color:#ef4444; text-align:center; margin-top: 40px;">Error al cargar movimientos: ${movAudioError?.message || movHierroError?.message || movConsumibleError?.message}</p>`;
      return;
    }

    // Combinar datos de cat√°logo de las 3 tablas
    const catMap = new Map();
    function addToCatMap(data, tipo) {
      (data || []).forEach(c => {
        catMap.set(c.codigo, {
          codigo: c.codigo,
          nombre: c.nombre,
          bodega_principal: c.bodega_principal,
          bodega_secundaria: c.bodega_secundaria,
          tipo: c.tipo_material,
          color: c.color,
          tabla_origen: tipo
        });
      });
    }

    addToCatMap(catAudioData, 'audiovisual');
    addToCatMap(catHierroData, 'hierros');
    addToCatMap(catConsumibleData, 'consumibles');

    if (catAudioError && catHierroError && catConsumibleError) {
      console.warn('No se pudieron cargar los cat√°logos:', catAudioError, catHierroError, catConsumibleError);
    }

    const inventarioMap = new Map();
    function makeKey(codigo, principal, secundaria) {
      return `${String(codigo || '').trim()}||${normalizarBodega(principal) || 'Principal'}||${normalizarBodega(secundaria) || 'General'}`;
    }

    // Calcular existencia desde movimientos de las 3 tablas
    const existenciaMap = new Map();

    function procesarMovimientos(movimientos, tipo) {
      (movimientos || []).forEach(m => {
        const codigo = String(m.material_codigo || '').trim();
        if (!codigo) return;

        const bodegaPrincipal = normalizarBodega(m.bodega_principal) || 'Principal';
        const bodegaSecundaria = normalizarBodega(m.bodega_secundaria) || 'General';
        const key = makeKey(codigo, bodegaPrincipal, bodegaSecundaria);

        const cantidad = Number(m.cantidad) || 0;
        const signo = Number(m.signo) || 1;
        const ajuste = cantidad * signo;

        if (!existenciaMap.has(key)) {
          existenciaMap.set(key, { existencia: 0, tabla_origen: tipo });
        }
        existenciaMap.get(key).existencia += ajuste;
      });
    }

    procesarMovimientos(movAudioData, 'audiovisual');
    procesarMovimientos(movHierroData, 'hierros');
    procesarMovimientos(movConsumibleData, 'consumibles');

    // Crear inventario con existencias calculadas
    existenciaMap.forEach((data, key) => {
      const [codigo, bodegaPrincipal, bodegaSecundaria] = key.split('||');
      const c = catMap.get(codigo) || {};
      const bodegaMostrar = bodegaSecundaria || bodegaPrincipal;

      inventarioMap.set(key, {
        codigo,
        nombre: c.nombre || codigo,
        bodega: bodegaMostrar,
        bodega_principal: bodegaPrincipal,
        bodega_secundaria: bodegaSecundaria,
        tipo: c.tipo || '‚Äì',
        color: c.color || '‚Äì',
        existencia: Math.max(0, data.existencia), // No permitir existencias negativas
        tabla_origen: data.tabla_origen
      });
    });

    // Complemento: items del cat√°logo sin movimientos a√∫n (existencia=0)
    function addCatalogoSinStock(data, tipo) {
      (data || []).forEach(c => {
        const codigo = String(c.codigo || '').trim();
        if (!codigo) return;

        const bodegaPrincipal = normalizarBodega(c.bodega_principal) || 'Principal';
        const bodegaSecundaria = normalizarBodega(c.bodega_secundaria) || 'General';
        const key = makeKey(codigo, bodegaPrincipal, bodegaSecundaria);
        if (inventarioMap.has(key)) return;

        const bodegaMostrar = bodegaSecundaria || bodegaPrincipal;
        inventarioMap.set(key, {
          codigo,
          nombre: c.nombre || codigo,
          bodega: bodegaMostrar,
          bodega_principal: bodegaPrincipal,
          bodega_secundaria: bodegaSecundaria,
          tipo: c.tipo_material || '‚Äì',
          color: c.color || '‚Äì',
          existencia: 0,
          tabla_origen: tipo
        });
      });
    }

    addCatalogoSinStock(catAudioData, 'audiovisual');
    addCatalogoSinStock(catHierroData, 'hierros');
    addCatalogoSinStock(catConsumibleData, 'consumibles');

    const inventario = Array.from(inventarioMap.values()).sort((a, b) =>
      a.bodega_principal.localeCompare(b.bodega_principal)
      || a.bodega_secundaria.localeCompare(b.bodega_secundaria)
      || a.codigo.localeCompare(b.codigo)
    );

    estado.inventario = inventario;
    estado.bodegasPrincipales = Array.from(new Set(inventario.map(i => i.bodega_principal).filter(Boolean))).sort();
    estado.bodegasSecundarias = Array.from(new Set(inventario.map(i => i.bodega_secundaria).filter(Boolean))).sort();

    // Mapear secundarias por principal
    estado.secundariasPorPrincipal = new Map();
    inventario.forEach(it => {
      const p = (it.bodega_principal || '').toString().trim();
      const s = (it.bodega_secundaria || '').toString().trim();
      if (!p || !s) return;
      const set = estado.secundariasPorPrincipal.get(p) || new Set();
      set.add(s);
      estado.secundariasPorPrincipal.set(p, set);
    });

    poblarSelectBodegaPrincipal(estado.bodegasPrincipales);
    poblarSelectBodegaSecundaria(document.getElementById('filtro-bodega-principal')?.value || 'todas');
  }

  async function cargarMovimientosRecientes() {
    if (!supa) return;

    try {
      // Consultar las 3 tablas de movimientos por separado y combinar
      console.log('Cargando movimientos de las 3 bodegas...');

      const [audioResult, hierroResult, consumibleResult] = await Promise.allSettled([
        supa
          .from('movimientos_bodega_audiovisual')
          .select(`
            id,
            material_codigo,
            material_nombre,
            bodega_principal,
            bodega_secundaria,
            ubicacion_nombre,
            tipo_movimiento,
            cantidad,
            signo,
            referencia_tipo,
            fecha_movimiento,
            observaciones,
            estado,
            created_at
          `)
          .order('created_at', { ascending: false })
          .limit(25),

        supa
          .from('movimientos_bodega_hierros')
          .select(`
            id,
            material_codigo,
            material_nombre,
            bodega_principal,
            bodega_secundaria,
            ubicacion_nombre,
            tipo_movimiento,
            cantidad,
            signo,
            referencia_tipo,
            fecha_movimiento,
            observaciones,
            estado,
            created_at
          `)
          .order('created_at', { ascending: false })
          .limit(25),

        supa
          .from('movimientos_bodega_consumibles')
          .select(`
            id,
            material_codigo,
            material_nombre,
            bodega_principal,
            bodega_secundaria,
            ubicacion_nombre,
            tipo_movimiento,
            cantidad,
            signo,
            referencia_tipo,
            fecha_movimiento,
            observaciones,
            estado,
            created_at
          `)
          .order('created_at', { ascending: false })
          .limit(25)
      ]);

      // Procesar resultados y manejar errores individuales
      const processResult = (result, tipo) => {
        if (result.status === 'fulfilled' && result.value.data) {
          return result.value.data.map(m => ({ ...m, tabla_origen: tipo }));
        } else {
          console.warn(`Error cargando movimientos de ${tipo}:`, result.reason || result.value?.error);
          return [];
        }
      };

      const movimientosAudio = processResult(audioResult, 'audiovisual');
      const movimientosHierro = processResult(hierroResult, 'hierros');
      const movimientosConsumible = processResult(consumibleResult, 'consumibles');

      // Combinar y ordenar por fecha (m√°s recientes primero)
      const allMovimientos = [
        ...movimientosAudio,
        ...movimientosHierro,
        ...movimientosConsumible
      ].sort((a, b) => {
        const fechaA = new Date(a.created_at || a.fecha_movimiento || 0);
        const fechaB = new Date(b.created_at || b.fecha_movimiento || 0);
        return fechaB - fechaA;
      });

      estado.movimientos = allMovimientos.slice(0, 50);
      renderizarMovimientos();

      // Actualizar indicador de estado
      actualizarIndicadorEstado('success', 'Conectado', `${allMovimientos.length} movimientos cargados`);

    } catch (err) {
      console.error('Error general en cargarMovimientosRecientes:', err);
      document.getElementById('panel-movimientos').innerHTML = `<div style="text-align: center; color: #ef4444;">Error al cargar movimientos</div>`;
      actualizarIndicadorEstado('error', 'Error de conexi√≥n', 'No se pudieron cargar los movimientos');
    }
  }

  function renderizarMovimientos() {
    const container = document.getElementById('panel-movimientos');
    if (!container) return;

    if (!estado.movimientos || estado.movimientos.length === 0) {
      container.innerHTML = `<div style="text-align: center; color: #888; margin-top: 20px;">No hay movimientos recientes</div>`;
      return;
    }

    let html = '<div style="display: flex; flex-direction: column; gap: 6px; max-height: 100%; overflow-y: auto;">';

    estado.movimientos.slice(0, 20).forEach(mov => { // Mostrar solo los 20 m√°s recientes
      const fecha = new Date(mov.created_at || mov.fecha_movimiento).toLocaleString('es-NI', {
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });

      const tipoIcon = mov.tipo_movimiento === 'ingreso' ? 'üì•' : 'üì§';
      const tipoColor = mov.tipo_movimiento === 'ingreso' ? '#4ade80' : '#f87171';
      const cantidadDisplay = `${mov.signo > 0 ? '+' : ''}${mov.cantidad}`;

      const referencia = mov.referencia_tipo ? ` ‚Ä¢ ${mov.referencia_tipo.replace(/_/g, ' ')}` : '';
      const ubicacion = mov.ubicacion_nombre ? ` ‚Üí ${mov.ubicacion_nombre}` : '';

      // Indicador de tipo de bodega
      const bodegaIcon = mov.tabla_origen === 'audiovisual' ? 'üé•' :
                        mov.tabla_origen === 'hierros' ? 'üîß' :
                        mov.tabla_origen === 'consumibles' ? 'üõ†Ô∏è' : 'üì¶';
      const bodegaLabel = mov.tabla_origen === 'audiovisual' ? 'Audio' :
                         mov.tabla_origen === 'hierros' ? 'Hierros' :
                         mov.tabla_origen === 'consumibles' ? 'Consumibles' : 'Gen√©rico';

      html += `
        <div style="background: rgba(30, 40, 70, 0.5); border: 1px solid rgba(99, 102, 241, 0.1); border-radius: 6px; padding: 8px; font-size: 12px; transition: background-color 0.2s;">
          <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 4px;">
            <div style="flex: 1; min-width: 0;">
              <div style="font-weight: bold; color: #cbd5e1; font-size: 11px; word-break: break-all;">${mov.material_codigo}</div>
              <div style="color: #94a3b8; font-size: 10px; margin-top: 2px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${mov.material_nombre || 'Sin nombre'}</div>
            </div>
            <div style="text-align: right; margin-left: 8px;">
              <div style="color: ${tipoColor}; font-weight: bold; font-size: 13px;">${tipoIcon} ${cantidadDisplay}</div>
              <div style="color: #64748b; font-size: 9px;">${fecha}</div>
            </div>
          </div>
          <div style="color: #64748b; font-size: 10px; margin-top: 4px;">
            <span style="color: #475569;">${bodegaIcon} ${bodegaLabel}</span> ‚Ä¢
            <span style="color: #64748b;">${mov.bodega_secundaria || mov.bodega_principal || 'Bodega'}</span>${ubicacion}${referencia}
          </div>
        </div>
      `;
    });

    html += '</div>';
    container.innerHTML = html;
  }

  function iniciarAutoRefresh() {
    // Actualizar movimientos cada 30 segundos
    estado.autoRefreshInterval = setInterval(async () => {
      actualizarIndicadorEstado('loading', 'Actualizando...', 'Sincronizando bodegas');
      await cargarMovimientosRecientes();
    }, 30000);
  }

  function detenerAutoRefresh() {
    if (estado.autoRefreshInterval) {
      clearInterval(estado.autoRefreshInterval);
      estado.autoRefreshInterval = null;
    }
  }

  function actualizarIndicadorEstado(tipo, texto, detalle = '') {
    const contenedor = document.getElementById('estado-conexion');
    const icono = document.getElementById('estado-icono');
    const textoEl = document.getElementById('estado-texto');
    const detalleEl = document.getElementById('estado-detalle');

    if (!contenedor || !icono || !textoEl) return;

    // Configurar colores y iconos seg√∫n el tipo
    let color, icon;
    switch (tipo) {
      case 'success':
        color = 'rgba(34, 197, 94, 0.2)';
        icon = '‚úÖ';
        break;
      case 'error':
        color = 'rgba(239, 68, 68, 0.2)';
        icon = '‚ùå';
        break;
      case 'warning':
        color = 'rgba(251, 191, 36, 0.2)';
        icon = '‚ö†Ô∏è';
        break;
      case 'loading':
      default:
        color = 'rgba(59, 130, 246, 0.2)';
        icon = 'üîÑ';
        break;
    }

    contenedor.style.background = color;
    contenedor.style.borderColor = tipo === 'success' ? 'rgba(34, 197, 94, 0.3)' :
                                  tipo === 'error' ? 'rgba(239, 68, 68, 0.3)' :
                                  tipo === 'warning' ? 'rgba(251, 191, 36, 0.3)' :
                                  'rgba(59, 130, 246, 0.3)';

    icono.textContent = icon;
    textoEl.textContent = texto;

    if (detalleEl) {
      detalleEl.textContent = detalle;
      detalleEl.style.display = detalle ? 'block' : 'none';
    }
  }

  function poblarSelectBodegaPrincipal(principales = []) {
    const select = document.getElementById('filtro-bodega-principal');
    if (!select) return;
    const actual = select.value || 'todas';

    const opciones = ['<option value="todas">Todas</option>'];
    principales.forEach(b => {
      const safe = String(b).replace(/"/g, '&quot;');
      opciones.push(`<option value="${safe}">${safe}</option>`);
    });

    select.innerHTML = opciones.join('');
    const disponibles = new Set(['todas', ...principales]);
    select.value = disponibles.has(actual) ? actual : 'todas';
  }

  function poblarSelectBodegaSecundaria(principalSeleccionada) {
    const select = document.getElementById('filtro-bodega-secundaria');
    if (!select) return;
    const actual = select.value || 'todas';

    let secundarias = [];
    if ((principalSeleccionada || 'todas') === 'todas') {
      secundarias = estado.bodegasSecundarias || [];
    } else {
      const set = estado.secundariasPorPrincipal.get(principalSeleccionada) || new Set();
      secundarias = Array.from(set).sort();
    }

    const opciones = ['<option value="todas">Todas</option>'];
    secundarias.forEach(b => {
      const safe = String(b).replace(/"/g, '&quot;');
      opciones.push(`<option value="${safe}">${safe}</option>`);
    });

    select.innerHTML = opciones.join('');
    const disponibles = new Set(['todas', ...secundarias]);
    select.value = disponibles.has(actual) ? actual : 'todas';
  }

  function renderizarTabla(bodegaPrincipalFiltro, bodegaSecundariaFiltro) {
    let itemsFiltrados = [...(estado.inventario || [])];

    if ((bodegaPrincipalFiltro || 'todas') !== 'todas') {
      itemsFiltrados = itemsFiltrados.filter(item => item.bodega_principal === bodegaPrincipalFiltro);
    }
    if ((bodegaSecundariaFiltro || 'todas') !== 'todas') {
      itemsFiltrados = itemsFiltrados.filter(item => item.bodega_secundaria === bodegaSecundariaFiltro);
    }

    let totalUnidades = 0, agotados = 0;
    let filas = '';

    itemsFiltrados.forEach(item => {
      const existencia = Number(item.existencia) || 0;
      totalUnidades += existencia;
      if (existencia === 0) agotados++;
      filas += `
        <tr>
          <td>${item.codigo}</td>
          <td>${item.nombre}</td>
          <td>${item.bodega}</td>
          <td>${item.tipo}</td>
          <td>${item.color}</td>
          <td>${existencia}</td>
          <td>${existencia > 0 ? 'Disponible' : 'Agotado'}</td>
        </tr>
      `;
    });

    document.getElementById('kpi-unicos').textContent = itemsFiltrados.length;
    document.getElementById('kpi-unidades').textContent = totalUnidades;
    document.getElementById('kpi-agotados').textContent = agotados;

    document.getElementById('tabla-inventario-bodega').innerHTML = `
      <table class="bodega-table">
        <thead>
          <tr>
            <th>C√≥digo</th>
            <th>Nombre</th>
            <th>Bodega</th>
            <th>Tipo</th>
            <th>Color</th>
            <th>Existencia</th>
            <th>Estado</th>
          </tr>
        </thead>
        <tbody>
          ${filas || '<tr><td colspan="7" style="text-align:center;color:#aaa;">No hay materiales en esta bodega</td></tr>'}
        </tbody>
      </table>
    `;
  }

  // === INICIALIZAR ===
  (async function init() {
    actualizarIndicadorEstado('loading', 'Cargando datos...', 'Conectando a bodegas');

    await Promise.all([
      cargarInventarioDesdeSupabase(),
      cargarMovimientosRecientes()
    ]);

    renderizarTabla(
      document.getElementById('filtro-bodega-principal')?.value || 'todas',
      document.getElementById('filtro-bodega-secundaria')?.value || 'todas'
    );

    // Iniciar actualizaci√≥n autom√°tica de movimientos
    iniciarAutoRefresh();
  })();

  // === EVENTOS ===
  document.getElementById('filtro-bodega-principal').addEventListener('change', (e) => {
    const principal = e.target.value;
    poblarSelectBodegaSecundaria(principal);
    renderizarTabla(principal, document.getElementById('filtro-bodega-secundaria')?.value || 'todas');
  });

  document.getElementById('filtro-bodega-secundaria').addEventListener('change', (e) => {
    renderizarTabla(
      document.getElementById('filtro-bodega-principal')?.value || 'todas',
      e.target.value
    );
  });

  // Detener auto-refresh cuando se cierre la p√°gina
  window.addEventListener('beforeunload', () => {
    detenerAutoRefresh();
  });

  // Tambi√©n detener cuando se cambie de vista (si hay navegaci√≥n)
  document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
      detenerAutoRefresh();
    } else {
      // Re-iniciar si vuelve a ser visible
      if (!estado.autoRefreshInterval) {
        iniciarAutoRefresh();
      }
    }
  });

  // Bot√≥n de refresh manual
  document.getElementById('btn-refresh-movimientos').addEventListener('click', async () => {
    const btn = document.getElementById('btn-refresh-movimientos');
    const originalText = btn.textContent;
    btn.textContent = '‚ü≥';
    btn.disabled = true;

    actualizarIndicadorEstado('loading', 'Actualizando...', 'Refresco manual');
    await cargarMovimientosRecientes();

    btn.textContent = originalText;
    btn.disabled = false;
  });

  document.getElementById('btn-exportar-xbodega').addEventListener('click', () => {
  if (typeof html2pdf === 'undefined') {
    alert('html2pdf no est√° cargado.');
    return;
  }

  const selectPrincipal = document.getElementById('filtro-bodega-principal');
  const selectSecundaria = document.getElementById('filtro-bodega-secundaria');
  const valorPrincipal = selectPrincipal?.value || 'todas';
  const valorSecundaria = selectSecundaria?.value || 'todas';
  const textoPrincipal = selectPrincipal?.selectedOptions?.[0]?.text || 'Todas';
  const textoSecundaria = selectSecundaria?.selectedOptions?.[0]?.text || 'Todas';
  const fecha = new Date().toLocaleDateString('es-NI');

  const grupos = {};

  document.querySelectorAll('#tabla-inventario-bodega tbody tr').forEach(tr => {
    const c = tr.children;
    if (c.length < 7) return;

    const bodega = c[2].textContent.trim();
    if (!grupos[bodega]) grupos[bodega] = [];

    grupos[bodega].push({
      codigo: c[0].textContent,
      nombre: c[1].textContent,
      tipo: c[3].textContent,
      color: c[4].textContent,
      existencia: c[5].textContent,
      estado: c[6].textContent.trim()
    });
  });

  const bodegas = Object.keys(grupos);

  let contenido = '';

  bodegas.forEach(bodega => {
    if (!grupos[bodega]) return;

    let filas = '';
    grupos[bodega].forEach(i => {
      filas += `
        <tr>
          <td>${i.codigo}</td>
          <td>${i.nombre}</td>
          <td>${i.tipo}</td>
          <td>${i.color}</td>
          <td style="text-align:center;">${i.existencia}</td>
          <td class="${i.estado === 'Disponible' ? 'ok' : 'bad'}">${i.estado}</td>
        </tr>
      `;
    });

    contenido += `
      <h2 class="grupo-bodega">üì¶ ${bodega}</h2>
      <table>
        <thead>
          <tr>
            <th>C√≥digo</th>
            <th>Nombre</th>
            <th>Tipo</th>
            <th>Color</th>
            <th>Exist.</th>
            <th>Estado</th>
          </tr>
        </thead>
        <tbody>${filas}</tbody>
      </table>
    `;
  });

  const html = `
  <style>
    body {
      font-family: Arial, sans-serif;
      color:#1f2937;
      margin-bottom:70px;
    }

    .header {
      text-align:center;
      border-bottom:2px solid #2563eb;
      padding-bottom:8px;
      margin-bottom:18px;
    }

    .header h1 {
      margin:0;
      font-size:18px;
      color:#1e3a8a;
    }

    .header p {
      margin:4px 0 0;
      font-size:11px;
      color:#555;
    }

    .grupo-bodega {
      margin:22px 0 8px;
      font-size:14px;
      color:#1e40af;
      border-left:4px solid #2563eb;
      padding-left:8px;
      page-break-inside: avoid;
    }

    table {
      width:100%;
      border-collapse:collapse;
      font-size:10.5px;
      margin-bottom:18px;
    }

    thead th {
      background:#2563eb;
      color:#fff;
      padding:6px;
      text-align:left;
    }

    tbody td {
      padding:5px 6px;
      border-bottom:1px solid #e5e7eb;
    }

    tbody tr:nth-child(even) {
      background:#f8fafc;
    }

    .ok { color:#166534; font-weight:bold; }
    .bad { color:#991b1b; font-weight:bold; }

    .footer {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      font-size:10px;
      color:#555;
      text-align:center;
      border-top:1px solid #e5e7eb;
      padding:6px 0;
      background:#fff;
    }
  </style>

  <div>
    <div class="header">
      <img src="assets/logo.png" style="height:48px;margin-bottom:4px;">
      <h1>Inventario General por Bodega</h1>
      <p>
        ${
          (valorPrincipal === 'todas' && valorSecundaria === 'todas')
            ? 'Todas las bodegas'
            : (valorPrincipal !== 'todas' && valorSecundaria === 'todas')
              ? `Bodega Principal: ${textoPrincipal}`
              : (valorPrincipal === 'todas' && valorSecundaria !== 'todas')
                ? `Bodega Secundaria: ${textoSecundaria}`
                : `Bodega Principal: ${textoPrincipal} ‚Ä¢ Secundaria: ${textoSecundaria}`
        }
        | Fecha: ${fecha}
      </p>
    </div>

    ${contenido}

    <div class="footer">
      Absolute de Nicaragua ¬∑ Inventario generado autom√°ticamente
    </div>
  </div>
  `;

  html2pdf().from(html).set({
    margin: [12, 12, 18, 12],
    filename: `Inventario_${
      (valorPrincipal === 'todas' && valorSecundaria === 'todas')
        ? 'General'
        : (valorPrincipal !== 'todas' && valorSecundaria === 'todas')
          ? textoPrincipal.replace(/ /g,'_')
          : (valorPrincipal === 'todas' && valorSecundaria !== 'todas')
            ? textoSecundaria.replace(/ /g,'_')
            : (textoPrincipal + '_' + textoSecundaria).replace(/ /g,'_')
    }.pdf`,
    html2canvas: { scale: 2 },
    jsPDF: { unit: 'mm', format: 'letter', orientation: 'portrait' }
  }).save();
});



  // === NAVEGACI√ìN R√ÅPIDA ===
  document.querySelectorAll('.bodega-nav-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const eventoFake = { target: { dataset: { vista: btn.dataset.vista } } };
      if (typeof manejarClicVista === 'function') {
        manejarClicVista(eventoFake);
      } else {
        console.warn('manejarClicVista no est√° disponible');
      }
    });
  });
})();
</script>
