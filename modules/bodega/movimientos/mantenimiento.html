<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Mantenimiento de Materiales</title>
</head>
  <body class="mantenimiento-theme">
  <style>
    :root{
      --mnt-accent: #0ea5a4;
      --mnt-accent-dark: #0b948f;
      --mnt-card-bg: linear-gradient(180deg, rgba(14,165,164,0.06), rgba(3,105,118,0.02));
      --mnt-highlight: #ecfeff;
    }
    .movimientos-view{
      width: 100%;
      max-width: 1400px;
      margin: 0 auto;
      box-sizing: border-box;
      position: relative;
      color: rgba(224, 224, 255, 0.92);
    }
    .mantenimiento-theme .mnt-contenedor{ width: 100%; box-sizing: border-box; }
    .mantenimiento-theme .mnt-tarjeta{
      background: var(--mnt-card-bg);
      border: 1px solid rgba(14,165,164,0.12);
      box-shadow: 0 8px 20px rgba(3,105,118,0.06);
      padding: 18px;
      border-radius: 12px;
    }
    .mantenimiento-theme .mnt-titulo{ color: var(--mnt-accent); margin-bottom: 6px; }
    .mantenimiento-theme .mnt-subtitulo{ color: #065f5b; margin-bottom: 12px; }
    .mantenimiento-theme .mnt-seccion{ margin-top: 14px; padding-top: 14px; border-top: 1px solid rgba(14,165,164,0.18); }
    .mantenimiento-theme .mnt-seccion:first-of-type{ margin-top: 0; padding-top: 0; border-top: none; }
    .mantenimiento-theme .mnt-seccion-titulo{ color: var(--mnt-accent-dark); font-size: 14px; font-weight: 800; letter-spacing: 0.6px; text-transform: uppercase; margin: 0 0 10px 0; }
    .mantenimiento-theme .mnt-fila{ display: grid; grid-template-columns: repeat(4, minmax(160px, 1fr)); gap: 12px; }
    @media (max-width: 1100px){ .mantenimiento-theme .mnt-fila{ grid-template-columns: repeat(2, minmax(160px, 1fr)); } }
    @media (max-width: 680px){ .mantenimiento-theme .mnt-fila{ grid-template-columns: 1fr; } }
    .mantenimiento-theme .mnt-columna{ min-width: 0; }
    .mantenimiento-theme .mnt-etiqueta{ display: block; margin: 0 0 6px 0; font-size: 12px; font-weight: 700; color: rgba(6, 95, 91, 0.92); }
    .mantenimiento-theme .mnt-entrada,
    .mantenimiento-theme .mnt-select{
      width: 100%;
      box-sizing: border-box;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid rgba(14,165,164,0.28);
      background: rgba(0, 0, 0, 0.10);
      color: rgba(255, 255, 255, 0.92);
      outline: none;
    }
    .mantenimiento-theme .mnt-entrada::placeholder{ color: rgba(6, 95, 91, 0.60); }
    .mantenimiento-theme .mnt-entrada:focus,
    .mantenimiento-theme .mnt-select:focus{ border-color: rgba(14,165,164,0.70); box-shadow: 0 0 0 2px rgba(14,165,164,0.18); }
    .mantenimiento-theme .mnt-entrada[readonly]{ background: #f0fdfa; color: #0f172a; }
    .mantenimiento-theme .mnt-acciones{ display: flex; gap: 10px; flex-wrap: wrap; justify-content: flex-end; margin-top: 16px; }
    .mantenimiento-theme .lista-solicitudes{ border: 1px solid rgba(14,165,164,0.06); background: linear-gradient(180deg, rgba(0,0,0,0.54), rgba(3,105,118,0.04)); }
    .mantenimiento-theme #lista-solicitudes-mantenimiento{ color: #0f766e; }
    .mantenimiento-theme .mnt-boton{
      border-radius: 10px;
      padding: 10px 14px;
      border: 1px solid rgba(14,165,164,0.22);
      background: rgba(255, 255, 255, 0.04);
      color: rgba(255, 255, 255, 0.92);
      font-weight: 800;
      cursor: pointer;
      transition: transform 140ms ease, box-shadow 180ms ease, background-color 180ms ease, border-color 180ms ease;
    }
    .mantenimiento-theme .mnt-boton:hover{ background: rgba(14,165,164,0.14); border-color: rgba(14,165,164,0.60); box-shadow: 0 0 14px rgba(14,165,164,0.18); transform: translateY(-1px); }
    .mantenimiento-theme .mnt-boton:disabled{ opacity: 0.55; cursor: not-allowed; }
    .mantenimiento-theme .mnt-boton.mnt-boton-primario{ background: var(--mnt-accent); border-color: var(--mnt-accent-dark); color: #003337; }
    .mantenimiento-theme .mnt-boton.mnt-boton-primario:hover{ background: var(--mnt-accent-dark); }
    .mantenimiento-theme .mnt-boton.mnt-boton-secundario{ background: rgba(14,165,164,0.06); border-color: rgba(14,165,164,0.12); color: var(--mnt-accent-dark); }
    .mantenimiento-theme .mnt-boton.mnt-boton-peligro{ background: rgba(220,38,38,0.06); border-color: rgba(220,38,38,0.12); color: #991b1b; }
    .mantenimiento-theme .mnt-modal-overlay{
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.72);
      z-index: 10000;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 18px;
      pointer-events: auto;
    }
    .mantenimiento-theme .mnt-modal-contenido{
      width: min(860px, 96vw);
      max-height: min(80vh, 860px);
      overflow: auto;
      background: linear-gradient(180deg, rgba(17, 32, 56, 0.96), rgba(10, 18, 30, 0.96));
      border: 1px solid rgba(14,165,164,0.22);
      border-radius: 14px;
      padding: 16px;
      box-shadow: 0 18px 60px rgba(0, 0, 0, 0.55);
    }
    .mantenimiento-theme #factura-contenido table { width: 100%; border-collapse: collapse; color: #e6eef0; margin-top: 8px; }
    .mantenimiento-theme #factura-contenido th, .mantenimiento-theme #factura-contenido td { padding: 8px 10px; border-bottom: 1px solid rgba(255,255,255,0.04); text-align: left; font-size: 13px; }
    .mantenimiento-theme #factura-contenido thead th { color: #9ae6e6; font-weight: 800; font-size: 13px; }
    .mantenimiento-theme #factura-contenido tbody tr:nth-child(odd) { background: rgba(255,255,255,0.02); }
    .mantenimiento-theme #factura-contenido .factura-total { font-weight: 900; color: #cfe9eb; font-size: 16px; margin-top: 10px; }
    .mantenimiento-theme .mnt-modal-titulo{ margin: 0 0 8px 0; color: rgba(255, 255, 255, 0.96); }
    .mantenimiento-theme .mnt-modal-texto{ margin: 0 0 14px 0; color: rgba(224, 224, 255, 0.72); }
    .mantenimiento-theme .mnt-modal-botones{ display: flex; gap: 10px; justify-content: flex-end; flex-wrap: wrap; margin-top: 12px; }
    .mantenimiento-theme .mnt-titulo::first-letter{ font-size: 1.15em; }
    #modal-seleccion-mantenimiento.fab-catalog-overlay{
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.85);
      z-index: 10000;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 18px;
      pointer-events: auto;
    }
    #modal-seleccion-mantenimiento .fab-catalog-modal{ width: min(1100px, 94vw); height: min(78vh, 860px); background: #ffffff; border-radius: 16px; overflow: hidden; display: flex; flex-direction: column; animation: fabCatalogIn 160ms ease; }
    #modal-seleccion-mantenimiento .fab-catalog-header{ display: flex; align-items: center; justify-content: space-between; padding: 14px 18px; border-bottom: 1px solid #e2e8f0; }
    #modal-seleccion-mantenimiento .fab-catalog-title{ margin: 0; font-size: 16px; font-weight: 800; color: #0f172a; }
    #modal-seleccion-mantenimiento .fab-catalog-close{ border: none; background: #f1f5f9; color: #0f172a; border-radius: 10px; width: 34px; height: 34px; cursor: pointer; font-size: 18px; }
    #modal-seleccion-mantenimiento .fab-catalog-close:hover{ background: #e2e8f0; }
    #modal-seleccion-mantenimiento .fab-catalog-filters{ padding: 12px 18px; border-bottom: 1px solid #e2e8f0; background: #f8fafc; }
    #modal-seleccion-mantenimiento .fab-catalog-filters-grid{ display: grid; grid-template-columns: 2fr 1fr auto; gap: 14px; align-items: end; }
    @media (max-width: 860px){ #modal-seleccion-mantenimiento .fab-catalog-filters-grid{ grid-template-columns: 1fr; } }
    #modal-seleccion-mantenimiento .fab-catalog-label{ display: block; margin: 0 0 6px 0; font-size: 13px; font-weight: 800; color: #334155; }
    #modal-seleccion-mantenimiento .mnt-entrada,
    #modal-seleccion-mantenimiento .mnt-select{ background: #ffffff; color: #0f172a; border-color: #cbd5e1; box-shadow: 0 0 0 1px rgba(2, 6, 23, 0.06) inset; font-size: 14px; padding: 10px 12px; min-height: 42px; }
    #modal-seleccion-mantenimiento .mnt-entrada::placeholder{ color: #94a3b8; }
    #modal-seleccion-mantenimiento .mnt-entrada:focus,
    #modal-seleccion-mantenimiento .mnt-select:focus{ border-color: #0ea5a4; box-shadow: 0 0 0 2px rgba(14, 165, 164, 0.18); }
    #modal-seleccion-mantenimiento .mnt-boton{ border-radius: 12px; font-weight: 900; letter-spacing: 0.2px; font-size: 14px; padding: 10px 14px; min-height: 42px; }
    #modal-seleccion-mantenimiento .mnt-boton:focus-visible{ outline: none; box-shadow: 0 0 0 2px rgba(14, 165, 164, 0.22); }
    #modal-seleccion-mantenimiento .mnt-boton:hover{ transform: translateY(-1px); }
    #modal-seleccion-mantenimiento .mnt-boton:active{ transform: translateY(0px); }
    #modal-seleccion-mantenimiento .mnt-boton-primario{ border-color: #0ea5a4; background: #0ea5a4; color: #ffffff; box-shadow: 0 12px 26px rgba(2, 6, 23, 0.18); }
    #modal-seleccion-mantenimiento .mnt-boton-primario:hover{ border-color: #0b948f; background: #0b948f; box-shadow: 0 16px 34px rgba(2, 6, 23, 0.22); }
    #modal-seleccion-mantenimiento .mnt-boton-secundario{ background: #e2e8f0; color: #0f172a; border-color: #cbd5e1; box-shadow: 0 0 0 1px rgba(2, 6, 23, 0.06) inset; }
    #modal-seleccion-mantenimiento .mnt-boton-secundario:hover{ background: #cbd5e1; border-color: #94a3b8; box-shadow: 0 10px 22px rgba(2, 6, 23, 0.12); }
    #modal-seleccion-mantenimiento .fab-catalog-results-wrap{ flex: 1; overflow: auto; padding: 16px 18px; }
    #modal-seleccion-mantenimiento .fab-catalog-results{ display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 16px; }
    #modal-seleccion-mantenimiento .fab-catalog-card{ border: 1px solid #e2e8f0; border-radius: 14px; padding: 14px; background: #ffffff; box-shadow: 0 10px 22px rgba(15, 23, 42, 0.08); display: flex; flex-direction: column; gap: 10px; }
    #modal-seleccion-mantenimiento .fab-catalog-card:hover{ box-shadow: 0 12px 30px rgba(15, 23, 42, 0.14); }
    #modal-seleccion-mantenimiento .fab-catalog-card-top{ display: flex; justify-content: space-between; gap: 10px; }
    #modal-seleccion-mantenimiento .fab-catalog-name{ font-weight: 800; color: #0f172a; }
    #modal-seleccion-mantenimiento .fab-catalog-code{ color: #64748b; font-size: 12px; }
    #modal-seleccion-mantenimiento .fab-catalog-existencia{ background: #0ea5a4; color: #ffffff; min-width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-weight: 900; }
    #modal-seleccion-mantenimiento .fab-catalog-tags{ display: flex; flex-wrap: wrap; gap: 6px; }
    #modal-seleccion-mantenimiento .fab-catalog-tag{ background: #f1f5f9; color: #0f172a; font-weight: 700; font-size: 11px; padding: 4px 8px; border-radius: 999px; }
    #modal-seleccion-mantenimiento .fab-catalog-tag--secondary{ background: #e2e8f0; }
    #modal-seleccion-mantenimiento .fab-catalog-select-btn{ width: 100%; }
    #modal-seleccion-mantenimiento .fab-catalog-footer{ padding: 12px 18px; border-top: 1px solid #e2e8f0; background: #f8fafc; display: flex; justify-content: flex-end; gap: 10px; }
    #modal-seleccion-mantenimiento .fab-catalog-empty,
    #modal-seleccion-mantenimiento .fab-catalog-error{ color: #0f172a; font-weight: 700; }
    #modal-seleccion-mantenimiento .fab-catalog-empty{ text-align: center; }
    #modal-seleccion-mantenimiento .fab-catalog-error{ color: #b91c1c; }
  </style>
  <div class="movimientos-view mantenimiento-theme">
  <div class="fabricacion-layout" style="display: grid; grid-template-columns: 340px 1fr; gap: 16px; align-items: start; padding: 10px;">

    <!-- Lista lateral de solicitudes -->
    <aside class="lista-solicitudes" style="background: rgba(15, 23, 42, 0.72); border: 1px solid #0f172a; border-radius: 12px; padding: 16px; box-shadow: 0 6px 14px rgba(0,0,0,0.18);">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
        <div>
          <h3 style="margin: 0; color: #e2e8f0; font-size: 16px;">Solicitudes</h3>
          <p style="margin: 2px 0 0 0; color: #cbd5e1; font-size: 12px;">Solo para reimprimir factura de mantenimiento</p>
        </div>
        <button id="fab-refresh-list" class="mnt-boton mnt-boton-secundario" style="padding: 6px 10px; font-size: 12px;">‚Üª</button>
      </div>
      <div id="lista-solicitudes-mantenimiento" style="display: flex; flex-direction: column; gap: 10px; max-height: 78vh; overflow-y: auto; background: rgba(255,255,255,0.04); border: 1px solid rgba(226,232,240,0.2); border-radius: 10px; padding: 10px;font-size: 13px; color: #df6e18;"></div>
    </aside>

    <div class="mnt-contenedor" style="margin: 0;">
    <div class="mnt-tarjeta">
      <h1 class="mnt-titulo">üîß Mantenimiento de Materiales</h1>
      <p class="mnt-subtitulo">Registre el mantenimiento de materiales existentes y los insumos consumidos en el proceso</p>
      
      <div class="mnt-seccion">
        <div class="mnt-fila">
          <div class="mnt-columna">
            <label class="mnt-etiqueta">Responsable de Mantenimiento</label>
            <select id="responsable-manufactura" class="mnt-select" required>
              <option value="">Seleccione un empleado...</option>
            </select>
          </div>
          <div class="mnt-columna">
            <label class="mnt-etiqueta">Fecha</label>
            <input type="date" id="fecha-manufactura" class="mnt-entrada" required />
          </div>
        </div>
      </div>
      
      <!-- MATERIALES CONSUMIDOS -->
      <div class="mnt-seccion">
        <h2 class="mnt-seccion-titulo">Materiales Consumidos</h2>
        <p style="color: #64748b; margin-bottom: 12px; font-size: 14px;">
          Materiales del inventario que se utilizar√°n en el mantenimiento (ser√°n dados de baja)
        </p>
        <div id="tabla-consumidos"></div>
        <button id="btn-abrir-modal-consumidos" class="mnt-boton mnt-boton-primario" style="margin-top: 12px; width: auto;">
          + Seleccionar del Cat√°logo
        </button>
      </div>
      
      <!-- MATERIAL EN MANTENIMIENTO -->
      <div class="mnt-seccion">
        <h2 class="mnt-seccion-titulo">Material en Mantenimiento</h2>
        <p style="color: #64748b; margin-bottom: 12px; font-size: 14px;">
          Material existente que ser√° reparado/mantenido (ser√° dado de baja temporalmente)
        </p>
        <div id="tabla-mantenimiento"></div>
        <button id="btn-abrir-modal-mantenimiento" class="mnt-boton mnt-boton-primario" style="margin-top: 12px; width: auto;">
          + Seleccionar del Cat√°logo
        </button>
      </div>
      
        <div class="mnt-acciones">
        <button id="btn-guardar-fabricacion" class="mnt-boton mnt-boton-primario" style="display:none;">Registrar Mantenimiento</button>
        <button id="btn-procesar-mantenimiento" class="mnt-boton mnt-boton-primario" style="background:#f59e0b;border-color:#d97706;color:#06151a;">Procesar Mantenimiento</button>
        <button id="btn-limpiar-fabricacion" class="mnt-boton mnt-boton-secundario">Limpiar</button>
      </div>
    </div>
    </div>
  </div>

  <!-- Modal de √©xito -->
  <div id="modal-fabricacion" class="mnt-modal-overlay" style="display: none;">
    <div class="mnt-modal-contenido" style="max-width: 800px;">
      <h2 class="mnt-modal-titulo">‚úÖ Mantenimiento Registrado</h2>
      <p class="mnt-modal-texto">
        El mantenimiento ha sido registrado exitosamente. Los materiales han sido dados de baja del inventario.
      </p>
      <div id="detalles-mantenimiento" style="margin-top: 20px;">
        <!-- Aqu√≠ se mostrar√° la tabla del material en mantenimiento -->
      </div>
      <div class="mnt-modal-botones">
        <button id="btn-cerrar-fabricacion" class="mnt-boton mnt-boton-secundario">Cerrar</button>
      </div>
    </div>
  </div>

  <script>
    setTimeout(() => {
      // =============================================================================
      // üîπ CARGA SEGURA DE LIBRER√çAS
      // =============================================================================
      function loadScriptOnce(src, globalCheck) {
        return new Promise((resolve, reject) => {
          if (globalCheck && typeof globalCheck === 'function' && globalCheck()) return resolve();
          if (document.querySelector(`script[data-dynamic-src="${src}"]`)) {
            const existing = document.querySelector(`script[data-dynamic-src="${src}"]`);
            if (existing.getAttribute('data-loaded') === 'true') return resolve();
            existing.addEventListener('load', () => resolve());
            existing.addEventListener('error', (e) => reject(e));
            return;
          }
          const s = document.createElement('script');
          s.src = src;
          s.async = true;
          s.setAttribute('data-dynamic-src', src);
          s.addEventListener('load', () => { s.setAttribute('data-loaded', 'true'); resolve(); });
          s.addEventListener('error', (e) => reject(e));
          document.head.appendChild(s);
        });
      }

      // =============================================================================
      // üîπ VARIABLES GLOBALES
      // =============================================================================
      let estado = {
        itemsConsumidos: [],
        itemsMantenimiento: [],
        datosFormulario: {},
        pdfData: null
      };

      let editingSolicitudId = null;
      let editingSolicitudEstado = null;
      let editingNumeroSolicitud = null;
      function formatearPrecio(valor) {
        if (valor === null || valor === undefined || isNaN(valor)) return '‚Äî';
        return `$${Number(valor).toFixed(2)}`;
      }

      // =============================================================================
      // üîπ CARGAR DATOS DE SUPABASE
      // =============================================================================
      async function cargarDatos() {
        try {
          // Empleados
          const { data: empleados, error: errEmp } = await window.supabaseClient
            .from('empleados')
            .select('nombres, apellidos')
            .order('nombres', { ascending: true });
          if (errEmp) throw errEmp;
          const selectEmpleados = document.getElementById('responsable-manufactura');
          empleados.forEach(emp => {
            const nombre = `${emp.nombres} ${emp.apellidos}`;
            const opt = document.createElement('option');
            opt.value = nombre;
            opt.textContent = nombre;
            selectEmpleados.appendChild(opt);
          });

          // Fecha actual
          document.getElementById('fecha-manufactura').value = new Date().toISOString().split('T')[0];

        } catch (err) {
          console.error('Error al cargar datos:', err);
          alert('‚ùå Error al cargar empleados: ' + err.message);
        }
      }

      // =============================================================================
      // üîπ DETERMINAR BODEGAS (MEJORADO)
      // =============================================================================
      function determinarBodegas(material) {
        if (!material) return { principal: 'Desconocida', secundaria: 'Sin clasificar' };
        
        // Si ya tenemos tabla_origen, usarla para determinar la bodega
        if (material.tabla_origen) {
          let bodegaPrincipal = 'Desconocida';
          if (material.tabla_origen === 'catalogo_hierros') {
            bodegaPrincipal = 'Hierros';
          } else if (material.tabla_origen === 'catalogo_audiovisual') {
            bodegaPrincipal = 'Audiovisual';
          } else if (material.tabla_origen === 'catalogo_consumibles') {
            bodegaPrincipal = 'Consumibles';
          }
          return { principal: bodegaPrincipal, secundaria: material.bodega_secundaria || 'Sin clasificar' };
        }
        
        // Fallback: usar prefijos de c√≥digo (l√≥gica anterior)
        let bodegaPrincipal = 'Desconocida';
        const prefijo = material.codigo?.split('-')[1] || '';
        if (prefijo === 'HIE') bodegaPrincipal = 'Hierros';
        else if (prefijo === 'AUD') bodegaPrincipal = 'Audiovisual';
        else if (['PER', 'MOB', 'SIL', 'HER'].includes(prefijo)) bodegaPrincipal = 'Perfiler√≠a y Mobiliario';
        else if (['ILU', 'LIG', 'FOC'].includes(prefijo)) bodegaPrincipal = 'Iluminaci√≥n Esc√©nica';
        else if (['SILL'].includes(prefijo)) bodegaPrincipal = 'Bodega Sillas';
        else if (['HERR', 'CONS', 'FERR'].includes(prefijo)) bodegaPrincipal = 'Consumibles';
        else bodegaPrincipal = material.bodega_principal || material.bodega || 'Sin clasificar';
        
        const bodegaSecundaria = material.bodega_secundaria || material.bodega || 'Sin clasificar';
        return { principal: bodegaPrincipal, secundaria: bodegaSecundaria };
      }

      // =============================================================================
      // üîπ MODAL DE SELECCI√ìN DE MATERIALES
      // =============================================================================
      async function abrirModalManufacturado(tipo) {
        window.modalTipoActual = tipo;
        let modal = document.getElementById('modal-seleccion-mantenimiento');
        if (!modal) {
          modal = document.createElement('div');
          modal.id = 'modal-seleccion-mantenimiento';
          modal.className = 'fab-catalog-overlay';
          modal.innerHTML = `
            <div class="fab-catalog-modal" role="dialog" aria-modal="true">
              <div class="fab-catalog-header">
                <h2 class="fab-catalog-title">üîç Seleccionar Material del Cat√°logo</h2>
                <button id="btn-cerrar-modal-seleccion" class="fab-catalog-close" aria-label="Cerrar">√ó</button>
              </div>

              <div class="fab-catalog-filters">
                <div class="fab-catalog-filters-grid">
                    <div class="fab-catalog-filter">
                      <label class="fab-catalog-label">Buscar por nombre:</label>
                      <input type="text" id="buscador-nombre-mantenimiento" class="mnt-entrada" placeholder="Escriba para buscar..." />
                  </div>

                  <div class="fab-catalog-filter">
                    <label class="fab-catalog-label">Filtrar por Bodega:</label>
                    <select id="filtro-bodega-mantenimiento" class="mnt-select">
                      <option value="todas">Todas las Bodegas</option>
                      <option value="Hierros">Hierros</option>
                      <option value="Audiovisual">Audiovisual</option>
                      <option value="Consumibles">Consumibles</option>
                    </select>
                  </div>

                  <div class="fab-catalog-filter fab-catalog-filter--actions">
                    <button id="btn-restablecer-filtros" class="mnt-boton mnt-boton-secundario">Restablecer</button>
                  </div>
                </div>
              </div>

              <div class="fab-catalog-results-wrap">
                <div id="resultados-busqueda-mantenimiento" class="fab-catalog-results"></div>
              </div>

              <div class="fab-catalog-footer">
                <button id="btn-cerrar-modal-bottom" class="mnt-boton mnt-boton-secundario">Cancelar</button>
              </div>
            </div>
          `;
          document.body.appendChild(modal);

          // Eventos del modal
          document.getElementById('btn-cerrar-modal-seleccion').addEventListener('click', () => modal.style.display = 'none');
          document.getElementById('btn-cerrar-modal-bottom').addEventListener('click', () => modal.style.display = 'none');
          
          let debounceTimer;
          document.getElementById('buscador-nombre-mantenimiento').addEventListener('input', (e) => {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(renderResultadosBusqueda, 300);
          });
          
          document.getElementById('filtro-bodega-mantenimiento').addEventListener('change', renderResultadosBusqueda);
          document.getElementById('btn-restablecer-filtros').addEventListener('click', () => {
            document.getElementById('buscador-nombre-mantenimiento').value = '';
            document.getElementById('filtro-bodega-mantenimiento').value = 'todas';
            renderResultadosBusqueda();
          });
        }

        renderResultadosBusqueda();
        modal.style.display = 'flex';
      }

      // =============================================================================
      // üîπ RENDERIZAR RESULTADOS DE B√öSQUEDA
      // =============================================================================
      async function renderResultadosBusqueda() {
        const contenedor = document.getElementById('resultados-busqueda-mantenimiento');
        const terminoBusqueda = document.getElementById('buscador-nombre-mantenimiento').value.toLowerCase();
        const bodegaFiltro = document.getElementById('filtro-bodega-mantenimiento').value;
        const tipo = window.modalTipoActual; // 'consumido' o 'mantenimiento'

        try {
            let materiales = [];
            if (tipo === 'consumido') {
                // Para consumidos: usar las 3 vistas de stock separadas
                let materialesStock = [];
                const tablasStock = ['stock_hierros', 'stock_audiovisual', 'stock_consumibles'];
                
                for (const tabla of tablasStock) {
                  try {
                    const { data, error } = await window.supabaseClient
                      .from(tabla)
                      .select('material_codigo, material_nombre, bodega_principal, stock_actual, precio')
                      .gt('stock_actual', 0); // Solo materiales con stock disponible
                    
                    if (!error && data) {
                      // Agregar propiedad tabla_origen para saber de d√≥nde viene
                      const materialesConOrigen = data.map(m => ({
                        ...m,
                        tabla_origen: tabla.replace('stock_', 'catalogo_')
                      }));
                      materialesStock = materialesStock.concat(materialesConOrigen);
                    }
                  } catch (e) {
                    console.warn(`Error consultando ${tabla}:`, e.message || e);
                    continue;
                  }
                }
                
                materiales = materialesStock.map(m => ({
                  material_codigo: m.material_codigo,
                  material_nombre: m.material_nombre,
                  bodega_principal: m.bodega_principal,
                  existencia: m.stock_actual,
                  precio_promedio: m.precio,
                  tabla_origen: m.tabla_origen
                }));
            } else {
                // Para mantenimiento: usar las 3 vistas de stock separadas (materiales existentes)
                let materialesStock = [];
                const tablasStock = ['stock_hierros', 'stock_audiovisual', 'stock_consumibles'];
                
                for (const tabla of tablasStock) {
                  try {
                    const { data, error } = await window.supabaseClient
                      .from(tabla)
                      .select('material_codigo, material_nombre, bodega_principal, stock_actual, precio')
                      .gt('stock_actual', 0); // Solo materiales con stock disponible
                    
                    if (!error && data) {
                      // Agregar propiedad tabla_origen para saber de d√≥nde viene
                      const materialesConOrigen = data.map(m => ({
                        ...m,
                        tabla_origen: tabla.replace('stock_', 'catalogo_')
                      }));
                      materialesStock = materialesStock.concat(materialesConOrigen);
                    }
                  } catch (e) {
                    console.warn(`Error consultando ${tabla}:`, e.message || e);
                    continue;
                  }
                }
                
                materiales = materialesStock.map(m => ({
                  material_codigo: m.material_codigo,
                  material_nombre: m.material_nombre,
                  bodega_principal: m.bodega_principal,
                  existencia: m.stock_actual,
                  precio_promedio: m.precio,
                  tabla_origen: m.tabla_origen
                }));
            }

          // Filtrar por bodega
          if (bodegaFiltro !== 'todas') {
            materiales = materiales.filter(m => 
              m.bodega === bodegaFiltro || m.bodega_principal === bodegaFiltro
            );
          }

          // Filtrar por nombre
          if (terminoBusqueda) {
            materiales = materiales.filter(m => {
              const nombre = (m.material_nombre || m.nombre || '').toLowerCase();
              const codigo = (m.material_codigo || m.codigo || '').toLowerCase();
              return nombre.includes(terminoBusqueda) || codigo.includes(terminoBusqueda);
            });
          }

          if (!materiales || materiales.length === 0) {
            contenedor.innerHTML = '<p class="fab-catalog-empty">No se encontraron materiales.</p>';
            return;
          }

          contenedor.innerHTML = materiales.map(material => {
            const nombre = material.material_nombre || material.nombre || 'Sin nombre';
            const codigo = material.material_codigo || material.codigo || 'Sin c√≥digo';
            const bodegas = determinarBodegas({ codigo, bodega: material.bodega, bodega_principal: material.bodega_principal });
                return `
              <div class="fab-catalog-card">
                <div class="fab-catalog-card-top">
                  <div class="fab-catalog-card-title">
                    <div class="fab-catalog-name">${nombre}</div>
                    <div class="fab-catalog-code">${codigo}</div>
                  </div>
                  <div class="fab-catalog-existencia" title="Existencia">
                    ${material.existencia || 0}
                  </div>
                </div>
                <div class="fab-catalog-tags">
                  <span class="fab-catalog-tag fab-catalog-tag--primary">${bodegas.principal}</span>
                  <span class="fab-catalog-tag fab-catalog-tag--secondary">${bodegas.secundaria}</span>
                </div>
                <button class="mnt-boton mnt-boton-primario fab-catalog-select-btn" data-material='${JSON.stringify({
                  codigo,
                  nombre,
                  bodega: material.bodega,
                  bodega_principal: material.bodega_principal,
                  existencia: material.existencia,
                  precio_promedio: material.precio_promedio
                })}'>
                  Seleccionar Material
                </button>
              </div>
            `;
          }).join('');

          contenedor.querySelectorAll('button[data-material]').forEach(btn => {
            btn.addEventListener('click', async (e) => {
              const material = JSON.parse(e.currentTarget.dataset.material);
              if (window.modalTipoActual === 'consumido') {
                await agregarMaterialAConsumidos(material);
              } else {
                agregarMaterialAMantenimiento(material);
              }
              document.getElementById('modal-seleccion-mantenimiento').style.display = 'none';
            });
          });

        } catch (err) {
          console.error('Error al buscar materiales:', err);
          contenedor.innerHTML = '<p class="fab-catalog-error">Error al cargar materiales.</p>';
        }
      }

      // =============================================================================
      // üîπ LISTA LATERAL DE SOLICITUDES
      // =============================================================================
      async function cargarSolicitudesList() {
        const container = document.getElementById('lista-solicitudes-mantenimiento');
        if (!container) return;

        container.innerHTML = '<div style="color:#e2e8f0; font-size: 13px;">Cargando...</div>';
        try {
          const { data, error } = await window.supabaseClient
            .from('solicitudes_mantenimiento')
            .select('id, numero_solicitud, responsable, fecha, estado')
            .order('fecha', { ascending: false });

          if (error) throw error;
          if (!data || data.length === 0) {
            container.innerHTML = '<div style="color:#e2e8f0; font-size: 13px;">No hay solicitudes registradas.</div>';
            return;
          }

          const html = data.map(s => {
            const estadoRaw = (s.estado || 'pendiente').toLowerCase();
            const completado = estadoRaw === 'completado';
            const estadoText = completado ? 'Completado' : 'Pendiente';
            const estadoColor = completado ? '#22c55e' : '#ca8a04';

            return `
              <div style="border:1px solid #0f172a; border-radius:10px; padding:10px; display:flex; justify-content:space-between; align-items:center; gap:8px; background: rgba(15,23,42,0.14); color:#e2e8f0;">
                <div style="flex:1;">
                  <div style="font-weight:700; color:#f8fafc; font-size:13px;">${s.numero_solicitud}</div>
                  <div style="color:#e2e8f0; font-size:12px;">${s.responsable || 'Sin responsable'}</div>
                  <div style="color:#cbd5e1; font-size:11px;">${s.fecha || ''}</div>
                </div>
                <div style="display:flex; flex-direction:column; gap:4px; align-items:flex-end;">
                  <span style="background:${estadoColor}22; color:${estadoColor}; padding:3px 8px; border-radius:12px; font-size:11px; font-weight:700;">${estadoText}</span>
                  <div style="display:flex; gap:6px;">
                    ${completado ? '' : `<button class="fab-list-btn" data-id="${s.id}" data-numero="${s.numero_solicitud}" data-action="edit" style="padding:5px 8px; font-size:11px; background:#1d4ed8; color:white; border:none; border-radius:6px; cursor:pointer;">Editar</button>`}
                    <button class="fab-list-btn" data-id="${s.id}" data-numero="${s.numero_solicitud}" data-action="print" style="padding:5px 8px; font-size:11px; background:#0f766e; color:white; border:none; border-radius:6px; cursor:pointer;">Reimprimir</button>
                  </div>
                </div>
              </div>
            `;
          }).join('');

          container.innerHTML = html;

          container.querySelectorAll('.fab-list-btn').forEach(btn => {
            btn.addEventListener('click', async (e) => {
              const id = e.currentTarget.dataset.id;
              const numero = e.currentTarget.dataset.numero;
              const action = e.currentTarget.dataset.action;
              if (action === 'edit') {
                await abrirModalFinalizarPendiente(id, numero);
              } else if (action === 'print') {
                await reimprimirFacturaMantenimiento(id, numero);
              }
            });
          });

        } catch (err) {
          console.error('Error al cargar solicitudes:', err);
          container.innerHTML = '<div style="color:#ef4444; font-size:13px;">Error al cargar la lista.</div>';
        }
      }

      async function abrirModalFinalizarPendiente(solicitudId, numeroSolicitud) {
        try {
          const { data: consumidos, error: errCons } = await window.supabaseClient
            .from('materiales_consumidos_mantenimiento')
            .select('*')
            .eq('solicitud_id', solicitudId);
          if (errCons) throw errCons;

          const { data: mantenimientos, error: errMant } = await window.supabaseClient
            .from('materiales_mantenimiento')
            .select('*')
            .eq('solicitud_id', solicitudId);
          if (errMant) throw errMant;

          editingSolicitudId = solicitudId;
          editingNumeroSolicitud = numeroSolicitud;
          editingSolicitudEstado = 'pendiente';

          mostrarModalProcesamiento(consumidos || [], mantenimientos || [], numeroSolicitud, true);
        } catch (err) {
          console.error('Error al abrir solicitud pendiente:', err);
          alert('No se pudo abrir la solicitud pendiente: ' + (err.message || err));
        }
      }

      async function reimprimirFacturaMantenimiento(solicitudId, numeroSolicitud) {
        try {
          const { data: solicitud, error: errSol } = await window.supabaseClient
            .from('solicitudes_mantenimiento')
            .select('numero_solicitud, responsable, fecha, estado')
            .eq('id', solicitudId)
            .maybeSingle();
          if (errSol) throw errSol;

          const { data: consumidos, error: errCons } = await window.supabaseClient
            .from('materiales_consumidos_mantenimiento')
            .select('*')
            .eq('solicitud_id', solicitudId);
          if (errCons) throw errCons;

          const { data: mantenimientos, error: errMant } = await window.supabaseClient
            .from('materiales_mantenimiento')
            .select('*')
            .eq('solicitud_id', solicitudId);
          if (errMant) throw errMant;

          const safeNumero = solicitud?.numero_solicitud || numeroSolicitud || 'Factura';
          const safeResponsable = solicitud?.responsable || 'Sin responsable';
          const safeFecha = solicitud?.fecha || '';
          const estadoText = ((solicitud?.estado || '').toLowerCase() === 'completado') ? 'Procesado' : 'Pendiente';

          let subtotalConsumidos = 0;
          (consumidos || []).forEach(it => {
            const pu = Number(it.precio || it.precio_promedio) || 0;
            const cantidad = Number(it.cantidad) || 0;
            subtotalConsumidos += (pu * cantidad);
          });

          let subtotalMantenimientoBase = 0;
          let totalManoObra = 0;
          let totalCantidadMantenimiento = 0;
          (mantenimientos || []).forEach(it => {
            const pu = Number(it.precio || it.precio_promedio) || 0;
            const cantidad = Number(it.cantidad) || 0;
            subtotalMantenimientoBase += (pu * cantidad);
            totalManoObra += Number(it.mano_obra) || 0;
            totalCantidadMantenimiento += cantidad;
          });

          const totalGeneral = subtotalConsumidos + subtotalMantenimientoBase + totalManoObra;
          const precioUnitarioFinal = totalCantidadMantenimiento > 0 ? (totalGeneral / totalCantidadMantenimiento) : 0;

          const contenido = `
            <div style="width: 180mm; font-family: Arial, sans-serif; color: #333; font-size: 10pt;">
              <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10pt; border-bottom: 2px solid #c2410c; padding-bottom: 6pt;">
                <img src="assets/logo.png" alt="Logo" style="height: 20mm; margin-right: 8mm;">
                <div style="text-align: center; flex: 1;">
                  <h1 style="color: #c2410c; margin: 0; font-size: 16pt;">FACTURA DE MANTENIMIENTO</h1>
                  <p style="margin: 3pt 0 0 0; color: #555; font-size: 9pt;">Solicitud de Mantenimiento</p>
                </div>
                <div style="text-align: right;">
                  <div style="font-size: 24pt; font-weight: bold; color: #c2410c; letter-spacing: 1px;">${safeNumero}</div>
                  <div style="font-size: 9pt; color: #777;">Fecha: ${safeFecha}</div>
                </div>
              </div>

              <div style="background: #fff3cd; padding: 8pt; border-radius: 4pt; margin-bottom: 12pt; font-size: 9pt; border: 1px solid #fde047;">
                <p><strong>Responsable:</strong> ${safeResponsable}</p>
                <p><strong>Estado:</strong> ${estadoText}</p>
              </div>

              ${(consumidos || []).length > 0 ? `
              <h3 style="color: #dc2626; margin: 12pt 0 6pt 0; font-size: 12pt; border-bottom: 1px solid #ccc; padding-bottom: 3pt;">Materiales Consumidos (Baja)</h3>
              <table style="width: 100%; border-collapse: collapse; font-size: 9pt;">
                <thead>
                  <tr style="background: #dc2626; color: black;">
                    <th style="padding: 6pt; border: 1px solid #ddd; text-align: left;">C√≥digo</th>
                    <th style="padding: 6pt; border: 1px solid #ddd; text-align: left;">Nombre</th>
                    <th style="padding: 6pt; border: 1px solid #ddd; text-align: center;">Cantidad</th>
                    <th style="padding: 6pt; border: 1px solid #ddd; text-align: right;">P.U.</th>
                    <th style="padding: 6pt; border: 1px solid #ddd; text-align: right;">Subtotal</th>
                    <th style="padding: 6pt; border: 1px solid #ddd; text-align: left;">Observaci√≥n</th>
                  </tr>
                </thead>
                <tbody>
                  ${(consumidos || []).map(item => {
                    const precio = Number(item.precio_base || item.precio || item.precio_promedio) || 0;
                    const cantidad = Number(item.cantidad) || 0;
                    const subtotal = precio * cantidad;
                    return `
                    <tr style="font-size: 9pt;">
                      <td style="padding: 6pt; border: 1px solid #ddd;">${item.material_codigo || ''}</td>
                      <td style="padding: 6pt; border: 1px solid #ddd;">${item.material_nombre || ''}</td>
                      <td style="padding: 6pt; border: 1px solid #ddd; text-align: center;">${cantidad}</td>
                      <td style="padding: 6pt; border: 1px solid #ddd; text-align: right;">$${precio.toFixed(2)}</td>
                      <td style="padding: 6pt; border: 1px solid #ddd; text-align: right;">$${subtotal.toFixed(2)}</td>
                      <td style="padding: 6pt; border: 1px solid #ddd;">${item.observaciones || item.observacion || ''}</td>
                    </tr>
                    `;
                  }).join('')}
                  <tr style="background: #fee2e2;">
                    <td colspan="4" style="padding: 6pt; border: 1px solid #ddd; text-align: right; font-weight: bold;">SUBTOTAL CONSUMIDOS</td>
                    <td style="padding: 6pt; border: 1px solid #ddd; text-align: right; font-weight: bold; color: #dc2626;">$${subtotalConsumidos.toFixed(2)}</td>
                    <td style="padding: 6pt; border: 1px solid #ddd;"></td>
                  </tr>
                </tbody>
              </table>
              ` : ''}

              ${(mantenimientos || []).length > 0 ? `
              <h3 style="color: #059669; margin: 12pt 0 6pt 0; font-size: 12pt; border-bottom: 1px solid #ccc; padding-bottom: 3pt; margin-top: 20pt;">Materiales en Mantenimiento</h3>
              <table style="width: 100%; border-collapse: collapse; font-size: 9pt;">
                <thead>
                  <tr style="background: #059669; color: black;">
                    <th style="padding: 6pt; border: 1px solid #ddd; text-align: left;">C√≥digo</th>
                    <th style="padding: 6pt; border: 1px solid #ddd; text-align: left;">Nombre</th>
                    <th style="padding: 6pt; border: 1px solid #ddd; text-align: center;">Cantidad</th>
                    <th style="padding: 6pt; border: 1px solid #ddd; text-align: right;">P.U. Base</th>
                    <th style="padding: 6pt; border: 1px solid #ddd; text-align: right;">Mano Obra</th>
                    <th style="padding: 6pt; border: 1px solid #ddd; text-align: left;">Observaci√≥n</th>
                  </tr>
                </thead>
                <tbody>
                  ${(mantenimientos || []).map(item => {
                    const precio = Number(item.precio_base || item.precio || item.precio_promedio) || 0;
                    const cantidad = Number(item.cantidad) || 0;
                    const mano = Number(item.mano_obra) || 0;
                    return `
                    <tr style="font-size: 9pt;">
                      <td style="padding: 6pt; border: 1px solid #ddd;">${item.material_codigo || ''}</td>
                      <td style="padding: 6pt; border: 1px solid #ddd;">${item.material_nombre || ''}</td>
                      <td style="padding: 6pt; border: 1px solid #ddd; text-align: center;">${cantidad}</td>
                      <td style="padding: 6pt; border: 1px solid #ddd; text-align: right;">$${precio.toFixed(2)}</td>
                      <td style="padding: 6pt; border: 1px solid #ddd; text-align: right;">$${mano.toFixed(2)}</td>
                      <td style="padding: 6pt; border: 1px solid #ddd;">${item.observaciones || item.observacion || ''}</td>
                    </tr>
                    `;
                  }).join('')}
                </tbody>
              </table>
              ` : ''}

              <div style="margin-top: 20pt; background: #f8fafc; padding: 12pt; border-radius: 8px; border: 1px solid #e2e8f0;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 8pt;">
                  <span style="font-weight: bold; color: #64748b;">Subtotal Consumidos:</span>
                  <span style="font-weight: bold; color: #dc2626;">$${subtotalConsumidos.toFixed(2)}</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 8pt;">
                  <span style="font-weight: bold; color: #64748b;">Subtotal Mantenimiento (base):</span>
                  <span style="font-weight: bold; color: #059669;">$${subtotalMantenimientoBase.toFixed(2)}</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 8pt;">
                  <span style="font-weight: bold; color: #64748b;">Mano de Obra:</span>
                  <span style="font-weight: bold; color: #c2410c;">$${totalManoObra.toFixed(2)}</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-top: 12pt; padding-top: 12pt; border-top: 2px solid #c2410c;">
                  <span style="font-size: 14pt; font-weight: 800; color: #c2410c;">TOTAL FACTURA:</span>
                  <span style="font-size: 16pt; font-weight: 800; color: #c2410c;">$${totalGeneral.toFixed(2)}</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-top: 8pt;">
                  <span style="font-weight: 700; color: #64748b;">Precio Unitario Final Referencial:</span>
                  <span style="font-weight: 800; color: #0f766e;">$${precioUnitarioFinal.toFixed(2)}</span>
                </div>
              </div>
            </div>
          `;

          const fullHtml = `
            <html>
            <head>
              <title>Factura ${safeNumero}</title>
              <style>
                body { font-family: Arial, sans-serif; padding: 20px; color: #111827; }
                table { width: 100%; border-collapse: collapse; margin-top: 12px; }
                th, td { border: 1px solid #d1d5db; padding: 8px; text-align: left; font-size: 12px; }
                th { background: #f3f4f6; }
                p { margin: 4px 0; }
              </style>
            </head>
            <body>
              ${contenido}
            </body>
            </html>
          `;

          const useElectron = window.electronAPI && typeof window.electronAPI.renderHtmlToPdf === 'function';
          if (!useElectron) {
            alert('No est√° disponible la API nativa de PDF de Electron en este entorno.');
            return;
          }

          const filename = `Factura_Mantenimiento_${safeNumero}.pdf`;
          const result = await window.electronAPI.renderHtmlToPdf({
            filename,
            html: fullHtml,
            baseUrl: document.baseURI
          });

          if (!result || result.canceled) {
            return;
          }
        } catch (err) {
          console.error('Error al reimprimir factura:', err);
          alert('No se pudo reimprimir la factura: ' + (err.message || err));
        }
      }

      // =============================================================================
      // üîπ AGREGAR MATERIALES A LAS LISTAS
      // =============================================================================
      async function agregarMaterialAConsumidos(material) {
        if ((material.existencia || 0) <= 0) {
          alert('‚ö†Ô∏è No se puede consumir un material con existencia 0 o negativa.');
          return;
        }
        if (estado.itemsConsumidos.some(item => item.codigo === material.codigo)) {
          alert('‚ö†Ô∏è Este material ya est√° en la lista de consumidos.');
          return;
        }
        estado.itemsConsumidos.push({
          codigo: material.codigo,
          nombre: material.nombre,
          existencia: material.existencia || 0,
          precio_promedio: material.precio_promedio || 0,
          cantidad: 1,
          observacion: ''
        });
        renderTablaConsumidos();
      }

      function agregarMaterialAMantenimiento(material) {
        if ((material.existencia || 0) <= 0) {
          alert('‚ö†Ô∏è No se puede mantener un material con existencia 0 o negativa.');
          return;
        }
        if (estado.itemsMantenimiento.some(item => item.codigo === material.codigo)) {
          alert('‚ö†Ô∏è Este material ya est√° en la lista de mantenimiento.');
          return;
        }
        
        estado.itemsMantenimiento.push({
          codigo: material.codigo,
          nombre: material.nombre,
          existencia: material.existencia || 0,
          precio_promedio: material.precio_promedio || 0,
          cantidad: 1,
          mano_obra: 0,
          observacion: ''
        });
        renderTablaMantenimiento();
      }

      // =============================================================================
      // üîπ RENDERIZADO DE TABLAS
      // =============================================================================
      function renderTablaConsumidos() {
        const contenedor = document.getElementById('tabla-consumidos');
        contenedor.innerHTML = estado.itemsConsumidos.length > 0
          ? '<div id="filas-consumidos"></div>'
          : '<p style="text-align: center; color: #999; margin: 20px 0;">Agregue materiales consumidos.</p>';

        if (estado.itemsConsumidos.length === 0) return;

        const tbody = document.getElementById('filas-consumidos');
        estado.itemsConsumidos.forEach((item, index) => {
          const row = document.createElement('div');
          row.className = 'mov-table-row';
          row.innerHTML = `
            <div class="mov-table-col" style="flex: 1.2;">
              <label class="mnt-etiqueta" style="margin-bottom: 4px;">C√≥digo</label>
              <input type="text" class="mnt-entrada" value="${item.codigo}" readonly />
            </div>
            <div class="mov-table-col" style="flex: 2.5;">
              <label class="mnt-etiqueta" style="margin-bottom: 4px;">Nombre</label>
              <input type="text" class="mnt-entrada" value="${item.nombre}" readonly />
            </div>
            <div class="mov-table-col" style="flex: 0.8; text-align: center;">
              <label class="mnt-etiqueta" style="margin-bottom: 4px;">Existencia</label>
              <input type="number" class="mnt-entrada" value="${item.existencia}" readonly style="background: #f0fdf4; color: #047857;" />
            </div>
            <div class="mov-table-col" style="flex: 1; text-align: center;">
              <label class="mnt-etiqueta" style="margin-bottom: 4px;">Precio prom. ingreso</label>
              <input type="text" class="mnt-entrada" value="${formatearPrecio(item.precio_promedio)}" readonly style="background: #fff7ed; color: #b45309; text-align: center;" />
            </div>
            <div class="mov-table-col" style="flex: 0.8; text-align: center;">
              <label class="mnt-etiqueta" style="margin-bottom: 4px;">Cantidad</label>
              <input type="number" class="mnt-entrada" value="${item.cantidad}" min="1" data-index="${index}" data-tipo="consumido" />
            </div>
            <div class="mov-table-col" style="flex: 1.5;">
              <label class="mnt-etiqueta" style="margin-bottom: 4px;">Observaci√≥n</label>
              <input type="text" class="mnt-entrada" value="${item.observacion}" data-index="${index}" data-tipo="consumido" />
            </div>
            <div class="mov-table-col" style="flex: 0.2; text-align: center;">
              <label class="mnt-etiqueta" style="margin-bottom: 4px;">&nbsp;</label>
              <button class="mnt-boton mnt-boton-peligro" style="padding: 4px 8px; font-size: 12px;" data-index="${index}" data-tipo="consumido">‚úï</button>
            </div>
          `;

          row.querySelectorAll('input[data-tipo="consumido"]').forEach(input => {
            input.addEventListener('input', (e) => {
              const idx = parseInt(e.target.dataset.index);
              if (e.target.type === 'number') {
                estado.itemsConsumidos[idx].cantidad = parseInt(e.target.value) || 0;
              } else {
                estado.itemsConsumidos[idx].observacion = e.target.value;
              }
            });
          });

          row.querySelector('button').addEventListener('click', (e) => {
            const idx = parseInt(e.target.dataset.index);
            estado.itemsConsumidos.splice(idx, 1);
            renderTablaConsumidos();
          });

          tbody.appendChild(row);
        });
      }

      function renderTablaMantenimiento() {
        const contenedor = document.getElementById('tabla-mantenimiento');
        contenedor.innerHTML = estado.itemsMantenimiento.length > 0
          ? '<div id="filas-mantenimiento"></div>'
          : '<p style="text-align: center; color: #999; margin: 20px 0;">Agregue el material en mantenimiento.</p>';

        if (estado.itemsMantenimiento.length === 0) return;

        const tbody = document.getElementById('filas-mantenimiento');
        estado.itemsMantenimiento.forEach((item, index) => {
          const row = document.createElement('div');
          row.className = 'mov-table-row';
          row.innerHTML = `
            <div class="mov-table-col" style="flex: 1.2;">
              <label class="mnt-etiqueta" style="margin-bottom: 4px;">C√≥digo</label>
              <input type="text" class="mnt-entrada" value="${item.codigo}" readonly />
            </div>
            <div class="mov-table-col" style="flex: 2.5;">
              <label class="mnt-etiqueta" style="margin-bottom: 4px;">Nombre</label>
              <input type="text" class="mnt-entrada" value="${item.nombre}" readonly />
            </div>
            <div class="mov-table-col" style="flex: 0.8; text-align: center;">
              <label class="mnt-etiqueta" style="margin-bottom: 4px;">Existencia</label>
              <input type="number" class="mnt-entrada" value="${item.existencia}" readonly style="background: #f0fdf4; color: #047857;" />
            </div>
            <div class="mov-table-col" style="flex: 1; text-align: center;">
              <label class="mnt-etiqueta" style="margin-bottom: 4px;">Precio prom. ingreso</label>
              <input type="text" class="mnt-entrada" value="${formatearPrecio(item.precio_promedio)}" readonly style="background: #fff7ed; color: #b45309; text-align: center;" />
            </div>
            <div class="mov-table-col" style="flex: 0.8; text-align: center;">
              <label class="mnt-etiqueta" style="margin-bottom: 4px;">Cantidad</label>
              <input type="number" class="mnt-entrada" value="${item.cantidad}" min="1" data-index="${index}" data-tipo="mantenimiento" data-field="cantidad" />
            </div>
            <div class="mov-table-col" style="flex: 1;">
              <label class="mnt-etiqueta" style="margin-bottom: 4px;">Mano de obra</label>
              <input type="number" class="mnt-entrada" value="${item.mano_obra}" min="0" step="0.01" data-index="${index}" data-tipo="mantenimiento" data-field="mano_obra" />
            </div>
            <div class="mov-table-col" style="flex: 1.5;">
              <label class="mnt-etiqueta" style="margin-bottom: 4px;">Observaci√≥n</label>
              <input type="text" class="mnt-entrada" value="${item.observacion}" data-index="${index}" data-tipo="mantenimiento" data-field="observacion" />
            </div>
            <div class="mov-table-col" style="flex: 0.2; text-align: center;">
              <label class="mnt-etiqueta" style="margin-bottom: 4px;">&nbsp;</label>
              <button class="mnt-boton mnt-boton-peligro" style="padding: 4px 8px; font-size: 12px;" data-index="${index}" data-tipo="mantenimiento">‚úï</button>
            </div>
          `;

          row.querySelectorAll('input[data-tipo="mantenimiento"]').forEach(input => {
            input.addEventListener('input', (e) => {
              const idx = parseInt(e.target.dataset.index);
              const field = e.target.dataset.field;
              if (field === 'mano_obra') {
                estado.itemsMantenimiento[idx].mano_obra = parseFloat(e.target.value) || 0;
              } else if (field === 'cantidad') {
                estado.itemsMantenimiento[idx].cantidad = parseInt(e.target.value) || 0;
              } else if (field === 'observacion') {
                estado.itemsMantenimiento[idx].observacion = e.target.value;
              }
            });
          });

          row.querySelector('button').addEventListener('click', (e) => {
            const idx = parseInt(e.target.dataset.index);
            estado.itemsMantenimiento.splice(idx, 1);
            renderTablaMantenimiento();
          });

          tbody.appendChild(row);
        });
      }

      // =============================================================================
      // üîπ GENERAR N√öMERO DE SOLICITUD
      // =============================================================================
      async function generarNumeroSolicitud() {
        try {
          const { data, error } = await window.supabaseClient
            .from('solicitudes_mantenimiento')
            .select('numero_solicitud', { count: 'exact' })
            .order('numero_solicitud', { ascending: false })
            .limit(1);

          if (error) throw error;
          const ultimo = data?.[0]?.numero_solicitud || 'MNT-00000';
          const match = ultimo.match(/MNT-(\d+)$/);
          const nuevoNumero = match ? parseInt(match[1], 10) + 1 : 1;
          return `MNT-${String(nuevoNumero).padStart(5, '0')}`;
        } catch (err) {
          console.warn('Error al generar n√∫mero de solicitud:', err);
          return `MNT-${Date.now().toString().slice(-5)}`;
        }
      }

      // =============================================================================
      // üîπ CARGAR SOLICITUD PARA EDICI√ìN
      // =============================================================================
      async function cargarSolicitudParaEdicion(id, numero, estadoActual) {
        try {
          const { data: solicitud, error: errSol } = await window.supabaseClient
            .from('solicitudes_mantenimiento')
            .select('*')
            .eq('id', id)
            .single();
          if (errSol) throw errSol;

          const { data: consumidos, error: errCons } = await window.supabaseClient
            .from('materiales_consumidos_mantenimiento')
            .select('material_codigo, cantidad, observaciones')
            .eq('solicitud_id', id);
          if (errCons) throw errCons;

          const { data: mantenimiento, error: errMant } = await window.supabaseClient
            .from('materiales_mantenimiento')
            .select('material_codigo, cantidad, mano_obra, observaciones')
            .eq('solicitud_id', id);
          if (errMant) throw errMant;

          const codigosCatalogo = Array.from(new Set([
            ...(consumidos || []).map(c => c.material_codigo),
            ...(mantenimiento || []).map(m => m.material_codigo)
          ].filter(Boolean)));

          let stockMap = new Map();
          if (codigosCatalogo.length > 0) {
            const tablasStock = ['stock_hierros', 'stock_audiovisual', 'stock_consumibles'];
            let stockData = [];
            
            for (const tabla of tablasStock) {
              try {
                let query = window.supabaseClient
                  .from(tabla)
                  .select('material_codigo, material_nombre, bodega_principal, stock_actual, precio');
                if (codigosCatalogo.length === 1) {
                  query = query.eq('material_codigo', codigosCatalogo[0]);
                } else {
                  query = query.in('material_codigo', codigosCatalogo);
                }
                const { data, error } = await query;
                if (!error && data) {
                  stockData = stockData.concat(data);
                }
              } catch (e) {
                console.warn(`Error consultando ${tabla}:`, e.message || e);
                continue;
              }
            }
            
            (stockData || []).forEach(s => stockMap.set(s.material_codigo, {
              nombre: s.material_nombre,
              bodega_principal: s.bodega_principal,
              existencia: s.stock_actual || 0,
              precio_promedio: s.precio || 0
            }));
          }

          estado.itemsConsumidos = (consumidos || []).map(c => ({
            codigo: c.material_codigo,
            nombre: stockMap.get(c.material_codigo)?.nombre || 'Sin nombre',
            existencia: stockMap.get(c.material_codigo)?.existencia ?? 0,
            precio_promedio: stockMap.get(c.material_codigo)?.precio_promedio ?? 0,
            cantidad: c.cantidad,
            observacion: c.observaciones || c.observacion || ''
          }));

          estado.itemsMantenimiento = (mantenimiento || []).map(m => ({
            codigo: m.material_codigo,
            nombre: stockMap.get(m.material_codigo)?.nombre || 'Sin nombre',
            existencia: stockMap.get(m.material_codigo)?.existencia ?? 0,
            precio_promedio: stockMap.get(m.material_codigo)?.precio_promedio ?? 0,
            cantidad: m.cantidad,
            mano_obra: m.mano_obra || 0,
            observacion: m.observaciones || m.observacion || ''
          }));

          editingSolicitudId = id;
          editingNumeroSolicitud = numero;
          editingSolicitudEstado = estadoActual || solicitud.estado || 'pendiente';

          document.getElementById('responsable-manufactura').value = solicitud.responsable || '';
          document.getElementById('fecha-manufactura').value = solicitud.fecha || new Date().toISOString().split('T')[0];

          renderTablaConsumidos();
          renderTablaMantenimiento();
          alert(`Editando solicitud ${numero}`);
        } catch (err) {
          console.error('Error al cargar solicitud:', err);
          alert('No se pudo cargar la solicitud para edici√≥n: ' + err.message);
        }
      }

      // =============================================================================
      // üîπ ELIMINAR SOLICITUD
      // =============================================================================
      async function eliminarSolicitud(id, numero, estadoActual) {
        const estadoLower = (estadoActual || '').toLowerCase();
        if (estadoLower === 'completado') {
          alert('No puede eliminar un mantenimiento completado.');
          return;
        }
        if (!confirm(`¬øEliminar el mantenimiento ${numero}?`)) return;
        try {
          await window.supabaseClient
            .from('materiales_consumidos_mantenimiento')
            .delete()
            .eq('solicitud_id', id);

          await window.supabaseClient
            .from('materiales_mantenimiento')
            .delete()
            .eq('solicitud_id', id);

          await window.supabaseClient
            .from('solicitudes_mantenimiento')
            .delete()
            .eq('id', id);

          if (editingSolicitudId === id) {
            estado = { itemsConsumidos: [], itemsMantenimiento: [], datosFormulario: {}, pdfData: null };
            editingSolicitudId = null;
            editingSolicitudEstado = null;
            editingNumeroSolicitud = null;
            renderTablaConsumidos();
            renderTablaMantenimiento();
          }

          await cargarSolicitudesList();
          alert(`Mantenimiento ${numero} eliminado`);
        } catch (err) {
          console.error('Error al eliminar mantenimiento:', err);
          alert('No se pudo eliminar el mantenimiento: ' + err.message);
        }
      }

      // =============================================================================
      // üîπ GUARDAR SOLICITUD EN SUPABASE
      // =============================================================================
      async function guardarFabricacion() {
        const btnGuardar = document.getElementById('btn-guardar-fabricacion');
        btnGuardar.disabled = true;
        btnGuardar.textContent = 'Registrando...';

        const responsable = document.getElementById('responsable-manufactura').value;
        const fecha = document.getElementById('fecha-manufactura').value;

        if (!responsable || !fecha) {
          alert('‚ö†Ô∏è Complete todos los campos obligatorios.');
          btnGuardar.disabled = false;
          btnGuardar.textContent = 'Registrar Mantenimiento';
          return;
        }

        const itemsConsumidosValidos = estado.itemsConsumidos
          .filter(item => item.codigo && (item.cantidad || 0) > 0)
          .map(item => ({
            ...item,
            precio_promedio: item.precio_promedio ?? 0
          }));
        const itemsMantenimientoValidos = estado.itemsMantenimiento.filter(item => item.codigo && item.nombre && (item.cantidad || 0) > 0);

        if (itemsConsumidosValidos.length === 0 && itemsMantenimientoValidos.length === 0) {
          alert('‚ö†Ô∏è Agregue al menos un material consumido o en mantenimiento.');
          return;
        }

        try {
          const esEdicion = Boolean(editingSolicitudId);

          if (esEdicion && editingSolicitudEstado.toLowerCase() === 'completado') {
            alert('No puede editar un mantenimiento completado.');
            return;
          }

          // Validar stock suficiente para consumidos y mantenimiento
          const codigosMateriales = [
            ...itemsConsumidosValidos.map(i => i.codigo),
            ...itemsMantenimientoValidos.map(i => i.codigo)
          ].filter(Boolean);
          
          if (codigosMateriales.length > 0) {
            const tablasStock = ['stock_hierros', 'stock_audiovisual', 'stock_consumibles'];
            let stockRows = [];
            
            for (const tabla of tablasStock) {
              try {
                let query = window.supabaseClient
                  .from(tabla)
                  .select('material_codigo, stock_actual');
                if (codigosMateriales.length === 1) {
                  query = query.eq('material_codigo', codigosMateriales[0]);
                } else {
                  query = query.in('material_codigo', codigosMateriales);
                }
                const { data, error } = await query;
                if (!error && data) {
                  stockRows = stockRows.concat(data);
                }
              } catch (e) {
                console.warn(`Error consultando ${tabla}:`, e.message || e);
                continue;
              }
            }

            const stockMap = new Map();
            (stockRows || []).forEach(row => {
              stockMap.set(row.material_codigo, row.stock_actual || 0);
            });

            for (const item of [...itemsConsumidosValidos, ...itemsMantenimientoValidos]) {
              const existencia = stockMap.get(item.codigo) ?? 0;
              if (existencia < item.cantidad) {
                alert(`‚ö†Ô∏è No hay suficiente stock para ${item.nombre}.`);
                return;
              }
            }
          }

          let numeroSolicitud = editingNumeroSolicitud;
          let solicitudId = editingSolicitudId;

          if (!esEdicion) {
            numeroSolicitud = await generarNumeroSolicitud();
            const { data: solicitud, error: errSolicitud } = await window.supabaseClient
              .from('solicitudes_mantenimiento')
              .insert([{
                numero_solicitud: numeroSolicitud,
                responsable: responsable,
                fecha: fecha,
                estado: 'pendiente',
                observaciones: 'Solicitud de mantenimiento con materiales consumidos y en mantenimiento'
              }])
              .select('id');

            if (errSolicitud) throw errSolicitud;
            solicitudId = solicitud?.[0]?.id;
          } else {
            const { error: errUpdate } = await window.supabaseClient
              .from('solicitudes_mantenimiento')
              .update({
                responsable,
                fecha,
                estado: editingSolicitudEstado
              })
              .eq('id', editingSolicitudId);
            if (errUpdate) throw errUpdate;

            await window.supabaseClient
              .from('materiales_consumidos_mantenimiento')
              .delete()
              .eq('solicitud_id', editingSolicitudId);
            await window.supabaseClient
              .from('materiales_mantenimiento')
              .delete()
              .eq('solicitud_id', editingSolicitudId);
          }

          if (!solicitudId) {
            throw new Error('No se pudo obtener el ID de la solicitud.');
          }

          // Obtener info adicional de stock para los materiales
          const materialCodes = [
            ...itemsConsumidosValidos.map(i => i.codigo),
            ...itemsMantenimientoValidos.map(i => i.codigo)
          ].filter(Boolean);
          
          let stockMap = new Map();
          if (materialCodes.length > 0) {
            const tablasStock = ['stock_hierros', 'stock_audiovisual', 'stock_consumibles'];
            
            for (const tabla of tablasStock) {
              try {
                let query = window.supabaseClient
                  .from(tabla)
                  .select('material_codigo, material_nombre, bodega_principal, bodega_secundaria, precio');
                if (materialCodes.length === 1) {
                  query = query.eq('material_codigo', materialCodes[0]);
                } else {
                  query = query.in('material_codigo', materialCodes);
                }
                const { data, error } = await query;
                if (!error && data) {
                  data.forEach(s => stockMap.set(s.material_codigo, {
                    nombre: s.material_nombre,
                    bodega_principal: s.bodega_principal,
                    bodega_secundaria: s.bodega_secundaria,
                    precio: s.precio || 0
                  }));
                }
              } catch (e) {
                console.warn(`Error consultando ${tabla}:`, e.message || e);
                continue;
              }
            }
          }

          // Guardar materiales consumidos
          if (itemsConsumidosValidos.length > 0) {
            const itemsConsumidos = itemsConsumidosValidos.map(item => {
              const info = stockMap.get(item.codigo) || {};
              return {
                solicitud_id: solicitudId,
                material_codigo: item.codigo,
                material_nombre: info.nombre || item.nombre,
                bodega_principal: info.bodega_principal || 'Principal',
                bodega_secundaria: info.bodega_secundaria || 'General',
                tipo_movimiento: 'baja',
                cantidad: item.cantidad,
                signo: -1,
                referencia_documento: numeroSolicitud,
                referencia_tipo: 'mantenimiento',
                responsable: responsable,
                fecha_movimiento: fecha,
                observaciones: item.observacion || '',
                estado: 'completado',
                precio_base: item.precio_promedio,
                created_at: new Date().toISOString()
              };
            });

            const { error: errConsumidos } = await window.supabaseClient
              .from('materiales_consumidos_mantenimiento')
              .insert(itemsConsumidos);

            if (errConsumidos) throw errConsumidos;
          }

          // Guardar materiales en mantenimiento
          if (itemsMantenimientoValidos.length > 0) {
            const itemsMantenimiento = itemsMantenimientoValidos.map(item => {
              const info = stockMap.get(item.codigo) || {};
              return {
                solicitud_id: solicitudId,
                material_codigo: item.codigo,
                material_nombre: info.nombre || item.nombre,
                bodega_principal: info.bodega_principal || 'Principal',
                bodega_secundaria: info.bodega_secundaria || 'General',
                tipo_movimiento: 'mantenimiento',
                cantidad: item.cantidad,
                signo: -1,
                referencia_documento: numeroSolicitud,
                referencia_tipo: 'mantenimiento',
                responsable: responsable,
                fecha_movimiento: fecha,
                observaciones: item.observacion || '',
                estado: 'pendiente', // Pendiente hasta completar el mantenimiento
                precio_base: item.precio_promedio,
                mano_obra: item.mano_obra,
                created_at: new Date().toISOString()
              };
            });

            const { error: errMantenimiento } = await window.supabaseClient
              .from('materiales_mantenimiento')
              .insert(itemsMantenimiento);

            if (errMantenimiento) throw errMantenimiento;
          }

          // Mostrar modal con detalles
          mostrarModalMantenimiento(itemsMantenimientoValidos, numeroSolicitud);

          alert(esEdicion ? `‚úÖ Mantenimiento ${numeroSolicitud} actualizado.` : `‚úÖ Mantenimiento ${numeroSolicitud} registrado exitosamente.`);
          editingSolicitudId = solicitudId;
          editingNumeroSolicitud = numeroSolicitud;
          editingSolicitudEstado = 'pendiente';
          await cargarSolicitudesList();

        } catch (err) {
          console.error('Error al guardar mantenimiento:', err);
          alert('‚ùå Error al guardar: ' + err.message);
          btnGuardar.disabled = false;
          btnGuardar.textContent = 'Registrar Mantenimiento';
        }
      }

      // =============================================================================
      // üîπ MOSTRAR MODAL CON DETALLES DEL MANTENIMIENTO
      // =============================================================================
      function mostrarModalMantenimiento(itemsMantenimiento, numeroSolicitud) {
        const detallesDiv = document.getElementById('detalles-mantenimiento');
        if (itemsMantenimiento.length > 0) {
          let html = '<h3>Material en Mantenimiento</h3><table style="width:100%; border-collapse:collapse;">';
          html += '<tr><th>C√≥digo</th><th>Nombre</th><th>Cantidad</th><th>Precio Total</th><th>Mano de Obra</th><th>Total</th></tr>';
          itemsMantenimiento.forEach(item => {
            const precioTotal = (item.precio_promedio * item.cantidad).toFixed(2);
            const total = (parseFloat(precioTotal) + item.mano_obra).toFixed(2);
            html += `<tr><td>${item.codigo}</td><td>${item.nombre}</td><td>${item.cantidad}</td><td>$${precioTotal}</td><td>$${item.mano_obra.toFixed(2)}</td><td>$${total}</td></tr>`;
          });
          html += '</table>';
          detallesDiv.innerHTML = html;
        }
        document.getElementById('modal-fabricacion').style.display = 'flex';
      }

      // =============================================================================
      // üîπ PROCESAR MANTENIMIENTO (genera movimientos espejo en tablas de movimientos)
      // =============================================================================
      async function detectMovimientoTable(material) {
        // material puede ser un c√≥digo (string) o un objeto con metadatos
        try {
          // Si recibimos objeto, preferir datos expl√≠citos
          if (material && typeof material === 'object') {
            // Preferir tabla_origen
            if (material.tabla_origen) {
              if (material.tabla_origen.includes('audiovisual')) return { table: 'movimientos_bodega_audiovisual', reason: 'tabla_origen' };
              if (material.tabla_origen.includes('hierros')) return { table: 'movimientos_bodega_hierros', reason: 'tabla_origen' };
              if (material.tabla_origen.includes('consumibles')) return { table: 'movimientos_bodega_consumibles', reason: 'tabla_origen' };
            }
            // Preferir bodega_principal
            const bp = (material.bodega_principal || '').toString().toLowerCase();
            if (bp.includes('audiovisual')) return { table: 'movimientos_bodega_audiovisual', reason: 'bodega_principal' };
            if (bp.includes('hierros')) return { table: 'movimientos_bodega_hierros', reason: 'bodega_principal' };
            if (bp.includes('consumibles')) return { table: 'movimientos_bodega_consumibles', reason: 'bodega_principal' };
            // If the material row already has an explicit movimientos table name
            if (material.tabla_movimientos) return { table: material.tabla_movimientos, reason: 'tabla_movimientos' };
          }

          // Si no hay metadatos, intentar inferir por prefijo del c√≥digo
          const codigo = (typeof material === 'string') ? material : (material && (material.material_codigo || material.codigo)) || '';
          const pref = (codigo.split('-')[1] || '').toUpperCase();
          if (['HIE', 'HIER', 'HIERRO', 'HIERROS'].includes(pref) || codigo.toUpperCase().includes('HIER')) {
            return { table: 'movimientos_bodega_hierros', reason: 'codigo-prefijo' };
          }
          if (['AUD', 'AUDIO', 'AUDIOVISUAL'].includes(pref) || codigo.toUpperCase().includes('AUD')) {
            return { table: 'movimientos_bodega_audiovisual', reason: 'codigo-prefijo' };
          }

          // Respaldo: buscar en las vistas de stock (√∫ltimo recurso)
          let q = await window.supabaseClient.from('stock_audiovisual').select('material_codigo').eq('material_codigo', codigo).limit(1);
          if (q.data && q.data.length) return { table: 'movimientos_bodega_audiovisual', reason: 'vista-stock' };
          q = await window.supabaseClient.from('stock_hierros').select('material_codigo').eq('material_codigo', codigo).limit(1);
          if (q.data && q.data.length) return { table: 'movimientos_bodega_hierros', reason: 'vista-stock' };
          q = await window.supabaseClient.from('stock_consumibles').select('material_codigo').eq('material_codigo', codigo).limit(1);
          if (q.data && q.data.length) return { table: 'movimientos_bodega_consumibles', reason: 'vista-stock' };
        } catch (e) {
          console.warn('No se pudo detectar tabla de movimiento, usando consumibles por defecto', e);
        }
        return { table: 'movimientos_bodega_consumibles', reason: 'fallback' };
      }

      function renderFacturaHtml(itemsConsumidos, itemsMantenimiento, numeroSolicitud, editableMano = false) {
        // Debug: ensure mano_obra is visible
        console.debug('renderFacturaHtml inputs', { itemsConsumidos, itemsMantenimiento });
        let html = `<div style="color:#e6eef0;"><h3>Factura - ${numeroSolicitud}</h3>`;
        html += '<table class="factura-table">';
        html += '<thead><tr><th>C√≥digo</th><th>Nombre</th><th>Cantidad</th><th>Precio Unit.</th><th>Mano Obra</th><th>Subtotal</th></tr></thead><tbody>';
        let subtotalConsumidos = 0; let subtotalMantenimiento = 0; let totalManoObra = 0;
        (itemsConsumidos||[]).forEach(it => {
          const pu = Number(it.precio ?? it.precio_promedio) || 0;
          const cantidad = Number(it.cantidad) || 0;
          const sub = cantidad * pu;
          subtotalConsumidos += sub;
          html += `<tr><td>${it.material_codigo || it.codigo || ''}</td><td>${it.material_nombre || it.nombre || ''}</td><td>${cantidad}</td><td>$${pu.toFixed(2)}</td><td>$0.00</td><td>$${sub.toFixed(2)}</td></tr>`;
        });
        (itemsMantenimiento||[]).forEach((it, idx) => {
          const pu = Number(it.precio ?? it.precio_promedio) || 0;
          const cantidad = Number(it.cantidad) || 0;
          const mano = Number(it.mano_obra ?? it.manoobra ?? it.mano) || 0;
          const sub = cantidad * pu + mano;
          subtotalMantenimiento += (cantidad * pu);
          totalManoObra += mano;
          if (editableMano) {
            const inputId = `factura-mano-${idx}`;
            html += `<tr><td>${it.material_codigo || it.codigo || ''}</td><td>${it.material_nombre || it.nombre || ''}</td><td>${cantidad}</td><td>$${pu.toFixed(2)}</td><td><input id="${inputId}" class="mnt-entrada factura-mano" data-material="${it.material_codigo || it.codigo || ''}" data-id="${it.id || ''}" type="number" step="0.01" min="0" value="${mano.toFixed(2)}" style="width:100px;" /></td><td>$${sub.toFixed(2)}</td></tr>`;
          } else {
            html += `<tr><td>${it.material_codigo || it.codigo || ''}</td><td>${it.material_nombre || it.nombre || ''}</td><td>${cantidad}</td><td>$${pu.toFixed(2)}</td><td>$${mano.toFixed(2)}</td><td>$${sub.toFixed(2)}</td></tr>`;
          }
        });
        html += `</tbody></table>`;
        const total = subtotalConsumidos + subtotalMantenimiento + totalManoObra;
        html += `<div class="factura-total">Subtotal consumidos: $${subtotalConsumidos.toFixed(2)} ‚Äî Subtotal mantenimiento (sin mano de obra): $${subtotalMantenimiento.toFixed(2)} ‚Äî Mano de obra: $${totalManoObra.toFixed(2)} ‚Äî Total: $${total.toFixed(2)}</div>`;
        html += '</div>';
        return { html, subtotalConsumidos, subtotalMantenimiento, totalManoObra, total };
      }

      function mostrarModalProcesamiento(consumidos, mantenimientos, numero, soloFinalizar = false) {
        const factura = renderFacturaHtml(consumidos || [], mantenimientos || [], numero, true);
        const solicitudIdActual = editingSolicitudId || null;

        const wrapper = document.createElement('div');
        wrapper.className = 'mantenimiento-theme';
        const modal = document.createElement('div');
        modal.className = 'mnt-modal-overlay';
        modal.innerHTML = `
          <div class="mnt-modal-contenido">
            <h2 class="mnt-modal-titulo">Procesar Mantenimiento - ${numero}</h2>
            <div class="mnt-modal-texto">Revise la factura antes de continuar. El proceso realizar√° 3 pasos: (1) registrar la solicitud y bajas consumidos, (2) crear movimientos de mantenimiento, (3) marcar como reparado y devolver al stock.</div>
            <div id="factura-contenido">${factura.html}</div>
            <div id="procesos-mantenimiento" style="margin-top:12px; padding:10px; background: rgba(0,0,0,0.06); border-radius:8px;">
              <div style="font-weight:800; margin-bottom:6px; color:#e6eef0;">Progreso</div>
              <ol style="margin:0 0 8px 18px; color:#cfe9eb;">
                <li id="step-1" style="margin-bottom:6px;">1. Registrar solicitud y aplicar bajas consumidos <span id="step-1-status" style="font-weight:700; margin-left:8px; color:${soloFinalizar ? '#10b981' : '#94a3b8'};">${soloFinalizar ? '(completado)' : '(pendiente)'}</span></li>
                <li id="step-2" style="margin-bottom:6px;">2. Crear movimientos de mantenimiento <span id="step-2-status" style="font-weight:700; margin-left:8px; color:${soloFinalizar ? '#10b981' : '#94a3b8'};">${soloFinalizar ? '(completado)' : '(pendiente)'}</span></li>
                <li id="step-3" style="margin-bottom:6px;">3. Marcar como reparado (movimiento +1) <span id="step-3-status" style="font-weight:700; margin-left:8px; color:#94a3b8;">(pendiente)</span></li>
              </ol>
              <div id="procesos-error" style="color:#fca5a5; display:none; font-weight:700;"></div>
              <div id="procesos-log" style="margin-top:8px; max-height:140px; overflow:auto; color:#cfe9eb; font-size:12px;"></div>
            </div>
            <div class="mnt-modal-botones">
              <button id="btn-cancelar-procesar" class="mnt-boton mnt-boton-secundario">Cancelar</button>
              <button id="btn-registrar-y-procesar" class="mnt-boton" style="background:#10b981;border-color:#059669;color:white; font-weight:900;">Registrar y Procesar</button>
            </div>
          </div>`;
        wrapper.appendChild(modal);
        document.body.appendChild(wrapper);

        document.getElementById('btn-cancelar-procesar').addEventListener('click', () => { wrapper.remove(); });

        const btnRegistrar = document.getElementById('btn-registrar-y-procesar');
        if (btnRegistrar) {
          btnRegistrar.addEventListener('click', async () => {
            try {
              btnRegistrar.disabled = true;
              if (!solicitudIdActual) throw new Error('No existe solicitud para finalizar el proceso.');

              const manoInputs = wrapper.querySelectorAll('.factura-mano');
              for (const inp of manoInputs) {
                const val = parseFloat(inp.value) || 0;
                const mat = inp.dataset.material;
                const id = inp.dataset.id;
                if (id) {
                  await window.supabaseClient.from('materiales_mantenimiento').update({ mano_obra: val }).eq('id', id);
                } else {
                  await window.supabaseClient.from('materiales_mantenimiento').update({ mano_obra: val }).match({ solicitud_id: solicitudIdActual, material_codigo: mat });
                }
              }

              await registrarYProcesar(solicitudIdActual, numero);
              alert('Procesamiento completo');
              wrapper.remove();
              await cargarSolicitudesList();
            } catch (e) {
              console.error('Error registrar y procesar:', e);
              const errDiv = wrapper.querySelector('#procesos-error');
              if (errDiv) { errDiv.style.display = 'block'; errDiv.textContent = e.message || String(e); }
              btnRegistrar.disabled = false;
            }
          });
        }
      }

      async function procesarMantenimiento() {
        // Preparar items: si la solicitud ya fue guardada, los leemos desde DB; si no, usamos el estado en memoria
        let consumidos = [];
        let mantenimientos = [];
        let numero = editingNumeroSolicitud || '';

        if (editingSolicitudId) {
          const { data: c, error: errCons } = await window.supabaseClient.from('materiales_consumidos_mantenimiento').select('*').eq('solicitud_id', editingSolicitudId);
          if (errCons) throw errCons;
          consumidos = c || [];
          const { data: m, error: errMant } = await window.supabaseClient.from('materiales_mantenimiento').select('*').eq('solicitud_id', editingSolicitudId);
          if (errMant) throw errMant;
          mantenimientos = m || [];
          const solicitud = await window.supabaseClient.from('solicitudes_mantenimiento').select('numero_solicitud').eq('id', editingSolicitudId).maybeSingle();
          numero = solicitud.data?.numero_solicitud || numero;
        } else {
          // Si a√∫n no est√° guardada, guardamos primero para poder crear movimientos -1 correctamente
          await guardarFabricacion();
          // tras guardar, tomar los datos desde DB
          const sid = editingSolicitudId;
          if (!sid) throw new Error('No se pudo obtener id de la solicitud tras guardar.');
          const { data: c, error: errCons } = await window.supabaseClient.from('materiales_consumidos_mantenimiento').select('*').eq('solicitud_id', sid);
          if (errCons) throw errCons;
          consumidos = c || [];
          const { data: m, error: errMant } = await window.supabaseClient.from('materiales_mantenimiento').select('*').eq('solicitud_id', sid);
          if (errMant) throw errMant;
          mantenimientos = m || [];
          numero = editingNumeroSolicitud || numero;
        }

        // EJECUTAR PASO 2 AHORA: crear movimientos -1 y marcar consumidos como 'baja'
        try {
          await confirmarProcesarMantenimiento(editingSolicitudId || null, numero, consumidos || [], mantenimientos || []);
        } catch (e) {
          console.error('Error al ejecutar paso 2 (movimientos -1):', e);
          throw e;
        }

        // Abrir modal para paso 3
        mostrarModalProcesamiento(consumidos || [], mantenimientos || [], numero, true);
      }

      async function confirmarProcesarMantenimiento(solicitudId, numeroSolicitud, consumidos, mantenimientos) {
        for (const it of (consumidos || [])) {
          const code = it.material_codigo;
          const { table: tabla, reason } = await detectMovimientoTable(it);
          const logDiv = document.getElementById('procesos-log');
          if (logDiv) logDiv.insertAdjacentHTML('beforeend', `<div>Consumido ${code} ‚Üí ${tabla} (${reason})</div>`);
          const exist = await window.supabaseClient
            .from(tabla)
            .select('id')
            .eq('referencia_documento', numeroSolicitud)
            .eq('material_codigo', code)
            .in('tipo_movimiento', ['baja', 'salida'])
            .limit(1);
          if (exist.error) throw exist.error;
          if (!exist.data || exist.data.length === 0) {
            const movimiento = {
              material_codigo: it.material_codigo,
              material_nombre: it.material_nombre,
              bodega_principal: it.bodega_principal || 'Principal',
              bodega_secundaria: it.bodega_secundaria || 'General',
              ubicacion_nombre: it.ubicacion_nombre || it.ubicacion_codigo || 'Sin Contenedor',
              tipo_movimiento: 'baja',
              cantidad: it.cantidad,
              signo: -1,
              referencia_documento: numeroSolicitud,
              referencia_tipo: 'mantenimiento',
              responsable: it.responsable || document.getElementById('responsable-manufactura').value || '',
              fecha_movimiento: it.fecha_movimiento || document.getElementById('fecha-manufactura').value || new Date().toISOString(),
              observaciones: it.observaciones || it.observacion || '',
              estado: 'baja',
              precio: it.precio || it.precio_promedio || 0,
              created_at: new Date().toISOString()
            };
            let { error: errIns } = await window.supabaseClient.from(tabla).insert([movimiento]);
            if (errIns) {
              // Fallback por compatibilidad de esquemas que no aceptan 'baja' en tipo_movimiento
              const movimientoFallback = { ...movimiento, tipo_movimiento: 'salida', estado: 'baja' };
              const retry = await window.supabaseClient.from(tabla).insert([movimientoFallback]);
              errIns = retry.error;
              if (!errIns && logDiv) {
                logDiv.insertAdjacentHTML('beforeend', `<div style="color:#fde68a;">Consumido ${code}: se registr√≥ como salida (fallback de compatibilidad).</div>`);
              }
            }
            if (errIns) {
              if (logDiv) logDiv.insertAdjacentHTML('beforeend', `<div style="color:#fca5a5;">Error consumido ${code}: ${errIns.message || errIns}</div>`);
              throw errIns;
            }
          }
          try {
            await window.supabaseClient.from('materiales_consumidos_mantenimiento').update({ estado: 'baja' }).eq('id', it.id);
          } catch (e) { console.warn('No se pudo actualizar estado consumido', e); }
        }

        for (const it of (mantenimientos || [])) {
          const code = it.material_codigo;
          const { table: tabla, reason } = await detectMovimientoTable(it);
          const logDiv = document.getElementById('procesos-log');
          if (logDiv) logDiv.insertAdjacentHTML('beforeend', `<div>Mantenimiento ${code} ‚Üí ${tabla} (${reason})</div>`);
          const exist = await window.supabaseClient.from(tabla).select('id').eq('referencia_documento', numeroSolicitud).eq('material_codigo', code).eq('tipo_movimiento', 'mantenimiento').limit(1).maybeSingle();
          if (!exist.data) {
              const movimiento = {
              material_codigo: it.material_codigo,
              material_nombre: it.material_nombre,
              bodega_principal: it.bodega_principal || 'Principal',
              bodega_secundaria: it.bodega_secundaria || 'General',
              ubicacion_nombre: it.ubicacion_nombre || it.ubicacion_codigo || 'Sin Contenedor',
              tipo_movimiento: 'mantenimiento',
              cantidad: it.cantidad,
              signo: -1,
              referencia_documento: numeroSolicitud,
              referencia_tipo: 'mantenimiento',
              responsable: it.responsable || document.getElementById('responsable-manufactura').value || '',
              fecha_movimiento: it.fecha_movimiento || document.getElementById('fecha-manufactura').value || new Date().toISOString(),
              observaciones: it.observaciones || it.observacion || '',
              estado: 'pendiente',
              precio: it.precio || it.precio_promedio || 0,
              created_at: new Date().toISOString()
            };
            const { error: errIns } = await window.supabaseClient.from(tabla).insert([movimiento]);
            if (errIns) console.warn('No se pudo insertar movimiento en', tabla, errIns);
          }
        }
      }

      // =============================================================================
      // üîπ REGISTRAR Y PROCESAR (ejecuta pasos 1->2->3 mostrando progreso)
      // =============================================================================
      async function registrarYProcesar(solicitudId, numeroSolicitud) {
        const setStatus = (step, text, color) => {
          const el = document.getElementById(`step-${step}-status`);
          if (el) { el.textContent = text; el.style.color = color || '#94a3b8'; }
        };
        const showError = (msg) => {
          const errDiv = document.getElementById('procesos-error');
          if (errDiv) { errDiv.style.display = 'block'; errDiv.textContent = msg; }
        };

        try {
          // Paso 1 y 2 ya deben haberse ejecutado antes de abrir el modal (al pulsar "Procesar Mantenimiento").
          if (!solicitudId) {
            throw new Error('Solicitud inv√°lida para finalizar mantenimiento.');
          }
          setStatus(1, '(completado)', '#10b981');
          setStatus(2, '(completado)', '#10b981');

          // Paso 3: crear movimientos 'reparado' (+1) y actualizar estados a reparado, calculando nuevo precio
          setStatus(3, '(en progreso)...', '#f59e0b');

          // Leer consumidos y mantenimientos actualizados (para obtener mano_obra guardada)
          const { data: consumidosDb, error: errC } = await window.supabaseClient.from('materiales_consumidos_mantenimiento').select('*').eq('solicitud_id', solicitudId);
          if (errC) throw errC;
          const { data: mantenimientosDb, error: errM } = await window.supabaseClient.from('materiales_mantenimiento').select('*').eq('solicitud_id', solicitudId);
          if (errM) throw errM;

          // Calcular costo total de consumibles asociados a la solicitud
          let totalConsumidosCost = 0;
          (consumidosDb || []).forEach(c => {
            const pu = Number(c.precio || c.precio_promedio) || 0;
            const cantidad = Number(c.cantidad) || 0;
            totalConsumidosCost += pu * cantidad;
          });

          const totalMantQty = Math.max(1, (mantenimientosDb || []).reduce((acc, m) => acc + (Number(m.cantidad) || 0), 0));
          for (const it of (mantenimientosDb || [])) {
            const code = it.material_codigo;
            const { table: tabla, reason } = await detectMovimientoTable(code);
            const logDiv = document.getElementById('procesos-log');
            if (logDiv) logDiv.insertAdjacentHTML('beforeend', `<div>Reparado ${code} ‚Üí ${tabla} (${reason})</div>`);

            // evitar duplicados
            const existing = await window.supabaseClient.from(tabla).select('id').eq('referencia_documento', numeroSolicitud).eq('material_codigo', code).eq('tipo_movimiento', 'reparado').limit(1).maybeSingle();
            if (!existing.data) {
              // F√≥rmula: ((precio_unitario*cantidad) + parte_consumibles + mano_obra) / cantidad
              const cantidadMant = Math.max(1, Number(it.cantidad) || 0);
              const shareConsumibles = totalConsumidosCost * (cantidadMant / totalMantQty);
              const basePrice = Number(it.precio || it.precio_promedio) || 0;
              const baseTotal = basePrice * cantidadMant;
              const mano = Number(it.mano_obra) || 0;
              const totalFinal = baseTotal + shareConsumibles + mano;
              const nuevoPrecio = parseFloat((totalFinal / cantidadMant).toFixed(2));

              const movimiento = {
                material_codigo: it.material_codigo,
                material_nombre: it.material_nombre,
                bodega_principal: it.bodega_principal || 'Principal',
                bodega_secundaria: it.bodega_secundaria || 'General',
                ubicacion_nombre: it.ubicacion_nombre || it.ubicacion_codigo || 'Sin Contenedor',
                tipo_movimiento: 'reparado',
                cantidad: it.cantidad,
                signo: 1,
                referencia_documento: numeroSolicitud,
                referencia_tipo: 'mantenimiento',
                responsable: it.responsable || document.getElementById('responsable-manufactura').value || '',
                fecha_movimiento: new Date().toISOString(),
                observaciones: it.observaciones || it.observacion || 'Reparado',
                estado: 'reparado',
                precio: nuevoPrecio,
                created_at: new Date().toISOString()
              };
              const { error: errIns } = await window.supabaseClient.from(tabla).insert([movimiento]);
              if (errIns) console.warn('No se pudo insertar movimiento reparado en', tabla, errIns);

              // actualizar estado y precio en materiales_mantenimiento
              try {
                await window.supabaseClient.from('materiales_mantenimiento').update({ estado: 'reparado', precio_base: it.precio, precio_final: nuevoPrecio }).eq('id', it.id);
              } catch (e) { console.warn('No se pudo actualizar estado/precio mantenimiento', e); }
            }
          }

          setStatus(3, '(completado)', '#10b981');

          // Marcar solicitud principal como completada/procesada al crear el ingreso +1
          const { error: errSolUpd } = await window.supabaseClient
            .from('solicitudes_mantenimiento')
            .update({ estado: 'completado' })
            .eq('id', solicitudId);
          if (errSolUpd) throw errSolUpd;
          editingSolicitudEstado = 'completado';

          return true;
        } catch (err) {
          console.error('Error en registrarYProcesar:', err);
          showError(err.message || String(err));
          throw err;
        }
      }

      // =============================================================================
      // üîπ INICIALIZACI√ìN
      // =============================================================================
      function initFabricacion() {
        document.getElementById('fab-refresh-list').addEventListener('click', cargarSolicitudesList);
        document.getElementById('btn-abrir-modal-consumidos').addEventListener('click', () => abrirModalManufacturado('consumido'));
        document.getElementById('btn-abrir-modal-mantenimiento').addEventListener('click', () => abrirModalManufacturado('mantenimiento'));
        document.getElementById('btn-guardar-fabricacion').addEventListener('click', guardarFabricacion);
        document.getElementById('btn-procesar-mantenimiento').addEventListener('click', async () => {
          try {
            await procesarMantenimiento();
          } catch (e) {
            console.error('Error en procesarMantenimiento:', e);
            alert('Error al procesar mantenimiento: ' + (e.message || e));
          }
        });
        document.getElementById('btn-limpiar-fabricacion').addEventListener('click', () => {
          estado = { itemsConsumidos: [], itemsMantenimiento: [], datosFormulario: {}, pdfData: null };
          editingSolicitudId = null;
          editingSolicitudEstado = null;
          editingNumeroSolicitud = null;
          renderTablaConsumidos();
          renderTablaMantenimiento();
          const btnGuardar = document.getElementById('btn-guardar-fabricacion');
          btnGuardar.disabled = false;
          btnGuardar.textContent = 'Registrar Mantenimiento';
        });
        document.getElementById('btn-cerrar-fabricacion').addEventListener('click', () => {
          document.getElementById('modal-fabricacion').style.display = 'none';
          estado = { itemsConsumidos: [], itemsMantenimiento: [], datosFormulario: {}, pdfData: null };
          editingSolicitudId = null;
          editingSolicitudEstado = null;
          editingNumeroSolicitud = null;
          document.getElementById('responsable-manufactura').value = '';
          document.getElementById('fecha-manufactura').value = '';
          renderTablaConsumidos();
          renderTablaMantenimiento();
        });

        cargarDatos();
        cargarSolicitudesList();
      }

      initFabricacion();
    }, 50);
  </script>
  </div>
</body>
</html>