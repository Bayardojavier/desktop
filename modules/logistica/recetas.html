<!-- La funci√≥n isRowContenedor se mueve al bloque <script> -->
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Administrar Recetas</title>
<link rel="stylesheet" href="./modules/logistica/recetas.css">
<style>
/* CSS cr√≠tico inline como respaldo */
.layout-fade {
  background: linear-gradient(135deg, #1e1e1e 0%, #2d2d30 100%);
  height: calc(100vh - 120px);
  width: 100%;
  max-width: 1550px;
  font-family: 'Segoe UI', 'Inter', sans-serif;
  color: #ffffff;
  display: grid;
  grid-template-columns: 340px 1fr;
  gap: 10px;
  border-radius: 10px;
  padding: 10px;
  box-sizing: border-box;
  overflow-x: auto;
}

/* Asegurar que los selects del modal no sean cortados */
#modalCatalogo select {
  position: relative;
  z-index: 1001;
}

/* Estilos para el modal de ver receta */
.receta-view-detalles {
  padding: 0;
  background: transparent;
}

.receta-view-info {
  background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 24px;
  border: 1px solid rgba(255, 255, 255, 0.1);
  backdrop-filter: blur(10px);
}

.receta-view-info h3 {
  margin: 0 0 16px 0;
  color: #f0f0f0;
  font-size: 1.8em;
  font-weight: 700;
  text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
}

.receta-view-info p {
  margin: 8px 0;
  color: #e0e0e0;
  font-size: 1em;
  display: flex;
  align-items: center;
  gap: 8px;
}

.receta-view-info p strong {
  color: #f0f0f0;
  font-weight: 600;
  min-width: 80px;
}

.receta-view-materiales h4 {
  margin: 0 0 16px 0;
  color: #f0f0f0;
  font-size: 1.4em;
  font-weight: 600;
  text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
  display: flex;
  align-items: center;
  gap: 8px;
}

.receta-view-materiales h4::before {
  content: 'üìã';
  font-size: 1.2em;
}

.receta-view-materiales-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 10px;
  background: #1e1e1e;
  border-radius: 8px;
  overflow: hidden;
}

.receta-view-materiales-table th, .receta-view-materiales-table td {
  padding: 12px;
  text-align: left;
  border-bottom: 1px solid #333;
}

.receta-view-materiales-table th {
  background: linear-gradient(135deg, #2d2d30 0%, #1e1e1e 100%);
  color: #f0f0f0;
  font-weight: bold;
  text-transform: uppercase;
  font-size: 0.9em;
}

.receta-view-materiales-table td {
  color: #cccccc;
}

.cantidad-cell {
  text-align: center;
  color: #00ff00;
  font-weight: bold;
  font-size: 1.1em;
}

.receta-view-materiales-table tbody tr:hover {
  background: #2a2a2a;
}

/* Estilos para la tabla de materiales en el modal de recetas */
.receta-view-materiales-lista {
  margin-top: 15px;
  background: linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.02) 100%);
  border-radius: 16px;
  padding: 24px;
  border: 1px solid rgba(255, 255, 255, 0.1);
  backdrop-filter: blur(10px);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
}

.receta-view-materiales-table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
  background: rgba(45, 45, 48, 0.95);
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.receta-view-materiales-table thead {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.receta-view-table-header-number,
.receta-view-table-header-name,
.receta-view-table-header-bodega,
.receta-view-table-header-cantidad {
  padding: 20px 24px;
  text-align: left;
  color: #f0f0f0;
  font-weight: 700;
  font-size: 0.95em;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  border-bottom: 2px solid rgba(255, 255, 255, 0.2);
  position: relative;
}

.receta-view-table-header-number {
  width: 60px;
  text-align: center;
}

.receta-view-table-header-name {
  width: 40%;
}

.receta-view-table-header-bodega {
  width: 35%;
}

.receta-view-table-header-cantidad {
  width: 15%;
  text-align: center;
}

.receta-view-table-row {
  transition: all 0.3s ease;
  border-bottom: 1px solid rgba(255, 255, 255, 0.08);
  margin-bottom: 4px;
}

.receta-view-table-row:hover {
  background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
  transform: scale(1.01);
}

.receta-view-table-row:last-child {
  border-bottom: none;
}

.receta-view-table-cell-number,
.receta-view-table-cell-name,
.receta-view-table-cell-bodega,
.receta-view-table-cell-cantidad {
  padding: 20px 24px;
  color: #e0e0e0;
  font-size: 0.95em;
  border-right: 1px solid rgba(255, 255, 255, 0.08);
  vertical-align: middle;
  position: relative;
}

.receta-view-table-cell-number::after,
.receta-view-table-cell-name::after,
.receta-view-table-cell-bodega::after {
  content: '';
  position: absolute;
  right: 0;
  top: 20%;
  bottom: 20%;
  width: 1px;
  background: linear-gradient(to bottom, transparent, rgba(255, 255, 255, 0.1), transparent);
}

.receta-view-table-cell-number {
  text-align: center;
  font-weight: 700;
  color: #667eea;
  background: rgba(102, 126, 234, 0.1);
  border-radius: 8px 0 0 8px;
  width: 60px;
}

.receta-view-table-cell-name {
  font-weight: 600;
  color: #f0f0f0;
  border-left: none;
}

.receta-view-table-cell-bodega {
  color: #b8c5d6;
  font-weight: 500;
  display: flex;
  align-items: center;
  gap: 8px;
}

.receta-view-table-cell-cantidad {
  text-align: center;
  font-weight: 700;
  color: #28a745;
  background: rgba(40, 167, 69, 0.1);
  border-radius: 0 8px 8px 0;
  border-right: none;
}

.receta-view-table-row:nth-child(even) {
  background: rgba(255, 255, 255, 0.02);
}

.receta-view-table-row:nth-child(even):hover {
  background: linear-gradient(135deg, rgba(102, 126, 234, 0.15) 0%, rgba(118, 75, 162, 0.15) 100%);
}

/* Estilos para los totales */
.receta-view-total-separator {
  margin: 24px 0 16px 0;
  text-align: center;
}

.receta-view-divider {
  border: none;
  height: 2px;
  background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.5), transparent);
  margin: 16px 0;
  border-radius: 1px;
}

.receta-view-total-count,
.receta-view-total-quantities {
  display: inline-block;
  margin: 8px 16px;
  padding: 12px 20px;
  background: linear-gradient(135deg, rgba(40, 167, 69, 0.1) 0%, rgba(34, 197, 94, 0.1) 100%);
  border-radius: 12px;
  border: 1px solid rgba(40, 167, 69, 0.2);
  font-weight: 600;
}

.receta-view-total-label,
.receta-view-quantities-label {
  color: #28a745;
  font-size: 0.9em;
  margin-right: 8px;
}

.receta-view-total-number,
.receta-view-quantities-number {
  color: #f0f0f0;
  font-size: 1.1em;
  font-weight: 700;
}

/* Ajuste del modal para contenido */
#modalVerReceta .receta-modal-content {
  max-width: 400px;
  width: 50vw;
  height: auto;
  min-height: 400px;
  max-height: 90vh;
}

#modalVerReceta .receta-modal-header {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
  border-radius: 16px 16px 0 0 !important;
}

#modalVerReceta .receta-modal-header h2 {
  color: #f0f0f0 !important;
  font-size: 1.5em !important;
  font-weight: 700 !important;
  text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3) !important;
}

#modalVerReceta .receta-modal-body {
  flex: 1;
  padding: 32px;
  overflow-y: auto;
  scrollbar-width: thin;
  scrollbar-color: #667eea rgba(45, 45, 48, 0.5);
}

/* Estilos para la tabla del cat√°logo */
.catalogo-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 10px;
  background: #1e1e1e;
  border-radius: 8px;
  overflow: hidden;
}

.catalogo-table th, .catalogo-table td {
  padding: 12px;
  text-align: left;
  border-bottom: 1px solid #333;
}

.catalogo-table th {
  background: linear-gradient(135deg, #2d2d30 0%, #1e1e1e 100%);
  color: #ffffff;
  font-weight: bold;
  text-transform: uppercase;
  font-size: 0.9em;
}

.catalogo-table td {
  color: #cccccc;
}
</style>
</head>
<body>
  <div class="layout-fade">

    <!-- Lista lateral de recetas -->
    <aside class="sidebar-effect">
      <div class="sidebar-header">
        <div>
          <h3>Recetas Existentes</h3>
          <p>Editar o eliminar recetas</p>
        </div>
        <button id="recetas-refresh-list" class="button-add">‚Üª</button>
      </div>
      <div id="contenedorRecetas" class="sidebar-container"></div>
    </aside>

    <!-- Formulario principal -->
    <div class="main-content">
      <div class="card-glass">
        <h1 class="title-shine">üìö Gesti√≥n de Recetas</h1>
        <p class="subtitle-fade">Crea grupos predefinidos de materiales por rubro</p>

        <div class="section-bounce">
          <label class="label-glow">Modo de Creaci√≥n:</label>
          <select id="modoCreacion" class="select-shadow">
            <option value="PLANTILLAS">Por Plantillas (Recomendable)</option>
            <option value="CODIGO">Por C√≥digo Espec√≠fico</option>
          </select>
        </div>

        <div class="form-fade">
          <div class="grid-split">
            <div>
              <label class="label-glow">Nombre de la Receta</label>
              <input type="text" id="nombreReceta" class="input-shadow" placeholder="Ej: Kit Iluminaci√≥n B√°sico" />
            </div>
            <div>
              <label class="label-glow">Rubro</label>
              <select id="rubroReceta" class="select-shadow">
                <option value="">Seleccione...</option>
                <option value="Estructuras">Estructuras</option>
                <option value="Audiovisual">Audiovisual</option>
                <option value="Mobiliario">Mobiliario</option>
                <option value="Iluminaci√≥n">Iluminaci√≥n</option>
                <option value="Otros">Otros</option>
              </select>
            </div>
          </div>

          <div class="section-bounce">
            <h3 class="subtitle-section">Materiales en la Receta</h3>
            <div id="listaMaterialesReceta"></div>
          </div>

          <div class="actions-pulse">
            <button id="btnAbrirCatalogo" class="button-add">üì¶ Abrir Cat√°logo</button>
            <button id="btnGuardarReceta" class="button-pulse">üíæ Guardar Receta</button>
            <button id="btnLimpiarForm" class="button-secondary">üóëÔ∏è Limpiar</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal del Cat√°logo de Materiales -->
    <div id="modalCatalogo" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-header">
          <h2>üì¶ CAT√ÅLOGO DE MATERIALES</h2>
          <button id="btnCerrarModal" class="modal-close">‚úï</button>
        </div>
        <div class="modal-body">
          <div class="filters-fade">
            <div class="filter-group">
              <label>Buscar por nombre:</label>
              <input type="text" id="buscador-nombre-recetas" class="input-shadow" placeholder="Escriba para buscar...">
            </div>
            <div class="filter-group">
              <label>Filtrar por Bodega Principal:</label>
              <select id="filtro-bodega-principal-recetas" class="select-shadow">
                <option value="todas">Todas las Bodegas</option>
              </select>
            </div>
            <div class="catalogo-filtro-grupo">
              <label>Filtrar por Bodega Secundaria:</label>
              <select id="filtro-bodega-secundaria-recetas" class="select-shadow">
                <option value="todas">Todas las Bodegas</option>
              </select>
            </div>
            <div class="view-switch-group">
              <label>Vista:</label>
              <div class="view-switch">
                <button id="btnVistaLista" class="view-option active" data-view="list">üìã Lista</button>
                <button id="btnVistaTarjetas" class="view-option" data-view="cards">üé¥ Tarjetas</button>
              </div>
            </div>
            <button id="btn-restablecer-filtros-recetas" class="button-add">üîÑ Restablecer</button>
          </div>
          <div id="resultados-busqueda-recetas" class="results-grid-modal"></div>
        </div>
      </div>
    </div>

    <!-- Modal para ver receta -->
    <div id="modalVerReceta" class="receta-modal-overlay">
      <div class="receta-modal-content">
        <div class="receta-modal-header">
          <h2>üëÅÔ∏è DETALLES DE LA RECETA</h2>
          <button id="btnCerrarModalVer" class="receta-modal-close">‚úï</button>
        </div>
        <div class="receta-modal-body">
          <div id="detallesReceta"></div>
        </div>
      </div>
    </div>

   
  <script>
        // =====================================================
        // üß© Utilidad: ¬øEs contenedor?
        // =====================================================
        function isRowContenedor(r) {
          // Considera contenedor si tiene es_contenedor true, o tipo_uso/tipo_material incluye 'contenedor'
          if (!r) return false;
          if (r.es_contenedor === true || r.es_contenedor === 1 || r.es_contenedor === '1') return true;
          const tu = (r.tipo_uso || '').toString().toLowerCase();
          const tm = (r.tipo_material || '').toString().toLowerCase();
          if (tu.includes('contenedor') || tm.includes('contenedor')) return true;
          return false;
        }

        // =====================================================
        // üß© Utilidades adicionales
        // =====================================================
        function getCampo(campos, nombreCampo) {
          if (!campos || !Array.isArray(campos)) return '';
          const campo = campos.find(c => (c.nombre || '').toString().toLowerCase() === nombreCampo.toLowerCase());
          return campo ? campo.valor || '' : '';
        }

        function isGrupoCodigo(codigo) {
          // Ahora las plantillas tienen clave = nombre_plantilla, no PLANTILLA|id
          // Verificar si existe en gruposCatalogo
          return (gruposCatalogo || []).some(g => g.clave === codigo);
        }

        function getGrupoClaveFromCodigo(codigo) {
          // Ya no necesitamos extraer de PLANTILLA|, la clave es directamente el nombre
          return codigo;
        }

        function isCaseBaseCodigo(codigo) {
          const c = (codigo || '').toString().toLowerCase();
          return c.includes('case') || c.startsWith('case_');
        }

        function getCaseBaseFromCodigo(codigo) {
          const c = (codigo || '').toString();
          if (c.toLowerCase().includes('case')) {
            return c.replace(/case/gi, '').trim() || 'Case';
          }
          return c;
        }

        function decodeLegacyTipoFromObs(obs) {
          const o = (obs || '').toString().trim();
          if (!o) return { tipo: 'ITEM', obs: '' };
          // Si contiene separador especial, decodificar
          if (o.includes('||')) {
            const parts = o.split('||');
            return { tipo: parts[0] || 'ITEM', obs: parts[1] || '' };
          }
          return { tipo: 'ITEM', obs: o };
        }

        function encodeObservacion(tipo, obs) {
          const t = (tipo || 'ITEM').toString().trim();
          const o = (obs || '').toString().trim();
          if (t === 'ITEM' && !o) return '';
          return t + '||' + o;
        }
    // =====================================================
    // üîå Configuraci√≥n de Supabase
    // =====================================================
    // Usa window.supabaseClient configurado globalmente

    // =====================================================
    // üß† Estado
    // =====================================================
    let materialesCatalogo = [];
    let casesCatalogo = [];
    let caseBases = []; // [{ base, bodega_principal, bodega_secundaria, count }]
    let materialesReceta = [];
    let isEditing = false;
    let editingId = null;
    let modoCreacion = 'PLANTILLAS'; // PLANTILLAS | CODIGO

    let gruposCatalogo = []; // [{ clave, nombre, descripcion, tipo }]

    const CATALOGOS = [
      { key: 'AUDIOVISUAL', label: 'Audiovisual', table: 'catalogo_audiovisual' },
      { key: 'HIERROS', label: 'Hierros', table: 'catalogo_hierros' },
      { key: 'CONSUMIBLES', label: 'Consumibles', table: 'catalogo_consumibles' }
    ];
    const CATALOGO_STORAGE_KEY = 'logistica_recetas_catalogo_v1';
    let catalogoActivoKey = 'AUDIOVISUAL';

    // Variables para el modal
    let resultadosContainer;
    let btnVistaLista;
    let btnVistaTarjetas;
    let vistaActual = 'cards';

    function normalizeCatalogoKey(v) {
      const t = (v || '').toString().trim().toUpperCase();
      return (t === 'AUDIOVISUAL' || t === 'HIERROS' || t === 'CONSUMIBLES' || t === 'TODOS') ? t : 'AUDIOVISUAL';
    }


    function loadCatalogoKey() {
      try {
        return normalizeCatalogoKey(localStorage.getItem(CATALOGO_STORAGE_KEY));
      } catch (_) {
        return 'AUDIOVISUAL';
      }
    }

    function setCatalogoKey(v) {
      catalogoActivoKey = normalizeCatalogoKey(v);
      try { localStorage.setItem(CATALOGO_STORAGE_KEY, catalogoActivoKey); } catch (_) {}
    }

    function asBool(v) {
      if (v === true) return true;
      if (v === false || v == null) return false;
      if (v === 1 || v === '1') return true;
      if (typeof v === 'string') {
        const t = v.trim().toLowerCase();
        return t === 'true' || t === 'yes' || t === 'si' || t === '1';
      }
      return Boolean(v);
    }

    function isRowCase(r) {
      const tm = (r?.tipo_material || '').toString().toLowerCase();
      const tu = (r?.tipo_uso || '').toString().toLowerCase();
      const nm = (r?.nombre || '').toString().toLowerCase();
      if (tm === 'case' || tu === 'case') return true;
      if (nm.includes('case')) return true;
      return false;
    }

    function parseBaseNombreCase(nombre) {
      const n = (nombre || '').toString().trim();
      if (!n) return '';
      // Quitar sufijo num√©rico tipo "Case 01" => "Case"
      const m = n.replace(/\s+\d+\s*$/g, '').trim();
      return m || n;
    }

    // =====================================================
    // üì• Cargar datos
    // =====================================================
    async function fetchCatalogRows(table) {
      const isConsumibles = (table === 'catalogo_consumibles');
      const selectStr = isConsumibles
        ? 'codigo, nombre, bodega_principal, bodega_secundaria, foto_url, campos_personalizados'
        : 'codigo, nombre, bodega_principal, bodega_secundaria, foto_url, tipo_material, tipo_uso, es_contenedor, tipo_alta, campos_personalizados';

      let { data, error } = await window.supabaseClient
        .from(table)
        .select(selectStr)
        .order('codigo', { ascending: true });

      if (error) {
        // fallback m√≠nimo por si faltan columnas
        const retry = await window.supabaseClient
          .from(table)
          .select('codigo, nombre, bodega_principal, bodega_secundaria, foto_url, campos_personalizados')
          .order('codigo', { ascending: true });
        if (retry.error) throw retry.error;
        data = retry.data || [];
      }
const tables = CATALOGOS.map(c => c.table);  // Siempre cargar todos los cat√°logos
      const rows = Array.isArray(data) ? data : [];
      return rows.map(r => ({ ...r, __catalogo_table: table }));
    }

    async function cargarCatalogo() {
      try {
        const tables = CATALOGOS.map(c => c.table); // Cargar todos los cat√°logos para tener m√°s opciones de bodega

        const allRows = [];
        for (const t of tables) {
          const part = await fetchCatalogRows(t);
          allRows.push(...part);
        }

        // En recetas, el cat√°logo es solo lectura: no depende de stock.
        // Materiales: todo lo que NO sea contenedor.
        materialesCatalogo = allRows.filter(r => !isRowContenedor(r));

        // Cases (plantillas): contenedores que parezcan Case.
        casesCatalogo = allRows.filter(r => isRowContenedor(r) && isRowCase(r));

        // Poblar filtros despu√©s de cargar
        poblarFiltrosBodega();

        // Agrupar Cases por "Nombre Clave/Base" para mostrarlos como gen√©ricos en recetas.
        // Importante: NO amarrar a un c√≥digo espec√≠fico ni a existencia actual.
        const baseMap = new Map();
        (casesCatalogo || []).forEach(c => {
          const base = (
            getCampo(c.campos_personalizados, 'Nombre Clave') ||
            getCampo(c.campos_personalizados, 'Nombre Base') ||
            parseBaseNombreCase(c.nombre)
          ).trim();
          if (!base) return;

          const key = base; // solo por nombre clave/base
          const prev = baseMap.get(key) || {
            base,
            count: 0,
            _bp: new Set()
          };
          prev.count += 1;
          if (c.bodega_principal) prev._bp.add(c.bodega_principal);
          baseMap.set(key, prev);
        });

        caseBases = Array.from(baseMap.values()).map(x => {
          const bp = Array.from(x._bp);
          return {
            base: x.base,
            count: x.count,
            bodega_principal: (bp.length === 1) ? bp[0] : 'Varias'
          };
        }).sort((a, b) => (a.base || '').localeCompare(b.base || ''));

    } catch (error) {
      console.error('Error al cargar cat√°logo:', error);
      alert('‚ö†Ô∏è No se pudo cargar el cat√°logo.');
      materialesCatalogo = [];
      casesCatalogo = [];
      caseBases = [];
    }

    }

    // =====================================================
    // üîç Funciones de B√∫squeda por Modo
    // =====================================================

    // Funci√≥n para poblar filtros en modo PLANTILLAS
    function poblarFiltrosPlantillas(filtroPrincipal = 'todas', filtroSecundaria = 'todas') {
      // Recopilar bodegas principales de plantillas
      const bodegasPrincipales = [...new Set(gruposCatalogo.flatMap(m => [
        m.catalogo,
        ...(m.catalogos || [])
      ].filter(Boolean)))].sort();

      // Recopilar bodegas secundarias de plantillas, filtradas por bodega principal si no es "todas"
      let bodegasSecundarias;
      if (filtroPrincipal === 'todas') {
        bodegasSecundarias = [...new Set(gruposCatalogo.flatMap(m => [
          ...(m.bodega_secundaria || [])
        ].filter(Boolean)))].sort();
      } else {
        const gruposFiltrados = gruposCatalogo.filter(m => {
          const catalogos = [m.catalogo, ...(m.catalogos || [])].filter(Boolean);
          return catalogos.includes(filtroPrincipal);
        });
        bodegasSecundarias = [...new Set(gruposFiltrados.flatMap(m => [
          ...(m.bodega_secundaria || [])
        ].filter(Boolean)))].sort();
      }

      const selectPrincipal = document.getElementById('filtro-bodega-principal-recetas');
      const selectSecundaria = document.getElementById('filtro-bodega-secundaria-recetas');

      // Limpiar opciones existentes
      selectPrincipal.innerHTML = '<option value="todas">Todas las Bodegas</option>';
      selectSecundaria.innerHTML = '<option value="todas">Todas las Bodegas</option>';

      // Poblar bodegas principales
      bodegasPrincipales.forEach(bodega => {
        selectPrincipal.innerHTML += `<option value="${bodega}">${bodega}</option>`;
      });

      // Poblar bodegas secundarias
      bodegasSecundarias.forEach(bodega => {
        selectSecundaria.innerHTML += `<option value="${bodega}">${bodega}</option>`;
      });

      // Reset valores
      selectPrincipal.value = filtroPrincipal;
      selectSecundaria.value = filtroSecundaria;
    }

    // Funci√≥n para poblar filtros en modo CODIGO
    function poblarFiltrosCodigos(filtroPrincipal = 'todas', filtroSecundaria = 'todas') {
      // Recopilar bodegas principales de cat√°logos
      const bodegasPrincipales = [...new Set(materialesCatalogo.map(m => m.bodega_principal).filter(Boolean))].sort();

      // Recopilar bodegas secundarias de cat√°logos
      const bodegasSecundarias = [...new Set(materialesCatalogo.flatMap(m => {
        const sec = m.bodega_secundaria;
        if (Array.isArray(sec)) return sec.filter(Boolean);
        return sec ? [sec] : [];
      }))].sort();

      const selectPrincipal = document.getElementById('filtro-bodega-principal-recetas');
      const selectSecundaria = document.getElementById('filtro-bodega-secundaria-recetas');

      // Limpiar opciones existentes
      selectPrincipal.innerHTML = '<option value="todas">Todas las Bodegas</option>';
      selectSecundaria.innerHTML = '<option value="todas">Todas las Bodegas</option>';

      // Poblar bodegas principales
      bodegasPrincipales.forEach(bodega => {
        selectPrincipal.innerHTML += `<option value="${bodega}">${bodega}</option>`;
      });

      // Poblar bodegas secundarias
      bodegasSecundarias.forEach(bodega => {
        selectSecundaria.innerHTML += `<option value="${bodega}">${bodega}</option>`;
      });

      // Reset valores
      selectPrincipal.value = filtroPrincipal;
      selectSecundaria.value = filtroSecundaria;
    }

    // Funci√≥n unificada para renderizar resultados seg√∫n modo
    function renderizarResultadosCatalogo() {
      if (modoCreacion === 'PLANTILLAS') {
        renderResultadosPlantillas();
      } else {
        renderResultadosCodigos();
      }
    }

    // Exponer funci√≥n globalmente para el switch de vista
    window.renderizarResultadosCatalogo = renderizarResultadosCatalogo;

    // =====================================================
    // üîç Funciones de B√∫squeda por Modo
    // =====================================================

    // Funci√≥n helper para renderizar un material seg√∫n la vista actual
    function renderizarMaterial(material, tipo = 'material') {
      const nombre = material.nombre || 'Sin nombre';
      const codigo = material.codigo || material.clave || 'Sin c√≥digo';
      
      // Recopilar todas las bodegas disponibles
      const bodegas = [
        material.bodega_principal,
        material.bodega_secundaria,
        ...(material.catalogos || []),
        ...(Array.isArray(material.bodega_secundaria) ? material.bodega_secundaria : [])
      ].filter(Boolean);
      
      const bodegaDisplay = bodegas.length > 0 ? bodegas.join(', ') : 'Sin bodega';
      const descripcion = material.descripcion || '';
      const subtitulo = tipo === 'plantilla' ? descripcion : codigo;
      const textoBoton = 'Seleccionar Material';
      
      const materialData = {
        codigo: material.codigo || material.clave,
        nombre,
        bodega_principal: material.bodega_principal || 'Sin bodega',
        bodega_secundaria: material.bodega_secundaria || (Array.isArray(material.bodega_secundaria) ? material.bodega_secundaria : '‚Äî'),
        clave: material.clave || null
      };

      if (vistaActual === 'list') {
        return `
          <div class="list-item">
            <div class="list-item-content">
              <div class="list-item-icon">${tipo === 'plantilla' ? 'üìã' : 'üîß'}</div>
              <div class="list-item-info">
                <h4>${nombre}</h4>
                <p>${subtitulo} ‚Ä¢ ${bodegaDisplay}</p>
              </div>
            </div>
            <div class="list-item-actions">
              <button class="btn-add catalogo-select-btn" data-material='${JSON.stringify(materialData)}'>
                ${textoBoton}
              </button>
            </div>
          </div>
        `;
      } else {
        return `
          <div class="catalogo-card">
            <div class="catalogo-card-header">
              <div>
                <div class="catalogo-card-title">${nombre}</div>
                <div class="catalogo-card-subtitle">${subtitulo}</div>
              </div>
            </div>
            <div class="catalogo-badges">
              <span class="catalogo-badge">${bodegaDisplay}</span>
            </div>
            <button class="btn-add catalogo-select-btn" data-material='${JSON.stringify(materialData)}'>
              ${textoBoton}
            </button>
          </div>
        `;
      }
    }

    // Funci√≥n para renderizar resultados en modo PLANTILLAS
    async function renderResultadosPlantillas() {
      const contenedor = document.getElementById('resultados-busqueda-recetas');
      const terminoBusqueda = document.getElementById('buscador-nombre-recetas').value.toLowerCase();
      const bodegaPrincipalFiltro = document.getElementById('filtro-bodega-principal-recetas').value;
      const bodegaSecundariaFiltro = document.getElementById('filtro-bodega-secundaria-recetas').value;

      try {
        let materiales = gruposCatalogo; // Solo plantillas

        // Filtrar por b√∫squeda de nombre
        if (terminoBusqueda) {
          materiales = materiales.filter(m => {
            const nombre = (m.nombre || '').toLowerCase();
            return nombre.includes(terminoBusqueda);
          });
        }

        // Filtrar por bodega principal (cat√°logo)
        if (bodegaPrincipalFiltro !== 'todas') {
          materiales = materiales.filter(m => {
            const bodegasPrincipales = [
              m.catalogo,
              ...(m.catalogos || [])
            ].filter(Boolean);
            return bodegasPrincipales.includes(bodegaPrincipalFiltro);
          });
        }

        // Filtrar por bodega secundaria
        if (bodegaSecundariaFiltro !== 'todas') {
          materiales = materiales.filter(m => {
            const bodegasSecundarias = [
              ...(m.bodega_secundaria || [])
            ].filter(Boolean);
            return bodegasSecundarias.includes(bodegaSecundariaFiltro);
          });
        }

        // Limitar resultados
        materiales = materiales.slice(0, 50);

        if (!materiales || materiales.length === 0) {
          contenedor.innerHTML = '<p class="empty-state">No se encontraron plantillas.</p>';
          return;
        }

        if (vistaActual === 'list') {
          // Vista de lista
          contenedor.innerHTML = materiales.map((material, index) => `
            <div class="list-item">
              <div class="list-item-content">
                <div class="list-item-icon">üìã</div>
                <div class="list-item-info">
                  <h4>${material.nombre}</h4>
                  <p>${material.descripcion || material.nombre} ‚Ä¢ ${material.catalogo}</p>
                </div>
              </div>
              <div class="list-item-actions">
                <button class="btn-add catalogo-select-btn" data-material='${JSON.stringify({
                  codigo: material.clave,
                  nombre: material.nombre,
                  bodega_principal: material.catalogo,
                  clave: material.clave
                })}'>Seleccionar</button>
              </div>
            </div>
          `).join('');
        } else {
          // Vista de tarjetas
          contenedor.innerHTML = materiales.map((material, index) => `
            <div class="catalogo-card">
              <div class="catalogo-card-header">
                <div>
                  <div class="catalogo-card-title">${material.nombre}</div>
                  <div class="catalogo-card-subtitle">${material.descripcion || material.nombre}</div>
                </div>
              </div>
              <div class="catalogo-badges">
                <span class="catalogo-badge">${material.catalogo}</span>
              </div>
              <button class="btn-add catalogo-select-btn" data-material='${JSON.stringify({
                codigo: material.clave,
                nombre: material.nombre,
                bodega_principal: material.catalogo,
                clave: material.clave
              })}'>Seleccionar</button>
            </div>
          `).join('');
        }

        contenedor.querySelectorAll('button[data-material]').forEach(btn => {
          btn.addEventListener('click', (e) => {
            try {
              const material = JSON.parse(e.currentTarget.dataset.material);
              agregarMaterialALista(material);
            } catch (err) {
              console.error('Error parsing material data:', err);
            }
          });
        });

      } catch (err) {
        console.error('Error renderizando plantillas:', err);
        contenedor.innerHTML = '<p class="error-state">Error al cargar plantillas.</p>';
      }
    }

    // Funci√≥n para renderizar resultados en modo CODIGO
    async function renderResultadosCodigos() {
      const contenedor = document.getElementById('resultados-busqueda-recetas');
      const terminoBusqueda = document.getElementById('buscador-nombre-recetas').value.toLowerCase();
      const bodegaPrincipalFiltro = document.getElementById('filtro-bodega-principal-recetas').value;
      const bodegaSecundariaFiltro = document.getElementById('filtro-bodega-secundaria-recetas').value;

      try {
        let materiales = materialesCatalogo; // Solo c√≥digos del cat√°logo

        // Filtrar por b√∫squeda de nombre
        if (terminoBusqueda) {
          materiales = materiales.filter(m => {
            const nombre = (m.nombre || '').toLowerCase();
            return nombre.includes(terminoBusqueda);
          });
        }

        // Filtrar por bodega principal
        if (bodegaPrincipalFiltro !== 'todas') {
          if (bodegaPrincipalFiltro === 'sin_bodega') {
            materiales = materiales.filter(m => !m.bodega_principal);
          } else {
            materiales = materiales.filter(m => m.bodega_principal === bodegaPrincipalFiltro);
          }
        }

        // Filtrar por bodega secundaria
        if (bodegaSecundariaFiltro !== 'todas') {
          materiales = materiales.filter(m => {
            const sec = m.bodega_secundaria;
            if (Array.isArray(sec)) return sec.includes(bodegaSecundariaFiltro);
            return sec === bodegaSecundariaFiltro;
          });
        }

        // Limitar resultados
        materiales = materiales.slice(0, 50);

        if (!materiales || materiales.length === 0) {
          contenedor.innerHTML = '<p class="empty-state">No se encontraron materiales.</p>';
          return;
        }

        contenedor.innerHTML = materiales.map(material => 
          renderizarMaterial(material, 'material')
        ).join('');

        contenedor.querySelectorAll('button[data-material]').forEach(btn => {
          btn.addEventListener('click', (e) => {
            try {
              const material = JSON.parse(e.currentTarget.dataset.material);
              agregarMaterialALista(material);
            } catch (err) {
              console.error('Error parsing material data:', err);
            }
          });
        });

      } catch (err) {
        console.error('Error renderizando c√≥digos:', err);
        contenedor.innerHTML = '<p class="error-state">Error al cargar materiales.</p>';
      }
    }

    // =====================================================
    // üîç B√∫squeda y Selecci√≥n de Materiales
    // =====================================================
    // Funci√≥n unificada para renderizar resultados seg√∫n modo
    async function renderResultadosBusquedaRecetas() {
      if (modoCreacion === 'PLANTILLAS') {
        await renderResultadosPlantillas();
      } else {
        await renderResultadosCodigos();
      }
    }

    async function agregarMaterialALista(material) {
      const tipo = (gruposCatalogo || []).some(g => g.clave === material.clave) ? 'GRUPO' : 'ITEM';
      if (tipo === 'GRUPO') {
        const clave = material.clave;
        // Agregar como √≠tem √∫nico
        if (materialesReceta.some(item => item.material_codigo === clave)) {
          alert('‚ö†Ô∏è Esta plantilla ya est√° en la lista de la receta.');
          return;
        }
        materialesReceta.push({
          material_codigo: clave,
          cantidad: 1,
          tipo,
          observacion: ''
        });
      } else {
        // Verificar si ya est√° en la lista
        if (materialesReceta.some(item => item.material_codigo === material.codigo)) {
          alert('‚ö†Ô∏è Este material ya est√° en la lista de la receta.');
          return;
        }
        // Agregar el material
        materialesReceta.push({
          material_codigo: material.codigo,
          cantidad: 1,
          tipo,
          observacion: ''
        });
      }

      renderListaMateriales();
    }

    async function cargarRecetasExistentes() {
      const tablaRecetas = modoCreacion === 'PLANTILLAS' ? 'recetas' : 'recetas_especificas';
      const tablaMateriales = modoCreacion === 'PLANTILLAS' ? 'recetas_materiales' : 'recetas_especificas_materiales';

      const { data: recetas, error } = await window.supabaseClient
        .from(tablaRecetas)
        .select('id, nombre, rubro')
        .order('creado_en', { ascending: false });
      if (error) {
        console.error('Error al cargar recetas:', error);
        return;
      }
      const contenedor = document.getElementById('contenedorRecetas');
      if (recetas.length === 0) {
        contenedor.innerHTML = '<p id="mensajeVacio">No hay recetas guardadas.</p>';
        return;
      }

      let html = `<div class="list-full">`;
      html += `<div class="list-header">`;
      html += `<div>Nombre</div><div>Rubro</div><div>Materiales</div><div>Acciones</div>`;
      html += `</div>`;

      for (const receta of recetas) {
        const { count, error: errMat } = await window.supabaseClient
          .from(tablaMateriales)
          .select('*', { count: 'exact', head: true })
          .eq('receta_id', receta.id);
        const materialesCount = errMat ? 0 : count;

        html += `<div class="list-row">`;
        html += `<div>${receta.nombre}</div>`;
        html += `<div>${receta.rubro}</div>`;
        html += `<div class="count-center">${materialesCount}</div>`;
        html += `<div>
          <button type="button" class="btn-accion btn-ver" onclick="verReceta('${receta.id}')">üëÅÔ∏è</button>
          <button type="button" class="btn-accion btn-editar" onclick="editarReceta('${receta.id}')">‚úèÔ∏è</button>
          <button type="button" class="btn-accion btn-eliminar" onclick="eliminarReceta('${receta.id}')">üóëÔ∏è</button>
        </div>`;
        html += `</div>`;
      }
      html += `</div>`;
      contenedor.innerHTML = html;
    }

    // =====================================================
    // üé® Renderizado
    // =====================================================
    function renderListaMateriales() {
      const contenedor = document.getElementById('listaMaterialesReceta');
      if (materialesReceta.length === 0) {
        contenedor.innerHTML = '<p id="mensajeVacio">Agrega materiales a esta receta.</p>';
        return;
      }

      let html = `<div class="materials-scroll"><table class="table-effect">`;
      html += `<thead><tr>
        <th class="col-material">Material</th>
        <th class="col-cantidad">Cantidad</th>
        <th class="col-obs">Obs.</th>
        <th class="col-acciones"></th>
      </tr></thead><tbody>`;

      materialesReceta.forEach((item, idx) => {
        const tipo = item.tipo || (isCaseBaseCodigo(item.material_codigo) ? 'CASE' : 'ITEM');
        const isCase = (tipo === 'CASE') || isCaseBaseCodigo(item.material_codigo);
        const isGrupo = (tipo === 'GRUPO') || isGrupoCodigo(item.material_codigo);

        if (isGrupo) {
          const clave = getGrupoClaveFromCodigo(item.material_codigo) || item.material_codigo;
          const g = (gruposCatalogo || []).find(x => (x.clave || '') === clave);
          const nombreGrupo = g ? g.nombre : clave;
          const display = nombreGrupo;
          html += `<tr>
            <td>
              <input type="text" class="input-shadow readonly-input" value="${display}" readonly />
            </td>
            <td class="td-center">
              <input type="number" class="input-shadow input-shadow-sm td-center" data-idx="${idx}" min="1" value="${item.cantidad || 1}" />
            </td>
            <td>
              <input type="text" class="input-shadow" data-idx="${idx}" placeholder="Opcional" value="${item.observacion || ''}" />
            </td>
            <td class="td-center">
              <button type="button" class="btn-remove btn-icon" data-idx="${idx}">‚úï</button>
            </td>
          </tr>`;
          return;
        }

        if (isCase) {
          const base = getCaseBaseFromCodigo(item.material_codigo) || item.material_codigo;
          const nombreCase = `CASE: ${base}`;
          html += `<tr>
            <td>
              <input type="text" class="input-shadow readonly-input" value="${nombreCase}" readonly />
            </td>
            <td class="td-center">
              <input type="number" class="input-shadow input-shadow-sm td-center" data-idx="${idx}" min="1" value="${item.cantidad || 1}" />
            </td>
            <td>
              <input type="text" class="input-shadow" data-idx="${idx}" placeholder="Opcional" value="${item.observacion || ''}" />
            </td>
            <td class="td-center">
              <button type="button" class="btn-remove btn-icon" data-idx="${idx}">‚úï</button>
            </td>
          </tr>`;
          return;
        }

        let nombre = item.material_codigo; // fallback por defecto

        if (item.material_nombre) {
          nombre = item.material_nombre;
        } else {
          // Buscar el material en el cat√°logo
          const mat = materialesCatalogo.find(m => m.codigo === item.material_codigo);
          if (mat) {
            nombre = `${mat.nombre || mat.material_nombre} (${mat.codigo || mat.material_codigo})`;
          }
        }
        html += `<tr>
          <td>
            <input type="text" class="input-shadow readonly-input" value="${nombre}" readonly />
          </td>
          <td class="td-center">
            <input type="number" class="input-shadow input-shadow-sm td-center" data-idx="${idx}" min="1" value="${item.cantidad || 1}" />
          </td>
          <td>
            <input type="text" class="input-shadow" data-idx="${idx}" placeholder="Opcional" value="${item.observacion || ''}" />
          </td>
          <td class="td-center">
            <button type="button" class="btn-remove btn-icon" data-idx="${idx}">‚úï</button>
          </td>
        </tr>`;
      });

      html += `</tbody></table></div>`;
      contenedor.innerHTML = html;

      // Eventos
      contenedor.querySelectorAll('input[type="number"][data-idx]').forEach(inp => {
        inp.addEventListener('input', e => {
          const idx = parseInt(e.target.dataset.idx);
          materialesReceta[idx].cantidad = parseFloat(e.target.value) || 1;
        });
      });
      contenedor.querySelectorAll('input[type="text"][data-idx]').forEach(inp => {
        inp.addEventListener('input', e => {
          const idx = parseInt(e.target.dataset.idx);
          materialesReceta[idx].observacion = e.target.value;
        });
      });
      contenedor.querySelectorAll('button[data-idx]').forEach(btn => {
        btn.addEventListener('click', e => {
          const idx = parseInt(e.target.dataset.idx);
          materialesReceta.splice(idx, 1);
          renderListaMateriales();
        });
      });
    }

    // =====================================================
    // üß© Eventos
    // =====================================================
    document.getElementById('btnGuardarReceta').addEventListener('click', async () => {
      const btn = document.getElementById('btnGuardarReceta');
      if (btn.disabled) return; // Prevent multiple clicks
      btn.disabled = true;
      btn.textContent = isEditing ? 'Actualizando...' : 'Guardando...';

      try {
        const nombre = document.getElementById('nombreReceta').value.trim();
        const rubro = document.getElementById('rubroReceta').value;
        if (!nombre || !rubro) {
          alert('‚ö†Ô∏è Ingrese nombre y rubro.');
          return;
        }

        const itemsValidos = materialesReceta.filter(item => item.material_codigo);
        if (itemsValidos.length === 0) {
          alert('‚ö†Ô∏è Agregue al menos un material v√°lido.');
          return;
        }

        let receta;
        const tablaRecetas = modoCreacion === 'PLANTILLAS' ? 'recetas' : 'recetas_especificas';
        const tablaMateriales = modoCreacion === 'PLANTILLAS' ? 'recetas_materiales' : 'recetas_especificas_materiales';

        if (isEditing) {
          // Update existing
          const { data, error } = await window.supabaseClient
            .from(tablaRecetas)
            .update({ nombre, rubro })
            .eq('id', editingId)
            .select()
            .single();
          if (error) {
            console.error('Error al actualizar receta:', error);
            alert('‚ùå Error al actualizar la receta.');
            // Mostrar notificaci√≥n de error
            if (window.showSystemNotification) {
              window.showSystemNotification('Error al Actualizar Receta', 'No se pudo actualizar la receta. Verifique los datos.');
            }
            return;
          }
          receta = data;
          // Delete old materials and insert new
          await window.supabaseClient.from(tablaMateriales).delete().eq('receta_id', editingId);
        } else {
          // Insert new
          const { data, error } = await window.supabaseClient
            .from(tablaRecetas)
            .insert({ nombre, rubro })
            .select()
            .single();
          if (error) {
            console.error('Error al guardar receta:', error);
            alert('‚ùå Error al guardar la receta.');
            // Mostrar notificaci√≥n de error
            if (window.showSystemNotification) {
              window.showSystemNotification('Error al Guardar Receta', 'No se pudo guardar la receta. Verifique los datos.');
            }
            return;
          }
          receta = data;
        }

        const materialesParaInsertar = itemsValidos.map(item => ({
          receta_id: receta.id,
          material_codigo: item.material_codigo,
          cantidad: item.cantidad,
          observacion: encodeObservacion(item.tipo || 'ITEM', item.observacion)
        }));

        const { error: errorMateriales } = await window.supabaseClient
          .from(tablaMateriales)
          .insert(materialesParaInsertar);
        if (errorMateriales) {
          console.error('Error al guardar materiales:', errorMateriales);
          alert('‚ùå Error al guardar los materiales de la receta.');
          // Mostrar notificaci√≥n de error
          if (window.showSystemNotification) {
            window.showSystemNotification('Error al Guardar Materiales', 'No se pudieron guardar los materiales de la receta.');
          }
          return;
        }

        alert(isEditing ? '‚úÖ Receta actualizada con √©xito.' : '‚úÖ Receta guardada con √©xito.');
        // Mostrar notificaci√≥n del sistema
        if (window.showSystemNotification) {
          window.showSystemNotification('Receta Guardada', isEditing ? 'Receta actualizada exitosamente.' : 'Nueva receta guardada exitosamente.');
        }
        limpiarFormulario();
        cargarRecetasExistentes();
      } finally {
        btn.disabled = false;
        btn.textContent = isEditing ? 'üíæ Actualizar Receta' : 'üíæ Guardar Receta';
      }
    });

    function limpiarFormulario() {
      document.getElementById('nombreReceta').value = '';
      document.getElementById('rubroReceta').value = '';
      materialesReceta = [];
      renderListaMateriales();
      isEditing = false;
      editingId = null;
      const btn = document.getElementById('btnGuardarReceta');
      btn.textContent = 'üíæ Guardar Receta';
      btn.disabled = false;
    }

    document.getElementById('btnLimpiarForm').addEventListener('click', limpiarFormulario);

    // =====================================================
    // ‚úèÔ∏è Editar Receta
    // =====================================================
    window.editarReceta = async (id) => {
      const tablaRecetas = modoCreacion === 'PLANTILLAS' ? 'recetas' : 'recetas_especificas';
      const tablaMateriales = modoCreacion === 'PLANTILLAS' ? 'recetas_materiales' : 'recetas_especificas_materiales';

      const { data: receta, error } = await window.supabaseClient
        .from(tablaRecetas)
        .select('*')
        .eq('id', id)
        .single();
      if (error) {
        console.error('Error al cargar receta:', error);
        alert('‚ùå Error al cargar la receta.');
        return;
      }

      const { data: materiales, error: errMat } = await window.supabaseClient
        .from(tablaMateriales)
        .select('id, material_codigo, material_nombre, bodega_principal, bodega_secundaria, cantidad, observacion')
        .eq('receta_id', id);

      // Load into form
      document.getElementById('nombreReceta').value = receta.nombre;
      document.getElementById('rubroReceta').value = receta.rubro;
      materialesReceta = materiales.map(m => ({
        material_codigo: m.material_codigo,
        material_nombre: m.material_nombre,
        cantidad: m.cantidad,
        tipo: isCaseBaseCodigo(m.material_codigo) ? 'CASE' : decodeLegacyTipoFromObs(m.observacion).tipo,
        observacion: isCaseBaseCodigo(m.material_codigo) ? (m.observacion || '') : decodeLegacyTipoFromObs(m.observacion).obs
      }));

      // Asegurar que el cat√°logo est√© cargado antes de renderizar
      if ((!gruposCatalogo || gruposCatalogo.length === 0) && (!materialesCatalogo || materialesCatalogo.length === 0)) {
        try {
          await cargarCatalogo();
        } catch (error) {
          console.error('Error cargando cat√°logos:', error);
        }
      }

      renderListaMateriales();

      isEditing = true;
      editingId = id;
      const btn = document.getElementById('btnGuardarReceta');
      btn.textContent = 'üíæ Actualizar Receta';
    };

    // =====================================================
    // üóëÔ∏è Eliminar Receta
    // =====================================================
    window.eliminarReceta = async (id) => {
      if (!confirm('¬øEst√°s seguro de que quieres eliminar esta receta? Esta acci√≥n no se puede deshacer.')) {
        return;
      }

      const tablaRecetas = modoCreacion === 'PLANTILLAS' ? 'recetas' : 'recetas_especificas';
      const tablaMateriales = modoCreacion === 'PLANTILLAS' ? 'recetas_materiales' : 'recetas_especificas_materiales';

      try {
        // Delete materials first
        await window.supabaseClient.from(tablaMateriales).delete().eq('receta_id', id);
        // Delete recipe
        const { error } = await window.supabaseClient.from(tablaRecetas).delete().eq('id', id);
        if (error) {
          console.error('Error al eliminar receta:', error);
          alert('‚ùå Error al eliminar la receta.');
          return;
        }
        alert('‚úÖ Receta eliminada con √©xito.');
        cargarRecetasExistentes();
      } catch (err) {
        console.error('Error:', err);
        alert('‚ùå Error al eliminar la receta.');
      }
    };

    // =====================================================
    // üöÄ Iniciar
    // =====================================================
    async function init() {
      // cat√°logo activo
      setCatalogoKey(loadCatalogoKey());

      // Cargar grupos/plantillas (desde tabla simplificada).
      try {
        const { data: gruposData, error } = await window.supabaseClient
          .from('recetas_plantillas_materiales')
          .select('id, nombre_plantilla, descripcion, tipo, activo, catalogos, bodega_secundaria, dimensiones')
          .eq('activo', true)
          .order('nombre_plantilla', { ascending: true });

        if (error) throw error;

        gruposCatalogo = (Array.isArray(gruposData) ? gruposData : []).map(g => {
          let dims_text = '';
          if (g.dimensiones) {
            const d = g.dimensiones;
            dims_text = [
              d.ancho, d.largo, d.grosor,
              d.diametro && !d.ancho ? d.diametro : null, d.largo,
              d.alto, d.ancho, d.largo
            ].filter(x => x).join('x');
          }
          return {
            clave: g.nombre_plantilla,  // Usar nombre_plantilla como clave en lugar de PLANTILLA|id
            nombre: g.nombre_plantilla,
            descripcion: g.descripcion,
            tipo: g.tipo,
            catalogo: g.catalogos ? g.catalogos.join(', ') : '',
            bodega_secundaria: g.bodega_secundaria || [],
            dimensiones: dims_text,
            count: 1
          };
        });

      } catch (err) {
        console.warn('Error cargando plantillas:', err);
        gruposCatalogo = [];
      }

      await cargarCatalogo();
      poblarFiltrosSegunModo();
      renderListaMateriales();
      cargarRecetasExistentes();

      // Evento para abrir cat√°logo
      document.getElementById('btnAbrirCatalogo').addEventListener('click', () => {
        document.getElementById('modalCatalogo').classList.add('active');
        // Asegurar que la vista est√© aplicada correctamente
        const vistaGuardada = localStorage.getItem('catalogoVista') || 'cards';
        cambiarVista(vistaGuardada);
        renderizarResultadosCatalogo();
      });

      // Evento para refrescar lista
      document.getElementById('recetas-refresh-list').addEventListener('click', cargarRecetasExistentes);

      // Eventos del panel de b√∫squeda
      document.getElementById('modoCreacion').value = modoCreacion;
      document.getElementById('modoCreacion').addEventListener('change', (e) => {
        modoCreacion = e.target.value;
        // Limpiar estado de edici√≥n al cambiar modo para evitar conflictos
        editingId = null;
        isEditing = false;
        document.getElementById('btnGuardarReceta').textContent = 'üíæ Guardar Receta';
        document.getElementById('nombreReceta').value = '';
        document.getElementById('rubroReceta').value = '';
        materialesReceta = [];
        renderListaMateriales();
        poblarFiltrosSegunModo();
        renderResultadosBusquedaRecetas();
        cargarRecetasExistentes(); // Recargar lista de recetas al cambiar modo
      });
      document.getElementById('buscador-nombre-recetas').addEventListener('input', renderResultadosBusquedaRecetas);
      document.getElementById('filtro-bodega-principal-recetas').addEventListener('change', (e) => {
        actualizarFiltrosSecundarios();
        renderizarResultadosCatalogo();
      });
      document.getElementById('filtro-bodega-secundaria-recetas').addEventListener('change', (e) => {
        renderResultadosBusquedaRecetas();
      });
      document.getElementById('btn-restablecer-filtros-recetas').addEventListener('click', () => {
        document.getElementById('buscador-nombre-recetas').value = '';
        document.getElementById('filtro-bodega-principal-recetas').value = 'todas';
        document.getElementById('filtro-bodega-secundaria-recetas').value = 'todas';
        poblarFiltrosBodega();
        renderResultadosBusquedaRecetas();
      });
    }

    verReceta = async (id) => {
      const tablaRecetas = modoCreacion === 'PLANTILLAS' ? 'recetas' : 'recetas_especificas';

      // Poblar el modal correctamente
      const contenedor = document.getElementById('detallesReceta');

      // Verificar si los cat√°logos est√°n cargados (solo necesario para recetas espec√≠ficas)
      if (modoCreacion !== 'PLANTILLAS') {
        if ((!gruposCatalogo || gruposCatalogo.length === 0) && (!materialesCatalogo || materialesCatalogo.length === 0)) {
          try {
            await cargarCatalogo();
          } catch (error) {
            console.error('Error cargando cat√°logos:', error);
            contenedor.innerHTML = `
              <div class="receta-detalles">
                <div class="receta-info">
                  <h3>Error</h3>
                  <p>No se pudieron cargar los datos del cat√°logo.</p>
                </div>
              </div>
            `;
            modalVerReceta.classList.add('active');
            return;
          }
        }
      }

      // Obtener datos de la receta
      const { data: receta, error: errorReceta } = await window.supabaseClient
        .from(tablaRecetas)
        .select('*')
        .eq('id', id)
        .single();
      if (errorReceta) {
        console.error('Error obteniendo receta:', errorReceta);
        alert('No se pudo cargar la receta.');
        return;
      }

      // Obtener materiales seg√∫n el modo
      const tablaMateriales = modoCreacion === 'PLANTILLAS' ? 'recetas_materiales' : 'recetas_especificas_materiales';
      let materiales = [];
      const { data: mats, error: errorMats } = await window.supabaseClient
        .from(tablaMateriales)
        .select('id, material_codigo, material_nombre, bodega_principal, bodega_secundaria, cantidad, observacion')
        .eq('receta_id', id);

      if (errorMats) {
        console.error('Error obteniendo materiales:', errorMats);
        alert('No se pudieron cargar los materiales.');
        return;
      }

      materiales = mats || [];

      // Renderizar filas de materiales como tabla
      let materialesList = '';
      if (!materiales || materiales.length === 0) {
        materialesList = '<div style="text-align: center; padding: 40px 20px; color: #6c757d; font-style: italic; background: rgba(108, 117, 125, 0.1); border-radius: 12px; border: 2px dashed rgba(108, 117, 125, 0.3);"><div style="font-size: 3em; margin-bottom: 16px;">üì¶</div><div style="font-size: 1.1em; font-weight: 500;">Esta receta no tiene materiales asignados</div><div style="font-size: 0.9em; margin-top: 8px; opacity: 0.8;">Agregue materiales desde el cat√°logo para completar la receta</div></div>';
      } else {
        materialesList = `
          <table class="receta-view-materiales-table">
            <thead>
              <tr>
                <th class="receta-view-table-header-number">#</th>
                <th class="receta-view-table-header-name">Material</th>
                <th class="receta-view-table-header-bodega">Bodega</th>
                <th class="receta-view-table-header-cantidad">Cantidad</th>
              </tr>
            </thead>
            <tbody>`;

        materiales.forEach((mat, idx) => {
          let nombre = mat.material_nombre || mat.material_codigo;
          let bodega = mat.bodega_principal || '';
          let cantidad = mat.cantidad || 1;

          // Asegurar que bodega sea string
          if (Array.isArray(bodega)) {
            bodega = bodega.join(', ');
          } else if (bodega === null || bodega === undefined) {
            bodega = 'Sin asignar';
          }

          materialesList += `
              <tr class="receta-view-table-row">
                <td class="receta-view-table-cell-number">${idx + 1}</td>
                <td class="receta-view-table-cell-name">${nombre}</td>
                <td class="receta-view-table-cell-bodega">üìç ${bodega}</td>
                <td class="receta-view-table-cell-cantidad">${cantidad}</td>
              </tr>`;
        });

        materialesList += `
            </tbody>
          </table>`;
      }

      // Calcular total de art√≠culos y suma de cantidades
      const totalArticulos = materiales.length;
      const totalCantidades = materiales.reduce((sum, mat) => sum + (parseInt(mat.cantidad) || 0), 0);

      contenedor.innerHTML = `
        <div class="receta-view-detalles">
          <div class="receta-view-info">
            <h3>${receta.nombre}</h3>
            <p><strong>Rubro:</strong> ${receta.rubro}</p>
            <p><strong>Creado:</strong> ${new Date(receta.creado_en).toLocaleString()}</p>
          </div>
          <div class="receta-view-materiales">
            <h4>Materiales:</h4>
            <div class="receta-view-materiales-lista">
              ${materialesList}
            </div>
            <div class="receta-view-total-separator">
              <hr class="receta-view-divider">
              <div class="receta-view-total-count">
                <span class="receta-view-total-label">Total de art√≠culos:</span>
                <span class="receta-view-total-number">${totalArticulos}</span>
              </div>
              <div class="receta-view-total-quantities">
                <span class="receta-view-quantities-label">Suma total de cantidades:</span>
                <span class="receta-view-quantities-number">${totalCantidades}</span>
              </div>
            </div>
          </div>
        </div>
      `;

      // Mostrar modal
      modalVerReceta.classList.add('active');
    };
    // Cerrar modal al hacer clic fuera
    modalCatalogo.addEventListener('click', (e) => {
      if (e.target === modalCatalogo) {
        modalCatalogo.classList.remove('active');
      }
    });

    // Cerrar modal con bot√≥n X
    document.getElementById('btnCerrarModal').addEventListener('click', () => {
      modalCatalogo.classList.remove('active');
    });

    // Cerrar modal con tecla Escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && modalCatalogo.classList.contains('active')) {
        modalCatalogo.classList.remove('active');
      }
    });

    // =====================================================
    // üéØ FUNCIONALIDAD DEL MODAL DE VER RECETA
    // =====================================================
    const modalVerReceta = document.getElementById('modalVerReceta');
    const btnCerrarModalVer = document.getElementById('btnCerrarModalVer');

    // Cerrar modal
    btnCerrarModalVer.addEventListener('click', () => {
      modalVerReceta.classList.remove('active');
    });

    // Cerrar modal al hacer clic fuera
    modalVerReceta.addEventListener('click', (e) => {
      if (e.target === modalVerReceta) {
        modalVerReceta.classList.remove('active');
      }
    });

    // Cerrar modal con tecla Escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && modalVerReceta.classList.contains('active')) {
        modalVerReceta.classList.remove('active');
      }
    });

    // =====================================================
    // üéØ FUNCIONALIDAD DEL SWITCH DE VISTA
    // =====================================================
    btnVistaLista = document.getElementById('btnVistaLista');
    btnVistaTarjetas = document.getElementById('btnVistaTarjetas');
    resultadosContainer = document.getElementById('resultados-busqueda-recetas');

    // Funci√≥n para actualizar filtros secundarios cuando cambia la bodega principal
    function actualizarFiltrosSecundarios() {
      const selectPrincipal = document.getElementById('filtro-bodega-principal-recetas');
      const selectSecundaria = document.getElementById('filtro-bodega-secundaria-recetas');
      
      if (!selectPrincipal || !selectSecundaria) return;
      
      const bodegaPrincipalSeleccionada = selectPrincipal.value;
      
      // Obtener bodegas secundarias filtradas
      let bodegasSecundarias;
      if (modoCreacion === 'PLANTILLAS') {
        // Para plantillas, filtrar por cat√°logo (bodega principal)
        if (bodegaPrincipalSeleccionada === 'todas') {
          bodegasSecundarias = [...new Set(gruposCatalogo.flatMap(m => (m.bodega_secundaria || []).filter(Boolean)))].sort();
        } else {
          const gruposFiltrados = gruposCatalogo.filter(m => {
            const catalogos = [m.catalogo, ...(m.catalogos || [])].filter(Boolean);
            return catalogos.includes(bodegaPrincipalSeleccionada);
          });
          bodegasSecundarias = [...new Set(gruposFiltrados.flatMap(m => (m.bodega_secundaria || []).filter(Boolean)))].sort();
        }
      } else {
        // Para c√≥digos, filtrar por bodega principal
        if (bodegaPrincipalSeleccionada === 'todas' || bodegaPrincipalSeleccionada === 'sin_bodega') {
          bodegasSecundarias = [...new Set(materialesCatalogo.flatMap(m => {
            const sec = m.bodega_secundaria;
            if (Array.isArray(sec)) return sec.filter(Boolean);
            return sec ? [sec] : [];
          }))].sort();
        } else {
          const materialesFiltrados = materialesCatalogo.filter(m => m.bodega_principal === bodegaPrincipalSeleccionada);
          bodegasSecundarias = [...new Set(materialesFiltrados.flatMap(m => {
            const sec = m.bodega_secundaria;
            if (Array.isArray(sec)) return sec.filter(Boolean);
            return sec ? [sec] : [];
          }))].sort();
        }
      }
      
      // Limpiar y agregar opci√≥n "Todas"
      selectSecundaria.innerHTML = '<option value="todas">Todas las Bodegas</option>';
      
      // Agregar bodegas secundarias filtradas
      bodegasSecundarias.forEach(bodega => {
        const option = document.createElement('option');
        option.value = bodega;
        option.textContent = bodega;
        selectSecundaria.appendChild(option);
      });
      
      // Resetear selecci√≥n a "todas"
      selectSecundaria.value = 'todas';
    }

    // Exponer funci√≥n globalmente
    window.actualizarFiltrosSecundarios = actualizarFiltrosSecundarios;

    // Funci√≥n para poblar filtros de bodega
    function poblarFiltrosBodega(filtroPrincipal = 'todas', filtroSecundaria = 'todas') {
      const selectPrincipal = document.getElementById('filtro-bodega-principal-recetas');
      const selectSecundaria = document.getElementById('filtro-bodega-secundaria-recetas');

      if (!selectPrincipal || !selectSecundaria) return;

      // Obtener bodegas principales √∫nicas
      const bodegasPrincipales = [...new Set(materialesCatalogo.map(m => m.bodega_principal).filter(Boolean))].sort();

      // Obtener bodegas secundarias, filtradas por bodega principal si no es "todas"
      let bodegasSecundarias;
      if (filtroPrincipal === 'todas' || filtroPrincipal === 'sin_bodega') {
        bodegasSecundarias = [...new Set(materialesCatalogo.flatMap(m => {
          const sec = m.bodega_secundaria;
          if (Array.isArray(sec)) return sec.filter(Boolean);
          return sec ? [sec] : [];
        }))].sort();
      } else {
        // Filtrar materiales que tengan la bodega principal seleccionada
        const materialesFiltrados = materialesCatalogo.filter(m => m.bodega_principal === filtroPrincipal);
        bodegasSecundarias = [...new Set(materialesFiltrados.flatMap(m => {
          const sec = m.bodega_secundaria;
          if (Array.isArray(sec)) return sec.filter(Boolean);
          return sec ? [sec] : [];
        }))].sort();
      }

      console.log('Bodegas principales encontradas:', bodegasPrincipales);
      console.log('Bodegas secundarias encontradas (filtradas):', bodegasSecundarias);

      // Verificar si hay materiales sin bodega principal
      const hasSinBodega = materialesCatalogo.some(m => !m.bodega_principal);

      // Limpiar y agregar opci√≥n "Todas"
      selectPrincipal.innerHTML = '<option value="todas">Todas las Bodegas</option>';
      selectSecundaria.innerHTML = '<option value="todas">Todas las Bodegas</option>';

      // Agregar opci√≥n "Sin Bodega" si aplica
      if (hasSinBodega) {
        selectPrincipal.innerHTML += '<option value="sin_bodega">Sin Bodega</option>';
      }

      // Agregar bodegas principales
      bodegasPrincipales.forEach(bodega => {
        const option = document.createElement('option');
        option.value = bodega;
        option.textContent = bodega;
        selectPrincipal.appendChild(option);
      });

      // Agregar bodegas secundarias
      bodegasSecundarias.forEach(bodega => {
        const option = document.createElement('option');
        option.value = bodega;
        option.textContent = bodega;
        selectSecundaria.appendChild(option);
      });

      // Establecer valores si se proporcionan
      if (filtroPrincipal !== 'todas') selectPrincipal.value = filtroPrincipal;
      if (filtroSecundaria !== 'todas') selectSecundaria.value = filtroSecundaria;
    }

    // Funci√≥n para poblar filtros seg√∫n modo
    function poblarFiltrosSegunModo() {
      if (modoCreacion === 'PLANTILLAS') {
        poblarFiltrosPlantillas();
      } else {
        poblarFiltrosBodega();
      }
    }

    // Exponer funci√≥n globalmente
    window.poblarFiltrosSegunModo = poblarFiltrosSegunModo;
    window.poblarFiltrosBodega = poblarFiltrosBodega;
    function cambiarVista(vista) {
      vistaActual = vista;
      
      // Actualizar botones
      document.querySelectorAll('.view-option').forEach(btn => {
        if (btn.classList) btn.classList.remove('active');
      });
      
      if (vista === 'list') {
        if (btnVistaLista && btnVistaLista.classList) btnVistaLista.classList.add('active');
        if (resultadosContainer) resultadosContainer.className = 'results-list-modal';
      } else {
        if (btnVistaTarjetas && btnVistaTarjetas.classList) btnVistaTarjetas.classList.add('active');
        if (resultadosContainer) resultadosContainer.className = 'results-grid-modal';
      }
      
      // Guardar preferencia
      localStorage.setItem('catalogoVista', vista);
      
      // Re-renderizar resultados si existen
      if (window.renderizarResultadosCatalogo) {
        window.renderizarResultadosCatalogo();
      }
    }

    // Event listeners para el switch
    if (btnVistaLista) btnVistaLista.addEventListener('click', () => cambiarVista('list'));
    if (btnVistaTarjetas) btnVistaTarjetas.addEventListener('click', () => cambiarVista('cards'));

    // Cargar vista guardada
    const vistaGuardada = localStorage.getItem('catalogoVista') || 'cards';
    cambiarVista(vistaGuardada);

    // Event listeners para filtros
    document.getElementById('buscador-nombre-recetas')?.addEventListener('input', () => {
      renderizarResultadosCatalogo();
    });

    document.getElementById('filtro-bodega-principal-recetas')?.addEventListener('change', () => {
      actualizarFiltrosSecundarios();
      renderizarResultadosCatalogo();
    });

    document.getElementById('filtro-bodega-secundaria-recetas')?.addEventListener('change', () => {
      renderizarResultadosCatalogo();
    });

    document.getElementById('btn-restablecer-filtros-recetas')?.addEventListener('click', () => {
      document.getElementById('buscador-nombre-recetas').value = '';
      document.getElementById('filtro-bodega-principal-recetas').value = 'todas';
      document.getElementById('filtro-bodega-secundaria-recetas').value = 'todas';
      poblarFiltrosSegunModo();
      renderizarResultadosCatalogo();
    });

    init();
  </script>
</body>
</html>
