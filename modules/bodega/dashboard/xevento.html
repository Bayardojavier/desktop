<div style="display:flex; gap:20px; height:100%;">

  <div style="flex:1; display:flex; flex-direction:column; gap:20px;">

    <!-- KPIs -->
    <div style="display:flex; gap:20px;">
      <div class="bodega-resumen-card">
        <div>Despachos</div>
        <div class="valor" id="kpi-despachos">‚Äì</div>
      </div>
      <div class="bodega-resumen-card">
        <div>√çtems √önicos</div>
        <div class="valor" id="kpi-items">‚Äì</div>
      </div>
      <div class="bodega-resumen-card">
        <div>Total Unidades</div>
        <div class="valor" id="kpi-unidades">‚Äì</div>
      </div>
      <div class="bodega-resumen-card">
        <div>Faltantes</div>
        <div class="valor" id="kpi-faltantes">‚Äì</div>
      </div>
    </div>

    <!-- Filtros -->
    <div class="bodega-filtros">
      <div class="bodega-filtro-grupo">
        <label>Evento</label>
        <select id="filtro-evento" class="dashboard-select">
          <option value="">Seleccione un evento...</option>
        </select>
      </div>
      <div class="bodega-filtro-grupo">
        <label>Organizar por</label>
        <select id="filtro-organizacion" class="dashboard-select">
          <option value="items">Por √≠tems</option>
          <option value="fecha">Por fecha</option>
          <option value="despacho">Por despacho</option>
          <option value="devolucion">Por devoluci√≥n</option>
          <option value="bodega">Por bodega</option>
        </select>
      </div>
      <button id="btn-exportar-xevento" class="bodega-export-pdf-btn">üìÑ Exportar Consolidado</button>
      <button id="btn-exportar-xevento-xlsx" class="bodega-export-pdf-btn" style="margin-left:8px">üìä Exportar Excel</button>
    </div>

    <!-- Info Evento -->
    <div id="info-evento"
      style="display:none; background:rgba(20,30,60,.6); border:1px solid rgba(99,102,241,.2); border-radius:12px; padding:16px;">
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
        <div><strong style="color: #93c5fd;">Cliente:</strong> <span id="cliente-evento" style="color: #e0e0ff;">‚Äì</span></div>
        <div><strong style="color: #93c5fd;">Lugar:</strong> <span id="lugar-evento" style="color: #e0e0ff;">‚Äì</span></div>
        <div><strong style="color: #93c5fd;">Fecha inicio salidas:</strong> <span id="fecha-evento" style="color: #e0e0ff;">‚Äì</span></div>
      </div>
    </div>

    <!-- Resumen ejecutivo + Timeline -->
    <div id="resumen-ejecutivo" style="display:none; background:rgba(255,255,255,0.02); border:1px solid rgba(99,102,241,0.08); border-radius:10px; padding:12px;">
      <div style="display:flex; gap:12px; align-items:flex-start;">
        <div id="resumen-metrics" style="flex:1; min-width:220px;">
          <!-- KPIs ser√°n rellenados por JS -->
        </div>
        <div id="timeline-evento" style="flex:2; min-width:320px;">
          <!-- Timeline simple -->
        </div>
      </div>
    </div>

    <!-- Tabla -->
    <div id="tabla-movimientos-evento" style="flex:1; overflow:auto;">
      <p style="text-align:center; color:#cbd5e1; margin-top:40px;">
        Seleccione un evento
      </p>
    </div>

  </div>
</div>

<style>
.bodega-resumen-card{
  background:rgba(20,30,60,.6);
  border:1px solid rgba(99,102,241,.2);
  border-radius:8px;
  padding:12px;
  min-width:160px;
  text-align:center;
  color:#cbd5e1;
}
.bodega-resumen-card .valor{
  font-size:24px;
  font-weight:bold;
  color:#64b5f6;
}
.dashboard-boton.export-pdf {
  background: linear-gradient(135deg, #1e40af, #3730a3);
  color: white;
  padding: 10px 20px;
  font-weight: 600;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  font-size: 14px;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
  transition: all 0.2s;
}

.dashboard-boton.export-pdf:hover {
  background: linear-gradient(135deg, #313a9f, #2c2685);
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
}

/* ‚úÖ ESTILOS PARA LA TABLA: texto s√≥lido y legible */
.bodega-table {
  width: 100%;
  border-collapse: collapse;
  color: #e0e0ff; /* ‚úÖ Texto blanco s√≥lido para toda la tabla */
}

.bodega-table th,
.bodega-table td {
  padding: 12px;
  text-align: left;
  border-bottom: 1px solid rgba(99, 102, 241, 0.2);
}

.bodega-table th {
  color: #93c5fd; /* Color de los encabezados de columna */
  font-weight: 600;
  background: rgba(20, 30, 60, 0.4);
}

.bodega-table tr:hover {
  background: rgba(40, 50, 90, 0.4);
}

.data-row { cursor: pointer; }
.detalle-row { display: none; background: rgba(255,255,255,0.02); }
.detalle-row td { padding: 10px; font-size: 12px; color: #94a3b8; }
.timeline-item { display:inline-flex; gap:8px; align-items:center; padding:6px; border-radius:6px; background:rgba(255,255,255,0.02); margin-right:6px; }
</style>

<script>
(function(){

  const estado = {
    supabase: window.supabaseClient || null,
    movimientosActuales: [],
    bodegaPorCodigo: new Map(),
  };

  function normalizarFecha(valor){
    if(!valor) return null;
    const d = new Date(valor);
    return Number.isNaN(d.getTime()) ? null : d;
  }

  // removed attachRowToggle: no expandable rows anymore

  // Formatea una fecha ISO/Timestamp a la fecha local legible (ej. 03/02/2026)
  function formatFecha(valor){
    if(!valor) return '';
    const d = new Date(valor);
    if(Number.isNaN(d.getTime())) return String(valor);
    try{
      return d.toLocaleDateString('es-NI');
    }catch(e){
      return d.toISOString().slice(0,10);
    }
  }

  // Formatea fecha + hora a representaci√≥n local (ej. 03/02/2026 14:30)
  function formatDateTime(fecha, hora){
    if(!fecha) return '‚Äì';
    try{
      if(hora) return new Date(fecha + 'T' + hora).toLocaleString('es-NI');
      return new Date(fecha).toLocaleString('es-NI');
    }catch(e){
      return fecha + (hora ? (' ' + hora) : '');
    }
  }

  // Derivar la bodega desde el c√≥digo del material.
  // Formatos esperados: "00006-AUDI", o c√≥digos largos donde las posiciones 6-10 indican la bodega.
  function resolveBodegaFromCodigo(codigo){
    if(!codigo) return null;
    const s = String(codigo).toUpperCase().trim();
    let key = null;
    if(s.includes('-')){
      const parts = s.split('-');
      if(parts[1]) key = parts[1];
    }
    if(!key && s.length >= 10){
      // posiciones 6..10 (1-based) => substring(5,10)
      key = s.substring(5,10);
    }
    if(!key) key = s.slice(-4);
    if(!key) return null;
    // Mapeo simple
    if(key.includes('AUD') || key.startsWith('AUDI') || key.startsWith('AU')) return 'Audiovisual';
    if(key.includes('HIER') || key.startsWith('HIER') || key.startsWith('HI')) return 'Hierros';
    if(key.includes('CONS') || key.startsWith('CONS') || key.startsWith('CO')) return 'Consumibles';
    return null;
  }

  function limpiarUI(){
    const cont = document.getElementById('tabla-movimientos-evento');
    const info = document.getElementById('info-evento');
    cont.innerHTML = `<p style="text-align:center;color:#cbd5e1;margin-top:40px;">Seleccione un evento</p>`;
    info.style.display = 'none';
    document.getElementById('kpi-despachos').textContent = '‚Äì';
    document.getElementById('kpi-items').textContent = '‚Äì';
    document.getElementById('kpi-unidades').textContent = '‚Äì';
    document.getElementById('kpi-faltantes').textContent = '‚Äì';
  }

  function poblarSelectEventos(nombres){
    const select = document.getElementById('filtro-evento');
    while(select.options.length > 1) select.remove(1);
    (nombres || []).forEach(nombre => {
      const opt = document.createElement('option');
      opt.value = nombre;
      opt.textContent = nombre;
      select.appendChild(opt);
    });
  }

  async function cargarEventos(){
    if(!estado.supabase){
      console.warn('Supabase client no disponible en window.supabaseClient');
      poblarSelectEventos([]);
      return;
    }

    // Preferir la tabla `eventos` para listar todos los eventos registrados
    try{
      const { data: evData, error: evErr } = await estado.supabase
        .from('eventos')
        .select('nombre,cliente,lugar,fecha_montaje,estado')
        .neq('estado', 'cancelado')
        .order('fecha_montaje', { ascending: true })
        .limit(5000);

      if(evErr){
        console.warn('No se pudo cargar eventos desde `eventos`:', evErr);
        throw evErr;
      }

      const nombres = Array.from(new Set((evData || []).map(r => (r.nombre || '').trim()).filter(Boolean)))
        .sort((a,b)=>a.localeCompare(b));
      poblarSelectEventos(nombres);
      return;
    } catch(e){
      // Fallback: usar eventos extra√≠dos de despachos_logistica (compatibilidad con datos antiguos)
      console.warn('Falling back a despachos_logistica para poblar eventos:', e);
      try{
        const { data, error } = await estado.supabase
          .from('despachos_logistica')
          .select('evento')
          .not('evento', 'is', null)
          .limit(5000);

        if(error){
          console.error('Error cargando eventos desde despachos_logistica (fallback):', error);
          poblarSelectEventos([]);
          return;
        }

        const unicos = Array.from(new Set((data || []).map(r => (r.evento || '').trim()).filter(Boolean)))
          .sort((a,b)=>a.localeCompare(b));
        poblarSelectEventos(unicos);
        return;
      } catch(inner){
        console.error('Fallback failed:', inner);
        poblarSelectEventos([]);
        return;
      }
    }
  }

  async function cargarBodegaPorCodigos(codigos){
    estado.bodegaPorCodigo = new Map();
    const lista = Array.from(new Set((codigos || []).filter(Boolean)));
    if(!estado.supabase || lista.length === 0) return;

    const lotes = [];
    const tam = 800;
    for(let i=0;i<lista.length;i+=tam) lotes.push(lista.slice(i, i+tam));

    for(const lote of lotes){
      // En V2 compat, catalogo expone bodega_secundaria (no 'bodega').
      // En legacy, puede existir 'bodega' y no 'bodega_secundaria'.
      let { data, error } = await estado.supabase
        .from('catalogo')
        .select('codigo,bodega_secundaria')
        .eq('es_contenedor', false)
        .in('codigo', lote);

      if(error){
        const msg = (error.message || '').toLowerCase();
        const missingCol = (msg.includes('does not exist') && msg.includes('bodega_secundaria')) || error.code === '42703';
        if (missingCol) {
          const retry = await estado.supabase
            .from('catalogo')
            .select('codigo,bodega')
            .eq('es_contenedor', false)
            .in('codigo', lote);
          data = retry.data;
          error = retry.error;
        }
      }

      if(error){
        console.error('Error cargando bodegas desde catalogo:', error);
        continue;
      }

      (data || []).forEach(row => {
        if(!row || !row.codigo) return;
        const b = row.bodega_secundaria || row.bodega || '-';
        estado.bodegaPorCodigo.set(row.codigo, b);
      });
    }
  }

  async function cargarMovimientosPorEvento(eventoNombre){
    const supabase = estado.supabase;
    if(!supabase) throw new Error('Supabase client no disponible');

    const { data: despachos, error: errDesp } = await supabase
      .from('despachos_logistica')
      .select('id,numero_despacho,evento,encargado_evento,fecha_despacho,cliente,lugar_montaje')
      .eq('evento', eventoNombre)
      .order('fecha_despacho', { ascending: true });

    if(errDesp) throw errDesp;

    const despachoIds = (despachos || []).map(d => d.id).filter(Boolean);
    let items = [];

    if(despachoIds.length > 0){
      const { data: itemsData, error: errItems } = await supabase
        .from('items_despacho_logistica')
        .select('*')
        .in('despacho_id', despachoIds);
      if(errItems) throw errItems;
      items = itemsData || [];
    }

    const itemsPorDespacho = new Map();
    items.forEach(it => {
      if(!it || !it.despacho_id) return;
      const arr = itemsPorDespacho.get(it.despacho_id) || [];
      arr.push(it);
      itemsPorDespacho.set(it.despacho_id, arr);
    });

    const movimientosDespacho = (despachos || []).map(d => {
      const idDoc = d.numero_despacho || d.id;
      const itemsDoc = (itemsPorDespacho.get(d.id) || []).map(it => ({
        codigo: (it.codigo_material || it.material_codigo || '').toString().trim(),
        nombre: it.nombre_material || it.material_nombre || '',
        cantidad: Number(it.cantidad_despachada ?? it.cantidad ?? 0),
      }));
      return {
        id: String(idDoc),
        tipo: 'despacho',
        fecha: d.fecha_despacho,
        evento: d.evento,
        encargado: d.encargado_evento || '-',
        cliente: d.cliente || '-',
        lugar: d.lugar_montaje || '-',
        items: itemsDoc,
      };
    });

    let devoluciones = [];
    try{
      const { data: devData, error: errDev } = await supabase
        .from('devoluciones')
        .select('id,fecha,encargado_ingreso,evento,items')
        .eq('evento', eventoNombre)
        .order('fecha', { ascending: true });
      if(errDev){
        console.warn('No se pudieron cargar devoluciones:', errDev);
      } else {
        devoluciones = devData || [];
      }
    } catch (e){
      console.warn('No se pudieron cargar devoluciones:', e);
    }

    const movimientosDevolucion = devoluciones.map(dev => {
      const itemsDev = Array.isArray(dev.items) ? dev.items : [];
      const itemsDoc = itemsDev.map(it => ({
        codigo: it.codigo || it.material_codigo,
        nombre: it.nombre || it.material_nombre,
        cantidad: Number(it.cantidadRecibida || it.cantidad_recibida || it.cantidad || 0),
      })).filter(it => it.codigo);

      return {
        id: String(dev.id || '-'),
        tipo: 'devolucion',
        fecha: dev.fecha,
        evento: dev.evento,
        encargado: dev.encargado_ingreso || '-',
        items: itemsDoc,
      };
    });

    // --- Incluir materiales da√±ados y faltantes registrados directamente por evento ---
    let materialesDanados = [];
    try{
      const { data: md, error: mdErr } = await supabase
        .from('materiales_danados')
        .select('id,material_codigo,material_nombre,cantidad,evento,fecha_proceso,fecha_despacho,numero_despacho,encargado_evento')
        .eq('evento', eventoNombre)
        .order('created_at', { ascending: true });
      if(mdErr) {
        console.warn('No se pudieron cargar materiales_danados:', mdErr);
      } else {
        materialesDanados = md || [];
      }
    } catch(e){
      console.warn('Error cargando materiales_danados:', e);
    }

    const movimientosDanados = materialesDanados.map(r => ({
      id: String(r.id || '-'),
      tipo: 'danado',
      fecha: r.fecha_proceso || r.fecha_despacho || null,
      evento: r.evento || eventoNombre,
      encargado: r.encargado_evento || '-',
      items: [{ codigo: r.material_codigo, nombre: r.material_nombre, cantidad: Number(r.cantidad || 0) }]
    }));

    let materialesFaltantes = [];
    try{
      const { data: mf, error: mfErr } = await supabase
        .from('materiales_faltantes')
        .select('id,material_codigo,material_nombre,cantidad_faltante,cantidad_despachada,evento,fecha_despacho,numero_despacho,encargado_evento')
        .eq('evento', eventoNombre)
        .order('created_at', { ascending: true });
      if(mfErr) {
        console.warn('No se pudieron cargar materiales_faltantes:', mfErr);
      } else {
        materialesFaltantes = mf || [];
      }
    } catch(e){
      console.warn('Error cargando materiales_faltantes:', e);
    }

    const movimientosFaltantes = materialesFaltantes.map(r => ({
      id: String(r.id || '-'),
      tipo: 'faltante',
      fecha: r.fecha_despacho || null,
      evento: r.evento || eventoNombre,
      encargado: r.encargado_evento || '-',
      items: [{ codigo: r.material_codigo, nombre: r.material_nombre, cantidad: Number(r.cantidad_faltante || 0) }]
    }));

    // --- Buscar movimientos registrados directamente en las tablas movimientos_bodega_*
    // que referencien el n√∫mero de despacho (ej. p√©rdidas/da√±os registrados ah√≠)
    let movimientosDesdeTablas = [];
    try{
      const despachoNumeros = (despachos || []).map(d => (d.numero_despacho || '').toString().trim()).filter(Boolean);
      if(despachoNumeros.length){
        const tablas = ['movimientos_bodega_audiovisual','movimientos_bodega_hierros','movimientos_bodega_consumibles'];
        for(const tabla of tablas){
          for(const num of despachoNumeros){
            try{
              const { data: rows, error: rowsErr } = await supabase
                .from(tabla)
                .select('id,material_codigo,material_nombre,cantidad,tipo_movimiento,referencia_documento,fecha_movimiento,responsable,bodega_principal,bodega_secundaria,ubicacion_codigo')
                .ilike('referencia_documento', `%${num}%`)
                .order('fecha_movimiento', { ascending: true });
              if(rowsErr){
                console.warn(`Error consultando ${tabla} by referencia ${num}:`, rowsErr);
                continue;
              }
              (rows || []).forEach(r => {
                // marcar origen de tabla para diagn√≥stico
                r.__tabla = tabla;
                movimientosDesdeTablas.push(r);
              });
            } catch(e){
              console.warn(`Error interno consultando ${tabla} referencia ${num}:`, e);
            }
          }
        }
      }
    } catch(e){
      console.warn('Error buscando movimientos en tablas por numero_despacho:', e);
    }

    // Mapear movimientos desde tablas a objetos est√°ndar con items
    const movimientosExtra = movimientosDesdeTablas.map(r => ({
      id: `${r.__tabla || 'mov'}-${r.id || 'x'}`,
      tipo: (r.tipo_movimiento || 'movimiento') ,
      fecha: r.fecha_movimiento || null,
      evento: eventoNombre,
      encargado: r.responsable || '-',
      items: [{ codigo: r.material_codigo, nombre: r.material_nombre, cantidad: Number(r.cantidad || 0) }]
    }));

    const movimientos = [...movimientosDespacho, ...movimientosDevolucion, ...movimientosDanados, ...movimientosFaltantes]
      .filter(m => m.items && m.items.length)
      .sort((a,b)=>{
        const da = normalizarFecha(a.fecha);
        const db = normalizarFecha(b.fecha);
        if(!da && !db) return 0;
        if(!da) return 1;
        if(!db) return -1;
        return da - db;
      });

    // intentar obtener metadatos y registro completo del evento (como hace despachobodega)
    let eventoMeta = {};
    let eventoCompleto = null;
    try{
      // buscar evento exacto
      let { data: eventosEncontrados, error: errEv } = await supabase
        .from('eventos')
        .select('*')
        .eq('nombre', eventoNombre);

      if((!eventosEncontrados || eventosEncontrados.length === 0) && !errEv){
        // buscar por coincidencia parcial
        const resp = await supabase
          .from('eventos')
          .select('*')
          .ilike('nombre', `%${eventoNombre}%`);
        eventosEncontrados = resp.data;
      }

      if(eventosEncontrados && eventosEncontrados.length > 0){
        eventoCompleto = eventosEncontrados[0];
        eventoMeta = {
          fecha_montaje: eventoCompleto.fecha_montaje,
          hora_montaje: eventoCompleto.hora_montaje,
          fecha_desmontaje: eventoCompleto.fecha_desmontaje,
          hora_desmontaje: eventoCompleto.hora_desmontaje
        };

        // si hay cotizacion_id, intentar obtener servicios
        try{
          if(eventoCompleto.cotizacion_id){
            const { data: cot, error: cotErr } = await supabase
              .from('cotizaciones')
              .select('servicios')
              .eq('id', eventoCompleto.cotizacion_id)
              .maybeSingle();
            if(!cotErr && cot && cot.servicios) eventoCompleto.servicios = cot.servicios;
          }
        }catch(cErr){ console.warn('No se pudo cargar cotizacion.servicios:', cErr); }
      }
    }catch(e){ console.warn('No se pudo leer metadata de eventos:', e); }

    const info = {
      cliente: (despachos && despachos[0] && despachos[0].cliente) || (eventoCompleto && (eventoCompleto.cliente || eventoCompleto.cliente_evento)) || '-',
      lugar: (despachos && despachos[0] && despachos[0].lugar_montaje) || (eventoCompleto && (eventoCompleto.lugar || eventoCompleto.lugar_montaje)) || '-',
      fechaInicio: (()=>{
        const fechas = (despachos || []).map(d => normalizarFecha(d.fecha_despacho)).filter(Boolean).sort((a,b)=>a-b);
        return fechas[0] ? fechas[0].toISOString().slice(0,10) : '-';
      })(),
      montajeFecha: eventoMeta.fecha_montaje || null,
      montajeHora: eventoMeta.hora_montaje || null,
      desmontajeFecha: eventoMeta.fecha_desmontaje || null,
      desmontajeHora: eventoMeta.hora_desmontaje || null,
      eventoCompleto: eventoCompleto || null
    };

    const codigos = [];
    movimientos.forEach(m => (m.items || []).forEach(i => codigos.push(i.codigo)));
    await cargarBodegaPorCodigos(codigos);

    return { info, movimientos };
  }

  function construirFilasYKPIs(movimientos, organizarPor = 'items'){
    // Normalizar y ordenar por fecha base
    const movsOrdenados = [...(movimientos || [])].sort((a,b)=>{
      const da = normalizarFecha(a.fecha);
      const db = normalizarFecha(b.fecha);
      if(!da && !db) return 0;
      if(!da) return 1;
      if(!db) return -1;
      return da - db;
    });

    // Flatten movements into per-item rows, keeping original columns
    const filasItems = [];
    const totalDespachadoPorItem = {};
    const totalDevueltoPorItem = {};
    const itemsUnicosSet = new Set();

    movsOrdenados.forEach(m => {
      (m.items || []).forEach(i => {
        const codigo = (i.codigo || '').toString().trim();
        if(!codigo) return;
        itemsUnicosSet.add(codigo);
        if(m.tipo === 'despacho') totalDespachadoPorItem[codigo] = (totalDespachadoPorItem[codigo] || 0) + Number(i.cantidad || 0);
        if(m.tipo === 'devolucion') totalDevueltoPorItem[codigo] = (totalDevueltoPorItem[codigo] || 0) + Number(i.cantidad || 0);
        filasItems.push({
          fecha: m.fecha || '',
          documento: m.id || '',
          tipo: m.tipo || '',
          encargado: m.encargado || '-',
          bodega: resolveBodegaFromCodigo(codigo) || estado.bodegaPorCodigo.get(codigo) || '-',
          codigo,
          nombre: i.nombre || '',
          cantidad: Number(i.cantidad || 0),
          movimientoOrigen: m,
        });
      });
    });

    // Compute faltantes por codigo (global)
    const faltantePorCodigo = {};
    Object.keys(totalDespachadoPorItem).forEach(cod => {
      const desp = totalDespachadoPorItem[cod] || 0;
      const dev = totalDevueltoPorItem[cod] || 0;
      faltantePorCodigo[cod] = Math.max(0, desp - dev);
    });

    // Apply filter based on organizarPor (only affects ordering/filtering)
    let filasFiltradas = filasItems.slice();
    if(organizarPor === 'despacho'){
      filasFiltradas = filasFiltradas.filter(r => (r.movimientoOrigen && r.movimientoOrigen.tipo === 'despacho'));
    } else if(organizarPor === 'devolucion'){
      filasFiltradas = filasFiltradas.filter(r => (r.movimientoOrigen && r.movimientoOrigen.tipo === 'devolucion'));
    }

    // Sorting rules
    if(organizarPor === 'items'){
      filasFiltradas.sort((a,b)=> (a.codigo||'').localeCompare(b.codigo||'') || (a.fecha||'').localeCompare(b.fecha||''));
    } else if(organizarPor === 'bodega'){
      filasFiltradas.sort((a,b)=> (a.bodega||'').localeCompare(b.bodega||'') || (a.codigo||'').localeCompare(b.codigo||''));
    } else if(organizarPor === 'fecha'){
      filasFiltradas.sort((a,b)=> new Date(a.fecha || 0) - new Date(b.fecha || 0));
    } else {
      // default: keep chronological
      filasFiltradas.sort((a,b)=> new Date(a.fecha || 0) - new Date(b.fecha || 0));
    }

    // Build HTML rows (full per-item columns) ‚Äî simple table, no expandable detail rows
    const filasHtml = filasFiltradas.map((r) => {
      const falt = faltantePorCodigo[r.codigo] || 0;
      return `
      <tr>
        <td>${formatFecha(r.fecha)}</td>
        <td>${r.documento}</td>
        <td>${r.tipo}</td>
        <td>${r.encargado}</td>
        <td>${r.bodega}</td>
        <td>${r.codigo}</td>
        <td>${r.nombre}</td>
        <td style="text-align:right">${r.cantidad ?? ''}</td>
        <td style="text-align:right">${falt}</td>
      </tr>
      `;
    }).join('\n');

    // KPIs (computed from all movimientos, not from filtered rows)
    const totalDespachos = movsOrdenados.filter(m => m.tipo === 'despacho').length;
    const totalUnidades = Object.values(totalDespachadoPorItem).reduce((s,v)=>s+Number(v||0),0);
    const totalFaltantes = Object.keys(faltantePorCodigo).reduce((s,c)=>s+Number(faltantePorCodigo[c]||0),0);

    return { filas: filasHtml, kpis: { totalDespachos, itemsUnicos: itemsUnicosSet.size, totalUnidades, totalFaltantes } };
  }

  async function renderizar(eventoNombre){
    const cont = document.getElementById('tabla-movimientos-evento');
    const info = document.getElementById('info-evento');

    if(!eventoNombre){
      limpiarUI();
      return;
    }

    if(!estado.supabase){
      cont.innerHTML = '<p style="text-align:center;color:#aaa;">Supabase no est√° inicializado.</p>';
      return;
    }

    cont.innerHTML = '<p style="text-align:center;color:#cbd5e1;margin-top:40px;">Cargando...</p>';

    try{
      const { info: infoEvento, movimientos } = await cargarMovimientosPorEvento(eventoNombre);
      estado.movimientosActuales = movimientos;

      document.getElementById('cliente-evento').textContent = infoEvento.cliente || '-';
      document.getElementById('lugar-evento').textContent = infoEvento.lugar || '-';
      document.getElementById('fecha-evento').textContent = infoEvento.fechaInicio || '-';
      info.style.display = 'block';

      if(!movimientos.length){
        cont.innerHTML = '<p style="text-align:center;color:#aaa;">Sin movimientos</p>';
        document.getElementById('kpi-despachos').textContent = '0';
        document.getElementById('kpi-items').textContent = '0';
        document.getElementById('kpi-unidades').textContent = '0';
        document.getElementById('kpi-faltantes').textContent = '0';
        return;
      }

      const organizarPor = document.getElementById('filtro-organizacion')?.value || 'items';
      const { filas, kpis } = construirFilasYKPIs(movimientos, organizarPor);
      document.getElementById('kpi-despachos').textContent = kpis.totalDespachos;
      document.getElementById('kpi-items').textContent = kpis.itemsUnicos;
      document.getElementById('kpi-unidades').textContent = kpis.totalUnidades;
      document.getElementById('kpi-faltantes').textContent = kpis.totalFaltantes;

      // Cabecera fija: siempre mostrar todas las columnas (vista Excel-like)
      const montajeInfo = (infoEvento && (infoEvento.montajeFecha || infoEvento.montajeHora)) ?
        `${infoEvento.montajeFecha ? formatFecha(infoEvento.montajeFecha) : ''} ${infoEvento.montajeHora || ''}` : '-';
      const desmontajeInfo = (infoEvento && (infoEvento.desmontajeFecha || infoEvento.desmontajeHora)) ?
        `${infoEvento.desmontajeFecha ? formatFecha(infoEvento.desmontajeFecha) : ''} ${infoEvento.desmontajeHora || ''}` : '-';

      const eventHeader = `Evento: ${eventoNombre} ‚Ä¢ Cliente: ${infoEvento.cliente || '-'} ‚Ä¢ Lugar: ${infoEvento.lugar || '-'} ‚Ä¢ Montaje: ${montajeInfo} ‚Ä¢ Desmontaje: ${desmontajeInfo}`;

      const headerCols = `<tr>
            <th>Fecha</th>
            <th>Documento</th>
            <th>Tipo</th>
            <th>Encargado</th>
            <th>Bodega</th>
            <th>C√≥digo</th>
            <th>Nombre</th>
            <th>Cantidad</th>
            <th>Faltante</th>
          </tr>`;

      const thead = `<tr><th colspan="9" style="text-align:left; background:rgba(20,30,60,.12);">${eventHeader}</th></tr>` + headerCols;

      // Render resumen ejecutivo + timeline
      const resumenEl = document.getElementById('resumen-ejecutivo');
      if(resumenEl){
        const metricsHtml = `<div style="display:flex;gap:12px;align-items:center;">`+
          `<div style="padding:8px;border-radius:6px;background:rgba(20,30,60,.6);min-width:80px;text-align:center;">`+
            `<div style="font-size:12px;color:#93c5fd">Despachos</div><div style="font-weight:bold;color:#64b5f6">${kpis.totalDespachos}</div></div>`+
          `<div style="padding:8px;border-radius:6px;background:rgba(20,30,60,.6);min-width:80px;text-align:center;">`+
            `<div style="font-size:12px;color:#93c5fd">√çtems</div><div style="font-weight:bold;color:#64b5f6">${kpis.itemsUnicos}</div></div>`+
          `<div style="padding:8px;border-radius:6px;background:rgba(20,30,60,.6);min-width:80px;text-align:center;">`+
            `<div style="font-size:12px;color:#93c5fd">Unidades</div><div style="font-weight:bold;color:#64b5f6">${kpis.totalUnidades}</div></div>`+
          `<div style="padding:8px;border-radius:6px;background:rgba(20,30,60,.6);min-width:80px;text-align:center;">`+
            `<div style="font-size:12px;color:#93c5fd">Faltantes</div><div style="font-weight:bold;color:#64b5f6">${kpis.totalFaltantes}</div></div>`+
        `</div>`;

        // Simple timeline: mostrar hasta 8 movimientos cronol√≥gicamente
        const timelineItems = (movimientos || []).slice(0,8).map(m => {
          const ic = m.tipo === 'despacho' ? 'üì§' : m.tipo === 'devolucion' ? 'üì•' : (m.tipo === 'danado' || m.tipo === 'faltante') ? '‚ö†Ô∏è' : 'üîÑ';
          return `<span class="timeline-item">${ic} <strong style="margin-left:4px">${formatFecha(m.fecha)}</strong> <span style="margin-left:6px;color:#94a3b8">${m.tipo}</span></span>`;
        }).join('');

        document.getElementById('resumen-metrics').innerHTML = metricsHtml;
        document.getElementById('timeline-evento').innerHTML = timelineItems;
        resumenEl.style.display = 'block';
      }

      cont.innerHTML = `
      <table class="bodega-table">
        <thead>${thead}</thead>
        <tbody>${filas}</tbody>
      </table>`;
    } catch (e){
      console.error('Error cargando consolidado por evento:', e);
      cont.innerHTML = '<p style="text-align:center;color:#aaa;">Error cargando datos del evento.</p>';
    }
  }

  document.getElementById('filtro-evento')
    .addEventListener('change',e=>renderizar(e.target.value));

  // Re-renderizar cuando cambia la organizaci√≥n: solo reordena/filtra las filas
  // sin ocultar/transformar columnas, para cumplir el comportamiento "Excel-like".
  const filtroOrgEl = document.getElementById('filtro-organizacion');
  if (filtroOrgEl) {
    filtroOrgEl.addEventListener('change', () => {
      const ev = document.getElementById('filtro-evento').value;
      if (ev) renderizar(ev);
    });
  }

  // Inicializaci√≥n
  limpiarUI();
  cargarEventos();

  // === FUNCI√ìN DE EXPORTACI√ìN FINAL ===
  document.getElementById('btn-exportar-xevento').addEventListener('click', async () => {
    const eventoSeleccionado = document.getElementById('filtro-evento').value;
    if (!eventoSeleccionado) return alert('Por favor, seleccione un evento primero.');

    // 1) Recopilar datos mostrados
    const cliente = document.getElementById('cliente-evento').textContent;
    const lugar = document.getElementById('lugar-evento').textContent;
    const fechaReporte = new Date().toLocaleDateString('es-NI');

    // 2) Preparar filas (usar estado.movimientosActuales)
    // Usamos la misma construcci√≥n que la vista: filas completas por √≠tem.
    const { filas: filasParaExportar } = construirFilasYKPIs(estado.movimientosActuales || [], document.getElementById('filtro-organizacion')?.value || 'items');

    // 2b) Obtener metadata del evento (montaje/desmontaje) para repetir en cada p√°gina del PDF
    let infoPdf = {};
    try{
      const res = await cargarMovimientosPorEvento(eventoSeleccionado);
      infoPdf = res && res.info ? res.info : {};
    }catch(e){ console.warn('No se pudo recargar metadata del evento para PDF:', e); }

    // 4) Llamar al handler nativo para generar PDF
    try {
      const filename = `Consolidado_Evento_${eventoSeleccionado.replace(/ /g,'_')}.pdf`;
      // Usar las filas ya preparadas (filasParaExportar) para el PDF.
      const filasPDF = filasParaExportar || '';
      const montajeInfoPDF = (infoPdf && (infoPdf.montajeFecha || infoPdf.montajeHora)) ? `${infoPdf.montajeFecha ? formatFecha(infoPdf.montajeFecha) : ''} ${infoPdf.montajeHora || ''}` : '-';
      const desmontajeInfoPDF = (infoPdf && (infoPdf.desmontajeFecha || infoPdf.desmontajeHora)) ? `${infoPdf.desmontajeFecha ? formatFecha(infoPdf.desmontajeFecha) : ''} ${infoPdf.desmontajeHora || ''}` : '-';
      const eventHeaderPDF = `Evento: ${eventoSeleccionado} ‚Ä¢ Cliente: ${cliente} ‚Ä¢ Lugar: ${lugar} ‚Ä¢ Montaje: ${montajeInfoPDF} ‚Ä¢ Desmontaje: ${desmontajeInfoPDF}`;

      // Cabecera fija: solo las columnas (el bloque de evento ir√° al pie de p√°gina)
      const tableHeadPDF = `<tr>
        <th>Fecha</th><th>Documento</th><th>Tipo</th><th>Encargado</th><th>Bodega</th>
        <th>C√≥digo</th><th>Nombre</th><th style="text-align:right">Cantidad</th><th style="text-align:right">Faltante</th>
      </tr>`;

      // Construir bloque de informaci√≥n del evento similar a Acta de Despacho
      let servicioHTML = 'No disponible';
      const eventoObj = infoPdf && infoPdf.eventoCompleto ? infoPdf.eventoCompleto : null;
      if(eventoObj){
        if(Array.isArray(eventoObj.servicios) && eventoObj.servicios.length>0){
          servicioHTML = '<ul style="margin:4pt 0; padding-left:16pt; font-size:10pt;">' + eventoObj.servicios.map(s=> `<li>${s.cantidad || ''} ${s.nombre || s}</li>`).join('') + '</ul>';
        } else if(eventoObj.descripcion){
          const desc = Array.isArray(eventoObj.descripcion) ? eventoObj.descripcion : [eventoObj.descripcion];
          servicioHTML = '<ul style="margin:4pt 0; padding-left:16pt; font-size:10pt;">' + desc.map(d=>`<li>${d}</li>`).join('') + '</ul>';
        }
      }

      const montajeStr = eventoObj ? formatDateTime(eventoObj.fecha_montaje, eventoObj.hora_montaje) : (infoPdf.montajeFecha ? formatDateTime(infoPdf.montajeFecha, infoPdf.montajeHora) : '-');
      const desmontajeStr = eventoObj ? formatDateTime(eventoObj.fecha_desmontaje, eventoObj.hora_desmontaje) : (infoPdf.desmontajeFecha ? formatDateTime(infoPdf.desmontajeFecha, infoPdf.desmontajeHora) : '-');

      // Bloque detallado del evento (similar al Acta de Despacho)
      const eventDetailBlock = `
        <div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius:6px; padding:8px; margin-bottom:12px; font-size:10pt;">
          <h4 style="margin:0 0 6px 0; color:#1e40af; font-size:11pt; border-bottom:1px solid #cbd5e1; padding-bottom:4px;">üìã Informaci√≥n del Evento</h4>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap:8px; font-size:10pt;">
            <div>
              <p style="margin:4px 0"><strong>Evento:</strong> <em>${eventoSeleccionado}</em></p>
              <p style="margin:4px 0"><strong>Cliente:</strong> <em>${cliente || '-'}</em></p>
              <p style="margin:4px 0"><strong>Lugar:</strong> <em>${lugar || '-'}</em></p>
            </div>
            <div>
              <p style="margin:4px 0"><strong>Montaje:</strong> <em>${montajeStr}</em></p>
              <p style="margin:4px 0"><strong>Desmontaje:</strong> <em>${desmontajeStr}</em></p>
            </div>
          </div>
          <div style="margin-top:8px"><p style="margin:4px 0"><strong>Servicio Solicitado:</strong></p>${servicioHTML}</div>
        </div>`;

      // Construir HTML del PDF (sin footer fijo)
      const fullHtml = `<!doctype html><html><head><meta charset="utf-8"><style>
        @page { margin: 16mm 10mm 16mm 10mm; }
        body{font-family:Arial, sans-serif;color:#111}
        table{width:100%;border-collapse:collapse;font-size:12px; page-break-inside:auto}
        thead{display:table-header-group}
        thead th{background:#f1f5f9;padding:10px;border-right:1px solid #e2e8f0}
        tbody{display:table-row-group}
        tbody tr{page-break-inside:avoid; break-inside:avoid; -webkit-column-break-inside:avoid; page-break-after:auto}
        tbody td{padding:6px;border-bottom:1px solid #e5e7eb; vertical-align:top}
      </style></head><body>
      <div style="text-align:center;margin-bottom:12px">
        <img src="assets/logo.png" style="height:50px;margin-bottom:8px">
        <h2 style="margin:0;color:#1e40af">Consolidado de Movimientos por Evento</h2>
        <p style="margin:6px 0 0 0">Generado: ${fechaReporte}</p>
      </div>
      ${eventDetailBlock}
      <table>
        <thead>${tableHeadPDF}</thead>
        <tbody>
          ${filasPDF}
        </tbody>
      </table>
      <div style="margin-top:10px;text-align:center;color:#666;font-size:11px">Evento: ${eventoSeleccionado}</div>
    </body></html>`;

      const result = await window.electronAPI.renderHtmlToPdf({ filename, html: fullHtml, baseUrl: document.baseURI });
      if (result && result.canceled === false) {
        alert('PDF guardado en: ' + result.filePath);
      }
    } catch (err) {
      console.error('Error generando PDF nativo para evento:', err);
      alert('Error al generar PDF nativo. Revisa la consola.');
    }
  });

  // === EXPORTAR A EXCEL (.xlsx) ===
  function formatFechaHora(valor){
    if(!valor) return '';
    try{ const d = new Date(valor); if(Number.isNaN(d.getTime())) return String(valor); return d.toLocaleString('es-NI'); }catch(e){ return String(valor); }
  }
  function loadXlsxLib(){
    return new Promise((resolve, reject)=>{
      if(window.XLSX) return resolve(window.XLSX);
      const s = document.createElement('script');
      s.src = 'https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js';
      s.onload = ()=> resolve(window.XLSX);
      s.onerror = (e)=> reject(e);
      document.head.appendChild(s);
    });
  }

  async function exportEventoExcel(){
    try{
      await loadXlsxLib();
      const movimientos = estado.movimientosActuales || [];

      // calcular faltantes similares a la vista
      const totalDesp = {};
      const totalDev = {};
      movimientos.forEach(m=>{
        (m.items||[]).forEach(i=>{
          const c = (i.codigo||'').toString().trim();
          if(!c) return;
          if(m.tipo==='despacho') totalDesp[c] = (totalDesp[c]||0) + Number(i.cantidad||0);
          if(m.tipo==='devolucion') totalDev[c] = (totalDev[c]||0) + Number(i.cantidad||0);
        });
      });

      const rows = [];
      movimientos.forEach(m=>{
        (m.items||[]).forEach(i=>{
          const codigo = (i.codigo||'').toString().trim();
          if(!codigo) return;
          const falt = Math.max(0, (totalDesp[codigo]||0) - (totalDev[codigo]||0));
          rows.push({
            Fecha: "'" + formatFechaHora(m.fecha),
            Documento: (m.id || '').toString(),
            Tipo: (m.tipo || '').toString(),
            Encargado: (m.encargado || '').toString(),
            Bodega: (resolveBodegaFromCodigo(codigo) || estado.bodegaPorCodigo.get(codigo) || '').toString(),
            Codigo: codigo,
            Nombre: (i.nombre || '').toString(),
            Cantidad: Number(i.cantidad||0),
            Faltante: falt
          });
        });
      });

      // Hoja de evento (meta)
      const info = await (async()=>{
        try{ const r = await cargarMovimientosPorEvento(document.getElementById('filtro-evento').value); return r.info || {}; }catch(e){ return {}; }
      })();

      const eventRows = [
        { Campo: 'Evento', Valor: document.getElementById('filtro-evento').value || '' },
        { Campo: 'Cliente', Valor: info.cliente || '' },
        { Campo: 'Lugar', Valor: info.lugar || '' },
        { Campo: 'FechaInicio', Valor: info.fechaInicio || '' },
        { Campo: 'Montaje', Valor: "'" + (info.montajeFecha ? formatDateTime(info.montajeFecha, info.montajeHora) : '') },
        { Campo: 'Desmontaje', Valor: "'" + (info.desmontajeFecha ? formatDateTime(info.desmontajeFecha, info.desmontajeHora) : '') }
      ];

      const wb = XLSX.utils.book_new();
      const wsMov = XLSX.utils.json_to_sheet(rows);
      XLSX.utils.book_append_sheet(wb, wsMov, 'Movimientos');
      const wsEvt = XLSX.utils.json_to_sheet(eventRows);
      XLSX.utils.book_append_sheet(wb, wsEvt, 'Evento');

      const filename = `Consolidado_Evento_${(document.getElementById('filtro-evento').value||'evento').replace(/\s+/g,'_')}.xlsx`;
      XLSX.writeFile(wb, filename);
    }catch(err){
      console.error('Error exportando XLSX evento:', err);
      alert('Error exportando Excel. Revisa la consola.');
    }
  }

  document.getElementById('btn-exportar-xevento-xlsx')?.addEventListener('click', exportEventoExcel);
})();
</script>
