<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Ventas de Materiales</title>
</head>
<body>
  <div class="movimientos-view">
  <div class="ventas-materiales-layout">
    <!-- Columna Principal - Formulario de Despacho -->
    <div class="ventas-materiales-principal">
      <div class="mov-form-container">
        <div class="mov-form-card">
          <h1 class="mov-form-title">üì§ Despachar Venta Activa</h1>
          <p class="mov-form-subtitle">Confirma y despacha materiales para ventas activas</p>

          <div class="mov-form-section">
            <div class="mov-form-row">
              <div class="mov-form-col">
                <label class="mov-form-label">Personal que Solicita</label>
                <select id="personalEntrega" class="mov-form-select" required>
                  <option value="">Seleccione un empleado...</option>
                </select>
              </div>
              <div class="mov-form-col">
                <label class="mov-form-label">Fecha</label>
                <input type="date" id="fechaSalida" class="mov-form-input" required />
              </div>
            </div>
          </div>

          <div class="mov-form-section">
            <div class="mov-form-row" style="margin-top: 16px;">
              <div class="mov-form-col">
                <label class="mov-form-label">N√∫mero de Venta Activa</label>
                <select id="numeroVentaExterna" class="mov-form-select" required>
                  <option value="">Seleccione...</option>
                </select>
              </div>
              <div class="mov-form-col">
                <label class="mov-form-label">Cliente</label>
                <input type="text" id="clienteExterno" class="mov-form-input" readonly />
              </div>
            </div>
            <div id="tablaVenta" style="margin-top: 24px; display: none;"></div>
          </div>

          <div class="mov-form-actions">
            <button id="btnGuardar" class="mov-btn mov-btn-primary">Despachar Venta</button>
            <button id="btnLimpiar" class="mov-btn mov-btn-secondary">Limpiar</button>
            <button id="btnImprimir" class="mov-btn mov-btn-secondary" style="display: none;">üñ®Ô∏è Imprimir</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Columna Lateral - Ventas Procesadas -->
    <div class="ventas-materiales-lateral">
      <!-- Lista de Ventas Procesadas -->
      <div class="ventas-procesadas-contenedor">
        <h2 class="ventas-procesadas-titulo">üìã Ventas Procesadas</h2>
        <p class="ventas-procesadas-subtitulo">Historial de despachos realizados - Puede reimprimir PDFs si es necesario</p>

        <div id="ventasProcesadasContainer" class="ventas-procesadas-seccion">
          <div id="ventasProcesadasLista" class="ventas-procesadas-lista">
            <!-- Las ventas procesadas se cargar√°n aqu√≠ din√°micamente -->
          </div>
          <div id="ventasProcesadasVacio" class="ventas-procesadas-vacio" style="display: none;">
            <p>No hay ventas procesadas a√∫n.</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="modalImprimir" class="mov-modal-overlay" style="display: none;">
    <div class="mov-modal-content">
      <h2 class="mov-modal-title">Venta Despachada</h2>
      <p class="mov-modal-text">La venta fue despachada exitosamente. ¬øDesea imprimir el documento?</p>
      <div class="mov-modal-buttons">
        <button id="btnNoImprimir" class="mov-btn mov-btn-secondary">No</button>
        <button id="btnSiImprimir" class="mov-btn mov-btn-primary">S√≠, Imprimir</button>
      </div>
    </div>
  </div>

  <script>
    // =============================================================================
    // üîπ CARGAR DATOS REALES DE SUPABASE
    // =============================================================================
    let empleados = [];
    let ventasActivas = [];
    let materialesCatalogo = [];
    let estado = { itemsVenta: [], pdfData: null };

    // =============================================================================
    // üîπ FUNCIONES DE CARGA DE DATOS
    // =============================================================================
    async function cargarEmpleados() {
      try {
        const { data, error } = await window.supabaseClient
          .from('empleados')
          .select('id, nombres, apellidos')
          .order('nombres', { ascending: true });

        if (error) {
          console.error('Error al cargar empleados:', error);
          return;
        }

        empleados = data || [];
      } catch (err) {
        console.error('Error:', err);
      }
    }

    async function cargarVentasActivas() {
      try {
        const { data, error } = await window.supabaseClient
          .from('ventas_activas')
          .select(`
            id,
            cliente,
            fecha,
            total,
            estado,
            items_venta_activa (
              codigo_material,
              nombre_material,
              cantidad,
              precio_unitario
            )
          `)
          .eq('estado', 'activa')
          .order('fecha', { ascending: false });

        if (error) {
          console.error('Error al cargar ventas activas:', error);
          return;
        }

        ventasActivas = (data || []).map(venta => ({
          id: venta.id,
          cliente: venta.cliente,
          fecha: venta.fecha,
          total: venta.total,
          estado: venta.estado,
          servicios: venta.items_venta_activa.map(item => ({
            codigo: item.codigo_material,
            nombre: item.nombre_material,
            cantidad: item.cantidad,
            precioUnitario: item.precio_unitario
          }))
        }));
      } catch (err) {
        console.error('Error:', err);
      }
    }

    async function cargarMaterialesCatalogo() {
      try {
        const { data, error } = await window.supabaseClient
          .from('catalogo')
          .select('codigo, nombre')
          .eq('es_contenedor', false)
          .order('codigo', { ascending: true });

        if (error) {
          console.error('Error al cargar cat√°logo:', error);
          return;
        }

        materialesCatalogo = data || [];
      } catch (err) {
        console.error('Error:', err);
      }
    }

    async function cargarVentasProcesadas() {
      try {
        // Consultar ventas despachadas directamente desde ventas_activas
        const { data: ventasDespachadas, error } = await window.supabaseClient
          .from('ventas_activas')
          .select(`
            id,
            cliente,
            fecha,
            total,
            estado,
            items_venta_activa (
              codigo_material,
              nombre_material,
              cantidad,
              precio_unitario
            )
          `)
          .eq('estado', 'despachada')
          .order('fecha', { ascending: false })
          .limit(50);

        if (error) {
          console.error('Error al cargar ventas procesadas:', error);
          return;
        }

        const contenedor = document.getElementById('ventasProcesadasLista');
        const contenedorVacio = document.getElementById('ventasProcesadasVacio');

        if (!ventasDespachadas || ventasDespachadas.length === 0) {
          contenedor.innerHTML = '';
          contenedorVacio.style.display = 'block';
          return;
        }

        contenedorVacio.style.display = 'none';
        contenedor.innerHTML = '';

        ventasDespachadas.forEach(venta => {
          const itemDiv = document.createElement('div');
          itemDiv.className = 'ventas-procesadas-item';

          const fechaFormateada = new Date(venta.fecha).toLocaleDateString('es-ES');
          const totalFormateado = new Intl.NumberFormat('es-ES', {
            style: 'currency',
            currency: 'USD'
          }).format(venta.total || 0);

          // Usar un ID simulado para el despacho basado en la venta
          const despachoIdSimulado = `DES-${venta.id.split('-')[1]}`;

          itemDiv.innerHTML = `
            <div class="ventas-procesadas-info">
              <div class="ventas-procesadas-titulo-item">Despacho ${despachoIdSimulado}</div>
              <div class="ventas-procesadas-detalles">
                <div><strong>Venta:</strong> ${venta.id}</div>
                <div><strong>Cliente:</strong> ${venta.cliente}</div>
                <div><strong>Fecha:</strong> ${fechaFormateada}</div>
                <div><strong>Total:</strong> ${totalFormateado}</div>
                <div><strong>Estado:</strong> Despachada</div>
              </div>
            </div>
            <div class="ventas-procesadas-acciones">
              <button class="ventas-procesadas-btn ventas-procesadas-btn-imprimir"
                      data-venta-id="${venta.id}"
                      data-cliente="${venta.cliente}"
                      data-fecha="${venta.fecha}"
                      data-total="${venta.total}"
                      title="Generar PDF del despacho">
                üñ®Ô∏è PDF
              </button>
            </div>
          `;

          contenedor.appendChild(itemDiv);
        });

        // Agregar event listeners a los botones PDF
        document.querySelectorAll('.ventas-procesadas-btn-imprimir').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const ventaId = e.currentTarget.dataset.ventaId;
            const cliente = e.currentTarget.dataset.cliente;
            const fecha = e.currentTarget.dataset.fecha;
            const total = e.currentTarget.dataset.total;

            try {
              // Generar PDF directamente desde la venta despachada
              await generarPDFFromVentaDespachada(ventaId, cliente, fecha, total);
            } catch (err) {
              console.error('Error al generar PDF:', err);
              alert('‚ùå Error al generar el PDF.');
            }
          });
        });

      } catch (err) {
        console.error('Error al cargar ventas procesadas:', err);
      }
    }

    // =============================================================================
    // üîπ FUNCI√ìN DE CORRELATIVO PARA VENTAS
    // =============================================================================
    async function generarCorrelativoVenta() {
        try {
            // Obtener el √∫ltimo correlativo desde la tabla despachos_ventas_activas
            const { data: despachos, error } = await window.supabaseClient
                .from('despachos_ventas_activas')
                .select('id')
                .order('fecha_registro', { ascending: false })
                .limit(1);

            let ultimoNumero = 0;
            if (!error && despachos && despachos.length > 0) {
                // Extraer el n√∫mero del formato "DESV-XXXXX" o "DES-XXXXX" (compatibilidad)
                const match = despachos[0].id.match(/(?:DESV|DES)-(\d+)/);
                if (match) {
                    ultimoNumero = parseInt(match[1]);
                }
            }

            const nuevoNumero = ultimoNumero + 1;
            return "DESV-" + nuevoNumero.toString().padStart(5, '0');
        } catch (error) {
            console.error('Error al generar correlativo de venta:', error);
            // Fallback: usar contador local pero con prefijo diferente para evitar conflictos
            return "DESV-" + String(contadorSolicitud++).padStart(5, '0');
        }
    }

    // Actualiza inventario en stock_actual_con_precio y registra movimientos de bodega
    async function procesarDespachoVenta(itemsVenta, ventaId, personal, fecha) {
      if (!Array.isArray(itemsVenta) || itemsVenta.length === 0) return;

      try {
        // Procesar cada item de la venta
        for (const item of itemsVenta) {
          const codigo = item && item.codigo != null ? String(item.codigo) : null;
          if (!codigo) continue;

          // Obtener informaci√≥n actual del stock (solo para validar existencia)
          const { data: stockActual, error: stockError } = await window.supabaseClient
            .from('stock_actual_con_precio')
            .select('material_codigo, existencia')
            .eq('material_codigo', codigo);

          if (stockError) {
            console.error('Error al consultar stock:', stockError);
            continue;
          }

          const cantidadActual = (stockActual && stockActual.length > 0) ? stockActual[0].existencia : 0;
          const cantidadDespachada = parseFloat(item.cantidad) || 0;

          if (cantidadDespachada <= 0) continue;
          if (cantidadDespachada > cantidadActual) {
            alert(`‚ö†Ô∏è Stock insuficiente para ${codigo}. Disponible: ${cantidadActual}, solicitado: ${cantidadDespachada}.`);
            continue;
          }

          // Obtener informaci√≥n del cat√°logo para el movimiento
          const infoCatalogo = materialesCatalogo.find(m => m.codigo === codigo) || {};
          const { data: infoStock } = await window.supabaseClient
            .from('stock_actual_con_precio')
            .select('bodega_principal, precio_promedio')
            .eq('material_codigo', codigo);

          // Registrar movimiento de bodega
          const movimiento = {
            material_codigo: codigo,
            material_nombre: item.nombre || infoCatalogo.nombre || codigo,
            bodega_principal: (infoStock && infoStock.length > 0) ? infoStock[0].bodega_principal : 'Principal',
            bodega_secundaria: 'General', // TODO: Implementar bodega secundaria si es necesario
            tipo_movimiento: 'venta',
            cantidad: cantidadDespachada,
            signo: -1,
            referencia_documento: ventaId,
            referencia_tipo: 'venta_activa',
            responsable: personal,
            fecha_movimiento: fecha,
            observaciones: item.observacion || `Despacho venta activa ${ventaId}`,
            precio_unitario: infoStock?.precio_promedio || 0
          };

          const { error: movimientoError } = await window.supabaseClient
            .from('movimientos_bodega')
            .insert(movimiento);

          if (movimientoError) {
            console.error('Error al registrar movimiento:', movimientoError);
          } else {
            console.log('‚úÖ Movimiento registrado correctamente:', movimiento);
          }
        }

        // Actualizar estado de la venta a 'despachada'
        const { error: ventaError } = await window.supabaseClient
          .from('ventas_activas')
          .update({ estado: 'despachada' })
          .eq('id', ventaId);

        if (ventaError) {
          console.error('Error al actualizar venta:', ventaError);
        }

      } catch (err) {
        console.error('Error en procesarDespachoVenta:', err);
        alert('‚ùå Error al procesar el despacho de la venta.');
      }
    }

    function formatDate(dateString) {
      return new Date(dateString).toLocaleDateString("es-ES");
    }

    // =============================================================================
    // üîπ RENDERIZADO
    // =============================================================================
    function renderPersonalYFecha() {
      var hoy = new Date().toISOString().split("T")[0];
      document.getElementById("fechaSalida").value = hoy;

      var selectPersonal = document.getElementById("personalEntrega");
      selectPersonal.innerHTML = '<option value="">Seleccione un empleado...</option>';

      empleados.forEach(function(empleado) {
        var nombre = (empleado.nombres || '') + ' ' + (empleado.apellidos || '');
        if (nombre.trim()) {
          var opt = document.createElement("option");
          opt.value = empleado.id;
          opt.textContent = nombre;
          selectPersonal.appendChild(opt);
        }
      });
    }

    function renderVentasActivas() {
      var selectVenta = document.getElementById("numeroVentaExterna");
      selectVenta.innerHTML = '<option value="">Seleccione...</option>';

      ventasActivas.forEach(function(venta) {
        var opt = document.createElement("option");
        opt.value = venta.id;
        opt.textContent = `${venta.id} - ${venta.cliente} (${formatDate(venta.fecha)})`;
        selectVenta.appendChild(opt);
      });
    }

    function renderTablaVenta() {
      var tabla = document.getElementById("tablaVenta");
      if (!tabla) return;

      if (!estado.itemsVenta || estado.itemsVenta.length === 0) {
        tabla.style.display = "none";
        tabla.innerHTML = '<p class="mov-empty">No hay √≠tems para esta venta.</p>';
        return;
      }

      var filas = estado.itemsVenta.map(function(item, idx) {
        var mat = materialesCatalogo.find(function(m) { return String(m.codigo) === String(item.codigo); });
        var nombre = mat ? (mat.codigo + ' ‚Äì ' + (mat.nombre || 'Sin nombre')) : (item.codigo || 'Desconocido');
        return `
          <tr>
            <td style="width: 55%;">${nombre}</td>
            <td style="text-align: center; width: 15%;">${item.cantidad || 0}</td>
            <td style="width: 30%;">
              <input type="text" class="mov-form-input" data-idx="${idx}" placeholder="Observaci√≥n" value="${(item.observacion || '').replace(/"/g,'&quot;')}" />
            </td>
          </tr>
        `;
      }).join('');

      tabla.innerHTML = `
        <table class="mov-table">
          <thead>
            <tr>
              <th style="width:55%;">Material</th>
              <th style="width:15%; text-align:center;">Cantidad</th>
              <th style="width:30%;">Observaci√≥n</th>
            </tr>
          </thead>
          <tbody>${filas}</tbody>
        </table>
      `;
      tabla.style.display = "block";

      tabla.querySelectorAll('input[data-idx]').forEach(function(input) {
        input.addEventListener('input', function(e) {
          var i = parseInt(e.target.dataset.idx, 10);
          if (!isNaN(i) && estado.itemsVenta[i]) {
            estado.itemsVenta[i].observacion = e.target.value;
          }
        });
      });
    }

    // =============================================================================
    // üîπ GUARDAR VENTA
    // =============================================================================
    async function guardarVentaDespachada(ventaData) {
      try {
        // Crear registro de despacho con correlativo √∫nico
        const despachoId = await generarCorrelativoVenta();

        // Nota: Las tablas de despacho tienen restricciones RLS que impiden la inserci√≥n
        // Por ahora, solo procesamos el despacho en el inventario
        console.log('Procesando despacho:', despachoId);

        // Registrar despacho en tabla de despachos (comentado por RLS)
        /*
        const { error: despachoError } = await window.supabaseClient
          .from('despachos_ventas_activas')
          .insert({
            id: despachoId,
            venta_activa_id: ventaData.numeroVenta,
            cliente: ventaData.cliente,
            personal_responsable: ventaData.personal,
            fecha_despacho: ventaData.fecha,
            observaciones: 'Despacho realizado desde m√≥dulo de bodega'
          });

        if (despachoError) {
          console.error('Error al registrar despacho:', despachoError);
          throw new Error(`No se pudo registrar el despacho: ${despachoError.message}`);
        }

        // Registrar items despachados
        const itemsParaDespacho = ventaData.itemsVenta.map(item => ({
          despacho_id: despachoId,
          codigo_material: item.codigo,
          nombre_material: item.nombre || item.codigo,
          cantidad_despachada: item.cantidad,
          observacion: item.observacion || ''
        }));

        const { error: itemsError } = await window.supabaseClient
          .from('items_despacho_venta_activa')
          .insert(itemsParaDespacho);

        if (itemsError) {
          console.error('Error al registrar items despachados:', itemsError);
        }
        */

        // Procesar el despacho (actualizar inventario y movimientos)
        await procesarDespachoVenta(ventaData.itemsVenta, ventaData.numeroVenta, ventaData.personal, ventaData.fecha);

        return { id: despachoId };
      } catch (err) {
        console.error('Error al guardar venta despachada:', err);
        throw err;
      }
    }

    // =============================================================================
    // üîπ PDF GENERATION
    // =============================================================================
    function generarDocumentoPDF(data) {
      if (!window.html2pdf) {
        alert("html2pdf no est√° cargado.");
        return;
      }
      var copias = [
        { leyenda: "Original ‚Äì Bodega" },
        { leyenda: "Copia ‚Äì Cliente" },
        { leyenda: "Copia ‚Äì Archivo" }
      ];
      var contenidoCompleto = "";
      copias.forEach(function(copia) {
        var titulo = "Despacho de Venta Activa";
        var numeroRegistro = "DESV-" + data.numeroRegistro;
        var colorHeader = "#10b981";
        var contenidoDetalles = '\
          <p><strong>ID Venta Activa:</strong> ' + data.numeroVenta + '</p>\
          <p><strong>Cliente:</strong> ' + data.cliente + '</p>\
        ';
        var tablaFilas = data.itemsVenta.map(function(item) {
          var mat = materialesCatalogo.find(function(m) { return m.codigo === item.codigo; });
          return '\
            <tr style="font-size: 9pt;">\
              <td style="padding: 6pt; border: 1px solid #ddd;">' + (mat ? mat.nombre : item.nombre || item.codigo) + '</td>\
              <td style="padding: 6pt; border: 1px solid #ddd; text-align: center;">' + item.cantidad + '</td>\
              <td style="padding: 6pt; border: 1px solid #ddd;">' + (item.observacion || "") + '</td>\
            </tr>\
          ';
        }).join("");
        contenidoDetalles += '\
          <h3 style="color: ' + colorHeader + '; margin: 12pt 0 6pt 0; font-size: 12pt; border-bottom: 1px solid #ccc; padding-bottom: 3pt;">Materiales Despachados</h3>\
          <table style="width: 100%; border-collapse: collapse; font-size: 9pt;">\
            <thead>\
              <tr style="background-color: ' + colorHeader + '; color: white;">\
                <th style="padding: 6pt; border: 1px solid #ddd;">Material</th>\
                <th style="padding: 6pt; border: 1px solid #ddd;">Cantidad</th>\
                <th style="padding: 6pt; border: 1px solid #ddd;">Observaci√≥n</th>\
              </tr>\
            </thead>\
            <tbody>' + tablaFilas + '</tbody>\
          </table>\
        ';
        contenidoCompleto += '\
        <div style="width: 185mm; font-family: Arial, sans-serif; color: #333; line-height: 1.3; font-size: 10pt; page-break-after: always;">\
          <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10pt; border-bottom: 2px solid ' + colorHeader + '; padding-bottom: 6pt;">\
            <img src="assets/logo.png" alt="Logo" style="height: 20mm; margin-right: 8mm;">\
            <div style="text-align: center; flex: 1;">\
              <h1 style="color: ' + colorHeader + '; margin: 0; font-size: 16pt;">' + titulo + '</h1>\
              <p style="margin: 3pt 0 0 0; color: #555; font-size: 9pt;">\
                Fecha: ' + data.fecha + '\
              </p>\
            </div>\
            <div style="text-align: right;">\
              <div style="font-size: 24pt; font-weight: bold; color: ' + colorHeader + '; letter-spacing: 1px;">' + numeroRegistro + '</div>\
            </div>\
          </div>\
          <div style="background: #f0fdf4; padding: 6pt; border-radius: 4pt; margin: 8pt 0; font-size: 9pt;">\
            <p><strong>Personal que Despacha:</strong> ' + data.personal + '</p>\
            ' + contenidoDetalles + '\
          </div>';
        // Firmas
        contenidoCompleto += '\
          <div style="display: flex; justify-content: space-around; margin-top: 20mm;">\
            <div style="text-align: center; width: 30%;">\
              <div style="border-top: 1px solid black; padding-top: 5pt; font-weight: bold;">Bodega</div>\
              <p style="margin: 5pt 0 0 0; font-size: 8pt;">Despacha</p>\
            </div>\
            <div style="text-align: center; width: 30%;">\
              <div style="border-top: 1px solid black; padding-top: 5pt; font-weight: bold;">' + data.cliente + '</div>\
              <p style="margin: 5pt 0 0 0; font-size: 8pt;">Recibe</p>\
            </div>\
            <div style="text-align: center; width: 30%;">\
              <div style="border-top: 1px solid black; padding-top: 5pt; font-weight: bold;">Supervisor</div>\
              <p style="margin: 5pt 0 0 0; font-size: 8pt;">Autoriza</p>\
            </div>\
          </div>';
        contenidoCompleto += '\
          <div style="margin-top: 10mm; text-align: center; font-size: 9pt; color: #666; border-top: 1px solid #eee; padding-top: 4pt;">\
            ' + copia.leyenda + '\
          </div>\
          <div style="background: #d1fae5; color: #065f46; padding: 4pt; font-size: 9pt; text-align: center; border: 1px dashed #a7f3d0; margin-top: 8pt;">\
            ‚úÖ DESPACHO COMPLETADO ‚Äì MATERIALES ENTREGADOS\
          </div>\
        </div>';
      });
      if (contenidoCompleto.endsWith('page-break-after: always;">')) {
        contenidoCompleto = contenidoCompleto.slice(0, -'page-break-after: always;">'.length) + '">';
      }
      var options = {
        margin: [15, 15, 15, 15],
        filename: 'Venta_' + data.numeroVenta + '.pdf',
        image: { type: 'jpeg', quality: 0.95 },
        html2canvas: { scale: 2, useCORS: true, backgroundColor: "#ffffff" },
        jsPDF: { unit: 'mm', format: 'letter', orientation: 'portrait' }
      };
      html2pdf().from(contenidoCompleto).set(options).save();
    }

    // =============================================================================
    // üîπ GENERAR PDF DESDE DESPACHO EXISTENTE
    // =============================================================================
    async function generarPDFDesdeDespacho(despachoId, ventaId) {
      try {
        // Cargar datos del despacho
        const { data: despacho, error: despachoError } = await window.supabaseClient
          .from('despachos_ventas_activas')
          .select(`
            id,
            venta_activa_id,
            cliente,
            personal_responsable,
            fecha_despacho,
            items_despacho_venta_activa (
              codigo_material,
              nombre_material,
              cantidad_despachada,
              observacion
            )
          `)
          .eq('id', despachoId)
          .single();

        if (despachoError) {
          console.error('Error al cargar despacho:', despachoError);
          alert('‚ùå Error al cargar los datos del despacho.');
          return;
        }

        // Preparar datos para el PDF
        const pdfData = {
          numeroRegistro: despachoId.split('-')[1],
          numeroVenta: despacho.venta_activa_id,
          cliente: despacho.cliente,
          personal: despacho.personal_responsable,
          fecha: new Date(despacho.fecha_despacho).toLocaleDateString('es-ES'),
          itemsVenta: despacho.items_despacho_venta_activa.map(item => ({
            codigo: item.codigo_material,
            nombre: item.nombre_material,
            cantidad: item.cantidad_despachada,
            observacion: item.observacion || ''
          }))
        };

        // Generar el PDF
        generarDocumentoPDF(pdfData);

      } catch (err) {
        console.error('Error al generar PDF desde despacho:', err);
        alert('‚ùå Error al generar el PDF.');
      }
    }

    // =============================================================================
    // üîπ GENERAR PDF DESDE VENTA DESPACHADA
    // =============================================================================
    async function generarPDFFromVentaDespachada(ventaId, cliente, fecha, total) {
      try {
        // Cargar datos de la venta despachada
        const { data: venta, error: ventaError } = await window.supabaseClient
          .from('ventas_activas')
          .select(`
            id,
            cliente,
            fecha,
            total,
            items_venta_activa (
              codigo_material,
              nombre_material,
              cantidad,
              precio_unitario
            )
          `)
          .eq('id', ventaId)
          .single();

        if (ventaError) {
          console.error('Error al cargar venta despachada:', ventaError);
          alert('‚ùå Error al cargar los datos de la venta.');
          return;
        }

        // Preparar datos para el PDF (usar datos del par√°metro si no est√°n en la consulta)
        const pdfData = {
          numeroRegistro: ventaId.split('-')[1],
          numeroVenta: ventaId,
          cliente: cliente || venta.cliente,
          personal: 'Personal de Bodega', // No tenemos este dato, usar gen√©rico
          fecha: new Date(fecha || venta.fecha).toLocaleDateString('es-ES'),
          itemsVenta: venta.items_venta_activa.map(item => ({
            codigo: item.codigo_material,
            nombre: item.nombre_material,
            cantidad: item.cantidad,
            observacion: '' // No tenemos observaciones en items_venta_activa
          }))
        };

        // Generar el PDF
        generarDocumentoPDF(pdfData);

      } catch (err) {
        console.error('Error al generar PDF desde venta despachada:', err);
        alert('‚ùå Error al generar el PDF.');
      }
    }

    // =============================================================================
    // üîπ L√ìGICA PRINCIPAL
    // =============================================================================
    function inicializarEventos() {
      document.getElementById("numeroVentaExterna").addEventListener("change", function(e) {
        var venta = ventasActivas.find(v => v.id === e.target.value);
        if (venta) {
          document.getElementById("clienteExterno").value = venta.cliente;
          estado.itemsVenta = venta.servicios.map(function(s) {
            return {
              codigo: s.codigo,
              cantidad: s.cantidad,
              observacion: "",
              nombre: s.nombre
            };
          });
          renderTablaVenta();
        } else {
          document.getElementById("clienteExterno").value = "";
          estado.itemsVenta = [];
          document.getElementById("tablaVenta").style.display = "none";
        }
      });

      document.getElementById("btnGuardar").addEventListener("click", async function() {
        var personalId = document.getElementById("personalEntrega").value;
        var fecha = document.getElementById("fechaSalida").value;
        var numeroVenta = document.getElementById("numeroVentaExterna").value;

        if (!personalId || !fecha || !numeroVenta) {
          alert("Complete todos los campos obligatorios.");
          return;
        }

        if (estado.itemsVenta.length === 0) {
          alert("No hay √≠tems para despachar.");
          return;
        }

        try {
          // Obtener nombre del empleado
          var empleado = empleados.find(e => e.id == personalId);
          var nombrePersonal = empleado ? `${empleado.nombres} ${empleado.apellidos}` : 'Desconocido';

          var cliente = document.getElementById("clienteExterno").value;
          var ventaData = {
            numeroVenta: numeroVenta,
            cliente: cliente,
            personal: nombrePersonal,
            fecha: fecha,
            itemsVenta: estado.itemsVenta
          };

          var ventaDespachada = await guardarVentaDespachada(ventaData);

          estado.pdfData = {
            esVenta: true,
            numeroRegistro: ventaDespachada.id.split('-')[1],
            numeroVenta: numeroVenta,
            cliente: cliente,
            personal: nombrePersonal,
            fecha: formatDate(fecha),
            itemsVenta: estado.itemsVenta
          };

          document.getElementById("modalImprimir").style.display = "flex";
          alert("‚úÖ Venta despachada con √©xito. Inventario actualizado.");

          // Recargar ventas activas para reflejar cambios
          await cargarVentasActivas();
          renderVentasActivas();

          // Recargar lista de ventas procesadas
          await cargarVentasProcesadas();

        } catch (err) {
          console.error('Error al despachar venta:', err);
          alert("‚ùå Error al despachar la venta.");
        }
      });

      document.getElementById("btnSiImprimir").addEventListener("click", function() {
        if (estado.pdfData) {
          generarDocumentoPDF(estado.pdfData);
          document.getElementById("modalImprimir").style.display = "none";
          document.getElementById("btnImprimir").style.display = "inline-block";
        }
      });

      document.getElementById("btnNoImprimir").addEventListener("click", function() {
        document.getElementById("modalImprimir").style.display = "none";
      });

      document.getElementById("btnLimpiar").addEventListener("click", function() {
        estado.itemsVenta = [];
        estado.pdfData = null;
        document.getElementById("tablaVenta").style.display = "none";
        document.getElementById("clienteExterno").value = "";
        document.getElementById("numeroVentaExterna").value = "";
        document.getElementById("btnImprimir").style.display = "none";
      });
    }

    // =============================================================================
    // üîπ INICIO
    // =============================================================================
    async function inicializarModulo() {
      try {
        // Cargar datos desde Supabase
        await cargarEmpleados();
        await cargarVentasActivas();
        await cargarMaterialesCatalogo();

        // Renderizar datos
        renderPersonalYFecha();
        renderVentasActivas();
        await cargarVentasProcesadas();

        // Inicializar eventos
        inicializarEventos();

      } catch (err) {
        console.error('Error al inicializar m√≥dulo:', err);
        alert('‚ùå Error al cargar el m√≥dulo de despachos.');
      }
    }

    // Iniciar cuando el DOM est√© listo
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', inicializarModulo);
    } else {
      inicializarModulo();
    }
  </script>
  </div>
</body>
</html>