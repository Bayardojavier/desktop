<!-- desktop/modules/bodega/universal/ficha_etiqueta.html -->
<div style="display:flex; gap:16px; height:100%;">
  <!-- Panel configuraci√≥n -->
  <div style="width: 360px; background: rgba(20, 30, 60, 0.45); border: 1px solid rgba(99, 102, 241, 0.2); border-radius: 10px; padding: 12px; overflow:auto;">
    <div style="font-weight: 900; color:lightgray; margin-bottom:8px;">ü™™ Ficha & Etiqueta</div>
    <div style="color:slategray; font-size:12px; line-height:1.35; margin-bottom:12px;">
      Configura qu√© datos aparecen y en qu√© posiciones. La ficha es para detalles (m√°s grande). La etiqueta es compacta.
    </div>

    <div style="border-top:1px solid rgba(148,163,184,0.15); padding-top:10px;">
      <div style="font-weight:800; color:lightsteelblue; margin-bottom:6px;">Buscar material</div>
      <label style="display:block; margin:6px 0 6px; font-weight:700; color:lightsteelblue;">Bodega</label>
      <select id="fe-bodega-select" class="audiovisual-input"></select>
      <label style="display:block; margin:8px 0 6px; font-weight:700; color:lightsteelblue;">Tipo de alta</label>
      <select id="fe-buscar-tipo" class="audiovisual-input">
        <option value="MATERIAL">Material</option>
        <option value="CONTENEDOR">Contenedor</option>
      </select>
      <div style="margin-top:6px; color:slategray; font-size:12px; line-height:1.25;">Equivale a la columna <b>tipo_alta</b> del cat√°logo: Material o Contenedor.</div>
      <input id="fe-codigo-buscar" class="audiovisual-input" placeholder="C√≥digo (ej: 2001-AUD-ILU-... )" />
      <div style="display:flex; gap:8px; margin-top:8px;">
        <button type="button" id="fe-btn-buscar" class="audiovisual-boton audiovisual-new" style="padding:8px 12px;">üîé Cargar</button>
        <button type="button" id="fe-btn-abrir-buscador" class="bodega-export-pdf-btn" style="padding:8px 12px;">üßæ Buscar</button>
        <button type="button" id="fe-btn-limpiar" class="bodega-export-pdf-btn" style="padding:8px 12px;">Limpiar</button>
      </div>
      <div id="fe-status" style="margin-top:8px; color:slategray; font-size:12px;">(sin material cargado)</div>
    </div>

    <div style="border-top:1px solid rgba(148,163,184,0.15); padding-top:10px; margin-top:10px;">
      <div style="font-weight:800; color:lightsteelblue; margin-bottom:6px;">Ficha (layout)</div>

      <label style="display:block; margin:8px 0 6px; font-weight:700; color:lightsteelblue;">Paleta / Tema</label>
      <select id="fe-ficha-theme" class="audiovisual-input"></select>

      <label style="display:block; margin:8px 0 6px; font-weight:700; color:lightsteelblue;">Principal</label>
      <select id="fe-ficha-principal" class="audiovisual-input"></select>

      <label style="display:block; margin:8px 0 6px; font-weight:700; color:lightsteelblue;">Secundario</label>
      <select id="fe-ficha-secundario" class="audiovisual-input"></select>

      <label style="display:block; margin:8px 0 6px; font-weight:700; color:lightsteelblue;">Foto</label>
      <select id="fe-ficha-foto-pos" class="audiovisual-input">
        <option value="left">Izquierda</option>
        <option value="right">Derecha</option>
        <option value="hide">Ocultar</option>
      </select>

      <label style="display:block; margin:8px 0 6px; font-weight:700; color:lightsteelblue;">Campos (hasta 12 l√≠neas)</label>
      <div id="fe-ficha-campos" style="display:flex; flex-direction:column; gap:8px;"></div>
    </div>

    <div style="border-top:1px solid rgba(148,163,184,0.15); padding-top:10px; margin-top:10px;">
      <div style="font-weight:800; color:lightsteelblue; margin-bottom:6px;">Etiqueta (layout)</div>

      <div style="margin:6px 0 10px; color:slategray; font-size:12px; line-height:1.25;">
        La etiqueta usa la misma paleta/tema que la ficha.
      </div>

      <label style="display:block; margin:8px 0 6px; font-weight:700; color:lightsteelblue;">Principal</label>
      <select id="fe-etiq-principal" class="audiovisual-input"></select>

      <label style="display:block; margin:8px 0 6px; font-weight:700; color:lightsteelblue;">Secundario</label>
      <select id="fe-etiq-secundario" class="audiovisual-input"></select>

      <label style="display:block; margin:8px 0 6px; font-weight:700; color:lightsteelblue;">Foto</label>
      <select id="fe-etiq-foto-pos" class="audiovisual-input">
        <option value="hide">Ocultar</option>
        <option value="left">Izquierda</option>
        <option value="right">Derecha</option>
      </select>

      <label style="display:block; margin:8px 0 6px; font-weight:700; color:lightsteelblue;">Campos (hasta 3 l√≠neas)</label>
      <div id="fe-etiq-campos" style="display:flex; flex-direction:column; gap:8px;"></div>
    </div>

    <div style="border-top:1px solid rgba(148,163,184,0.15); padding-top:10px; margin-top:10px; display:flex; gap:8px;">
      <button type="button" id="fe-btn-guardar" class="audiovisual-boton audiovisual-save" style="padding:10px 12px; flex:1;">üíæ Guardar configuraci√≥n</button>
      <button type="button" id="fe-btn-reset" class="bodega-export-pdf-btn" style="padding:10px 12px;">Reset</button>
    </div>
  </div>

  <!-- Preview -->
  <div style="flex:1; min-width:520px; overflow:auto;">
    <div class="bodega-encabezado" style="margin-bottom: 12px;">
      <div style="display:flex; align-items:center; gap:12px;">
        <button id="fe-btn-prev" class="bodega-export-pdf-btn" style="padding:6px 10px; font-size:16px;">‚¨ÖÔ∏è</button>
        <h1 class="bodega-titulo" style="margin:0;">ü™™ Ficha & Etiqueta</h1>
        <button id="fe-btn-next" class="bodega-export-pdf-btn" style="padding:6px 10px; font-size:16px;">‚û°Ô∏è</button>

        <div style="margin-left: auto; display:flex; gap:8px;">
          <button type="button" id="fe-btn-export-pdf" class="audiovisual-boton audiovisual-new" style="padding:8px 10px; font-size:14px;">üìÑ PDF</button>
          <button type="button" id="fe-btn-export-ficha-png" class="audiovisual-boton audiovisual-new" style="padding:8px 10px; font-size:14px;">üñºÔ∏è Ficha PNG</button>
          <button type="button" id="fe-btn-export-etiq-png" class="audiovisual-boton audiovisual-new" style="padding:8px 10px; font-size:14px;">üè∑Ô∏è Etiqueta PNG</button>
        </div>
      </div>
      <p class="bodega-subtitulo" style="margin:6px 0 0 0;">Vista previa y configuraci√≥n din√°mica.</p>
    </div>

    <div style="display:flex; gap:16px; flex-wrap:wrap; align-items:flex-start;">
      <!-- Ficha preview -->
      <div id="fe-preview-ficha" style="width: 720px; max-width: 100%; background: rgba(15,23,42,0.35); border: 1px solid rgba(148,163,184,0.15); border-radius: 12px; padding: 14px;">
        <div id="fe-ficha-print-area" style="background:white; color:darkslateblue; border-radius: 10px; overflow:hidden;"></div>
      </div>

      <!-- Etiqueta preview -->
      <div id="fe-preview-etiq" style="width: 420px; background: rgba(15,23,42,0.35); border: 1px solid rgba(148,163,184,0.15); border-radius: 12px; padding: 14px;">
        <div id="fe-etiq-print-area" style="background:white; color:darkslateblue; border-radius: 10px; overflow:hidden;"></div>
      </div>
    </div>
  </div>
</div>

<!-- Modal buscador de material -->
<div id="fe-modal-buscador" style="position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.55); z-index: 9999;">
  <div style="width: 720px; max-width: calc(100vw - 32px); max-height: calc(100vh - 32px); background: rgba(15,23,42,0.98); border: 1px solid rgba(99,102,241,0.28); border-radius: 12px; padding: 14px; display:flex; flex-direction:column;">
    <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
      <div style="font-weight: 900; color: lightgray;">üßæ Buscar material</div>
      <button type="button" id="fe-modal-x" class="bodega-export-pdf-btn" style="padding:6px 10px;">‚úï</button>
    </div>

    <div style="margin-top: 10px; display:flex; gap:8px;">

      <input id="fe-modal-q" class="audiovisual-input" placeholder="Buscar por c√≥digo, nombre, contenedor o tipo..." style="flex:1;" />
      <button type="button" id="fe-modal-buscar" class="audiovisual-boton audiovisual-new" style="padding:8px 12px;">üîé Buscar</button>
    </div>
    <div id="fe-modal-hint" style="margin-top: 6px; color:slategray; font-size:12px;">Tip: busca por c√≥digo, nombre, contenedor o tipo de contenedor.</div>


    <div id="fe-modal-resultados" style="margin-top: 10px; overflow:auto; padding-right:6px; display:flex; flex-direction:column; gap:8px;"></div>

    <div style="display:flex; justify-content:flex-end; gap:10px; margin-top: 12px;">
      <button type="button" id="fe-modal-cancel" class="bodega-export-pdf-btn" style="padding:8px 12px;">Cerrar</button>
    </div>
  </div>
</div>

<!-- Modal de Espera -->
<div id="fe-modal-espera" class="devolucion-modal-overlay" style="display: none;">
  <div class="devolucion-modal-content">
    <div class="devolucion-modal-body" style="text-align: center;">
      <div class="spinner" style="border: 4px solid whitesmoke; border-top: 4px solid blue; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 16px;"></div>
      <h3 class="devolucion-modal-title">Generando PDF</h3>
      <p>Por favor espere mientras se genera el archivo PDF...</p>
    </div>
  </div>
</div>

<!-- Supabase SDK -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="../../../src/config/supabaseClient.js"></script>
<!-- PDF export (local) -->
<script src="../../../libs/html2pdf.min.js"></script>

<style>
/* Plantilla ficha/etiqueta (estilo tipo tu ejemplo) */
.fe-ficha { width: 792px; max-width: 100%; margin: 0 auto; background: white; border: 1px solid #eee; position: relative; padding-bottom: 60px; }
.fe-ficha-header { padding: 25px; display:flex; align-items:center; justify-content:space-between; gap:14px; }
.fe-ficha-header h1 { color: white; margin: 0; font-size: 26px; letter-spacing: 1px; font-weight: 800; }
.fe-ficha-header p { color: rgba(255,255,255,0.9); font-size: 14px; margin: 5px 0 0 0; font-weight: bold; }
.fe-logo-box { background: white; padding: 8px; border-radius: 8px; display:flex; align-items:center; justify-content:center; box-shadow: 0 4px 6px rgba(0,0,0,0.2); }
.fe-logo { height: 65px; width: auto; object-fit: contain; }
.fe-ficha-content { padding: 30px; display:flex; gap: 30px; }
.fe-photo { width: 220px; height: 220px; border: 1px solid lightgray; border-radius: 10px; overflow:hidden; flex-shrink: 0; background: aliceblue; display:flex; align-items:center; justify-content:center; }
.fe-photo-placeholder { font-size: 60px; color: lightsteelblue; }
.fe-grid { flex: 1; display:grid; grid-template-columns: 1fr 1fr; gap: 15px 25px; color: darkslategray; font-size: 14px; }
.fe-item { border-bottom: 1px solid whitesmoke; padding-bottom: 4px; }
.fe-label { font-weight: bold; }
.fe-footer {
  text-align: center;
  padding: 20px;
  background: aliceblue;
  font-size: 42px;
  font-weight: 900;
  letter-spacing: 3px;
  word-break: break-word;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 10px;
}

.fe-etiq { width: 380px; max-width: 100%; background: white; border: 2px solid black; padding: 15px; font-family: Arial, sans-serif; position: relative; }
.fe-etiq-row { display:flex; gap:12px; align-items:flex-start; }
.fe-etiq-photo { width: 70px; height: 70px; border: 1px solid lightgray; border-radius: 8px; overflow:hidden; flex-shrink: 0; background: aliceblue; display:flex; align-items:center; justify-content:center; }
.fe-etiq-photo img { width:100%; height:100%; object-fit:cover; }
.fe-etiq-photo-placeholder { font-size: 30px; color: lightsteelblue; }
.fe-etiq-right { flex: 1; min-width: 0; }
.fe-etiq-grid { display:flex; flex-wrap:wrap; gap:12px; padding: 10px; }
.fe-hijos-table { width:100%; border-collapse: collapse; font-size: 12px; margin-top: 12px; }
.fe-hijos-table th, .fe-hijos-table td { border:1px solid lightgray; padding: 6px 8px; text-align:left; vertical-align: top; }
.fe-hijos-table th { background:aliceblue; }
.fe-hijos-thumb { width: 34px; height: 34px; border-radius: 6px; overflow:hidden; border:1px solid lightgray; background:aliceblue; display:flex; align-items:center; justify-content:center; flex-shrink:0; }
.fe-hijos-thumb img { width:100%; height:100%; object-fit:cover; }
.fe-hijos-thumb span { font-size: 16px; color:lightsteelblue; }
.fe-barcode { display:none; }
.fe-bar { display:none; }
.fe-bar4 { display:none; }
.fe-etiq-codigo { text-align:center; font-size: 22px; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 10px; word-break: break-all; font-weight: 900; }
.fe-etiq-nombre { font-weight: 900; font-size: 16px; text-transform: uppercase; margin-bottom: 4px; }
.fe-etiq-detalle { font-size: 14px; color: #444; margin-bottom: 15px; }
.fe-etiq-footer {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
  gap: 8px;
  border-top: 1px dashed #ccc;
  padding-top: 10px;
  font-family: Arial, sans-serif;
  font-size: 12px;
  color: #888;
}
.fe-etiq-logo { height: 25px; width: auto; object-fit: contain; }
.fe-qr-box { display:none; }
.fe-etiq-qr { display:none; }
.fe-pagebreak { page-break-before: always; break-before: page; }

/* Indicador de cantidad */
.fe-cantidad-indicator {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  color: white;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  font-size: 14px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

/* En ficha: que la cantidad se vea grande (similar al c√≥digo del footer) */
.fe-footer .fe-cantidad-indicator {
  width: 78px;
  height: 78px;
  font-size: inherit;
  line-height: 1;
}

/* Impresi√≥n: solo se imprime el √°rea seleccionada */
@media print {
  body * { visibility: hidden !important; }
  .fe-print-root, .fe-print-root * { visibility: visible !important; }
  .fe-print-root { position: fixed; left: 0; top: 0; width: 100%; }
}

/* Estilos para modal de espera */
.devolucion-modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1000;
}
.devolucion-modal-content {
  background: white;
  border-radius: 12px;
  padding: 24px;
  max-width: 500px;
  width: 90%;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
}
.devolucion-modal-title {
  margin: 0 0 16px 0;
  color: mediumblue;
  font-size: 20px;
}
.devolucion-modal-body {
  margin-bottom: 20px;
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
</style>

<script>
(function () {
  const root = document.getElementById('fe-preview-ficha');
  if (!root) return;
  if (root.dataset.feInit === '1') return;
  root.dataset.feInit = '1';

  const supa = window.supabaseClient;
  const FICHA_KEY = 'bodega_ficha_layout_v1';
  const ETIQ_KEY  = 'bodega_etiqueta_layout_v1';

  const THEMES = [
    { key: 'AUTO', name: 'Auto (por bodega)', start: null, end: null, accent: null },
    { key: 'AZUL', name: 'Azul', start: 'mediumblue', end: 'skyblue', accent: 'mediumblue' },
    { key: 'MORADO', name: 'Morado', start: 'mediumpurple', end: 'hotpink', accent: 'mediumpurple' },
    { key: 'VERDE', name: 'Verde', start: 'teal', end: 'limegreen', accent: 'teal' },
    { key: 'NARANJA', name: 'Naranja', start: 'chocolate', end: 'darkorange', accent: 'chocolate' },
    { key: 'ROJO', name: 'Rojo', start: 'crimson', end: 'red', accent: 'crimson' },
    { key: 'GRIS', name: 'Gris', start: 'darkslategray', end: 'slategray', accent: 'darkslategray' },
    { key: 'AMARILLO', name: 'Amarillo', start: 'goldenrod', end: 'khaki', accent: 'goldenrod' },
    { key: 'TURQUESA', name: 'Turquesa', start: 'darkcyan', end: 'paleturquoise', accent: 'darkcyan' },
    { key: 'ROSA', name: 'Rosa', start: 'deeppink', end: 'pink', accent: 'deeppink' },
    { key: 'MARRON', name: 'Marr√≥n', start: 'saddlebrown', end: 'burlywood', accent: 'saddlebrown' },
    { key: 'LIMA', name: 'Lima', start: 'seagreen', end: 'greenyellow', accent: 'seagreen' }
  ];

  const ALLOWED = [
    { value: 'NADA', label: 'Nada (vac√≠o)' },
    { value: 'NOMBRE', label: 'Nombre' },
    { value: 'CODIGO', label: 'C√≥digo' },
    { value: 'UBICACION', label: 'Ubicaci√≥n (Principal/Secundaria)' },
    { value: 'PRINCIPAL', label: 'Bodega Principal' },
    { value: 'SECUNDARIA', label: 'Bodega Secundaria' },
    { value: 'CONTENEDOR', label: 'Contenedor/Lote' },
    { value: 'TIPO_USO', label: 'Tipo de uso' },
    { value: 'TIPO_MATERIAL', label: 'Tipo de material' },
    { value: 'COLOR', label: 'Color' },
    { value: 'UNIDAD', label: 'Unidad' },
    { value: 'DIMENSIONES', label: 'Medidas/Dimensiones' },
    { value: 'MARCA', label: 'Marca' },
    { value: 'MODELO', label: 'Modelo' },

    { value: 'ESTADO', label: 'Estado (Fabricaci√≥n Local/Original)' },

    { value: 'FECHA', label: 'Fecha' }
  ];

  const DEFAULT_FICHA = {
    principal: 'NOMBRE',
    secundario: 'CODIGO',
    fotoPos: 'left',
    campos: ['NOMBRE', 'CODIGO', 'UBICACION', 'COLOR', 'TIPO_USO', 'TIPO_MATERIAL', 'UNIDAD', 'DIMENSIONES', 'MARCA', 'MODELO', 'ESTADO', 'FECHA'],
    themeKey: 'AUTO'
  };

  const DEFAULT_ETIQ = {
    principal: 'CODIGO',
    secundario: 'NOMBRE',
    fotoPos: 'hide',
    campos: ['COLOR', 'UBICACION', 'NADA'],
  };

  const state = {
    bodegaKey: null,
    buscarTipo: 'MATERIAL',
    material: null,
    hijos: [],
    ficha: null,
    etiq: null,
    allCodes: [],
    currentIndex: -1
  };

  const BUSCAR_TIPO_STORAGE_KEY = 'bodega_ficha_etiqueta_buscar_tipo_v1';

  const BODEGA_STORAGE_KEY = 'bodega_ficha_etiqueta_bodega_v1';
  const BODEGAS = [
    { key: 'AUDIOVISUAL', label: 'Audiovisual', catalogo: 'catalogo_audiovisual', movimientos: 'movimientos_bodega_audiovisual', stock: 'stock_audiovisual' },
    { key: 'HIERROS', label: 'Hierros', catalogo: 'catalogo_hierros', movimientos: 'movimientos_bodega_hierros', stock: 'stock_hierros' },
    { key: 'CONSUMIBLES', label: 'Consumibles', catalogo: 'catalogo_consumibles', movimientos: 'movimientos_bodega_consumibles', stock: 'stock_consumibles' }
  ];

  function normalizeBodegaKey(k) {
    const kk = (k || '').toString().trim().toUpperCase();
    return BODEGAS.some(b => b.key === kk) ? kk : null;
  }

  function inferBodegaKeyFromContext() {
    const ctxCatalogo = window.__UA_CONTEXT?.tableOverrides?.catalogo;
    if (!ctxCatalogo) return null;
    const hit = BODEGAS.find(b => b.catalogo === ctxCatalogo);
    return hit?.key || null;
  }

  function loadBodegaKey() {
    try {
      const stored = normalizeBodegaKey(localStorage.getItem(BODEGA_STORAGE_KEY));
      if (stored) return stored;
    } catch (_) {}
    const inferred = inferBodegaKeyFromContext();
    if (inferred) return inferred;
    return 'AUDIOVISUAL';
  }

  function getActiveBodega() {
    const k = normalizeBodegaKey(state.bodegaKey) || 'AUDIOVISUAL';
    return BODEGAS.find(b => b.key === k) || BODEGAS[0];
  }

  function getActiveTables() {
    const b = getActiveBodega();
    return { catalogo: b.catalogo, movimientos: b.movimientos, stock: b.stock };
  }

  function setActiveBodega(key, opts = {}) {
    const { persist = true, clearMaterial = true } = opts;
    const k = normalizeBodegaKey(key) || 'AUDIOVISUAL';
    state.bodegaKey = k;
    if (persist) {
      try { localStorage.setItem(BODEGA_STORAGE_KEY, k); } catch (_) {}
    }
    if (clearMaterial) {
      state.material = null;
      state.hijos = [];
      state.currentIndex = -1;
      state.allCodes = [];
      loadAllCodes();
      const status = document.getElementById('fe-status');
      if (status) status.textContent = `(sin material cargado) ‚Äî Bodega: ${getActiveBodega().label}`;
      renderAll();
    }
  }

  function normalizeBuscarTipo(v) {
    const t = (v || '').toString().trim().toUpperCase();
    return (t === 'CONTENEDOR' || t === 'MATERIAL') ? t : 'MATERIAL';
  }

  function normalizeTipoAlta(v) {
    const t = (v || '').toString().trim().toUpperCase();
    if (t.includes('CONTEN')) return 'CONTENEDOR';
    if (t.includes('MATER')) return 'MATERIAL';
    return '';
  }
  function asBool(v) {
    if (v === true) return true;
    if (v === false || v == null) return false;
    if (v === 1 || v === '1') return true;
    if (typeof v === 'string') {
      const t = v.trim().toLowerCase();
      return t === 't' || t === 'true' || t === 'yes' || t === 'si' || t === 's√≠';
    }
    return false;
  }

  function loadBuscarTipo() {
    try {
      return normalizeBuscarTipo(localStorage.getItem(BUSCAR_TIPO_STORAGE_KEY));
    } catch (_) {
      return 'MATERIAL';
    }
  }

  function setBuscarTipo(v, opts = {}) {
    const { persist = true, clearMaterial = false } = opts;
    state.buscarTipo = normalizeBuscarTipo(v);
    if (persist) {
      try { localStorage.setItem(BUSCAR_TIPO_STORAGE_KEY, state.buscarTipo); } catch (_) {}
    }
    if (clearMaterial) {
      state.material = null;
      state.hijos = [];
      const status = document.getElementById('fe-status');
      if (status) status.textContent = `(sin material cargado) ‚Äî Bodega: ${getActiveBodega().label}`;
      renderAll();
    }
  }

  // ----------------------------
  // Modal buscador de material
  // ----------------------------
  const modal = document.getElementById('fe-modal-buscador');
  const modalQ = document.getElementById('fe-modal-q');
  const modalResultados = document.getElementById('fe-modal-resultados');
  const btnAbrirBuscador = document.getElementById('fe-btn-abrir-buscador');
  const btnModalBuscar = document.getElementById('fe-modal-buscar');
  const btnModalCancel = document.getElementById('fe-modal-cancel');
  const btnModalX = document.getElementById('fe-modal-x');

  function abrirModalBuscador() {
    if (!modal) return;
    modal.style.display = 'flex';
    if (modalResultados) modalResultados.innerHTML = '<div style="color:slategray; font-size:12px;">Escribe para buscar...</div>';
    setTimeout(() => modalQ?.focus(), 0);
  }

  function cerrarModalBuscador() {
    if (!modal) return;
    modal.style.display = 'none';
  }

  function escapeHtml(s) {
    return String(s || '')
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#039;');
  }

  function hashStringToIndex(str, mod) {
    const s = String(str || '');
    let h = 0;
    for (let i = 0; i < s.length; i++) {
      h = ((h << 5) - h) + s.charCodeAt(i);
      h |= 0;
    }
    const n = Math.abs(h);
    return mod ? (n % mod) : n;
  }

  function normalizeThemeKey(key) {
    const raw = (key ?? 'AUTO').toString().trim();
    const k = raw.toUpperCase();
    if (THEMES.some(t => t.key === k)) return k;
    const byName = THEMES.find(t => String(t.name || '').trim().toUpperCase() === k);
    return byName ? byName.key : 'AUTO';
  }

  function getGradienteYColor(bodegaActual, themeKey) {
    const k = normalizeThemeKey(themeKey);
    if (k === 'AUTO') {
      // Paleta estable por nombre de bodega
      const palette = ['mediumblue', 'mediumpurple', 'teal', 'chocolate', 'crimson', 'skyblue'];
      const idx = hashStringToIndex(bodegaActual, palette.length);
      const base = palette[idx];
      return { gradienteStart: base, gradienteEnd: `${base}99`, colorAcento: base };
    }

    const t = THEMES.find(x => x.key === k);
    return {
      gradienteStart: t?.start || 'mediumblue',
      gradienteEnd: t?.end || 'skyblue',
      colorAcento: t?.accent || 'mediumblue'
    };
  }

  function getColorHex(colorNombre) {
    const c = String(colorNombre || '').trim().toLowerCase();
    const map = {
      'sin color': 'slategray',
      'negro': 'black',
      'blanco': 'white',
      'rojo': 'red',
      'rojo oscuro': 'darkred',
      'azul': 'blue',
      'azul oscuro': 'mediumblue',
      'celeste': 'blue',
      'verde': 'limegreen',
      'verde lima': 'limegreen',
      'verde oscuro': 'darkgreen',
      'amarillo': 'yellow',
      'naranja': 'darkorange',
      'gris': 'gray',
      'gris oscuro': 'darkgray',
      'violeta': 'violet',
      'fucsia': 'hotpink'
    };
    return map[c] || 'slategray';
  }

  function hexToColorName(hex) {
    const map = {
      '#94a3b8': 'sin color',
      '#000000': 'negro',
      '#ffffff': 'blanco',
      '#ef4444': 'rojo',
      '#b91c1c': 'rojo oscuro',
      '#3b82f6': 'azul',
      '#1e40af': 'azul oscuro',
      '#3b82f6': 'celeste',
      '#22c55e': 'verde',
      '#22c55e': 'verde lima',
      '#166534': 'verde oscuro',
      '#fde047': 'amarillo',
      '#f97316': 'naranja',
      '#9ca3af': 'gris',
      '#4b5563': 'gris oscuro',
      '#8b5cf6': 'violeta',
      '#d946ef': 'fucsia',
      '#0f172a': 'gris oscuro'
    };
    return map[hex] || hex;
  }

  function buildDimensionesStr(m) {
    const unidad = (m?.unidad_medida || 'SIN').toString();
    if (unidad === 'SIN') return 'Sin Medida';
    const dims = m?.dimensiones && typeof m.dimensiones === 'object' ? m.dimensiones : {};
    const ancho = (dims.ancho ?? dims.width ?? dims.ANCHO);
    const largo = (dims.largo ?? dims.length ?? dims.LARGO);
    const grosor = (dims.grosor ?? dims.alto ?? dims.height ?? dims.GROSOR);
    const uLabel = (unidad === 'PUL') ? 'pulg' : 'cm';
    const a = (ancho ?? '‚Äì');
    const l = (largo ?? '‚Äì');
    const g = (grosor ?? '‚Äì');
    return `${a} √ó ${l} √ó ${g} ${uLabel}`;
  }

  async function buscarMateriales(q) {
    if (!supa) throw new Error('Supabase no est√° inicializado.');
    const clean = String(q || '').trim();
    if (!clean) return [];

    const { catalogo } = getActiveTables();
    const isConsumibles = (catalogo === 'catalogo_consumibles');

    // Limita caracteres problem√°ticos en el filtro OR
    const safe = clean.replace(/[,]/g, ' ').slice(0, 80);
    const like = `%${safe}%`;

    const wantContainers = (state.buscarTipo === 'CONTENEDOR');

    // No mezclar contenedores en b√∫squedas de materiales.
    // IMPORTANTE: en tu data actual, los contenedores pueden tener es_contenedor=false,
    // as√≠ que la fuente de verdad aqu√≠ es tipo_alta (y es_contenedor solo ayuda si est√° bien).
    const selectBusqueda = isConsumibles

      ? 'codigo, nombre, bodega_principal, bodega_secundaria, foto_url, campos_personalizados, contenedor, contenedor_tipo'
      : 'codigo, nombre, bodega_principal, bodega_secundaria, foto_url, es_contenedor, tipo_alta, campos_personalizados, contenedor, contenedor_tipo';


    let { data, error } = await supa
      .from(catalogo)
      .select(selectBusqueda)

      .or(`codigo.ilike.${like},nombre.ilike.${like},contenedor.ilike.${like},contenedor_tipo.ilike.${like}`)

      .order('nombre', { ascending: true })
      .limit(80);

    if (error) {
      const msg = (error.message || '').toLowerCase();
      const missingKnown = (msg.includes('does not exist') && (msg.includes('es_contenedor') || msg.includes('tipo_alta'))) || error.code === '42703';
      if (!missingKnown) throw error;

      const retry = await supa
        .from(catalogo)

        .select('codigo, nombre, bodega_principal, bodega_secundaria, foto_url, campos_personalizados, contenedor, contenedor_tipo')
        .or(`codigo.ilike.${like},nombre.ilike.${like},contenedor.ilike.${like},contenedor_tipo.ilike.${like}`)

        .order('nombre', { ascending: true })
        .limit(80);
      if (retry.error) throw retry.error;
      data = retry.data || [];
    }

    const rows = Array.isArray(data) ? data : [];
    const filtered = rows.filter(r => {
      const rowIsCont = asBool(r?.es_contenedor) || (normalizeTipoAlta(r?.tipo_alta || r?.campos_personalizados?.tipo_alta) === 'CONTENEDOR');
      return wantContainers ? rowIsCont : !rowIsCont;
    });
    return filtered.slice(0, 30);
  }

  function renderResultados(items) {
    if (!modalResultados) return;
    if (!items.length) {
      modalResultados.innerHTML = '<div style="color:slategray; font-size:12px;">Sin resultados.</div>';
      return;
    }

    modalResultados.innerHTML = '';
    items.forEach((it) => {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'bodega-export-pdf-btn';
      btn.style.textAlign = 'left';
      btn.style.padding = '10px 10px';
      btn.style.border = '1px solid rgba(148,163,184,0.18)';
      btn.style.background = 'rgba(15,23,42,0.18)';
      btn.innerHTML = `
        <div style="display:flex; justify-content:space-between; gap:10px;">
          <div style="font-weight:900; color:lightgray;">${escapeHtml(it.nombre || '')}</div>
          <div style="color:lightsteelblue; font-weight:800;">${escapeHtml(it.codigo || '')}</div>
        </div>
        <div style="margin-top:4px; color:slategray; font-size:12px;">
          ${escapeHtml(it.bodega_principal || '')} / ${escapeHtml(it.bodega_secundaria || '')}
        </div>
      `;
      btn.onclick = async () => {
        const codigo = (it.codigo || '').toString();
        const inputCodigo = document.getElementById('fe-codigo-buscar');
        if (inputCodigo) inputCodigo.value = codigo;
        cerrarModalBuscador();
        try {
          await cargarMaterial(codigo);
        } catch (err) {
          console.error(err);
          alert('‚ùå No se pudo cargar: ' + (err.message || err));
        }
      };
      modalResultados.appendChild(btn);
    });
  }

  async function ejecutarBusquedaModal() {
    const q = (modalQ?.value || '').toString().trim();
    if (!q) {
      renderResultados([]);
      return;
    }
    if (modalResultados) modalResultados.innerHTML = '<div style="color:slategray; font-size:12px;">Buscando...</div>';
    const items = await buscarMateriales(q);
    renderResultados(items);
  }

  function loadCfg(key, fallback) {
    try {
      const raw = JSON.parse(localStorage.getItem(key) || 'null');
      if (!raw || typeof raw !== 'object') return { ...fallback };
      const base = {
        principal: raw.principal || fallback.principal,
        secundario: raw.secundario || fallback.secundario,
        fotoPos: raw.fotoPos || fallback.fotoPos,
        campos: Array.isArray(raw.campos) ? raw.campos.slice(0, fallback.campos.length) : fallback.campos.slice()
      };
      if ('themeKey' in fallback) {
        base.themeKey = normalizeThemeKey(raw.themeKey || fallback.themeKey || 'AUTO');
      }
      return base;
    } catch {
      return { ...fallback };
    }
  }

  function saveCfg() {
    localStorage.setItem(FICHA_KEY, JSON.stringify(state.ficha));
    localStorage.setItem(ETIQ_KEY, JSON.stringify(state.etiq));
  }

  function optHtml() {
    return ALLOWED.map(o => `<option value="${o.value}">${o.label}</option>`).join('');
  }

  function setSelectOptions(selectEl) {
    selectEl.innerHTML = optHtml();
  }

  function getValue(field, material) {
    const m = material || {};
    switch (field) {
      case 'NADA': return '';
      case 'NOMBRE': return (m.nombre || '').toString();
      case 'CODIGO': return (m.codigo || '').toString();
      case 'UBICACION': {
        const p = (m.bodega_principal || '').toString();
        const s = (m.bodega_secundaria || '').toString();
        if (p && s) return `${p} / ${s}`;
        return p || s || '';
      }
      case 'PRINCIPAL': return (m.bodega_principal || '').toString();
      case 'SECUNDARIA': return (m.bodega_secundaria || '').toString();
      case 'CONTENEDOR': return (m.__contenedores_str || m.contenedor_nombre || '').toString();
      case 'TIPO_USO': return (m.tipo_uso || '').toString();
      case 'TIPO_MATERIAL': return (m.tipo_material || '').toString();
      case 'COLOR': {
        const colorValue = (m.color || '').toString();
        return /^#[0-9a-fA-F]{6}$/.test(colorValue) ? hexToColorName(colorValue) : colorValue;
      }
      case 'UNIDAD': return (m.unidad_medida || '').toString();
      case 'DIMENSIONES': return (m.__dimensiones_str || '').toString();
      case 'MARCA': return (m.marca || '').toString();
      case 'MODELO': return (m.modelo || '').toString();
      case 'ESTADO': return (m.__estado_str || '').toString();
      case 'FECHA': return (m.__fecha_str || '').toString();
      default: return '';
    }
  }

  function buildContenedoresStr(rows) {
    const list = Array.isArray(rows) ? rows : [];
    const cleaned = list
      .map(r => ({
        nombre: (r?.ubicacion_nombre ?? '').toString().trim(),
        existencia: Number(r?.cantidad ?? 0)
      }))
      .filter(x => x.nombre && isFinite(x.existencia) && x.existencia !== 0);

    if (!cleaned.length) return '';
    return cleaned
      .map(x => `${x.nombre}: ${x.existencia}`)
      .join(' | ');
  }

  function labelOf(field) {
    return ALLOWED.find(a => a.value === field)?.label || field;
  }

  function renderFieldsList(container, values, max) {
    container.innerHTML = '';
    for (let i = 0; i < max; i++) {
      const select = document.createElement('select');
      select.className = 'audiovisual-input';
      setSelectOptions(select);
      select.value = values[i] || 'NADA';
      container.appendChild(select);
    }
  }

  function readFieldsList(container) {
    const selects = Array.from(container.querySelectorAll('select'));
    return selects.map(s => (s.value || '').toString()).filter(Boolean);
  }

  function renderPreviewFicha() {
    const m = state.material;
    const cfg = state.ficha;

    const printArea = document.getElementById('fe-ficha-print-area');
    if (!printArea) return;

    const material = m || {};
    const principalText = getValue(cfg.principal, material) || '‚Äî';
    const secundarioText = getValue(cfg.secundario, material) || '';

    const bodegaActual = (material.bodega_principal || material.bodega_secundaria || 'Bodega').toString();
    const { gradienteStart, gradienteEnd, colorAcento } = getGradienteYColor(bodegaActual, cfg.themeKey);

    const codigoFooter = (material.codigo || '').toString() || '‚Äî';
    const cantidadFooter = (m && !m.__es_contenedor)
      ? (m.__stock_total ?? m.cantidad ?? 1)
      : null;

    const fotoUrl = material.foto_url ? String(material.foto_url) : '';
    const fotoBlock = (cfg.fotoPos === 'hide')
      ? ''
      : `
        <div class="fe-photo" style="order:${cfg.fotoPos === 'right' ? 2 : 0};">
          ${fotoUrl
            ? `<img src="${fotoUrl}" style="width:100%; height:100%; object-fit:cover;" />`
            : `<div class="fe-photo-placeholder">üì∑</div>`
          }
        </div>
      `;

    const campos = Array.isArray(cfg.campos) ? cfg.campos.slice(0, 12) : [];
    const gridItems = campos.map(f => {
      const v = getValue(f, material);
      if (!v) return '';

      if (f === 'COLOR') {
        const hex = getColorHex(String(v));
        return `
          <div class="fe-item">
            <span class="fe-label" style="color:${colorAcento};">${labelOf(f)}:</span><br>
            <span style="display:inline-block;width:12px;height:12px;background:${hex};border:1px solid slategray;border-radius:2px;margin-right:5px;"></span>
            ${escapeHtml(String(v))}
          </div>
        `;
      }

      return `
        <div class="fe-item">
          <span class="fe-label" style="color:${colorAcento};">${labelOf(f)}:</span><br>
          ${escapeHtml(String(v))}
        </div>
      `;
    }).filter(Boolean).join('');

    const hijos = Array.isArray(state.hijos) ? state.hijos : [];
    const totalItems = hijos.reduce((acc, h) => {
      const q = Number(h?.__cantidad);
      if (!isFinite(q)) return acc + 1;
      return acc + q;
    }, 0);
    const totalItemsStr = Number.isInteger(totalItems) ? String(totalItems) : String(Math.round(totalItems * 100) / 100);

    const hijosBlock = (material.__es_contenedor && hijos.length)
      ? `
        <div style="margin-top: 14px;">
          <div style="font-weight:900; margin: 0 0 6px 0; color:${colorAcento};">Hijos dentro del contenedor (${hijos.length}) ‚Äî Total items: ${escapeHtml(totalItemsStr)}</div>
          <table class="fe-hijos-table">
            <thead>
              <tr>
                <th style="width:190px;">C√≥digo</th>
                <th>Nombre</th>
                <th style="width:90px; text-align:right;">Cantidad</th>
              </tr>
            </thead>
            <tbody>
              ${hijos.map(h => {
                return `
                  <tr>
                    <td style="font-weight:900;">${escapeHtml(String(h.codigo || ''))}</td>
                    <td>${escapeHtml(String(h.nombre || ''))}</td>
                    <td style="text-align:right; font-weight:900;">${escapeHtml(String(h.__cantidad ?? ''))}</td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        </div>
      `
      : '';

    printArea.innerHTML = `
      <div class="fe-ficha">
        <div class="fe-ficha-header" style="background: linear-gradient(135deg, ${gradienteStart}, ${gradienteEnd});">
          <div>
            <h1>FICHA T√âCNICA DE MATERIAL</h1>
            <p>BODEGA: ${escapeHtml(bodegaActual.toUpperCase())}</p>
          </div>
          <div class="fe-logo-box">
            <img class="fe-logo" src="./assets/logo.png" alt="Logo" />
          </div>
        </div>

        <div class="fe-ficha-content" style="flex-direction:${cfg.fotoPos === 'right' ? 'row-reverse' : 'row'};">
          ${fotoBlock}
          <div class="fe-grid">
            <div class="fe-item"><span class="fe-label" style="color:${colorAcento};">${escapeHtml(labelOf(cfg.principal))}:</span><br>${escapeHtml(String(principalText))}</div>
            <div class="fe-item"><span class="fe-label" style="color:${colorAcento};">${escapeHtml(labelOf(cfg.secundario))}:</span><br>${escapeHtml(String(secundarioText))}</div>
            ${gridItems}
          </div>
        </div>

        ${hijosBlock}
        <div class="fe-footer" style="border-top: 5px solid ${colorAcento}; color:${colorAcento};">
          <div>${escapeHtml(codigoFooter)}</div>
          ${(cantidadFooter !== null && cantidadFooter !== undefined)
            ? `<div class="fe-cantidad-indicator" style="background:${colorAcento};">${escapeHtml(String(cantidadFooter))}</div>`
            : ''}
        </div>
      </div>
    `;
  }

  function renderPreviewEtiq() {
    const m = state.material;
    const cfg = state.etiq;

    const printArea = document.getElementById('fe-etiq-print-area');
    if (!printArea) return;

    const material = m || {};
    const bodegaActual = (material.bodega_principal || material.bodega_secundaria || 'Bodega').toString();
    const { colorAcento } = getGradienteYColor(bodegaActual, state.ficha?.themeKey || 'AUTO');

    function renderEtiquetaDeItem(item) {
      const principalCfg = (cfg.principal || '').toString().toUpperCase();
      // Siempre mostrar el c√≥digo real del √≠tem como fallback (para que nunca quede vac√≠o)
      const codigo = (principalCfg === 'NADA')
        ? (item.codigo || '‚Äî')
        : (getValue(cfg.principal, item) || (item.codigo || '‚Äî'));
      const nombre = getValue(cfg.secundario, item) || (item.nombre || 'Producto');
      const campos = Array.isArray(cfg.campos) ? cfg.campos.slice(0, 3) : [];
      const detalleParts = campos
        .map(f => getValue(f, item))
        .map(v => (v || '').toString().trim())
        .filter(Boolean)
        .slice(0, 3);
      const detalle = detalleParts.length ? detalleParts.join(' | ') : '';

      const fotoUrl = item.foto_url ? String(item.foto_url) : '';
      const showFoto = (cfg.fotoPos && cfg.fotoPos !== 'hide');
      const fotoBlock = (!showFoto)
        ? ''
        : `
          <div class="fe-etiq-photo" style="order:${cfg.fotoPos === 'right' ? 2 : 0};">
            ${fotoUrl ? `<img src="${fotoUrl}" />` : `<div class="fe-etiq-photo-placeholder">üì∑</div>`}
          </div>
        `;

      const qrBlock = '';
      const qty = (item?.__cantidad ?? item?.__stock_total ?? item?.cantidad ?? 1);

      return `
        <div class="fe-etiq" style="border-color:${colorAcento}; width: 384px; position: relative;">
          <div class="fe-etiq-row" style="flex-direction:${cfg.fotoPos === 'right' ? 'row-reverse' : 'row'};">
            ${fotoBlock}
            <div class="fe-etiq-right">
              <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:10px;">
                <div style="flex:1; min-width:0;">
                  <div class="fe-etiq-nombre">${escapeHtml(String(nombre))}</div>
                  <div class="fe-etiq-detalle">${escapeHtml(detalle)}</div>
                </div>
                ${qrBlock}
              </div>
              <div class="fe-etiq-footer" style="border-top-color:${colorAcento};">
                <div class="fe-etiq-codigo" style="border-bottom-color:${colorAcento} !important; color:${colorAcento} !important; font-size: 18px; font-weight: bold;">${escapeHtml(String(codigo))}</div>
                <div class="fe-cantidad-indicator" style="background:${colorAcento};">${escapeHtml(String(qty))}</div>
              </div>
            </div>
          </div>
          <img class="fe-etiq-logo" src="./assets/logo.png" alt="Logo" style="position: absolute; top: 10px; right: 10px; width: 120px; height: auto; z-index: 10;" />
        </div>
      `;
    }

    if (material.__es_contenedor) {
      const hijos = Array.isArray(state.hijos) ? state.hijos : [];
      if (!hijos.length) {
        printArea.innerHTML = `
          <div style="padding: 10px; color:darkslategray; font-size: 13px;">
            (Contenedor cargado sin hijos)
          </div>
        `;
        return;
      }
      printArea.innerHTML = `
        <div class="fe-etiq-grid">
          ${hijos.map(h => renderEtiquetaDeItem(h)).join('')}
        </div>
      `;
      return;
    }

    printArea.innerHTML = renderEtiquetaDeItem(material);
  }

  function renderAll() {
    renderPreviewFicha();
    renderPreviewEtiq();
  }

  function wireUI() {
    const bodegaSelect = document.getElementById('fe-bodega-select');
    const buscarTipo = document.getElementById('fe-buscar-tipo');
    const fichaPrincipal = document.getElementById('fe-ficha-principal');
    const fichaSec = document.getElementById('fe-ficha-secundario');
    const fichaFoto = document.getElementById('fe-ficha-foto-pos');
    const fichaTheme = document.getElementById('fe-ficha-theme');
    const fichaCampos = document.getElementById('fe-ficha-campos');

    const etiqPrincipal = document.getElementById('fe-etiq-principal');
    const etiqSec = document.getElementById('fe-etiq-secundario');
    const etiqFoto = document.getElementById('fe-etiq-foto-pos');
    const etiqCampos = document.getElementById('fe-etiq-campos');

    if (bodegaSelect) {
      bodegaSelect.innerHTML = BODEGAS.map(b => `<option value="${b.key}">${b.label}</option>`).join('');
      bodegaSelect.value = normalizeBodegaKey(state.bodegaKey) || 'AUDIOVISUAL';
      bodegaSelect.addEventListener('change', () => {
        setActiveBodega(bodegaSelect.value, { persist: true, clearMaterial: true });
      });
    }

    if (buscarTipo) {
      buscarTipo.value = normalizeBuscarTipo(state.buscarTipo);
      buscarTipo.addEventListener('change', () => {
        setBuscarTipo(buscarTipo.value, { persist: true, clearMaterial: true });
      });
    }

    [fichaPrincipal, fichaSec, etiqPrincipal, etiqSec].forEach(setSelectOptions);

    if (fichaTheme) {
      fichaTheme.innerHTML = THEMES.map(t => `<option value="${t.key}">${t.name}</option>`).join('');
    }

    fichaPrincipal.value = state.ficha.principal;
    fichaSec.value = state.ficha.secundario;
    fichaFoto.value = state.ficha.fotoPos;
    if (fichaTheme) fichaTheme.value = normalizeThemeKey(state.ficha.themeKey);

    etiqPrincipal.value = state.etiq.principal;
    etiqSec.value = state.etiq.secundario;
    etiqFoto.value = state.etiq.fotoPos;

    renderFieldsList(fichaCampos, state.ficha.campos, 12);
    renderFieldsList(etiqCampos, state.etiq.campos, 3);

    const onChange = () => {
      state.ficha.principal = fichaPrincipal.value;
      state.ficha.secundario = fichaSec.value;
      state.ficha.fotoPos = fichaFoto.value;
      state.ficha.campos = readFieldsList(fichaCampos).slice(0, 12);
      state.ficha.themeKey = normalizeThemeKey(fichaTheme?.value || state.ficha.themeKey);

      state.etiq.principal = etiqPrincipal.value;
      state.etiq.secundario = etiqSec.value;
      state.etiq.fotoPos = etiqFoto.value;
      state.etiq.campos = readFieldsList(etiqCampos).slice(0, 3);

      renderAll();
    };

    [fichaPrincipal, fichaSec, fichaFoto, fichaTheme, etiqPrincipal, etiqSec, etiqFoto]
      .filter(Boolean)
      .forEach(el => el.addEventListener('change', onChange));
    fichaCampos.addEventListener('change', onChange);
    etiqCampos.addEventListener('change', onChange);

    document.getElementById('fe-btn-guardar').addEventListener('click', () => {
      onChange();
      saveCfg();
      alert('‚úÖ Configuraci√≥n guardada.');
    });

    document.getElementById('fe-btn-reset').addEventListener('click', () => {
      state.ficha = { ...DEFAULT_FICHA, campos: DEFAULT_FICHA.campos.slice() };
      state.etiq = { ...DEFAULT_ETIQ, campos: DEFAULT_ETIQ.campos.slice() };
      saveCfg();
      wireUI();
      renderAll();
    });

    document.getElementById('fe-btn-limpiar').addEventListener('click', () => {
      state.material = null;
      state.currentIndex = -1;
      document.getElementById('fe-status').textContent = `(sin material cargado) ‚Äî Bodega: ${getActiveBodega().label}`;
      state.hijos = [];
      renderAll();
    });

    document.getElementById('fe-btn-buscar').addEventListener('click', () => {
      const codigo = (document.getElementById('fe-codigo-buscar').value || '').trim();
      if (!codigo) { alert('Ingrese un c√≥digo.'); return; }
      cargarMaterial(codigo).catch(err => {
        console.error(err);
        alert('‚ùå No se pudo cargar: ' + (err.message || err));
      });
    });

    // Modal buscador
    btnAbrirBuscador?.addEventListener('click', () => {
      if (!supa) {
        alert('‚ùå Supabase no est√° inicializado.');
        return;
      }
      abrirModalBuscador();
    });
    btnModalBuscar?.addEventListener('click', () => {
      ejecutarBusquedaModal().catch(err => {
        console.error(err);
        alert('‚ùå Error buscando: ' + (err.message || err));
      });
    });
    btnModalCancel?.addEventListener('click', cerrarModalBuscador);
    btnModalX?.addEventListener('click', cerrarModalBuscador);

    modal?.addEventListener('click', (e) => {
      if (e.target === modal) cerrarModalBuscador();
    });

    modalQ?.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        e.preventDefault();
        cerrarModalBuscador();
        return;
      }
      if (e.key === 'Enter') {
        e.preventDefault();
        ejecutarBusquedaModal().catch(err => {
          console.error(err);
          alert('‚ùå Error buscando: ' + (err.message || err));
        });
      }
    });

    document.getElementById('fe-btn-export-pdf')?.addEventListener('click', () => {
      exportarPDF().catch(err => {
        console.error(err);
        alert('‚ùå No se pudo exportar a PDF: ' + (err.message || err));
      });
    });


    document.getElementById('fe-btn-export-ficha-png')?.addEventListener('click', async () => {
      if (!state.material) {
        alert('‚ùå Primero carga un material o contenedor.');
        return;
      }
      try {
        await exportarPNG('ficha', state.material.codigo);
        alert('‚úÖ Ficha PNG exportada correctamente.');
      } catch (err) {
        alert('‚ùå Error al exportar ficha PNG: ' + (err.message || err));
      }
    });

    document.getElementById('fe-btn-export-etiq-png')?.addEventListener('click', async () => {
      if (!state.material) {
        alert('‚ùå Primero carga un material o contenedor.');
        return;
      }
      try {
        await exportarPNG('etiqueta', state.material.codigo);
        alert('‚úÖ Etiqueta PNG exportada correctamente.');
      } catch (err) {
        alert('‚ùå Error al exportar etiqueta PNG: ' + (err.message || err));
      }
    });

    // Navigation buttons
    document.getElementById('fe-btn-prev')?.addEventListener('click', () => {
      if (state.allCodes.length === 0) {
        loadAllCodes().then(() => {
          if (state.currentIndex > 0) navigateToCode(state.currentIndex - 1);
        });
      } else {
        if (state.currentIndex > 0) navigateToCode(state.currentIndex - 1);
      }
    });

    document.getElementById('fe-btn-next')?.addEventListener('click', () => {
      if (state.allCodes.length === 0) {
        loadAllCodes().then(() => {
          if (state.currentIndex < state.allCodes.length - 1) navigateToCode(state.currentIndex + 1);
        });
      } else {
        if (state.currentIndex < state.allCodes.length - 1) navigateToCode(state.currentIndex + 1);
      }
    });

  }

  function arrayBufferToBase64(buffer) {
    const bytes = new Uint8Array(buffer);
    let binary = '';
    const chunk = 0x8000;
    for (let i = 0; i < bytes.length; i += chunk) {
      binary += String.fromCharCode.apply(null, bytes.subarray(i, i + chunk));
    }
    return btoa(binary);
  }

  async function waitForImages(rootEl) {
    const imgs = Array.from(rootEl.querySelectorAll('img'));
    await Promise.all(imgs.map(img => {
      if (img.complete && img.naturalWidth > 0) return Promise.resolve();
      return new Promise(resolve => {
        const done = () => resolve();
        img.addEventListener('load', done, { once: true });
        img.addEventListener('error', done, { once: true });
      });
    }));
  }

  async function exportarPDF() {
    if (!state.material) throw new Error('Primero carga un material o contenedor.');
    if (!window.electronAPI || typeof window.electronAPI.renderHtmlToPdf !== 'function') {
      throw new Error('PDF nativo de Electron no est√° disponible.');
    }

    // Mostrar modal de espera
    document.getElementById('fe-modal-espera').style.display = 'flex';

    try {

    const fichaEl = document.getElementById('fe-ficha-print-area');
    const etiqEl = document.getElementById('fe-etiq-print-area');
    if (!fichaEl || !etiqEl) throw new Error('No se encontr√≥ el √°rea de exportaci√≥n.');

    const fichaHtml = (fichaEl.innerHTML || '').trim();
    const etiqHtml = (etiqEl.innerHTML || '').trim();
    if (!fichaHtml && !etiqHtml) throw new Error('La ficha/etiquetas est√°n vac√≠as (no hay nada que exportar).');

    const codigo = String(state.material.codigo || 'material');
    const filename = `${codigo}-ficha-etiquetas.pdf`;

    // Tomar el src ABSOLUTO del logo tal cual est√° cargando bien en la UI
    // (en export PDF, el HTML va en data URL y las rutas relativas suelen romperse).
    const logoSrcAbs = (() => {
      try {
        const img = document.querySelector('img.fe-logo') || document.querySelector('img.fe-etiq-logo');
        const src = img && img.src ? String(img.src) : '';
        return src;
      } catch (_) {
        return '';
      }
    })();

    const normalizeLogoInHtml = (html) => {
      if (!logoSrcAbs) return html;
      const safe = logoSrcAbs.replace(/"/g, '&quot;');
      return String(html)
        .replaceAll('src="./assets/logo.png"', `src="${safe}"`)
        .replaceAll("src='./assets/logo.png'", `src='${safe}'`)
        .replaceAll('src="assets/logo.png"', `src="${safe}"`)
        .replaceAll("src='assets/logo.png'", `src='${safe}'`);
    };

    const fichaHtmlFixed = normalizeLogoInHtml(fichaHtml);
    const etiqHtmlFixed = normalizeLogoInHtml(etiqHtml);

    const cssText = Array.from(document.querySelectorAll('style'))
      .map(s => s.textContent || '')
      .join('\n');

    const baseHref = (() => {
      try {
        const href = String(window.location.href || '');
        return new URL('../../../', href).href;
      } catch (_) {
        try {
          const href = String(window.location.href || '');
          return href.replace(/[^/]*$/, '');
        } catch (_2) {
          return '';
        }
      }
    })();

    const htmlDoc = `<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  ${baseHref ? `<base href="${baseHref}">` : ''}
  <style>
    ${cssText}
    html, body { margin: 0; padding: 0; background: white; }

    /* Override de impresi√≥n para export PDF multi-p√°gina:
       La app usa .fe-print-root fixed para impresi√≥n ‚Äúpor √°rea‚Äù, pero eso rompe el flujo del PDF.
       En esta ventana de export solo existe nuestro contenido, as√≠ que lo hacemos visible y est√°tico. */
    @media print {
      body * { visibility: visible !important; }
      .fe-print-root { position: static !important; left: auto !important; top: auto !important; width: auto !important; }
    }
  </style>
</head>
<body>
  <div class="fe-print-root" style="padding: 10px;">
    ${fichaHtmlFixed}
    <div class="fe-pagebreak"></div>
    ${etiqHtmlFixed}
  </div>
</body>
</html>`;

    const res = await window.electronAPI.renderHtmlToPdf({ filename, html: htmlDoc, baseUrl: baseHref });
    if (res && res.canceled) return;
    if (res && res.filePath) {
      alert('‚úÖ PDF guardado: ' + res.filePath);
      return;
    }
    throw new Error('Error al generar el PDF');
    } finally {
      // Ocultar modal de espera
      document.getElementById('fe-modal-espera').style.display = 'none';
    }
  }


  async function exportarPNG(tipo, selectedCode) {
    if (!state.material) throw new Error('Primero carga un material o contenedor.');
    if (!window.html2canvas) throw new Error('html2canvas no est√° disponible.');

    let elementId, filename;
    if (tipo === 'ficha') {
      elementId = 'fe-ficha-print-area';
      filename = `${selectedCode}-ficha.png`;
    } else {
      elementId = 'fe-etiq-print-area';
      filename = `${selectedCode}-etiqueta.png`;
    }

    const el = document.getElementById(elementId);
    if (!el) throw new Error(`No se encontr√≥ el √°rea de ${tipo}.`);

    const html = (el.innerHTML || '').trim();
    if (!html) throw new Error(`La ${tipo} est√° vac√≠a (no hay nada que exportar).`);

    try {
      // Capturar directamente el elemento visible
      const canvas = await window.html2canvas(el, {
        scale: 2, // Alta resoluci√≥n
        useCORS: true,
        allowTaint: true,
        backgroundColor: 'white'
      });

      // Convertir a blob y descargar
      canvas.toBlob((blob) => {
        if (!blob) {
          alert('‚ùå Error generando la imagen PNG.');
          return;
        }
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        alert('‚úÖ PNG exportado correctamente.');
      }, 'image/png');
    } catch (error) {
      throw new Error('Error capturando la imagen: ' + error.message);
    }
  }


  async function cargarMaterial(codigo) {
    if (!supa) throw new Error('Supabase no est√° inicializado.');

    const { catalogo, movimientos, stock } = getActiveTables();
    const isConsumibles = (catalogo === 'catalogo_consumibles');

    // 1) Cat√°logo
    let data = null;
    try {
      const res = await supa
        .from(catalogo)
        // Nota: apodo/nombre_base/nombre_numero/contenedor ayudan a identificar contenedores
        // (p.ej. "CASE 02") y a deducir hijos/ubicaci√≥n.
        // En consumibles, muchas de estas columnas NO existen; ah√≠ usamos campos_personalizados.
        .select(isConsumibles
          ? 'codigo, nombre, bodega_principal, bodega_secundaria, tipo_uso, tipo_material, color, unidad_medida, dimensiones, es_hechizo, marca, modelo, foto_url, campos_personalizados'
          : 'codigo, nombre, apodo, nombre_base, nombre_numero, contenedor, bodega_principal, bodega_secundaria, tipo_uso, tipo_material, color, unidad_medida, dimensiones, es_hechizo, marca, modelo, foto_url, es_contenedor, tipo_alta, campos_personalizados')
        .eq('codigo', codigo)
        .maybeSingle();
      if (res.error) throw res.error;
      data = res.data;
    } catch (e1) {
      const msg = (e1?.message || '').toLowerCase();
      const missingCol = (msg.includes('does not exist') && (
        msg.includes('es_contenedor') ||
        msg.includes('tipo_alta') ||
        msg.includes('apodo') ||
        msg.includes('nombre_base') ||
        msg.includes('nombre_numero') ||
        msg.includes('contenedor')
      )) || e1?.code === '42703';
      if (!missingCol) throw e1;

      const res2 = await supa
        .from(catalogo)
        .select('codigo, nombre, bodega_principal, bodega_secundaria, tipo_uso, tipo_material, color, unidad_medida, dimensiones, es_hechizo, marca, modelo, foto_url, campos_personalizados')
        .eq('codigo', codigo)
        .maybeSingle();
      if (res2.error) throw res2.error;
      data = res2.data;
    }

    if (!data) throw new Error('No encontrado en cat√°logo.');

    const isContenedor = asBool(data.es_contenedor) || (normalizeTipoAlta(data.tipo_alta || data.campos_personalizados?.tipo_alta) === 'CONTENEDOR');

    function computeContenedorKeys(row) {
      const r = row || {};
      const cp = (r && typeof r === 'object') ? (r.campos_personalizados || {}) : {};

      const nb = String(r.nombre_base || cp.nombre_base || '').trim();
      const nn = String(r.nombre_numero || cp.nombre_numero || '').trim();
      const c3 = `${nb} ${nn}`.trim();

      const keys = [
        String(r.codigo || '').trim(),
        String(r.contenedor || '').trim(),
        String(cp.contenedor || '').trim(),
        String(r.apodo || '').trim(),
        String(cp.apodo || '').trim(),
        (c3 && c3 !== '-') ? c3 : '',
        String(r.nombre || '').trim()
      ].filter(Boolean);

      // √∫nicos, en orden
      return Array.from(new Set(keys));
    }

    // 2) Si es contenedor: traer hijos por el campo "contenedor" (llave del contenedor, p.ej "CASE 01").
    // Si NO es contenedor: deducir ubicaci√≥n por RPC/√∫ltimo movimiento (comportamiento actual).
    let contenedor_nombre = '';
    let __contenedores_str = '';
    let stockTotal = null;
    let hijos = [];

    if (isContenedor) {
      try {
        const contKeys = computeContenedorKeys(data);
        const selfCodigo = String(data.codigo || '');

        const hijosSelect = isConsumibles
          ? 'codigo, nombre, foto_url, bodega_principal, bodega_secundaria, campos_personalizados'
          : 'codigo, nombre, foto_url, bodega_principal, bodega_secundaria, es_contenedor, tipo_alta, campos_personalizados';

        let rows = [];
        for (const contKey of contKeys) {
          if (!contKey) continue;

          // En consumibles no existe columna "contenedor": vamos directo por JSON.
          let res;
          if (isConsumibles) {
            res = await supa
              .from(catalogo)
              .select(hijosSelect)
              .eq('campos_personalizados->>contenedor', contKey)
              .neq('codigo', selfCodigo)
              .order('codigo', { ascending: true })
              .limit(300);
            if (res.error) continue;
          } else {
            // 1) intentar por columna directa "contenedor"
            res = await supa
              .from(catalogo)
              .select(hijosSelect)
              .eq('contenedor', contKey)
              .neq('codigo', selfCodigo)
              .order('codigo', { ascending: true })
              .limit(300);

            // Si la columna no existe o falla, intentar por JSON
            if (res.error) {
              res = await supa
                .from(catalogo)
                .select(hijosSelect)
                .eq('campos_personalizados->>contenedor', contKey)
                .neq('codigo', selfCodigo)
                .order('codigo', { ascending: true })
                .limit(300);
            }
            if (res.error) continue;
          }

          rows = Array.isArray(res.data) ? res.data : [];
          if (rows.length) break;
        }

        // Fallback: si el cat√°logo no guarda "contenedor" en la fila del hijo,
        // intentamos deducir hijos por movimientos cuya ubicaci√≥n coincide con este contenedor.
        if (!rows.length) {
          function stripConsecutivoPrefix(code) {
            return String(code || '').trim().toUpperCase().replace(/^\d+\-/, '');
          }

          const movCodes = new Set();

          for (const key of contKeys) {
            if (!key) continue;
            const rMov = await supa
              .from(movimientos)
              .select('material_codigo, ubicacion_nombre')
              .ilike('ubicacion_nombre', `%${key}%`)
              .limit(5000);
            if (rMov.error) continue;
            const movRows = Array.isArray(rMov.data) ? rMov.data : [];
            for (const m of movRows) {
              const mc = String(m?.material_codigo || '').trim();
              if (mc && mc !== selfCodigo) movCodes.add(mc);
            }
          }

          const parentBase = stripConsecutivoPrefix(selfCodigo);
          const allCodes = Array.from(movCodes);
          const apellidoFiltered = allCodes.filter((c) => {
            const childBase = stripConsecutivoPrefix(c);
            return parentBase && childBase && childBase !== parentBase && childBase.startsWith(parentBase + '-');
          });

          // Si el filtro por apellido aplica y devuelve algo, √∫salo.
          // Si no devuelve nada (por cat√°logos con otro esquema), cae al set original.
          const codes = (apellidoFiltered.length ? apellidoFiltered : allCodes).slice(0, 300);

          if (codes.length) {
            const rCat = await supa
              .from(catalogo)
              .select(hijosSelect)
              .in('codigo', codes)
              .order('codigo', { ascending: true });
            if (!rCat.error) rows = Array.isArray(rCat.data) ? rCat.data : [];
          }
        }

        hijos = rows.filter(r => normalizeTipoAlta(r?.tipo_alta || r?.campos_personalizados?.tipo_alta) !== 'CONTENEDOR');
      } catch (e) {
        // si falla la carga de hijos, dejar vac√≠o
        hijos = [];
      }

      // Cargar stock para hijos
      if (hijos.length > 0) {
        try {
          const stockMap = {};
          for (const cod of hijosCodigos) {
            const { data: movRows, error: err } = await supa
              .from(movimientos)
              .select('cantidad')
              .eq('material_codigo', cod)
              .eq('tipo_movimiento', 'INGRESO');
            if (!err && movRows) {
              const sum = movRows.reduce((s, r) => s + (parseFloat(r.cantidad) || 0), 0);
              stockMap[cod] = sum;
            }
          }
          hijos = hijos.map(h => ({ ...h, __cantidad: stockMap[h.codigo] || 0 }));
        } catch (e) {
          // si falla, dejar __cantidad como 0
        }
      }

      // Cantidad por hijo (por movimientos dentro de este contenedor)
      try {
        const contKey = computeContenedorKeys(data)[0] || '';
        const codes = hijos.map(h => String(h.codigo || '').trim()).filter(Boolean);
        if (!codes.length) {
          hijos = hijos.map(h => ({ ...h, __cantidad: 1 }));
        } else {
          const keysToTry = Array.from(new Set([
            contKey,
            String(data?.apodo || '').trim(),
            `${String(data?.nombre_base || '').trim()} ${String(data?.nombre_numero || '').trim()}`.trim(),
            String(data?.nombre || '').trim()
          ].filter(Boolean)));

          async function fetchMovsByUbicacion(key) {
            // ilike sin % funciona como match case-insensitive (y tolera variaciones de may√∫sculas)
            const r1 = await supa
              .from(movimientos)
              .select('material_codigo, cantidad, signo, ubicacion_nombre')
              .ilike('ubicacion_nombre', `%${key}%`)
              .in('material_codigo', codes)
              .limit(5000);
            if (r1.error) throw r1.error;
            return Array.isArray(r1.data) ? r1.data : [];
          }

          let movRows = [];
          for (const key of keysToTry) {
            movRows = await fetchMovsByUbicacion(key);
            if (movRows.length) break;
          }

          // Fallback: si no pudimos filtrar por ubicaci√≥n (o no coincide), sumamos por material_codigo.
          // Esto cubre bien accesorios que entran con cantidad>1 en un solo movimiento.
          if (!movRows.length) {
            const rAny = await supa
              .from(movimientos)
              .select('material_codigo, cantidad, signo')
              .in('material_codigo', codes)
              .limit(8000);
            if (rAny.error) throw rAny.error;
            movRows = Array.isArray(rAny.data) ? rAny.data : [];
          }

          const qtyByCode = Object.create(null);
          movRows.forEach(r => {
            const c = String(r?.material_codigo || '').trim();
            if (!c) return;
            const qty = Number(r?.cantidad ?? 0);
            const sign = Number(r?.signo ?? 1);
            const delta = (isFinite(qty) ? qty : 0) * (isFinite(sign) ? sign : 1);
            qtyByCode[c] = (qtyByCode[c] || 0) + delta;
          });

          hijos = hijos.map(h => {
            const c = String(h.codigo || '').trim();
            let q = qtyByCode[c];
            if (!isFinite(q)) q = 1;
            const qOut = Number.isInteger(q) ? q : Math.round(q * 100) / 100;
            return { ...h, __cantidad: qOut };
          });
        }
      } catch (_) {
        // Si falla, mostramos 1 por defecto (hijos individuales)
        hijos = hijos.map(h => ({ ...h, __cantidad: 1 }));
      }
    }
    else {
      // Soporta multi-lote
      try {
        const { data: movRows, error: movErr } = await supa
          .from(movimientos)
          .select('ubicacion_nombre, cantidad, signo')
          .eq('material_codigo', codigo)
          .limit(8000);
        if (movErr) throw movErr;

        // Agrupar por ubicacion_nombre y sumar cantidad * signo (misma l√≥gica que el contenedor)
        const ubicaciones = {};
        (movRows || []).forEach(row => {
          const ubi = row.ubicacion_nombre || '';
          const qty = Number(row?.cantidad ?? 0);
          const sign = Number(row?.signo ?? 1);
          const delta = (isFinite(qty) ? qty : 0) * (isFinite(sign) ? sign : 1);
          ubicaciones[ubi] = (ubicaciones[ubi] || 0) + delta;
        });
        const rows = Object.entries(ubicaciones)
          .map(([ubi, cant]) => ({ ubicacion_nombre: ubi, cantidad: cant }))
          .filter(r => String(r.ubicacion_nombre || '').trim() !== '');

        __contenedores_str = buildContenedoresStr(rows);
        stockTotal = (Array.isArray(rows) && rows.length)
          ? rows.reduce((sum, r) => sum + r.cantidad, 0)
          : null;
        if (Array.isArray(rows) && rows.length === 1) {
          contenedor_nombre = (rows[0]?.ubicacion_nombre || '').toString();
        } else if (Array.isArray(rows) && rows.length > 1) {
          contenedor_nombre = 'Varios';
        }
      } catch (_) {
        // Fallback: deducir ubicaci√≥n por el √∫ltimo movimiento (comportamiento actual)
        try {
          const { data: movs } = await supa
            .from(movimientos)
            .select('ubicacion_nombre')
            .eq('material_codigo', codigo)
            .order('fecha_movimiento', { ascending: false })
            .limit(1);
          contenedor_nombre = (movs && movs[0] && movs[0].ubicacion_nombre) ? movs[0].ubicacion_nombre : '';
        } catch (_) {
          // si no existe columna o vista, lo ignoramos
        }
      }
    }

    const esHechizo = !!data.es_hechizo;
    const hoy = new Date().toLocaleDateString('es-NI');
    state.material = {
      ...data,
      __es_contenedor: isContenedor,
      contenedor_nombre,
      __contenedores_str,
      __stock_total: stockTotal,
      __dimensiones_str: buildDimensionesStr(data),

      __estado_str: esHechizo ? 'Fabricaci√≥n Local' : 'Original',

      __fecha_str: hoy
    };
    state.hijos = hijos;
    state.currentIndex = state.allCodes.indexOf(codigo);
    const positionStr = state.allCodes.length > 0 ? ` (${state.currentIndex + 1}/${state.allCodes.length})` : '';
    document.getElementById('fe-status').textContent = isContenedor
      ? `‚úÖ Contenedor cargado: ${data.nombre} (${data.codigo})${positionStr} ‚Äî Hijos: ${hijos.length}`
      : `‚úÖ Cargado: ${data.nombre} (${data.codigo})${positionStr}`;
    renderAll();
  }

  function imprimirArea(areaId) {
    const el = document.getElementById(areaId);
    if (!el) return;

    // Marcar como ra√≠z de impresi√≥n
    document.querySelectorAll('.fe-print-root').forEach(n => n.classList.remove('fe-print-root'));
    el.classList.add('fe-print-root');

    window.print();

    // Limpieza (despu√©s de imprimir)
    setTimeout(() => {
      el.classList.remove('fe-print-root');
    }, 250);
  }

  async function loadAllCodes() {
    if (!supa) return;
    try {
      const bodega = getActiveBodega();
      const res = await supa
        .from(bodega.catalogo)
        .select('codigo')
        .order('codigo', { ascending: true });
      if (res.error) throw res.error;
      state.allCodes = (res.data || []).map(row => row.codigo).filter(Boolean);
    } catch (err) {
      console.error('Error loading all codes:', err);
      state.allCodes = [];
    }
  }

  function navigateToCode(index) {
    if (index < 0 || index >= state.allCodes.length) return;
    const codigo = state.allCodes[index];
    state.currentIndex = index;
    document.getElementById('fe-codigo-buscar').value = codigo;
    cargarMaterial(codigo).catch(err => {
      console.error(err);
      alert('‚ùå No se pudo cargar: ' + (err.message || err));
    });
  }

  // Init
  state.bodegaKey = loadBodegaKey();
  state.buscarTipo = loadBuscarTipo();
  state.ficha = loadCfg(FICHA_KEY, DEFAULT_FICHA);
  state.etiq = loadCfg(ETIQ_KEY, DEFAULT_ETIQ);
  wireUI();
  setActiveBodega(state.bodegaKey, { persist: false, clearMaterial: true });
  renderAll();
  loadAllCodes();

})();
</script>

