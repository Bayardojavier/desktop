<!-- crear.html -->
<div class="srv-container">
  <h1 class="srv-title">üõ†Ô∏è Crear Servicio</h1>

  <form id="form-servicio" class="srv-form">
    <!-- ID (solo lectura) -->
    <div class="srv-field">
      <label class="srv-label">ID del Servicio</label>
      <input type="text" id="servicio-id" class="srv-input" readonly placeholder="SRV-00001">
    </div>

    <!-- Descripci√≥n Corta -->
    <div class="srv-field">
      <label class="srv-label">Descripci√≥n Corta * <span style="font-weight: normal; font-size: 12px; color: #64748b;">(m√°x. 50 caracteres)</span></label>
      <input type="text" id="servicio-desc-corta" class="srv-input" maxlength="50" 
             placeholder="Ej: Limpieza de Oficinas">
      <div id="error-desc-corta" class="srv-error"></div>
    </div>

    <!-- Descripci√≥n Larga -->
    <div class="srv-field">
      <label class="srv-label">Descripci√≥n Detallada</label>
      <textarea id="servicio-descripcion" class="srv-textarea" rows="3" 
                placeholder="Ej: Incluye limpieza de ba√±os, pisos, y mobiliario..."></textarea>
    </div>

    <!-- Precios A, B, C (en d√≥lares) -->
    <div class="srv-precios-grid">
      <div class="srv-field">
        <label class="srv-label">Precio A ($) *</label>
        <input type="number" id="precio-a" class="srv-input" step="0.01" min="0" placeholder="0.00">
        <div id="error-a" class="srv-error"></div>
      </div>
      <div class="srv-field">
        <label class="srv-label">Precio B ($)</label>
        <input type="number" id="precio-b" class="srv-input" step="0.01" min="0" placeholder="0.00">
      </div>
      <div class="srv-field">
        <label class="srv-label">Precio C ($)</label>
        <input type="number" id="precio-c" class="srv-input" step="0.01" min="0" placeholder="0.00">
      </div>
    </div>

    <!-- Acciones -->
    <div class="srv-actions">
      <button type="submit" class="srv-btn srv-btn-save">‚ûï Agregar Servicio</button>
      <button type="button" id="btn-nuevo" class="srv-btn srv-btn-secondary">üîÑ Nuevo</button>
    </div>
  </form>
</div>

<style>
  /* =============================================================================
     ESTILOS PROPIOS PARA SERVICIOS (AISLADO DE APP.CSS)
     ============================================================================= */
  .srv-container {
    padding: 20px;
    max-width: 800px;
    margin: 0 auto;
    font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
    color: #1e293b;
  }

  .srv-title {
    font-size: 22px;
    font-weight: 700;
    margin-bottom: 24px;
    color: #1e3a8a;
  }

  .srv-form {
    display: grid;
    gap: 20px;
  }

  .srv-field {
    display: flex;
    flex-direction: column;
  }

  .srv-label {
    font-weight: 600;
    margin-bottom: 8px;
    font-size: 14px;
    color: #334155;
  }

  .srv-input,
  .srv-textarea {
    padding: 10px 12px;
    border: 1px solid #cbd5e1;
    border-radius: 8px;
    font-size: 14px;
    background: white;
    color: #1e293b;
  }

  .srv-input:focus,
  .srv-textarea:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }

  .srv-textarea {
    resize: vertical;
    min-height: 80px;
  }

  .srv-precios-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
  }

  .srv-error {
    color: #ef4445;
    font-size: 12px;
    margin-top: 4px;
    min-height: 16px;
  }

  .srv-actions {
    display: flex;
    gap: 12px;
    justify-content: flex-end;
  }

  .srv-btn {
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
  }

  .srv-btn-save {
    background: #10b981;
    color: white;
  }

  .srv-btn-secondary {
    background: #64748b;
    color: white;
  }

  .srv-btn:hover {
    opacity: 0.9;
    transform: translateY(-1px);
  }

  /* Responsive */
  @media (max-width: 600px) {
    .srv-precios-grid {
      grid-template-columns: 1fr;
    }
  }
</style>

<script>
  setTimeout(() => {
    // =============================================================================
    // üîπ GENERAR ID √öNICO
    // =============================================================================
    // Nota: el ID NO se debe generar solo con localStorage porque al reinstalar/limpiar
    // el navegador o usar otra PC se repite el mismo SRV-xxxxx y da 23505.

    function formatearIdServicio(numero) {
      return `SRV-${String(numero).padStart(5, '0')}`;
    }

    function extraerNumeroServicio(id) {
      if (!id || typeof id !== 'string') return null;
      const match = id.match(/^SRV-(\d{1,})$/);
      if (!match) return null;
      const n = parseInt(match[1], 10);
      return Number.isFinite(n) ? n : null;
    }

    function obtenerUltimoNumeroLocal() {
      const n = parseInt(localStorage.getItem('ultimoNumServicio'), 10);
      return Number.isFinite(n) ? n : 0;
    }

    function guardarUltimoNumeroLocal(numero) {
      if (!Number.isFinite(numero) || numero < 0) return;
      localStorage.setItem('ultimoNumServicio', String(numero));
    }

    async function obtenerUltimoNumeroServicioEnDB() {
      try {
        const { data, error } = await window.supabaseClient
          .from('servicios')
          .select('id')
          .like('id', 'SRV-%')
          .order('id', { ascending: false })
          .limit(1);

        if (error) {
          console.warn('No se pudo obtener el √∫ltimo ID desde DB:', error);
          return null;
        }

        const ultimoId = Array.isArray(data) && data.length ? data[0].id : null;
        return extraerNumeroServicio(ultimoId);
      } catch (err) {
        console.warn('Error inesperado leyendo ID desde DB:', err);
        return null;
      }
    }

    async function obtenerSiguienteNumeroServicio() {
      const ultimoLocal = obtenerUltimoNumeroLocal();
      const ultimoDb = await obtenerUltimoNumeroServicioEnDB();
      const base = Number.isFinite(ultimoDb) ? Math.max(ultimoLocal, ultimoDb) : ultimoLocal;
      return base + 1;
    }

    async function obtenerSiguienteIdServicio() {
      const siguienteNumero = await obtenerSiguienteNumeroServicio();
      return formatearIdServicio(siguienteNumero);
    }

    async function refrescarCampoIdServicio() {
      const inputId = document.getElementById('servicio-id');
      if (!inputId) return;
      inputId.value = '...';
      inputId.value = await obtenerSiguienteIdServicio();
    }


    // =============================================================================
    // üîπ VALIDAR FORMULARIO
    // =============================================================================
    function validarFormulario() {
      let esValido = true;
      document.querySelectorAll('.srv-error').forEach(el => el.textContent = '');

      const descCorta = document.getElementById('servicio-desc-corta').value.trim();
      const precioA = document.getElementById('precio-a').value.trim();

      if (!descCorta) {
        document.getElementById('error-desc-corta').textContent = "La descripci√≥n corta es obligatoria.";
        esValido = false;
      } else if (descCorta.length < 3) {
        document.getElementById('error-desc-corta').textContent = "M√≠nimo 3 caracteres.";
        esValido = false;
      }

      if (!precioA) {
        document.getElementById('error-a').textContent = "El Precio A es obligatorio.";
        esValido = false;
      } else if (parseFloat(precioA) < 0) {
        document.getElementById('error-a').textContent = "El precio no puede ser negativo.";
        esValido = false;
      }

      return esValido;
    }

    // =============================================================================
    // üîπ GUARDAR SERVICIO (precios en d√≥lares)
    // =============================================================================
    async function guardarServicio(e) {
      e.preventDefault();
      
      if (!validarFormulario()) return;

      const servicioBase = {
        nombre: document.getElementById('servicio-desc-corta').value.trim(),
        descripcion: document.getElementById('servicio-descripcion').value.trim(),
        precio_a: parseFloat(document.getElementById('precio-a').value) || 0,
        precio_b: parseFloat(document.getElementById('precio-b').value) || 0,
        precio_c: parseFloat(document.getElementById('precio-c').value) || 0,
        activo: true
      };

      const maxIntentos = 8;
      let numero = await obtenerSiguienteNumeroServicio();

      try {
        let data = null;
        for (let intento = 0; intento < maxIntentos; intento++) {
          const idCandidato = formatearIdServicio(numero + intento);
          const servicio = { id: idCandidato, ...servicioBase };

          const res = await window.supabaseClient
            .from('servicios')
            .insert(servicio)
            .select()
            .single();

          if (!res.error) {
            data = res.data;
            const usado = extraerNumeroServicio(idCandidato);
            if (Number.isFinite(usado)) guardarUltimoNumeroLocal(usado);
            break;
          }

          // 23505 = unique_violation (PK duplicada). Probablemente otro equipo/instancia us√≥ el mismo ID.
          if (String(res.error.code) === '23505') {
            console.warn('ID de servicio duplicado, reintentando con el siguiente:', idCandidato);
            continue;
          }

          console.error('Error al guardar servicio:', res.error);
          alert(`‚ùå Error al guardar el servicio.\n${res.error.message || ''}`);
          return;
        }

        if (!data) {
          alert('‚ùå No se pudo guardar el servicio: demasiados reintentos por ID duplicado.');
          return;
        }

        alert(`‚úÖ Servicio "${data.nombre}" guardado en d√≥lares con ID ${data.id}.`);
        
        // Resetear formulario
        await refrescarCampoIdServicio();
        document.getElementById('servicio-desc-corta').value = '';
        document.getElementById('servicio-descripcion').value = '';
        document.getElementById('precio-a').value = '';
        document.getElementById('precio-b').value = '';
        document.getElementById('precio-c').value = '';
        document.getElementById('servicio-desc-corta').focus();
      } catch (err) {
        console.error('Error:', err);
        alert('‚ùå Error al guardar el servicio.');
      }
    }

    // =============================================================================
    // üîπ CREAR NUEVO
    // =============================================================================
    async function crearNuevo() {
      if (confirm("¬øDesea crear un nuevo servicio? Se perder√°n los cambios no guardados.")) {
        await refrescarCampoIdServicio();

        document.getElementById('servicio-desc-corta').value = '';
        document.getElementById('servicio-descripcion').value = '';
        document.getElementById('precio-a').value = '';
        document.getElementById('precio-b').value = '';
        document.getElementById('precio-c').value = '';
        document.querySelectorAll('.srv-error').forEach(el => el.textContent = '');
        document.getElementById('servicio-desc-corta').focus();
      }
    }

    // =============================================================================
    // üîπ INICIALIZACI√ìN
    // =============================================================================
    refrescarCampoIdServicio();

    
    document.getElementById('form-servicio').addEventListener('submit', guardarServicio);
    document.getElementById('btn-nuevo').addEventListener('click', crearNuevo);
    
  }, 50);
</script>