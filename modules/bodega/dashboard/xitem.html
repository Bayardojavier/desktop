<!-- desktop/modules/bodega/dashboard/xitem.html -->
<div style="display: flex; gap: 20px; height: 100%;">

  <!-- √ÅREA PRINCIPAL (todo ocupa el ancho) -->
  <div style="flex: 1; display: flex; flex-direction: column; gap: 20px;">

    <!-- INFORMER GENERAL (KPIs) -->
    <div style="display: flex; gap: 20px; justify-content: flex-start;">
      <div class="bodega-resumen-card">
        <div>Existencia Actual</div>
        <div class="valor" id="kpi-existencia">‚Äì</div>
      </div>
      <div class="bodega-resumen-card">
        <div>Ingresos Totales</div>
        <div class="valor" id="kpi-ingresos">‚Äì</div>
      </div>
      <div class="bodega-resumen-card">
        <div>Despachos Totales</div>
        <div class="valor" id="kpi-despachos">‚Äì</div>
      </div>
    </div>

    <!-- FILTROS -->
    <div class="bodega-filtros">
      <div class="bodega-filtro-grupo">
        <label for="filtro-item">√çtem</label>
        <button id="btn-buscar-item" class="bodega-export-pdf-btn">üîç Buscar √çtem</button>
      </div>
      <button id="btn-exportar-xitem" class="bodega-export-pdf-btn">üìÑ Exportar Historial</button>
    </div>

    <!-- MODAL DE B√öSQUEDA -->
    <div id="modal-buscar-item" class="modal-overlay" style="display: none;">
      <div class="modal-content">
        <h3>Buscar √çtem</h3>
        <input type="text" id="modal-search-input" placeholder="Buscar por c√≥digo o nombre..." class="dashboard-select">
        <div id="modal-results" class="modal-results">
          <!-- Resultados se poblar√°n aqu√≠ -->
        </div>
        <div class="modal-buttons">
          <button id="btn-modal-cancelar" class="bodega-export-pdf-btn">Cancelar</button>
        </div>
      </div>
    </div>

    <!-- TABLA DE MOVIMIENTOS -->
    <div id="tabla-historial-item" style="flex: 1; overflow: auto;">
      <p style="color: #cbd5e1; text-align: center; margin-top: 40px;">
        Seleccione un √≠tem para ver su historial de movimientos.
      </p>
    </div>

  </div>
</div>

<style>
.bodega-resumen-card {
  background: rgba(20, 30, 60, 0.6);
  border: 1px solid rgba(99, 102, 241, 0.2);
  border-radius: 8px;
  padding: 12px;
  text-align: center;
  color: #cbd5e1;
  min-width: 160px;
}

.bodega-resumen-card .valor {
  font-size: 24px;
  font-weight: bold;
  color: #64b5f6;
  margin: 4px 0 0 0;
}

.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.7);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1000;
}

.modal-content {
  background: rgba(20, 30, 60, 0.9);
  border: 1px solid rgba(99, 102, 241, 0.2);
  border-radius: 8px;
  padding: 20px;
  max-width: 500px;
  width: 90%;
  max-height: 70%;
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

.modal-content h3 {
  margin: 0 0 15px 0;
  color: #cbd5e1;
}

.modal-results {
  flex: 1;
  overflow-y: auto;
  margin: 10px 0;
}

.modal-result-item {
  padding: 10px;
  border-bottom: 1px solid rgba(156, 163, 175, 0.2);
  cursor: pointer;
  color: #cbd5e1;
}

.modal-result-item:hover {
  background: rgba(99, 102, 241, 0.1);
}

.modal-buttons {
  display: flex;
  justify-content: flex-end;
  gap: 10px;
}
</style>

<script>
(function() {
  const supa = window.supabaseClient;
  if (!supa) {
    console.error('‚ùå Supabase no est√° inicializado (window.supabaseClient).');
  }

  async function obtenerLogoPdfSrc() {
    try {
      if (window.__xitemLogoPdfSrc) return window.__xitemLogoPdfSrc;
      if (window.__xitemLogoPdfSrcPromise) return await window.__xitemLogoPdfSrcPromise;

      const fallbackUrl = new URL('../../../assets/logo.png', window.location.href).href;
      if (window.electronAPI && typeof window.electronAPI.getAssetDataUrl === 'function') {
        window.__xitemLogoPdfSrcPromise = window.electronAPI.getAssetDataUrl({ path: 'logo.png' })
          .then((r) => {
            if (r && r.ok && r.dataUrl) return r.dataUrl;
            throw new Error((r && r.error) ? r.error : 'No se pudo leer asset');
          })
          .then((dataUrl) => {
            window.__xitemLogoPdfSrc = dataUrl;
            return dataUrl;
          })
          .catch((err) => {
            console.warn('Logo IPC fall√≥ (xitem), usando URL directa:', err);
            window.__xitemLogoPdfSrc = fallbackUrl;
            return fallbackUrl;
          });
      } else {
        window.__xitemLogoPdfSrcPromise = Promise.resolve(fallbackUrl);
      }

      return await window.__xitemLogoPdfSrcPromise;
    } catch (e) {
      console.warn('Logo fallback (xitem):', e);
      return new URL('../../../assets/logo.png', window.location.href).href;
    }
  }

  const estado = {
    catalogo: [],
    historialActual: [],
    itemActual: null
  };

  function fmtFechaHora(iso) {
    if (!iso) return { fecha: '‚Äì', hora: '' };
    const d = new Date(iso);
    const fecha = isNaN(d.getTime()) ? String(iso) : d.toLocaleDateString('es-NI');
    const hora = isNaN(d.getTime()) ? '' : d.toLocaleTimeString('es-NI', { hour: '2-digit', minute: '2-digit' });
    return { fecha, hora };
  }

  function capitalizar(txt) {
    const s = (txt || '').toString();
    return s ? s.charAt(0).toUpperCase() + s.slice(1) : '‚Äì';
  }

  function formatearOrigenDestino(m) {
    // m = fila unificada desde movimientos_bodega_*
    if (m.tipo_movimiento === 'ingreso') {
      return 'Ingreso';
    }
    if (m.tipo_movimiento === 'venta') {
      return `Venta ${m.referencia_documento || ''}`.trim();
    }
    if (m.tipo_movimiento === 'despacho') {
      return (m.observaciones || `Despacho ${m.referencia_documento || ''}`).toString();
    }
    return (m.referencia_tipo || m.observaciones || '‚Äì').toString();
  }

  async function cargarCatalogoParaSelect() {
    if (!supa) return;

    const tablas = [
      'movimientos_bodega_audiovisual',
      'movimientos_bodega_hierros',
      'movimientos_bodega_consumibles'
    ];

    // Consultar todas las tablas de movimientos para obtener c√≥digos y nombres √∫nicos
    const results = await Promise.all(tablas.map(async (t) => {
      const { data, error } = await supa
        .from(t)
        .select('material_codigo, material_nombre')
        .order('material_codigo', { ascending: true });
      if (error) {
        console.error(`Error cargando ${t}:`, error);
        return [];
      }
      return (data || []).map(r => ({
        codigo: String(r.material_codigo || '').trim(),
        nombre: (r.material_nombre || '').toString().trim()
      }));
    }));

    const allData = results.flat();

    // Unificar por codigo
    const map = new Map();
    allData.forEach(r => {
      const codigo = r.codigo;
      if (!codigo) return;
      if (!map.has(codigo)) {
        map.set(codigo, {
          codigo,
          nombre: r.nombre || codigo,
          bodegas: new Set()
        });
      } else {
        const prev = map.get(codigo);
        if (!prev.nombre && r.nombre) prev.nombre = r.nombre;
      }
    });

    // Opcional: agregar info de bodega desde stock_actual_con_precio si existe
    try {
      const { data: stockData } = await supa
        .from('stock_actual_con_precio')
        .select('material_codigo, bodega_principal, bodega_secundaria');
      (stockData || []).forEach(r => {
        const codigo = String(r.material_codigo || '').trim();
        if (map.has(codigo)) {
          const principal = (r.bodega_principal || '').toString().trim();
          const secundaria = (r.bodega_secundaria || '').toString().trim();
          const bodega = secundaria || principal;
          if (bodega) map.get(codigo).bodegas.add(bodega);
        }
      });
    } catch (e) {
      console.warn('No se pudo cargar info de bodega:', e);
    }

    estado.catalogo = Array.from(map.values())
      .map(it => ({
        codigo: it.codigo,
        nombre: it.nombre,
        bodega: (it.bodegas.size > 1) ? Array.from(it.bodegas).join(' / ') : (Array.from(it.bodegas)[0] || '‚Äì')
      }));
  }

  function mostrarModalBusqueda() {
    const modal = document.getElementById('modal-buscar-item');
    const input = document.getElementById('modal-search-input');
    const results = document.getElementById('modal-results');
    input.value = '';
    results.innerHTML = '';
    modal.style.display = 'flex';
    input.focus();
  }

  function ocultarModalBusqueda() {
    const modal = document.getElementById('modal-buscar-item');
    modal.style.display = 'none';
  }

  function filtrarResultados(query) {
    const results = document.getElementById('modal-results');
    const q = query.toLowerCase().trim();
    const filtrados = estado.catalogo.filter(it =>
      it.codigo.toLowerCase().includes(q) || it.nombre.toLowerCase().includes(q)
    ).sort((a, b) => a.codigo.localeCompare(b.codigo));
    results.innerHTML = '';
    filtrados.forEach(it => {
      const div = document.createElement('div');
      div.className = 'modal-result-item';
      div.textContent = `${it.codigo} ‚Äî ${it.nombre}`;
      div.onclick = () => {
        ocultarModalBusqueda();
        renderizarHistorial(it.codigo);
      };
      results.appendChild(div);
    });
  }

  async function obtenerExistenciaActual(codigo) {
    if (!supa || !codigo) return 0;
    try {
      const { data, error } = await supa
        .rpc('stock_actual_codigo', { material_codigo_input: codigo });
      if (error) throw error;
      if (Array.isArray(data)) return Number(data[0]?.existencia) || 0;
      if (data && typeof data === 'object') return Number(data.existencia) || 0;
      return 0;
    } catch (e) {
      console.warn('No se pudo obtener stock_actual_codigo:', e);
      return 0;
    }
  }

  async function cargarMovimientosPorItem(codigo) {
    if (!supa || !codigo) return [];

    const tablas = [
      'movimientos_bodega_audiovisual',
      'movimientos_bodega_hierros',
      'movimientos_bodega_consumibles'
    ];

    const selectCols = 'created_at, fecha_movimiento, tipo_movimiento, referencia_documento, referencia_tipo, responsable, cantidad, signo, observaciones, bodega_principal, bodega_secundaria, estado';

    const results = await Promise.all(tablas.map(async (t) => {
      const { data, error } = await supa
        .from(t)
        .select(selectCols)
        .eq('material_codigo', codigo);
      if (error) {
        console.error(`Error cargando ${t}:`, error);
        return [];
      }
      return (data || []).map(r => ({ ...r, __tabla: t }));
    }));

    const merged = results.flat();
    merged.sort((a, b) => {
      const ta = new Date(a.created_at || a.fecha_movimiento || 0).getTime();
      const tb = new Date(b.created_at || b.fecha_movimiento || 0).getTime();
      return tb - ta;
    });
    return merged;
  }

  async function renderizarHistorial(codigo) {
    const contenedor = document.getElementById('tabla-historial-item');
    if (!codigo) {
      contenedor.innerHTML = '<p style="color: #cbd5e1; text-align: center; margin-top: 40px;">Seleccione un √≠tem para ver su historial de movimientos.</p>';
      document.getElementById('kpi-existencia').textContent = '‚Äì';
      document.getElementById('kpi-ingresos').textContent = '‚Äì';
      document.getElementById('kpi-despachos').textContent = '‚Äì';
      estado.historialActual = [];
      estado.itemActual = null;
      return;
    }

    contenedor.innerHTML = '<p style="color:#cbd5e1; text-align:center; margin-top: 40px;">Cargando historial‚Ä¶</p>';

    const item = (estado.catalogo || []).find(i => String(i.codigo || '').trim() === String(codigo || '').trim()) || null;
    estado.itemActual = item;

    let movimientos = [];
    try {
      movimientos = await cargarMovimientosPorItem(codigo);
    } catch (e) {
      contenedor.innerHTML = `<p style="color:#ef4444; text-align:center; margin-top: 40px;">Error al cargar movimientos: ${e.message || e}</p>`;
      return;
    }

    const existencia = await obtenerExistenciaActual(codigo);
    const ingresos = movimientos
      .filter(m => Number(m.signo) === 1)
      .reduce((sum, m) => sum + (Number(m.cantidad) || 0), 0);
    const despachos = movimientos
      .filter(m => Number(m.signo) === -1)
      .reduce((sum, m) => sum + (Number(m.cantidad) || 0), 0);

    document.getElementById('kpi-existencia').textContent = existencia;
    document.getElementById('kpi-ingresos').textContent = ingresos;
    document.getElementById('kpi-despachos').textContent = despachos;

    const historial = movimientos.map(m => {
      const { fecha, hora } = fmtFechaHora(m.created_at || m.fecha_movimiento);
      const qty = Number(m.cantidad) || 0;
      const signo = Number(m.signo);
      return {
        fecha,
        hora,
        tipo: capitalizar(m.tipo_movimiento),
        documento: m.referencia_documento || '‚Äì',
        quienEntrega: m.responsable || '‚Äì',
        quienRecibe: '‚Äì',
        cantidadIngreso: signo === 1 ? qty : 0,
        cantidadSalida: signo === -1 ? qty : 0,
        cantidadFaltante: 0,
        origenDestino: formatearOrigenDestino(m)
      };
    });

    estado.historialActual = historial;

    if (!historial.length) {
      contenedor.innerHTML = '<p style="color: #666; text-align: center; margin-top: 40px;">No hay movimientos registrados para este √≠tem.</p>';
      return;
    }

    let filas = '';
    historial.forEach(m => {
      filas += `<tr>
        <td>${m.fecha} ${m.hora}</td>
        <td>${m.tipo}</td>
        <td>${m.documento}</td>
        <td>${m.quienEntrega}</td>
        <td>${m.quienRecibe}</td>
        <td>${m.cantidadIngreso}</td>
        <td>${m.cantidadSalida}</td>
        <td>${m.cantidadFaltante}</td>
        <td>${m.origenDestino}</td>
      </tr>`;
    });

    contenedor.innerHTML = `
      <div style="margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid rgba(156,163,175,0.2);">
        <strong>√çtem:</strong> ${item ? `${item.codigo} ‚Äì ${item.nombre}` : codigo}<br>
        <strong>Bodega:</strong> ${item ? item.bodega : '‚Äì'}
      </div>
      <table class="bodega-table">
        <thead>
          <tr>
            <th>Fecha y Hora</th>
            <th>Tipo</th>
            <th>Documento</th>
            <th>Qui√©n Entrega</th>
            <th>Qui√©n Recibe</th>
            <th>Ingreso</th>
            <th>Salida</th>
            <th>Faltante</th>
            <th>Origen/Destino</th>
          </tr>
        </thead>
        <tbody>${filas}</tbody>
      </table>`;
  }

  document.getElementById('btn-buscar-item').addEventListener('click', mostrarModalBusqueda);

  document.getElementById('modal-search-input').addEventListener('input', e => {
    filtrarResultados(e.target.value);
  });

  document.getElementById('btn-modal-cancelar').addEventListener('click', ocultarModalBusqueda);

  // Cerrar modal al hacer clic fuera
  document.getElementById('modal-buscar-item').addEventListener('click', e => {
    if (e.target.id === 'modal-buscar-item') {
      ocultarModalBusqueda();
    }
  });
    // === FUNCI√ìN DE EXPORTACI√ìN A PDF COMPLETA ===
  document.getElementById('btn-exportar-xitem').addEventListener('click', async () => {
    if (typeof html2pdf === 'undefined') {
      alert('html2pdf no est√° cargado.');
      return;
    }

    const item = estado.itemActual;
    if (!item) {
      alert('Por favor, busque un √≠tem primero.');
      return;
    }

    const codigoItem = item.codigo;
    const historial = estado.historialActual || [];
    if (!historial.length) {
      alert('No hay movimientos para exportar.');
      return;
    }

    const logoSrc = await obtenerLogoPdfSrc();

    // === CONSTRUIR EL CONTENIDO DE LA TABLA PARA EL PDF ===
    let filasPDF = '';
    historial.forEach(m => {
      filasPDF += `
        <tr>
          <td>${m.fecha} ${m.hora}</td>
          <td>${m.tipo}</td>
          <td>${m.documento}</td>
          <td>${m.quienEntrega}</td>
          <td>${m.quienRecibe}</td>
          <td>${m.cantidadIngreso}</td>
          <td>${m.cantidadSalida}</td>
          <td>${m.cantidadFaltante}</td>
          <td>${m.origenDestino}</td>
        </tr>
      `;
    });

    // === CONSTRUIR EL HTML PARA EL PDF (DISE√ëO DE IMPRESI√ìN) ===
    const htmlPDF = `
      <div style="font-family: Arial, sans-serif; padding: 20px; color: #000; width: 100%;">
        <div style="text-align: center; margin-bottom: 24px;">
          <img src="${logoSrc}" style="height: 60px; margin-bottom: 16px;">
          <h2 style="color: #1e40af; margin: 0; font-size: 22px;">Historial de Movimientos por √çtem</h2>
          <p style="margin: 8px 0 0 0; color: #333; font-size: 14px;">
            <strong>√çtem:</strong> ${item.codigo} ‚Äì ${item.nombre}<br>
            <strong>Bodega:</strong> ${item.bodega}
          </p>
        </div>

        <table style="width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 11px;">
          <thead>
            <tr style="background-color: #f1f5f9; border-bottom: 2px solid #cbd5e1;">
              <th style="padding: 8px; text-align: left; border-right: 1px solid #e2e8f0;">Fecha y Hora</th>
              <th style="padding: 8px; text-align: left; border-right: 1px solid #e2e8f0;">Tipo</th>
              <th style="padding: 8px; text-align: left; border-right: 1px solid #e2e8f0;">Documento</th>
              <th style="padding: 8px; text-align: left; border-right: 1px solid #e2e8f0;">Qui√©n Entrega</th>
              <th style="padding: 8px; text-align: left; border-right: 1px solid #e2e8f0;">Qui√©n Recibe</th>
              <th style="padding: 8px; text-align: left; border-right: 1px solid #e2e8f0;">Ingreso</th>
              <th style="padding: 8px; text-align: left; border-right: 1px solid #e2e8f0;">Salida</th>
              <th style="padding: 8px; text-align: left; border-right: 1px solid #e2e8f0;">Faltante</th>
              <th style="padding: 8px; text-align: left;">Origen/Destino</th>
            </tr>
          </thead>
          <tbody>
            ${filasPDF}
          </tbody>
        </table>

        <div style="margin-top: 40px; text-align: center; font-size: 11px; color: #64748b; border-top: 1px solid #e2e8f0; padding-top: 16px;">
          <p>Documento generado por Absolute de Nicaragua</p>
          <p>Original Bodega ‚Ä¢ Copia Caceta y Seguridad ‚Ä¢ Copia Encargado</p>
        </div>
      </div>
    `;

    // === GENERAR EL PDF ===
    html2pdf().from(htmlPDF).set({
      margin: 15, // 15mm en todos los lados
      filename: `Historial_Item_${item.codigo.replace(/ /g, '_')}.pdf`,
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { 
        scale: 2, 
        useCORS: true,
        backgroundColor: '#ffffff' // Fondo blanco obligatorio para impresi√≥n
      },
      jsPDF: { 
        unit: 'mm', 
        format: 'letter', 
        orientation: 'landscape' 
      }
    }).save();
  });

  // === INICIALIZACI√ìN ===
  (async function init() {
    await cargarCatalogoParaSelect();
  })();
})();


</script>
