<!-- üîπ CONTENEDOR PRINCIPAL: OCUPA TODO EL √ÅREA DE TRABAJO -->
<div class="logistica-container" style="display: flex; flex-direction: column; height: calc(85vh - 100px);">

  <!-- T√çTULO + BOT√ìN EN LA MISMA L√çNEA -->
  <div style="display: flex; justify-content: space-between; align-items: flex-start; background: rgba(0, 0, 0, 0.767); padding: 12px 24px; border-bottom: 5px solid var(--accent); margin-bottom: 12px; border-radius: 8px">
    <div>
      <h2 style="font-size: 16pt; margin: 0; color: #f5f6f7; display: flex; align-items: center; gap: 8px;">
        <span>üì§</span>
        Generar Solicitud de Materiales
      </h2>
      <p style="color: #bebcbc; font-size: 12px; margin: 6px 0 0 0;">
        Seleccione evento y defina los materiales requeridos.
      </p>
    </div>
    <button id="btn-enviar" class="btn-submit" style="width: auto; padding: 8px 16px; font-size: 13px; height: fit-content; align-self: flex-end;">
      üöÄ ENVIAR A BODEGA
    </button>
  </div>

  <!-- CONTENEDOR DE LAS DOS COLUMNAS -->
  <div style="display: flex; gap: 20px; height: 700px; overflow: hidden;">

    <!-- Columna izquierda: datos generales + evento -->
    <div style="width: 290px; overflow-y: auto; display: flex; flex-direction: column; gap: 16px; background: rgba(0, 0, 0, 0.767); padding: 14px; border-radius: 8px; border: 1px solid #e2e8f0;">
      <div>
        <label class="log-label" style="font-size: 12px; margin-bottom: 4px;">Evento Destino:</label>
        <select id="sol-evento" class="log-select" required style="font-size: 13px;">
          <option value="">-- Seleccione un Evento --</option>
          <!-- Los eventos se cargar√°n aqu√≠ desde localStorage -->
        </select>
      </div>
      <div>
        <label class="log-label" style="font-size: 12px; margin-bottom: 4px;">Encargado de Operaciones:</label>
        <input type="text" id="sol-responsable" class="log-input" value="Carlos M√©ndez" style="font-size: 13px;">
      </div>

      <div style="padding-top: 10px; border-top: 1px solid #e2e8f0;">
        <h3 class="log-titulo" style="font-size: 13px; margin: 0 0 6px 0; color: #dfe2e6;">Modo de Ingreso</h3>
        <div style="display: flex; gap: 8px;">
          <button type="button" class="log-tab-btn active" data-modo="receta" style="font-size: 12px; padding: 6px 10px;">Por Receta</button>
          <button type="button" class="log-tab-btn" data-modo="item" style="font-size: 12px; padding: 6px 10px;">Por √çtem</button>
        </div>
      </div>

      <div id="panelResumenEvento" style="background: #0f172a; color: #f1f5f9; padding: 14px; border-radius: 8px; min-height: 180px; display: none;">
        <h3 style="color: #93c5fd; font-size: 13pt; border-bottom: 2px solid #334155; padding-bottom: 6px; margin: 0 0 10px 0;">üìã Informaci√≥n del Evento</h3>
        <div style="display: grid; grid-template-columns: 1fr; gap: 10px; font-size: 9.5pt;">
          <div><div style="font-weight: bold; color: #94a3b8; margin-bottom: 2px;">Nombre</div><div id="resumen-nombre">‚Äî</div></div>
          <div><div style="font-weight: bold; color: #94a3b8; margin-bottom: 2px;">Cliente</div><div id="resumen-cliente">‚Äî</div></div>
          <div><div style="font-weight: bold; color: #94a3b8; margin-bottom: 2px;">Lugar</div><div id="resumen-lugar">‚Äî</div></div>
          <div><div style="font-weight: bold; color: #94a3b8; margin-bottom: 2px;">Servicio Solicitado</div><div id="resumen-descripcion">‚Äî</div></div>
          <div><div style="font-weight: bold; color: #94a3b8; margin-bottom: 2px;">Montaje</div><div id="resumen-montaje">‚Äî</div></div>
          <div><div style="font-weight: bold; color: #94a3b8; margin-bottom: 2px;">Desmontaje</div><div id="resumen-desmontaje">‚Äî</div></div>
        </div>
      </div>
    </div>

    <!-- Columna derecha: contenido din√°mico -->
    <div style="flex: 1; overflow-y: auto; background: rgba(0, 0, 0, 0.767); padding: 14px; border-radius: 8px; border: 1px solid #e2e8f0;">
      <div id="contenidoDinamico"></div>
    </div>

  </div>

</div>

<script>
  (function() {
    // Recetas se cargar√°n desde Supabase
    let recetasSimuladas = [];
    let recetasDisponibles = [];

    // =============================================================================
    // üîπ ESTADO
    // =============================================================================
    let estado = {
      modoIngreso: "receta",
      recetasSeleccionadas: {
        plantillas: [],
        especificas: []
      },
      materialesEspecificos: [],
      plantillasAdicionales: [],
      itemsPorItem: []
    };

    // =============================================================================
    // üîπ UTILIDADES
    // =============================================================================
    function formatDateTime(fecha, hora) {
      return fecha && hora ? `${fecha} ${hora}` : "‚Äî";
    }

    function getMaterial(codigo) {
      return materialesCatalogo.find(m => m.cod.trim() === (codigo || '').toString().trim());
    }

    function decodeTipoYObs(observacion) {
      const raw = (observacion || '').toString().trim();
      if (!raw) return { tipo: 'ITEM', obs: '' };
      if (raw === 'CASE') return { tipo: 'CASE', obs: '' };
      if (raw.startsWith('CASE|')) return { tipo: 'CASE', obs: raw.substring(5) };
      if (raw.startsWith('CASE:')) return { tipo: 'CASE', obs: raw.substring(5).trim() };
      return { tipo: 'ITEM', obs: raw };
    }

    function isCaseBaseCodigo(codigo) {
      return (codigo || '').toString().startsWith('CASEBASE|');
    }

    function getCaseBaseFromCodigo(codigo) {
      const s = (codigo || '').toString();
      if (!s.startsWith('CASEBASE|')) return '';
      return s.substring('CASEBASE|'.length).trim();
    }

    function formatMedidas(dimensiones) {
      if (!dimensiones) return '';
      if (typeof dimensiones === 'object') {
        const d = dimensiones;
        if (d.alto && d.ancho && d.profundidad && d.unidad) {
          return `${d.alto}x${d.ancho}x${d.profundidad}${d.unidad}`;
        }
        if (d.largo && d.ancho && d.alto) {
          return `${d.largo}x${d.ancho}x${d.alto}`;
        }
      }
      if (typeof dimensiones === 'string') return dimensiones;
      return '';
    }

    function asBool(v) {
      if (v === true) return true;
      if (v === false || v == null) return false;
      if (v === 1 || v === '1') return true;
      if (typeof v === 'string') {
        const t = v.trim().toLowerCase();
        return t === 't' || t === 'true' || t === 'yes' || t === 'si' || t === 's√≠';
      }
      return false;
    }

    function coalesceTipoAlta(cp) {
      if (!cp) return '';
      const keys = ['tipo_alta', 'Tipo de alta', 'Tipo Alta', 'Tipo de Alta'];
      for (const k of keys) {
        const val = cp[k] || cp[k.toLowerCase()] || cp[k.replace(/\s+/g, '_')];
        if (val) return (val || '').toString().trim().toUpperCase();
      }
      return '';
    }

    const _caseTemplateCache = new Map();
    async function getCaseTemplateItems(caseCodigo) {
      const key = (caseCodigo || '').toString().trim();
      if (!key) return [];
      if (_caseTemplateCache.has(key)) return _caseTemplateCache.get(key);

      const p = (async () => {
        // 1) Hijos del Case por campos_personalizados: {nombre:'Case Padre',tipo:'text',valor:key}
        let hijos = [];
        try {
          const CATALOGOS = [
            { table: 'catalogo_hierros' },
            { table: 'catalogo_audiovisual' },
            { table: 'catalogo_consumibles' }
          ];
          for (const c of CATALOGOS) {
            const selectStr = c.table === 'catalogo_consumibles'
              ? 'codigo, nombre, dimensiones, color, unidad_medida, campos_personalizados'
              : 'codigo, nombre, dimensiones, color, unidad_medida, campos_personalizados';
            const { data, error } = await window.supabaseClient
              .from(c.table)
              .select(selectStr)
              .eq('es_contenedor', false)
              .contains('campos_personalizados', [{ nombre: 'Case Padre', tipo: 'text', valor: key }]);
            if (error) {
              console.warn(`Error al consultar ${c.table}:`, error);
              continue;
            }
            const part = (data || []).map(r => ({
              codigo: r.codigo,
              nombre: r.nombre || r.codigo,
              medidas: formatMedidas(r.dimensiones),
              color: r.color || ''
            }));
            hijos.push(...part);
          }
        } catch (e) {
          console.warn('No se pudo cargar hijos del Case desde cat√°logo:', e);
          return [];
        }

        if (hijos.length === 0) return [];

        // 2) Cantidades actuales dentro del Case (si hay ubicaci√≥n en movimientos_bodega)
        const qtyByCode = new Map();
        try {
          const codigos = hijos.map(h => h.codigo);
          const { data: movs, error: movErr } = await window.supabaseClient
            .from('movimientos_bodega')
            .select('material_codigo, cantidad, signo, ubicacion_codigo')
            .eq('ubicacion_codigo', key)
            .in('material_codigo', codigos);
          if (movErr) throw movErr;

          (movs || []).forEach(m => {
            const c = (m.material_codigo || '').toString().trim();
            if (!c) return;
            const delta = (Number(m.cantidad) || 0) * (Number(m.signo) || 0);
            qtyByCode.set(c, (qtyByCode.get(c) || 0) + delta);
          });
        } catch (e) {
          console.warn('No se pudo calcular cantidades por ubicaci√≥n; fallback 1 por hijo:', e);
          hijos.forEach(h => qtyByCode.set(h.codigo, 1));
        }

        return hijos
          .map(h => ({
            codigo: h.codigo,
            nombre: h.nombre,
            cantidad: Math.max(0, Number(qtyByCode.get(h.codigo) || 0)) || 0,
            medidas: h.medidas || '',
            color: h.color || ''
          }))
          .filter(x => (Number(x.cantidad) || 0) > 0);
      })();

      _caseTemplateCache.set(key, p);
      return p;
    }

    function mostrarNotificacion(mensaje, tipo = 'info') {
      // Crear elemento de notificaci√≥n
      const notif = document.createElement('div');
      notif.style = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${tipo === 'error' ? '#dc3545' : tipo === 'success' ? '#28a745' : '#007bff'};
        color: white;
        padding: 12px 16px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        z-index: 10000;
        font-size: 14px;
        max-width: 400px;
        word-wrap: break-word;
      `;
      notif.textContent = mensaje;
      document.body.appendChild(notif);

      // Auto-remover despu√©s de 3 segundos
      setTimeout(() => {
        if (notif.parentNode) {
          notif.parentNode.removeChild(notif);
        }
      }, 3000);
    }

    // =============================================================================
    // üîπ MODAL: ELEGIR TIPO DE MATERIAL
    // =============================================================================
    function abrirModalElegirTipoMaterial() {
      if (document.getElementById('modal-elegir-tipo')) return;

      const modal = document.createElement('div');
      modal.id = 'modal-elegir-tipo';
      modal.style = `
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 2000;
      `;
      modal.innerHTML = `
        <div style="background: white; width: 90%; max-width: 400px; border-radius: 12px; padding: 24px; text-align: center;">
          <h3 style="margin: 0 0 20px 0; font-size: 18px; color: #1a365d;">¬øQu√© tipo de material deseas agregar?</h3>
          <div style="display: flex; gap: 12px; justify-content: center;">
            <button id="btn-material-especifico" style="padding: 12px 20px; background: #007bff; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;">Material Espec√≠fico</button>
            <button id="btn-material-plantilla" style="padding: 12px 20px; background: #28a745; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;">Material de Plantilla</button>
          </div>
          <button id="btn-cerrar-modal" style="margin-top: 16px; background: none; border: none; color: #6c757d; cursor: pointer; font-size: 14px;">Cancelar</button>
        </div>
      `;
      document.body.appendChild(modal);

      modal.querySelector('#btn-material-especifico').addEventListener('click', () => {
        document.body.removeChild(modal);
        abrirModalAdicionales();
      });

      modal.querySelector('#btn-material-plantilla').addEventListener('click', () => {
        document.body.removeChild(modal);
        abrirModalPlantillas();
      });

      modal.querySelector('#btn-cerrar-modal').addEventListener('click', () => {
        document.body.removeChild(modal);
      });

      modal.addEventListener('click', (e) => {
        if (e.target === modal) document.body.removeChild(modal);
      });
    }

    // =============================================================================
    // üîπ MODAL: MATERIALES ADICIONALES
    // =============================================================================
    function abrirModalAdicionales() {
      if (document.getElementById('modal-adicionales')) return;

      const modal = document.createElement('div');
      modal.id = 'modal-adicionales';
      modal.style = `
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 2000;
      `;
      modal.innerHTML = `
        <div style="background: white; width: 90%; max-width: 800px; max-height: 80vh; overflow: hidden; border-radius: 12px; display: flex; flex-direction: column;">
          <div style="padding: 16px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin: 0; font-size: 16px; color: #1a365d;">‚ûï Seleccionar Material Adicional</h3>
            <button id="btn-cerrar-modal" style="background: none; border: none; font-size: 20px; cursor: pointer;">‚úï</button>
          </div>
          <div style="padding: 16px; border-bottom: 1px solid #e2e8f0;">
            <div style="display: flex; gap: 12px; align-items: center;">
              <input type="text" id="busqueda-materiales" placeholder="Buscar por c√≥digo o nombre..." style="flex: 1; padding: 8px; border: 1px solid #e2e8f0; border-radius: 4px; font-size: 14px;">
              <select id="filtro-bodega" style="padding: 8px; border: 1px solid #e2e8f0; border-radius: 4px; font-size: 14px;">
                <option value="">Todas las bodegas</option>
              </select>
            </div>
          </div>
          <div style="flex: 1; overflow-y: auto; padding: 16px;">
            <table class="solicitud-table" style="font-size: 13px; width: 100%;">
              <thead>
                <tr>
                  <th>C√≥digo</th>
                  <th>Material</th>
                  <th>Ubicaci√≥n</th>
                  <th>Stock</th>
                  <th>Bodega</th>
                  <th>Contenedor</th>
                  <th style="text-align: center;">Acci√≥n</th>
                </tr>
              </thead>
              <tbody id="modal-cat-body"></tbody>
            </table>
          </div>
        </div>
      `;
      document.body.appendChild(modal);

      // Poblar filtro de bodegas
      const filtroBodega = modal.querySelector('#filtro-bodega');
      const bodegas = [...new Set(materialesCatalogo.map(m => m.bodegaPrincipal).filter(b => b))];
      bodegas.forEach(b => {
        const option = document.createElement('option');
        option.value = b;
        option.textContent = b;
        filtroBodega.appendChild(option);
      });

      // Funci√≥n para renderizar tabla filtrada
      function renderTablaFiltrada() {
        const busqueda = modal.querySelector('#busqueda-materiales').value.toLowerCase();
        const bodega = filtroBodega.value;

        // Crear set de c√≥digos en recetas para filtrar
        const codigosEnRecetas = new Set();
        if (estado.recetasSeleccionadas) {
          // Recorrer recetas de plantillas
          (estado.recetasSeleccionadas.plantillas || []).forEach(grupo => {
            if (grupo.receta && grupo.receta.items) {
              grupo.receta.items.forEach(item => {
                if (item && item.codigo) {
                  codigosEnRecetas.add(item.codigo.trim().toLowerCase());
                }
              });
            }
          });

          // Recorrer recetas espec√≠ficas
          (estado.recetasSeleccionadas.especificas || []).forEach(grupo => {
            if (grupo.receta && grupo.receta.items) {
              grupo.receta.items.forEach(item => {
                if (item && item.codigo) {
                  codigosEnRecetas.add(item.codigo.trim().toLowerCase());
                }
              });
            }
          });
        }
        
        const filtrados = materialesCatalogo.filter(m => {
          const matchBusqueda = m.cod.toLowerCase().includes(busqueda) || m.nom.toLowerCase().includes(busqueda);
          const matchBodega = !bodega || m.bodegaPrincipal === bodega;
          const notInRecetas = !codigosEnRecetas.has(m.cod.trim().toLowerCase());
          return matchBusqueda && matchBodega && notInRecetas;
        });
        const tbody = modal.querySelector('#modal-cat-body');
        tbody.innerHTML = filtrados.map(m => `
          <tr>
            <td><span class="code-badge" style="font-size: 11px;">${m.cod}</span></td>
            <td>${m.nom}</td>
            <td>${m.ubicacionNombre}</td>
            <td>${m.stockActual}</td>
            <td>${m.bodegaPrincipal}</td>
            <td>${m.contenedor}</td>
            <td style="text-align: center;">
              <button class="btn-add" data-cod="${m.cod}" style="font-size: 12px; padding: 4px 8px;">Ôºã Agregar</button>
            </td>
          </tr>
        `).join('');
        // Re-agregar event listeners
        tbody.querySelectorAll('[data-cod]').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const cod = e.currentTarget.dataset.cod;
            const m = getMaterial(cod);
            if (!m) return;
            const existe = estado.materialesEspecificos.find(i => i.codigo === cod);
            if (existe) {
              mostrarNotificacion(`‚ùå Material ${m.nom} (${cod}) ya est√° en la lista. No se permiten duplicados.`, 'error');
              return;
            } else {
              if (estado.recetasSeleccionadas) {
                // Verificar si el material ya est√° en alguna receta seleccionada
                const yaEnPlantillas = estado.recetasSeleccionadas.plantillas.some(grupo =>
                  grupo.receta && grupo.receta.items && grupo.receta.items.some(mat => mat && mat.codigo === cod)
                );
                const yaEnEspecificas = estado.recetasSeleccionadas.especificas.some(grupo =>
                  grupo.receta && grupo.receta.items && grupo.receta.items.some(mat => mat && mat.codigo === cod)
                );

                if (yaEnPlantillas || yaEnEspecificas) {
                  mostrarNotificacion(`‚ùå Material ${m.nom} (${cod}) ya est√° incluido en la receta. No se puede agregar como adicional.`, 'error');
                  return;
                }
              }
              estado.materialesEspecificos.push({
                codigo: m.cod,
                nombre: m.nom,
                ubicacionNombre: m.ubicacionNombre,
                stockActual: m.stockActual,
                bodegaPrincipal: m.bodegaPrincipal,
                contenedor: m.contenedor,
                cantidad: 1
              });
              mostrarNotificacion(`‚úÖ Material adicional agregado: ${m.nom} (${cod}).`, 'success');
            }
            renderResumenEspecificos();
          });
        });
      }

      // Llamar inicialmente
      renderTablaFiltrada();

      // Event listeners
      modal.querySelector('#busqueda-materiales').addEventListener('input', renderTablaFiltrada);
      filtroBodega.addEventListener('change', renderTablaFiltrada);

      modal.querySelector('#btn-cerrar-modal').onclick = () => {
        document.body.removeChild(modal);
      };
      modal.onclick = (e) => {
        if (e.target === modal) document.body.removeChild(modal);
      };
    }

    // =============================================================================
    // üîπ MODAL: PLANTILLAS
    // =============================================================================
    function abrirModalPlantillas() {
      if (document.getElementById('modal-plantillas')) return;

      const modal = document.createElement('div');
      modal.id = 'modal-plantillas';
      modal.style = `
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 2000;
      `;
      modal.innerHTML = `
        <div style="background: white; width: 90%; max-width: 800px; max-height: 80vh; overflow: hidden; border-radius: 12px; display: flex; flex-direction: column;">
          <div style="padding: 16px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin: 0; font-size: 16px; color: #1a365d;">üìã Seleccionar Plantilla</h3>
            <button id="btn-cerrar-modal" style="background: none; border: none; font-size: 20px; cursor: pointer;">‚úï</button>
          </div>
          <div style="padding: 16px; border-bottom: 1px solid #e2e8f0;">
            <input type="text" id="busqueda-plantillas" placeholder="Buscar plantillas..." style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 4px; font-size: 14px;">
          </div>
          <div style="flex: 1; overflow-y: auto; padding: 16px;">
            <div id="plantillas-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 16px;">
              ${renderPlantillas(plantillas)}
            </div>
          </div>
        </div>
      `;
      document.body.appendChild(modal);

      // Event delegation for selecting plantilla
      modal.addEventListener('click', (e) => {
        if (e.target.matches('[data-plantilla]')) {
          const clave = e.target.dataset.plantilla;
          const plantilla = plantillas.find(p => p.id === clave);
          if (plantilla) {
            // Agregar como material adicional de tipo GRUPO
            const existe = estado.plantillasAdicionales.find(i => i.codigo === clave);
            if (existe) {
              mostrarNotificacion(`‚ùå Plantilla ${plantilla.nombre_plantilla} ya est√° en la lista. No se permiten duplicados.`, 'error');
              return;
            } else {
              estado.plantillasAdicionales.push({
                codigo: clave,
                nombre: plantilla.nombre_plantilla,
                ubicacionNombre: '',
                stockActual: 0, // Plantillas no tienen stock directo
                bodegaPrincipal: plantilla.bodega_secundaria ? plantilla.bodega_secundaria.join(', ') : '',
                contenedor: '',
                cantidad: 1,
                tipo: 'GRUPO'
              });
              mostrarNotificacion(`‚úÖ Plantilla agregada: ${plantilla.nombre_plantilla}.`, 'success');
            }
            renderResumenPlantillas();
            document.body.removeChild(modal);
          }
        }
      });

      // Search functionality
      modal.querySelector('#busqueda-plantillas').addEventListener('input', (e) => {
        const busqueda = e.target.value.toLowerCase();
        const filtradas = plantillas.filter(p => p.nombre_plantilla.toLowerCase().includes(busqueda) || (p.descripcion && p.descripcion.toLowerCase().includes(busqueda)));
        modal.querySelector('#plantillas-grid').innerHTML = renderPlantillas(filtradas);
      });

      modal.querySelector('#btn-cerrar-modal').onclick = () => {
        document.body.removeChild(modal);
      };
      modal.onclick = (e) => {
        if (e.target === modal) document.body.removeChild(modal);
      };
    }

    function renderPlantillas(plantillasList) {
      return plantillasList.map(plantilla => `
        <div style="border: 1px solid #e2e8f0; border-radius: 8px; padding: 12px; background: #f8fafc;">
          <h4 style="margin: 0 0 8px 0; font-size: 14px; color: #1a365d;">${plantilla.nombre_plantilla}</h4>
          <p style="margin: 0 0 8px 0; font-size: 12px; color: #64748b;">${plantilla.descripcion || 'Sin descripci√≥n'}</p>
          <p style="margin: 0 0 8px 0; font-size: 11px; color: #64748b;">Tipo: ${plantilla.tipo}</p>
          <p style="margin: 0 0 12px 0; font-size: 11px; color: #64748b;">Bodega: ${plantilla.bodega_secundaria && plantilla.bodega_secundaria.length > 0 ? plantilla.bodega_secundaria.join(', ') : 'N/A'}</p>
          <button class="btn-add" data-plantilla="${plantilla.id}" style="width: 100%; font-size: 12px; padding: 6px;">Seleccionar Plantilla</button>
        </div>
      `).join('');
    }

    // =============================================================================
    // üîπ MODAL: RECETAS
    // =============================================================================
    async function abrirModalRecetas() {
      if (document.getElementById('modal-recetas')) return;

      // Cargar recetas desde Supabase
      await cargarRecetas();

      const modal = document.createElement('div');
      modal.id = 'modal-recetas';
      modal.style = `
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 2000;
      `;
      modal.innerHTML = `
        <div style="background: white; width: 90%; max-width: 900px; max-height: 85vh; overflow: hidden; border-radius: 12px; display: flex; flex-direction: column;">
          <div style="padding: 16px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin: 0; font-size: 16px; color: #1a365d;">üìã Seleccionar Receta</h3>
            <button id="btn-cerrar-modal" style="background: none; border: none; font-size: 20px; cursor: pointer;">‚úï</button>
          </div>
          <div style="padding: 16px; border-bottom: 1px solid #e2e8f0;">
            <div style="display: flex; gap: 12px; align-items: center;">
              <input type="text" id="busqueda-recetas" placeholder="Buscar por nombre o c√≥digo..." style="flex: 1; padding: 8px; border: 1px solid #e2e8f0; border-radius: 4px; font-size: 14px;">
              <select id="filtro-rubro-recetas" style="padding: 8px; border: 1px solid #e2e8f0; border-radius: 4px; font-size: 14px;">
                <option value="">Todos los rubros</option>
                <option value="Estructuras">Estructuras</option>
                <option value="Audiovisual">Audiovisual</option>
                <option value="Mobiliario">Mobiliario</option>
                <option value="Iluminaci√≥n">Iluminaci√≥n</option>
                <option value="Otros">Otros</option>
              </select>
            </div>
          </div>
          <div style="flex: 1; overflow-y: auto; padding: 16px;">
            <div id="recetas-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px;">
              ${renderRecetasFiltradas(recetasDisponibles)}
            </div>
          </div>
        </div>
      `;
      document.body.appendChild(modal);

      // Event delegation for recipe selection
      modal.addEventListener('click', (e) => {
        if (e.target.matches('[data-receta]')) {
          const nombreReceta = e.target.dataset.receta;
          const tipoReceta = e.target.dataset.tipo;
          const receta = recetasDisponibles.find(r => r.nombre === nombreReceta && r.tipo === tipoReceta);

          if (receta) {
            // Verificar si ya est√° seleccionada en su tipo correspondiente
            const yaSeleccionada = estado.recetasSeleccionadas[tipoReceta === 'plantilla' ? 'plantillas' : 'especificas']
              .some(grupo => grupo.receta.nombre === nombreReceta);

            if (yaSeleccionada) {
              mostrarNotificacion(`‚ö†Ô∏è La receta "${nombreReceta}" ya est√° seleccionada.`, 'warning');
              return;
            }

            // Agregar al contenedor correspondiente
            const contenedor = tipoReceta === 'plantilla' ? 'plantillas' : 'especificas';
            estado.recetasSeleccionadas[contenedor].push({
              receta: receta,
              cantidadRecetas: 1
            });

            // Renderizar el contenedor correspondiente
            if (tipoReceta === 'plantilla') {
              renderResumenRecetasPlantillas();
            } else {
              renderResumenRecetasEspecificas();
            }

            document.body.removeChild(modal);
            mostrarNotificacion(`‚úÖ Receta "${nombreReceta}" agregada correctamente.`, 'success');
          }
        }
      });

      // Attach event listeners for search and filter
      modal.querySelector('#busqueda-recetas').addEventListener('input', filtrarRecetasLocal);
      modal.querySelector('#filtro-rubro-recetas').addEventListener('change', filtrarRecetasLocal);

      modal.querySelector('#btn-cerrar-modal').onclick = () => {
        document.body.removeChild(modal);
      };
      modal.onclick = (e) => {
        if (e.target === modal) document.body.removeChild(modal);
      };

      // Funci√≥n de filtrado espec√≠fica para este modal
      function filtrarRecetasLocal() {
        const busqueda = modal.querySelector('#busqueda-recetas').value.toLowerCase();
        const filtroRubro = modal.querySelector('#filtro-rubro-recetas').value;

        const filtradas = recetasDisponibles.filter(receta => {
          const matchBusqueda = !busqueda ||
            receta.nombre.toLowerCase().includes(busqueda) ||
            receta.items.some(item => item.codigo.toLowerCase().includes(busqueda));

          const matchRubro = !filtroRubro || receta.rubro === filtroRubro;

          return matchBusqueda && matchRubro;
        });

        const grid = modal.querySelector('#recetas-grid');
        grid.innerHTML = renderRecetasFiltradas(filtradas);
      }

      // Event listeners para filtrado
      modal.querySelector('#busqueda-recetas').addEventListener('input', filtrarRecetasLocal);
      modal.querySelector('#filtro-rubro-recetas').addEventListener('change', filtrarRecetasLocal);
    }

    // =============================================================================
    // üîπ RENDERIZADO
    // =============================================================================
    function renderContenidoDinamico() {
      const contenedor = document.getElementById("contenidoDinamico");
      if (estado.modoIngreso === "receta") {
        renderModoReceta(contenedor);
      } else {
        renderModoItem(contenedor);
      }
    }

    function renderModoReceta(contenedor) {
      contenedor.innerHTML = `
        <div style="display: flex; gap: 20px; height: 620px; overflow: hidden;">

          <!-- Columna izquierda: resumen de recetas separadas por tipo -->
          <div style="flex: 2; overflow-y: auto; background: #f1f5f9; padding: 14px; border-radius: 8px; border: 1px solid #e2e8f0;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
              <h3 class="log-titulo" style="font-size: 15px; margin: 0; color: #1a365d;">1. Recetas Seleccionadas</h3>
              <button id="btn-abrir-modal-recetas" class="btn-add" style="font-size: 12px; padding: 4px 8px; height: fit-content;">+ Agregar Receta</button>
            </div>

            <!-- Recetas de Plantillas -->
            <div style="margin-bottom: 20px;">
              <h4 style="font-size: 14px; margin: 0 0 12px 0; color: #1a365d; display: flex; align-items: center; gap: 8px;">
                <span style="color: #764ba2;">üìã</span>
                Recetas de Plantillas
              </h4>
              <div id="resumen-recetas-plantillas-contenedor"></div>
              <div id="msg-recetas-plantillas-vacio" style="padding: 12px; text-align: center; color: #94a3b8; font-style: italic; font-size: 12px; display: ${estado.recetasSeleccionadas.plantillas.length === 0 ? 'block' : 'none'};">
                No hay recetas de plantillas seleccionadas.
              </div>
            </div>

            <!-- Recetas Espec√≠ficas -->
            <div>
              <h4 style="font-size: 14px; margin: 0 0 12px 0; color: #1a365d; display: flex; align-items: center; gap: 8px;">
                <span style="color: #3797a4;">üéØ</span>
                Recetas Espec√≠ficas
              </h4>
              <div id="resumen-recetas-especificas-contenedor"></div>
              <div id="msg-recetas-especificas-vacio" style="padding: 12px; text-align: center; color: #94a3b8; font-style: italic; font-size: 12px; display: ${estado.recetasSeleccionadas.especificas.length === 0 ? 'block' : 'none'};">
                No hay recetas espec√≠ficas seleccionadas.
              </div>
            </div>
          </div>

          <!-- Columna derecha: materiales adicionales -->
          <div style="flex: 1; display: flex; flex-direction: column; gap: 14px; background: white; padding: 14px; border-radius: 8px; border: 1px solid #e2e8f0; max-height: 620px; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <h3 class="log-titulo" style="font-size: 13px; margin: 0; color: #1a365d;">Materiales Adicionales</h3>
              <button id="btn-abrir-modal-adicionales" class="btn-add" style="font-size: 12px; padding: 4px 8px; height: fit-content;">+ Agregar</button>
            </div>
            
            <!-- Materiales Espec√≠ficos -->
            <div style="flex: 1; display: flex; flex-direction: column;">
              <h4 style="font-size: 12px; margin: 0 0 8px 0; color: #1a365d;">Espec√≠ficos</h4>
              <div style="border: 1px solid var(--accent); border-radius: 8px; background: white; flex: 1; display: flex; flex-direction: column;">
                <div style="overflow-y: auto; flex: 1;">
                  <table class="solicitud-table" style="font-size: 12px;">
                    <thead>
                      <tr style="background: rgba(55, 148, 255, 0.05);">
                        <th style="width: 60%;">Descripci√≥n</th>
                        <th style="width: 20%;">Cant.</th>
                        <th style="width: 20%; text-align: center;">Quitar</th>
                      </tr>
                    </thead>
                    <tbody id="ped-especificos-body"></tbody>
                  </table>
                  <div id="msg-especificos-vacio" style="padding: 16px; text-align: center; color: #94a3b8; font-style: italic; font-size: 12px; display: block;">No hay materiales espec√≠ficos.</div>
                </div>
              </div>
            </div>
            
            <!-- Plantillas -->
            <div style="flex: 1; display: flex; flex-direction: column;">
              <h4 style="font-size: 12px; margin: 0 0 8px 0; color: #1a365d;">Plantillas</h4>
              <div style="border: 1px solid var(--accent); border-radius: 8px; background: white; flex: 1; display: flex; flex-direction: column;">
                <div style="overflow-y: auto; flex: 1;">
                  <table class="solicitud-table" style="font-size: 12px;">
                    <thead>
                      <tr style="background: rgba(118, 75, 162, 0.05);">
                        <th style="width: 60%;">Descripci√≥n</th>
                        <th style="width: 20%;">Cant.</th>
                        <th style="width: 20%; text-align: center;">Quitar</th>
                      </tr>
                    </thead>
                    <tbody id="ped-plantillas-body"></tbody>
                  </table>
                  <div id="msg-plantillas-vacio" style="padding: 16px; text-align: center; color: #94a3b8; font-style: italic; font-size: 12px; display: block;">No hay plantillas.</div>
                </div>
              </div>
            </div>
          </div>

        </div>
      `;

      renderResumenRecetasPlantillas();
      renderResumenRecetasEspecificas();
      renderResumenEspecificos();
      renderResumenPlantillas();

      document.querySelector('.logistica-container #btn-abrir-modal-recetas').addEventListener("click", () => {
        abrirModalRecetas();
      });

      document.querySelector('.logistica-container #btn-abrir-modal-adicionales').addEventListener("click", () => {
        abrirModalElegirTipoMaterial();
      });
    }

    function renderResumenRecetasPlantillas() {
      const contenedor = document.querySelector('.logistica-container #resumen-recetas-plantillas-contenedor');
      const msg = document.querySelector('.logistica-container #msg-recetas-plantillas-vacio');

      if (estado.recetasSeleccionadas.plantillas.length === 0) {
        contenedor.innerHTML = '';
        msg.style.display = 'block';
        return;
      }
      msg.style.display = 'none';

      contenedor.innerHTML = estado.recetasSeleccionadas.plantillas.map((grupo, index) => `
        <div style="margin-bottom: 16px; padding: 12px; border: 1px solid #764ba2; border-radius: 8px; background: #f8f0ff;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <strong style="font-size: 13px; color: #1a365d;">${grupo.receta.nombre}</strong>
            <button class="btn-remove" data-tipo="plantilla" data-index="${index}" style="width: 24px; height: 24px; padding: 0; font-size: 14px;">‚úï</button>
          </div>
          <div style="display: flex; gap: 12px; align-items: end; margin-bottom: 12px;">
            <div style="flex: 1;">
              <label class="log-label" style="font-size: 12px; margin-bottom: 4px;">Cantidad de Recetas</label>
              <input type="number" class="log-input" min="1" value="${grupo.cantidadRecetas}" data-tipo="plantilla" data-index="${index}" data-campo="cantidadRecetas" style="width: 100%; font-size: 13px;"/>
            </div>
          </div>
          <div style="margin-top: 10px;">
            <table class="solicitud-table" style="font-size: 12px;">
              <thead>
                <tr>
                  <th>Material</th>
                  <th>Cantidad</th>
                </tr>
              </thead>
              <tbody>
                ${grupo.receta.items.map(item => {
                  const cantidadTotal = (item.cantidad || 0) * (grupo.cantidadRecetas || 1);
                  if (item.tipo === 'CASE' || isCaseBaseCodigo(item.codigo)) {
                    return `
                      <tr>
                        <td>
                          <strong>CASE ${getCaseBaseFromCodigo(item.codigo) || 'Case'}</strong><br>
                          <small>Se selecciona el Case f√≠sico en despacho</small>
                        </td>
                        <td>${cantidadTotal}</td>
                      </tr>
                    `;
                  }
                  const mat = getMaterial(item.codigo);
                  return `
                    <tr>
                      <td>
                        <strong>${item.nombre || item.codigo}</strong><br>
                        <small>${mat ? `(${mat.med}) ‚Äì ${mat.col}` : ''}</small>
                      </td>
                      <td>${cantidadTotal}</td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          </div>
        </div>
      `).join('');

      // Event listeners para plantillas
      document.querySelectorAll('.logistica-container #resumen-recetas-plantillas-contenedor [data-campo="cantidadRecetas"]').forEach(input => {
        input.addEventListener('input', (e) => {
          const idx = parseInt(e.target.dataset.index);
          estado.recetasSeleccionadas.plantillas[idx].cantidadRecetas = parseInt(e.target.value) || 1;
          renderResumenRecetasPlantillas();
        });
      });

      document.querySelectorAll('.logistica-container #resumen-recetas-plantillas-contenedor .btn-remove').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const idx = parseInt(e.currentTarget.dataset.index);
          estado.recetasSeleccionadas.plantillas.splice(idx, 1);
          renderResumenRecetasPlantillas();
        });
      });
    }

    function renderResumenRecetasEspecificas() {
      const contenedor = document.querySelector('.logistica-container #resumen-recetas-especificas-contenedor');
      const msg = document.querySelector('.logistica-container #msg-recetas-especificas-vacio');

      if (estado.recetasSeleccionadas.especificas.length === 0) {
        contenedor.innerHTML = '';
        msg.style.display = 'block';
        return;
      }
      msg.style.display = 'none';

      contenedor.innerHTML = estado.recetasSeleccionadas.especificas.map((grupo, index) => `
        <div style="margin-bottom: 16px; padding: 12px; border: 1px solid #3797a4; border-radius: 8px; background: #f0fdff;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <strong style="font-size: 13px; color: #1a365d;">${grupo.receta.nombre}</strong>
            <button class="btn-remove" data-tipo="especifica" data-index="${index}" style="width: 24px; height: 24px; padding: 0; font-size: 14px;">‚úï</button>
          </div>
          <div style="display: flex; gap: 12px; align-items: end; margin-bottom: 12px;">
            <div style="flex: 1;">
              <label class="log-label" style="font-size: 12px; margin-bottom: 4px;">Cantidad de Recetas</label>
              <input type="number" class="log-input" min="1" value="${grupo.cantidadRecetas}" data-tipo="especifica" data-index="${index}" data-campo="cantidadRecetas" style="width: 100%; font-size: 13px;"/>
            </div>
          </div>
          <div style="margin-top: 10px;">
            <table class="solicitud-table" style="font-size: 12px;">
              <thead>
                <tr>
                  <th>Material</th>
                  <th>Cantidad</th>
                </tr>
              </thead>
              <tbody>
                ${grupo.receta.items.map(item => {
                  const cantidadTotal = (item.cantidad || 0) * (grupo.cantidadRecetas || 1);
                  if (item.tipo === 'CASE' || isCaseBaseCodigo(item.codigo)) {
                    return `
                      <tr>
                        <td>
                          <strong>CASE ${getCaseBaseFromCodigo(item.codigo) || 'Case'}</strong><br>
                          <small>Se selecciona el Case f√≠sico en despacho</small>
                        </td>
                        <td>${cantidadTotal}</td>
                      </tr>
                    `;
                  }
                  const mat = getMaterial(item.codigo);
                  return `
                    <tr>
                      <td>
                        <strong>${item.nombre || item.codigo}</strong><br>
                        <small>${mat ? `(${mat.med}) ‚Äì ${mat.col}` : ''}</small>
                      </td>
                      <td>${cantidadTotal}</td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          </div>
        </div>
      `).join('');

      // Event listeners para espec√≠ficas
      document.querySelectorAll('.logistica-container #resumen-recetas-especificas-contenedor [data-campo="cantidadRecetas"]').forEach(input => {
        input.addEventListener('input', (e) => {
          const idx = parseInt(e.target.dataset.index);
          estado.recetasSeleccionadas.especificas[idx].cantidadRecetas = parseInt(e.target.value) || 1;
          renderResumenRecetasEspecificas();
        });
      });

      document.querySelectorAll('.logistica-container #resumen-recetas-especificas-contenedor .btn-remove').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const idx = parseInt(e.currentTarget.dataset.index);
          estado.recetasSeleccionadas.especificas.splice(idx, 1);
          renderResumenRecetasEspecificas();
        });
      });
    }

    function renderResumenEspecificos() {
      if (!estado.materialesEspecificos) estado.materialesEspecificos = [];
      const tbody = document.querySelector('.logistica-container #ped-especificos-body');
      const msg = document.querySelector('.logistica-container #msg-especificos-vacio');
      if (estado.materialesEspecificos.length === 0) {
        tbody.innerHTML = '';
        msg.style.display = 'block';
        return;
      }
      msg.style.display = 'none';
      tbody.innerHTML = estado.materialesEspecificos.map((item, idx) => `
        <tr>
          <td>
            <strong>${item.nombre}</strong><br>
            <small>(Ubicaci√≥n: ${item.ubicacionNombre}) ‚Äì Stock: ${item.stockActual}</small>
          </td>
          <td>
            <input type="number" class="log-input" min="1" max="${item.stockActual}" value="${item.cantidad}" data-index="${idx}" style="width: 60px; padding: 4px; font-size: 12px;" />
          </td>
          <td style="text-align: center;">
            <button class="btn-remove" data-index="${idx}" style="width: 24px; height: 24px; padding: 0; font-size: 12px;">‚úï</button>
          </td>
        </tr>
      `).join('');
      document.querySelectorAll('.logistica-container #ped-especificos-body [data-index]').forEach(el => {
        if (el.tagName === 'INPUT') {
          el.addEventListener('input', (e) => {
            const idx = parseInt(e.target.dataset.index);
            let val = parseInt(e.target.value) || 1;
            if (val > estado.materialesEspecificos[idx].stockActual) {
              val = estado.materialesEspecificos[idx].stockActual;
              e.target.value = val;
              mostrarNotificacion(`Cantidad ajustada al stock disponible: ${val}`, 'warning');
            }
            estado.materialesEspecificos[idx].cantidad = val;
          });
        } else if (el.classList.contains('btn-remove')) {
          el.addEventListener('click', (e) => {
            const idx = parseInt(e.currentTarget.dataset.index);
            estado.materialesEspecificos.splice(idx, 1);
            renderResumenEspecificos();
          });
        }
      });
    }

    function renderResumenPlantillas() {
      if (!estado.plantillasAdicionales) estado.plantillasAdicionales = [];
      const tbody = document.querySelector('.logistica-container #ped-plantillas-body');
      const msg = document.querySelector('.logistica-container #msg-plantillas-vacio');
      if (estado.plantillasAdicionales.length === 0) {
        tbody.innerHTML = '';
        msg.style.display = 'block';
        return;
      }
      msg.style.display = 'none';
      tbody.innerHTML = estado.plantillasAdicionales.map((item, idx) => `
        <tr>
          <td>
            <strong>${item.nombre}</strong><br>
            <small>${item.tipo === 'GRUPO' ? '' : `(Ubicaci√≥n: ${item.ubicacionNombre})`}</small>
          </td>
          <td>
            <input type="number" class="log-input" min="1" value="${item.cantidad}" data-index="${idx}" style="width: 60px; padding: 4px; font-size: 12px;" />
          </td>
          <td style="text-align: center;">
            <button class="btn-remove" data-index="${idx}" style="width: 24px; height: 24px; padding: 0; font-size: 12px;">‚úï</button>
          </td>
        </tr>
      `).join('');
      document.querySelectorAll('.logistica-container #ped-plantillas-body [data-index]').forEach(el => {
        if (el.tagName === 'INPUT') {
          el.addEventListener('input', (e) => {
            const idx = parseInt(e.target.dataset.index);
            let val = parseInt(e.target.value) || 1;
            estado.plantillasAdicionales[idx].cantidad = val;
          });
        } else if (el.classList.contains('btn-remove')) {
          el.addEventListener('click', (e) => {
            const idx = parseInt(e.currentTarget.dataset.index);
            estado.plantillasAdicionales.splice(idx, 1);
            renderResumenPlantillas();
          });
        }
      });
    }

    function renderModoItem(contenedor) {
      contenedor.innerHTML = `
        <h3 class="log-titulo" style="font-size: 15px; margin: 12px 0 10px 0; color: #fefcff;">Cat√°logo de Inventario</h3>
        
        <!-- Divisi√≥n en dos columnas -->
        <div style="display: flex; gap: 20px; height: 620px; overflow: hidden;">

          <!-- Columna izquierda: cat√°logo -->
          <div style="flex: 2; overflow-y: auto; background: #f8fafc; padding: 14px; border-radius: 8px; border: 1px solid #e2e8f0;">
            <div style="max-height: 540px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 8px; background: white;">
              <table class="solicitud-table" style="font-size: 12px;">
                <thead style="position: sticky; top: 0; background: #f8fafc;">
                  <tr>
                    <th>C√≥digo</th>
                    <th>Material</th>
                    <th>Ubicaci√≥n</th>
                    <th>Stock</th>
                    <th>Bodega</th>
                    <th>Contenedor</th>
                    <th style="text-align: center;">Acci√≥n</th>
                  </tr>
                </thead>
                <tbody id="cat-item-body"></tbody>
              </table>
            </div>
          </div>

          <!-- Columna derecha: resumen del pedido -->
          <div style="flex: 1; display: flex; flex-direction: column; gap: 14px; background: white; padding: 14px; border-radius: 8px; border: 1px solid #e2e8f0;">
            <h3 class="log-titulo" style="font-size: 13px; margin: 0 0 8px 0; color: #1a365d;">Resumen de Pedido</h3>
            <div style="border: 1px solid var(--accent); border-radius: 8px; overflow: hidden; background: white; flex: 1;">
              <table class="solicitud-table" style="font-size: 12px;">
                <thead>
                  <tr style="background: rgba(55, 148, 255, 0.05);">
                    <th style="width: 60%;">Descripci√≥n</th>
                    <th style="width: 20%;">Cant.</th>
                    <th style="width: 20%; text-align: center;">Quitar</th>
                  </tr>
                </thead>
                <tbody id="ped-item-body"></tbody>
              </table>
              <div id="msg-item-vacio" style="padding: 16px; text-align: center; color: #94a3b8; font-style: italic; font-size: 12px; display: ${estado.itemsPorItem.length === 0 ? 'block' : 'none'};">
                No hay materiales en la lista.
              </div>
            </div>
          </div>

        </div>
      `;
      renderCatalogoItem();
      renderResumenItem();
    }

    function renderCatalogoItem() {
      const tbody = document.querySelector('.logistica-container #cat-item-body');
      tbody.innerHTML = materialesCatalogo.map(m => `
        <tr>
          <td><span class="code-badge" style="font-size: 11px;">${m.cod}</span></td>
          <td>${m.nom}</td>
          <td>${m.ubicacionNombre}</td>
          <td>${m.stockActual}</td>
          <td>${m.bodegaPrincipal}</td>
          <td>${m.contenedor}</td>
          <td style="text-align: center;">
            <button class="btn-add" data-cod="${m.cod}" style="font-size: 12px; padding: 4px 8px;">Ôºã Agregar</button>
          </td>
        </tr>
      `).join('');
      tbody.querySelectorAll('[data-cod]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const cod = e.currentTarget.dataset.cod;
          const m = getMaterial(cod);
          if (!m) return;
          const existe = estado.itemsPorItem.find(i => i.codigo === cod);
          if (existe) {
            existe.cantidad++;
            mostrarNotificacion(`‚ûï Cantidad aumentada: ${m.nom} (${cod}) ahora tiene ${existe.cantidad} unidades.`, 'info');
          } else {
            estado.itemsPorItem.push({
              codigo: m.cod,
              nombre: m.nom,
              ubicacionNombre: m.ubicacionNombre,
              stockActual: m.stockActual,
              bodegaPrincipal: m.bodegaPrincipal,
              contenedor: m.contenedor,
              cantidad: 1
            });
            mostrarNotificacion(`‚úÖ Material agregado: ${m.nom} (${cod}).`, 'success');
          }
          renderResumenItem();
        });
      });
    }

    function renderResumenItem() {
      if (!estado.itemsPorItem) estado.itemsPorItem = [];
      const tbody = document.querySelector('.logistica-container #ped-item-body');
      const msg = document.querySelector('.logistica-container #msg-item-vacio');
      if (estado.itemsPorItem.length === 0) {
        tbody.innerHTML = '';
        msg.style.display = 'block';
        return;
      }
      msg.style.display = 'none';
      tbody.innerHTML = estado.itemsPorItem.map((item, idx) => `
        <tr>
          <td>
            <strong>${item.codigo}</strong><br>
            <small>${item.nombre} (${item.ubicacionNombre})</small>
          </td>
          <td>
            <input type="number" class="log-input" min="1" max="${item.stockActual}" value="${item.cantidad}" data-index="${idx}" style="width: 60px; padding: 4px; font-size: 12px;" />
          </td>
          <td style="text-align: center;">
            <button class="btn-remove" data-index="${idx}" style="width: 24px; height: 24px; padding: 0; font-size: 12px;">‚úï</button>
          </td>
        </tr>
      `).join('');
      document.querySelectorAll('.logistica-container #ped-item-body [data-index]').forEach(el => {
        if (el.tagName === 'INPUT') {
          el.addEventListener('input', (e) => {
            const idx = parseInt(e.target.dataset.index);
            let val = parseInt(e.target.value) || 1;
            if (val > estado.itemsPorItem[idx].stockActual) {
              val = estado.itemsPorItem[idx].stockActual;
              e.target.value = val;
              mostrarNotificacion(`Cantidad ajustada al stock disponible: ${val}`, 'warning');
            }
            estado.itemsPorItem[idx].cantidad = val;
          });
        } else if (el.classList.contains('btn-remove')) {
          el.addEventListener('click', (e) => {
            const idx = parseInt(e.currentTarget.dataset.index);
            estado.itemsPorItem.splice(idx, 1);
            renderResumenItem();
          });
        }
      });
    }

    // =============================================================================
    // üîπ CARGAR DATOS DESDE SUPABASE
    // =============================================================================
    let eventos = [];
    let materialesCatalogo = [];
    let plantillas = [];
    let recetas = [];

    async function cargarEventos() {
      try {
        const { data, error } = await window.supabaseClient
          .from('eventos')
          .select('id, nombre, cliente, lugar, fecha_montaje, hora_montaje, fecha_desmontaje, hora_desmontaje, descripcion, estado, cotizacion_id')
          .eq('estado', 'activo')
          .order('fecha_montaje', { ascending: false });

        if (error) {
          console.error('Error al cargar eventos:', error);
          eventos = [];
          return;
        }

        eventos = data || [];
      } catch (err) {
        console.error('Error:', err);
        eventos = [];
      }
    }

    async function cargarMaterialesCatalogo() {
      try {
        const allRows = [];
        const CATALOGOS = [
          { table: 'catalogo_hierros' },
          { table: 'catalogo_audiovisual' },
          { table: 'catalogo_consumibles' }
        ];
        for (const c of CATALOGOS) {
          const selectStr = c.table === 'catalogo_consumibles'
            ? 'codigo, nombre, dimensiones, color, unidad_medida, campos_personalizados'
            : 'codigo, nombre, dimensiones, color, unidad_medida, campos_personalizados';
          const { data, error } = await window.supabaseClient
            .from(c.table)
            .select(selectStr)
            .order('codigo', { ascending: true });
          if (error) {
            console.error(`Error al cargar ${c.table}:`, error);
            continue;
          }
          const rows = (data || []).map(r => ({ ...r, __catalogo: c.table }));
          allRows.push(...rows);
        }

        // Crear mapa de materiales con nombres
        const materialesMap = new Map();
        allRows.forEach(item => {
          materialesMap.set(item.codigo, {
            cod: item.codigo,
            nom: item.nombre,
            med: formatMedidas(item.dimensiones),
            col: item.color || '',
            bodegaPrincipal: '',
            bodegaSecundaria: '',
            contenedor: '',
            ubicacionNombre: '',
            stockActual: 0,
            fechaCompra: null,
            __catalogo: item.__catalogo
          });
        });

        // Actualizar con datos de stock
        const STOCK_VIEWS = [
          { view: 'stock_hierros' },
          { view: 'stock_audiovisual' },
          { view: 'stock_consumibles' }
        ];
        for (const v of STOCK_VIEWS) {
          const { data, error } = await window.supabaseClient
            .from(v.view)
            .select('material_codigo, material_nombre, precio, stock_actual, bodega_principal, bodega_secundaria, contenedor, ubicacion_nombre, fecha_compra');
          if (error) {
            console.error(`Error al cargar stock de ${v.view}:`, error);
            continue;
          }
          (data || []).forEach(r => {
            if (materialesMap.has(r.material_codigo)) {
              const mat = materialesMap.get(r.material_codigo);
              mat.bodegaPrincipal = r.bodega_principal || '';
              mat.bodegaSecundaria = r.bodega_secundaria || '';
              mat.contenedor = r.contenedor || '';
              mat.ubicacionNombre = r.ubicacion_nombre || '';
              mat.stockActual = r.stock_actual || 0;
              mat.fechaCompra = r.fecha_compra || null;
            } else {
              // Si no est√° en cat√°logo, agregarlo (aunque no deber√≠a pasar)
              materialesMap.set(r.material_codigo, {
                cod: r.material_codigo,
                nom: r.material_nombre,
                med: '',
                col: '',
                bodegaPrincipal: r.bodega_principal || '',
                bodegaSecundaria: r.bodega_secundaria || '',
                contenedor: r.contenedor || '',
                ubicacionNombre: r.ubicacion_nombre || '',
                stockActual: r.stock_actual || 0,
                fechaCompra: r.fecha_compra || null,
                __catalogo: v.view
              });
            }
          });
        }

        materialesCatalogo = Array.from(materialesMap.values());

      } catch (err) {
        console.error('Error cargando materiales:', err);
        materialesCatalogo = [];
      }
    }

    async function cargarPlantillas() {
      try {
        const { data, error } = await window.supabaseClient
          .from('recetas_plantillas_materiales')
          .select('id, nombre_plantilla, tipo, dimensiones, catalogos, descripcion, bodega_secundaria')
          .order('nombre_plantilla', { ascending: true });
        if (error) {
          console.error('Error al cargar plantillas:', error);
          return;
        }
        plantillas = data || [];
      } catch (err) {
        console.error('Error:', err);
      }
    }

    async function cargarRecetas() {
      try {
        // Cargar recetas de plantillas
        const { data: dataPlantillas, error: errorPlantillas } = await window.supabaseClient
          .from('recetas')
          .select(`
            id,
            nombre,
            rubro,
            recetas_materiales (
              material_codigo,
              cantidad,
              observacion,
              material_nombre
            )
          `)
          .order('nombre', { ascending: true });

        if (errorPlantillas) {
          console.error('Error al cargar recetas de plantillas:', errorPlantillas);
        }

        // Cargar recetas espec√≠ficas
        const { data: dataEspecificas, error: errorEspecificas } = await window.supabaseClient
          .from('recetas_especificas')
          .select(`
            id,
            nombre,
            rubro,
            recetas_especificas_materiales (
              material_codigo,
              cantidad,
              observacion,
              material_nombre
            )
          `)
          .order('nombre', { ascending: true });

        if (errorEspecificas) {
          console.error('Error al cargar recetas espec√≠ficas:', errorEspecificas);
        }

        // Procesar recetas de plantillas
        const recetasPlantillas = (dataPlantillas || []).map(receta => ({
          id: receta.id,
          nombre: receta.nombre,
          rubro: receta.rubro,
          tipo: 'plantilla',
          items: receta.recetas_materiales.map(item => ({
            codigo: item.material_codigo,
            cantidad: item.cantidad,
            nombre: item.material_nombre,
            tipo: isCaseBaseCodigo(item.material_codigo) ? 'CASE' : decodeTipoYObs(item.observacion).tipo,
            observacion: isCaseBaseCodigo(item.material_codigo) ? (item.observacion || '') : decodeTipoYObs(item.observacion).obs
          }))
        }));

        // Procesar recetas espec√≠ficas
        const recetasEspecificas = (dataEspecificas || []).map(receta => ({
          id: receta.id,
          nombre: receta.nombre,
          rubro: receta.rubro,
          tipo: 'especifica',
          items: receta.recetas_especificas_materiales.map(item => ({
            codigo: item.material_codigo,
            cantidad: item.cantidad,
            nombre: item.material_nombre,
            tipo: isCaseBaseCodigo(item.material_codigo) ? 'CASE' : decodeTipoYObs(item.observacion).tipo,
            observacion: isCaseBaseCodigo(item.material_codigo) ? (item.observacion || '') : decodeTipoYObs(item.observacion).obs
          }))
        }));

        // Combinar ambas listas
        recetasDisponibles = [...recetasPlantillas, ...recetasEspecificas];
      } catch (err) {
        console.error('Error:', err);
      }
    }

    function renderRecetasFiltradas(recetas) {
      return recetas.map(receta => {
        const tipoIcono = receta.tipo === 'plantilla' ? 'üìã' : 'üéØ';
        const tipoColor = receta.tipo === 'plantilla' ? '#764ba2' : '#3797a4';
        const tipoTexto = receta.tipo === 'plantilla' ? 'Plantilla' : 'Espec√≠fica';

        return `
        <div style="border: 1px solid #e2e8f0; border-radius: 8px; padding: 16px; background: #f8fafc; display: flex; flex-direction: column; gap: 12px;">
          <div>
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 4px;">
              <h4 style="margin: 0; font-size: 16px; color: #1a365d;">${receta.nombre}</h4>
              <span style="font-size: 12px; color: ${tipoColor}; background: rgba(255,255,255,0.8); padding: 2px 6px; border-radius: 4px; border: 1px solid ${tipoColor};">${tipoIcono} ${tipoTexto}</span>
            </div>
            <div style="font-size: 12px; color: #64748b;">Rubro: ${receta.rubro || 'Sin especificar'}</div>
          </div>
          <div style="flex: 1;">
            <h5 style="margin: 0 0 8px 0; font-size: 14px; color: #374151;">Materiales:</h5>
            <div style="max-height: 200px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 4px; background: white;">
              <table style="width: 100%; font-size: 12px; border-collapse: collapse;">
                <thead style="background: #f1f5f9;">
                  <tr>
                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #e2e8f0;">Material</th>
                    <th style="padding: 8px; text-align: center; border-bottom: 1px solid #e2e8f0; width: 80px;">Cant.</th>
                  </tr>
                </thead>
                <tbody>
                  ${receta.items.map(item => {
                    if (item.tipo === 'CASE' || isCaseBaseCodigo(item.codigo)) {
                      const baseName = getCaseBaseFromCodigo(item.codigo) || 'Case';
                      return `<tr><td style="padding: 6px 8px; border-bottom: 1px solid #f1f5f9;">CASE ${baseName}</td><td style="padding: 6px 8px; text-align: center; border-bottom: 1px solid #f1f5f9;">${item.cantidad}</td></tr>`;
                    }
                    return `<tr><td style="padding: 6px 8px; border-bottom: 1px solid #f1f5f9;">${item.nombre || item.codigo}</td><td style="padding: 6px 8px; text-align: center; border-bottom: 1px solid #f1f5f9;">${item.cantidad}</td></tr>`;
                  }).join('')}
                </tbody>
              </table>
            </div>
          </div>
          <button class="btn-add" data-receta="${receta.nombre}" data-tipo="${receta.tipo}" style="width: 100%; font-size: 12px; padding: 8px; background: ${tipoColor};">Seleccionar Receta</button>
        </div>
      `;
      }).join('');
    }

    // =============================================================================
    // üîπ CARGAR EVENTOS DESDE SUPABASE
    // =============================================================================
    function cargarEventosEnSelect() {
      const select = document.querySelector('.logistica-container #sol-evento');
      if (!select) {
        console.error('Elemento sol-evento no encontrado');
        return;
      }
      select.innerHTML = '<option value="">-- Seleccione un Evento --</option>';

      eventos.forEach(evento => {
        const option = document.createElement('option');
        option.value = evento.nombre;
        option.textContent = `${evento.nombre} - ${evento.cliente}`;
        select.appendChild(option);
      });
    }

    // =============================================================================
    // üîπ ACTUALIZAR PANEL DE EVENTO (DESDE SUPABASE)
    // =============================================================================
    async function actualizarPanelEvento(nombreEvento) {
      const panel = document.getElementById('panelResumenEvento');
      if (!panel) return;

      const evento = eventos.find(e => e.nombre === nombreEvento);

      if (!evento) {
        panel.style.display = 'none';
        return;
      }

      // Obtener servicios con cantidades desde la cotizaci√≥n
      let serviciosTexto = 'No disponible';
      if (evento.cotizacion_id) {
        console.log('Consultando cotizaci√≥n:', evento.cotizacion_id);
        try {
          const { data: cotizacion, error: cotError } = await window.supabaseClient
            .from('cotizaciones')
            .select('servicios')
            .eq('id', evento.cotizacion_id)
            .single();

          if (cotError) {
            console.error('Error consultando cotizaci√≥n:', cotError);
          } else {
            console.log('Cotizaci√≥n obtenida:', cotizacion);
          }

          if (!cotError && cotizacion?.servicios && cotizacion.servicios.length > 0) {
            serviciosTexto = cotizacion.servicios.map(s => {
              const cantidad = s.cantidad || 1;
              const nombre = s.nombre || 'Servicio sin nombre';
              return `‚Ä¢ ${cantidad} ${nombre}`;
            }).join('<br>');
            console.log('Servicios texto generado:', serviciosTexto);
          }
        } catch (cotErr) {
          console.warn('Error al cargar servicios de cotizaci√≥n:', cotErr);
          // Fallback a la descripci√≥n guardada en el evento
          serviciosTexto = (Array.isArray(evento.descripcion) ? evento.descripcion : [evento.descripcion])
            .map(i => `‚Ä¢ ${i}`).join('<br>') || "No disponible";
        }
      } else {
        console.log('Evento sin cotizacion_id:', evento);
        // Fallback a la descripci√≥n guardada en el evento
        serviciosTexto = (Array.isArray(evento.descripcion) ? evento.descripcion : [evento.descripcion])
          .map(i => `‚Ä¢ ${i}`).join('<br>') || "No disponible";
      }

      panel.style.display = 'block';
      document.getElementById("resumen-nombre").textContent = evento.nombre || "‚Äî";
      document.getElementById("resumen-cliente").textContent = evento.cliente || "‚Äî";
      document.getElementById("resumen-lugar").textContent = evento.lugar || "‚Äî";
      document.getElementById("resumen-descripcion").innerHTML = serviciosTexto;
      document.getElementById("resumen-montaje").textContent = 
        formatDateTime(evento.fecha_montaje, evento.hora_montaje);
      document.getElementById("resumen-desmontaje").textContent = 
        formatDateTime(evento.fecha_desmontaje, evento.hora_desmontaje);
    }

    // =============================================================================
    // üîπ L√ìGICA PRINCIPAL
    // =============================================================================
    async function obtenerItemsParaGuardar() {
      const agg = new Map();

      function addOrSum(row) {
        const code = (row.codigo || '').toString().trim();
        if (!code) return;
        const prev = agg.get(code);
        if (!prev) {
          agg.set(code, { ...row });
          return;
        }
        prev.cantidad = (Number(prev.cantidad) || 0) + (Number(row.cantidad) || 0);
        if (!prev.nombre && row.nombre) prev.nombre = row.nombre;
        if (!prev.medidas && row.medidas) prev.medidas = row.medidas;
        if (!prev.color && row.color) prev.color = row.color;
      }

      if (estado.modoIngreso === "receta") {
        // Procesar recetas de plantillas
        for (const grupo of estado.recetasSeleccionadas.plantillas || []) {
          if (!grupo.receta) continue;
          const factorReceta = (Number(grupo.cantidadRecetas) || 1);

          for (const item of (grupo.receta.items || [])) {
            const base = (Number(item.cantidad) || 0) * factorReceta;
            if (base <= 0) continue;

            // CASE gen√©rico (por base): NO se expande aqu√≠. Bodega elige Case f√≠sico al despachar.
            if (isCaseBaseCodigo(item.codigo) || item.tipo === 'CASE') {
              const baseName = getCaseBaseFromCodigo(item.codigo) || 'Case';
              const codigoPlantilla = isCaseBaseCodigo(item.codigo) ? item.codigo : `CASEBASE|${baseName}`;
              addOrSum({
                codigo: codigoPlantilla,
                nombre: baseName,
                cantidad: base,
                estado: "pendiente",
                observacion: `Requiere ${baseName} (selecci√≥n de Case f√≠sico en despacho)`,
                medidas: "",
                color: ""
              });
            } else {
              const mat = getMaterial(item.codigo);
              addOrSum({
                codigo: item.codigo,
                nombre: mat?.nom || "Desconocido",
                cantidad: base,
                estado: "pendiente",
                observacion: "",
                medidas: mat?.med || "",
                color: mat?.col || ""
              });
            }
          }
        }

        // Procesar recetas espec√≠ficas
        for (const grupo of estado.recetasSeleccionadas.especificas || []) {
          if (!grupo.receta) continue;
          const factorReceta = (Number(grupo.cantidadRecetas) || 1);

          for (const item of (grupo.receta.items || [])) {
            const base = (Number(item.cantidad) || 0) * factorReceta;
            if (base <= 0) continue;

            // CASE gen√©rico (por base): NO se expande aqu√≠. Bodega elige Case f√≠sico al despachar.
            if (isCaseBaseCodigo(item.codigo) || item.tipo === 'CASE') {
              const baseName = getCaseBaseFromCodigo(item.codigo) || 'Case';
              const codigoPlantilla = isCaseBaseCodigo(item.codigo) ? item.codigo : `CASEBASE|${baseName}`;
              addOrSum({
                codigo: codigoPlantilla,
                nombre: baseName,
                cantidad: base,
                estado: "pendiente",
                observacion: `Requiere ${baseName} (selecci√≥n de Case f√≠sico en despacho)`,
                medidas: "",
                color: ""
              });
            } else {
              const mat = getMaterial(item.codigo);
              addOrSum({
                codigo: item.codigo,
                nombre: mat?.nom || "Desconocido",
                cantidad: base,
                estado: "pendiente",
                observacion: "",
                medidas: mat?.med || "",
                color: mat?.col || ""
              });
            }
          }
        }

        estado.materialesEspecificos.forEach(item => {
          addOrSum({
            codigo: item.codigo,
            nombre: item.nombre,
            cantidad: item.cantidad,
            estado: "pendiente",
            observacion: "Material adicional espec√≠fico (fuera de receta)",
            medidas: item.medidas,
            color: item.color
          });
        });

        estado.plantillasAdicionales.forEach(item => {
          addOrSum({
            codigo: item.codigo,
            nombre: item.nombre,
            cantidad: item.cantidad,
            estado: "pendiente",
            observacion: "Plantilla adicional (fuera de receta)",
            medidas: "",
            color: ""
          });
        });
      } else {
        estado.itemsPorItem.forEach(item => {
          addOrSum({
            codigo: item.codigo,
            nombre: item.nombre,
            cantidad: item.cantidad,
            estado: "pendiente",
            observacion: "",
            medidas: item.medidas,
            color: item.color
          });
        });
      }

      return Array.from(agg.values()).filter(x => (Number(x.cantidad) || 0) > 0);
    }

    async function generarIdSolicitud() {
      try {
        // Buscar el ID m√°s alto existente que empiece con SOL-
        const { data, error } = await window.supabaseClient
          .from('solicitudes_logistica')
          .select('id')
          .like('id', 'SOL-%')
          .order('id', { ascending: false })
          .limit(1);

        if (error) {
          console.error('Error al obtener √∫ltimo ID:', error);
          // Si hay error, usar 1 como fallback
          return 'SOL-00001';
        }

        let nextNumber = 1;
        if (data && data.length > 0) {
          // Extraer el n√∫mero del ID (SOL-XXXXX)
          const lastId = data[0].id;
          const match = lastId.match(/^SOL-(\d+)$/);
          if (match) {
            nextNumber = parseInt(match[1]) + 1;
          }
        }

        // Formatear con 5 d√≠gitos, cero-padded
        return `SOL-${nextNumber.toString().padStart(5, '0')}`;
      } catch (err) {
        console.error('Error al generar ID:', err);
        return 'SOL-00001';
      }
    }

    async function enviarSolicitudFinal() {
      const evento = document.getElementById('sol-evento').value;
      if (!evento) {
        alert("‚ö†Ô∏è Seleccione un evento.");
        return;
      }
      const items = await obtenerItemsParaGuardar();
      if (items.length === 0) {
        alert("‚ö†Ô∏è Agregue al menos un material.");
        return;
      }

      // Validar que no haya c√≥digos duplicados
      const codigos = items.map(item => item.codigo);
      const codigosUnicos = [...new Set(codigos)];
      if (codigos.length !== codigosUnicos.length) {
        // Mostrar interfaz para resolver duplicados
        await mostrarResolucionDuplicados(items);
        return;
      }

      await procesarEnvioSolicitud(items, evento);
    }

    async function mostrarResolucionDuplicados(items) {
      return new Promise((resolve) => {
        // Crear modal para resoluci√≥n de duplicados
        const modal = document.createElement('div');
        modal.style.cssText = `
          position: fixed; top: 0; left: 0; width: 100%; height: 100%;
          background: rgba(0,0,0,0.8); z-index: 10000; display: flex;
          align-items: center; justify-content: center; font-family: Arial, sans-serif;
        `;

        // Encontrar c√≥digos duplicados
        const codigos = items.map(item => item.codigo);
        const duplicadosMap = new Map();

        codigos.forEach((codigo, index) => {
          if (!duplicadosMap.has(codigo)) {
            duplicadosMap.set(codigo, []);
          }
          duplicadosMap.get(codigo).push({ item: items[index], index });
        });

        const codigosDuplicados = Array.from(duplicadosMap.entries())
          .filter(([codigo, ocurrencias]) => ocurrencias.length > 1);

        modal.innerHTML = `
          <div style="background: #1a1a1a; color: white; padding: 24px; border-radius: 12px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
            <h3 style="color: #ff6b6b; margin: 0 0 16px 0; font-size: 18px;">‚ö†Ô∏è C√≥digos Duplicados Detectados</h3>
            <p style="margin: 0 0 20px 0; color: #ccc;">Se encontraron c√≥digos duplicados. Selecciona cu√°l instancia deseas mantener para cada c√≥digo:</p>

            <div id="duplicados-container" style="margin-bottom: 24px;">
              ${codigosDuplicados.map(([codigo, ocurrencias]) => `
                <div style="background: #2a2a2a; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                  <h4 style="color: #4ecdc4; margin: 0 0 12px 0; font-size: 14px;">C√≥digo: ${codigo}</h4>
                  <div style="display: flex; flex-direction: column; gap: 8px;">
                    ${ocurrencias.map((ocurrencia, idx) => `
                      <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 8px; border-radius: 4px; background: #333;">
                        <input type="radio" name="duplicado-${codigo}" value="${ocurrencia.index}" ${idx === 0 ? 'checked' : ''} style="margin: 0;">
                        <div style="flex: 1;">
                          <div style="font-weight: bold; color: #fff;">${ocurrencia.item.nombre || 'Sin nombre'}</div>
                          <div style="font-size: 12px; color: #ccc;">Cantidad: ${ocurrencia.item.cantidad} | Estado: ${ocurrencia.item.estado}</div>
                          ${ocurrencia.item.observacion ? `<div style="font-size: 11px; color: #888;">Obs: ${ocurrencia.item.observacion}</div>` : ''}
                        </div>
                      </label>
                    `).join('')}
                  </div>
                </div>
              `).join('')}
            </div>

            <div style="display: flex; gap: 12px; justify-content: flex-end;">
              <button id="btn-cancelar" style="background: #666; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">Cancelar</button>
              <button id="btn-resolver" style="background: #4ecdc4; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">Resolver Duplicados</button>
            </div>
          </div>
        `;

        document.body.appendChild(modal);

        // Event listeners
        document.getElementById('btn-cancelar').onclick = () => {
          document.body.removeChild(modal);
          resolve(false);
        };

        document.getElementById('btn-resolver').onclick = async () => {
          // Recopilar √≠ndices seleccionados para mantener
          const indicesAMantener = new Set();
          codigosDuplicados.forEach(([codigo]) => {
            const radioSeleccionado = document.querySelector(`input[name="duplicado-${codigo}"]:checked`);
            if (radioSeleccionado) {
              indicesAMantener.add(parseInt(radioSeleccionado.value));
            }
          });

          // Filtrar items manteniendo solo los seleccionados
          const itemsResueltos = items.filter((item, index) => indicesAMantener.has(index));

          document.body.removeChild(modal);

          // Proceder con el env√≠o usando los items resueltos
          const evento = document.getElementById('sol-evento').value;
          await procesarEnvioSolicitud(itemsResueltos, evento);
          resolve(true);
        };
      });
    }

    async function procesarEnvioSolicitud(items, evento) {

      try {
        // Generar ID secuencial para la solicitud
        const idSolicitud = await generarIdSolicitud();

        const responsable = document.getElementById('sol-responsable').value;

        // Insertar solicitud principal
        const { data: solicitud, error: errorSolicitud } = await window.supabaseClient
          .from('solicitudes_logistica')
          .insert({
            id: idSolicitud,
            tipo: "despacho",
            estado: "pendiente_bodega",
            evento: evento,
            encargado_evento: responsable,
            prioridad: "Normal",
            modo_ingreso: estado.modoIngreso,
            fecha_solicitud: new Date().toISOString(),
            usuario_id: window.currentUser?.id
          })
          .select()
          .single();

        if (errorSolicitud) {
          console.error('Error al guardar solicitud:', errorSolicitud);
          alert('‚ùå Error al guardar la solicitud.');
          return;
        }

        // Log de auditor√≠a para solicitud
        await window.logAuditoria('INSERT', 'solicitudes_logistica', idSolicitud, {
          id: idSolicitud,
          tipo: "despacho",
          estado: "pendiente_bodega",
          evento: evento,
          encargado_evento: responsable,
          prioridad: "Normal",
          modo_ingreso: estado.modoIngreso,
          fecha_solicitud: new Date().toISOString(),
          usuario_id: window.currentUser?.id
        });

        // Insertar items de la solicitud
        const itemsParaInsertar = items.map(item => ({
          solicitud_id: idSolicitud,
          codigo_material: item.codigo,
          nombre_material: item.nombre || (getMaterial(item.codigo)?.nom || 'Desconocido'),
          cantidad_solicitada: item.cantidad,
          estado: item.estado,
          observacion: item.observacion,
          medidas: item.medidas,
          color: item.color,
          usuario_id: window.currentUser?.id
        }));

        const { error: errorItems } = await window.supabaseClient
          .from('items_solicitud_logistica')
          .insert(itemsParaInsertar);

        if (errorItems) {
          console.error('Error al guardar items de solicitud:', errorItems);
          alert('‚ùå Error al guardar los items de la solicitud.');
          return;
        }

        // Log de auditor√≠a para items de solicitud
        itemsParaInsertar.forEach(item => {
          window.logAuditoria('INSERT', 'items_solicitud_logistica', null, item);
        });

        alert(`‚úÖ Solicitud ${idSolicitud} enviada a Bodega.`);

        // Reiniciar estado
        estado = { 
          modoIngreso: "receta", 
          recetasSeleccionadas: {
            plantillas: [],
            especificas: []
          },
          materialesEspecificos: [],
          plantillasAdicionales: [],
          itemsPorItem: []
        };
        renderContenidoDinamico();
        document.getElementById('sol-evento').value = "";
        const panel = document.getElementById('panelResumenEvento');
        if (panel) panel.style.display = 'none';

      } catch (err) {
        console.error('Error al enviar solicitud:', err);
        alert('‚ùå Error al enviar la solicitud.');
      }
    }

    // =============================================================================
    // üîπ EVENTOS
    // =============================================================================
    document.getElementById('sol-evento').addEventListener('change', async (e) => {
      await actualizarPanelEvento(e.target.value);
    });

    document.querySelectorAll('.log-tab-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        document.querySelectorAll('.log-tab-btn').forEach(b => b.classList.remove('active'));
        e.currentTarget.classList.add('active');
        estado.modoIngreso = e.currentTarget.dataset.modo;
        renderContenidoDinamico();
      });
    });

    document.getElementById('btn-enviar').addEventListener('click', enviarSolicitudFinal);

    // =============================================================================
    // üîπ SOPORTE PARA EDICI√ìN
    // =============================================================================
    async function cargarSolicitudDesdeURL() {
      const urlParams = new URLSearchParams(window.location.search);
      const editId = urlParams.get('edit');
      if (!editId) return;

      try {
        // Cargar solicitud desde Supabase
        const { data: solicitud, error } = await window.supabaseClient
          .from('solicitudes_logistica')
          .select(`
            id,
            evento,
            encargado_evento,
            modo_ingreso,
            items_solicitud_logistica (
              codigo_material,
              nombre_material,
              cantidad_solicitada,
              observacion,
              medidas,
              color
            )
          `)
          .eq('id', editId)
          .eq('estado', 'pendiente_bodega')
          .single();

        if (error || !solicitud) {
          alert("‚ö†Ô∏è Solicitud no encontrada o ya fue procesada.");
          return;
        }

        document.querySelector('.logistica-container #sol-evento').value = solicitud.evento;
        document.querySelector('.logistica-container #sol-responsable').value = solicitud.encargado_evento || "Carlos M√©ndez";
        await actualizarPanelEvento(solicitud.evento);

        estado = {
          modoIngreso: solicitud.modo_ingreso || "receta",
          recetasSeleccionadas: {
            plantillas: [],
            especificas: []
          },
          materialesEspecificos: [],
          plantillasAdicionales: [],
          itemsPorItem: []
        };

        // Reconstruir el estado desde los items guardados
        solicitud.items_solicitud_logistica.forEach(item => {
          if (item.observacion === "Material adicional (fuera de receta)") {
            estado.materialesEspecificos.push({
              codigo: item.codigo_material,
              nombre: item.nombre_material,
              medidas: item.medidas,
              color: item.color,
              cantidad: item.cantidad_solicitada
            });
          } else if (item.observacion === "Plantilla adicional (fuera de receta)") {
            estado.plantillasAdicionales.push({
              codigo: item.codigo_material,
              nombre: item.nombre_material,
              medidas: item.medidas,
              color: item.color,
              cantidad: item.cantidad_solicitada
            });
          } else {
            // Intentar encontrar la receta correspondiente (primero en plantillas, luego en espec√≠ficas)
            let recetaEncontrada = null;
            let tipoReceta = null;

            // Buscar en recetas de plantillas
            const recetaPlantilla = recetasDisponibles.find(r =>
              r.tipo === 'plantilla' && r.items.some(ri => ri.codigo === item.codigo_material)
            );
            if (recetaPlantilla) {
              recetaEncontrada = recetaPlantilla;
              tipoReceta = 'plantillas';
            } else {
              // Buscar en recetas espec√≠ficas
              const recetaEspecifica = recetasDisponibles.find(r =>
                r.tipo === 'especifica' && r.items.some(ri => ri.codigo === item.codigo_material)
              );
              if (recetaEspecifica) {
                recetaEncontrada = recetaEspecifica;
                tipoReceta = 'especificas';
              }
            }

            if (recetaEncontrada && tipoReceta) {
              const itemReceta = recetaEncontrada.items.find(ri => ri.codigo === item.codigo_material);
              const cantidadRecetas = Math.floor(item.cantidad_solicitada / (itemReceta?.cantidad || 1));
              const existing = estado.recetasSeleccionadas[tipoReceta].find(r => r.receta.nombre === recetaEncontrada.nombre);
              if (existing) {
                existing.cantidadRecetas = Math.max(existing.cantidadRecetas, cantidadRecetas);
              } else {
                estado.recetasSeleccionadas[tipoReceta].push({
                  receta: recetaEncontrada,
                  cantidadRecetas: cantidadRecetas
                });
              }
            } else {
              // Si no es de receta, agregarlo como item individual
              estado.itemsPorItem.push({
                codigo: item.codigo_material,
                nombre: item.nombre_material,
                medidas: item.medidas,
                color: item.color,
                cantidad: item.cantidad_solicitada
              });
            }
          }
        });

        renderContenidoDinamico();
        document.querySelector('.logistica-container .log-tab-btn[data-modo="' + estado.modoIngreso + '"]').click();

      } catch (err) {
        console.error('Error al cargar solicitud:', err);
        alert('‚ùå Error al cargar la solicitud para edici√≥n.');
      }
    }

    // =============================================================================
    // üîπ INICIO
    // =============================================================================
    function poblarFiltrosPlantillas(filtroPrincipal = 'todas', filtroSecundaria = 'todas') {
      // Funci√≥n para poblar filtros de plantillas, con checks para evitar errores
      const selectPrincipal = document.getElementById('filtro-bodega-principal-recetas');
      const selectSecundaria = document.getElementById('filtro-bodega-secundaria-recetas');
      
      if (selectPrincipal) {
        selectPrincipal.innerHTML = '<option value="todas">Todas las Bodegas</option>';
        // Poblar si es necesario
      }
      
      if (selectSecundaria) {
        selectSecundaria.innerHTML = '<option value="todas">Todas las Bodegas</option>';
        // Poblar si es necesario
      }
    }

    async function inicializarModulo() {
      try {
        // Cargar datos desde Supabase
        await cargarEventos();
        await cargarMaterialesCatalogo();
        await cargarPlantillas();
        await cargarRecetas();

        // Actualizar la variable recetasSimuladas para compatibilidad
        recetasSimuladas = recetas;

        // Renderizar interfaz
        cargarEventosEnSelect();
        renderContenidoDinamico();
        await cargarSolicitudDesdeURL();

      } catch (err) {
        console.error('Error al inicializar m√≥dulo:', err);
        alert('‚ùå Error al cargar el m√≥dulo de solicitudes.');
      }
    }

    // Iniciar cuando el DOM est√© listo
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', inicializarModulo);
    } else {
      inicializarModulo();
    }
  })();
</script>