<div style="display: flex; flex-direction: column; gap: 20px; height: 100%;">

  <!-- FILTROS + RESUMEN + EXPORTAR -->
  <div class="bodega-filtros" style="display: flex; align-items: flex-end; gap: 16px; flex-wrap: wrap;">

    <div class="bodega-filtro-grupo">
      <label for="filtro-bodega-principal">Bodega Principal</label>
      <select id="filtro-bodega-principal" class="dashboard-select">
        <option value="todas">Todas</option>
      </select>
    </div>

    <div class="bodega-filtro-grupo">
      <label for="filtro-bodega-secundaria">Bodega Secundaria</label>
      <select id="filtro-bodega-secundaria" class="dashboard-select">
        <option value="todas">Todas</option>
      </select>
    </div>

    <!-- KPIs EN FILA -->
    <div style="display: flex; gap: 12px;">
      <div class="bodega-resumen-card">
        <div>Materiales</div>
        <div class="valor" id="kpi-unicos">‚Äì</div>
      </div>
      <div class="bodega-resumen-card">
        <div>Unidades</div>
        <div class="valor" id="kpi-unidades">‚Äì</div>
      </div>
      <div class="bodega-resumen-card">
        <div>Agotados</div>
        <div class="valor" id="kpi-agotados">‚Äì</div>
      </div>
    </div>

    <button id="btn-exportar-xbodega" class="bodega-export-pdf-btn">
      üìÑ Exportar Inventario
    </button>
    <button id="btn-exportar-xbodega-xlsx" class="bodega-export-pdf-btn" style="margin-left:8px">üìä Exportar Excel</button>
  </div>

  <!-- CONTENEDOR PRINCIPAL CON DOS COLUMNAS -->
  <div style="display: flex; gap: 20px; flex: 1; overflow: hidden;">
    <!-- TABLA DE INVENTARIO -->
    <div style="flex: 2; display: flex; flex-direction: column;">
      <h3 style="color: #cbd5e1; margin-bottom: 10px; font-size: 16px;">üì¶ Inventario Actual</h3>
      <div id="tabla-inventario-bodega" style="flex: 1; overflow: auto; border: 1px solid rgba(99, 102, 241, 0.2); border-radius: 8px; padding: 10px; background: rgba(20, 30, 60, 0.3);"></div>
    </div>

    <!-- MOVIMIENTOS RECIENTES -->
    <div style="flex: 1; display: flex; flex-direction: column;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <h3 style="color: #cbd5e1; font-size: 16px; margin: 0;">üîÑ Actividad Reciente</h3>
        <div style="display: flex; gap: 8px; align-items: center;">
          <button id="btn-refresh-movimientos" style="background: rgba(59, 130, 246, 0.2); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 4px; color: #cbd5e1; padding: 4px 8px; font-size: 11px; cursor: pointer;">‚Üª</button>
          <div style="font-size: 11px; color: #64748b;">
            <span id="movimientos-status">üîÑ Auto-actualizaci√≥n</span>
          </div>
        </div>
      </div>
      <div id="panel-movimientos" style="flex: 1; overflow: auto; border: 1px solid rgba(99, 102, 241, 0.2); border-radius: 8px; padding: 10px; background: rgba(20, 30, 60, 0.3);">
        <div style="text-align: center; color: #888; margin-top: 20px; font-size: 12px;">
          <div>Cargando actividad de bodegas...</div>
          <div style="font-size: 10px; margin-top: 4px; color: #666;">üé• Audiovisual ‚Ä¢ üîß Hierros ‚Ä¢ üõ†Ô∏è Consumibles</div>
        </div>
      </div>
    </div>
  </div>

  <!-- INDICADOR DE ESTADO -->
  <div id="estado-conexion" style="position: absolute; top: 10px; right: 10px; padding: 8px 12px; border-radius: 6px; font-size: 11px; font-weight: bold; z-index: 1000; background: rgba(20, 30, 60, 0.9); border: 1px solid rgba(99, 102, 241, 0.3);">
    <div style="display: flex; align-items: center; gap: 6px;">
      <div id="estado-icono">üîÑ</div>
      <div id="estado-texto">Conectando...</div>
    </div>
    <div id="estado-detalle" style="font-size: 9px; margin-top: 2px; opacity: 0.8;"></div>
  </div>

</div>

<style>
.bodega-resumen-card {
  background: rgba(20, 30, 60, 0.6);
  border: 1px solid rgba(99, 102, 241, 0.2);
  border-radius: 10px;
  padding: 10px 14px;
  min-width: 120px;
  text-align: center;
  color: #cbd5e1;
}

.bodega-resumen-card .valor {
  font-size: 22px;
  font-weight: bold;
  color: #64b5f6;
}

#btn-refresh-movimientos {
  transition: all 0.2s;
}

#btn-refresh-movimientos:hover:not(:disabled) {
  background: rgba(59, 130, 246, 0.4);
  border-color: rgba(59, 130, 246, 0.5);
}

#btn-refresh-movimientos:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}
</style>


<script>
// --- L√≥gica aut√≥noma para xbodega.html ---
(function() {
  const supa = window.supabaseClient;
  if (!supa) {
    console.error('‚ùå Supabase no est√° inicializado (window.supabaseClient).');
  }

  const estado = {
    inventario: [],
    movimientos: [],
    bodegasPrincipales: [],
    bodegasSecundarias: [],
    secundariasPorPrincipal: new Map(),
    autoRefreshInterval: null,
    connectionErrorCount: 0
  };

  // Mostrar color: si viene como hex (#rrggbb) mostrar swatch y nombre aproximado
  function renderColorLabel(raw) {
    const c = (raw || '').toString().trim();
    if (!c) return '';

    // Mapeo simple de hex a nombre (ampliable)
    const colorNames = {
      '#000000': 'Negro',
      '#ffffff': 'Blanco',
      '#0f172a': 'Azul oscuro',
      '#1e40af': 'Azul',
      '#2563eb': 'Azul claro',
      '#16a34a': 'Verde',
      '#dc2626': 'Rojo',
      '#991b1b': 'Burdeos',
      '#94a3b8': 'Gris azulado',
      '#f8fafc': 'Gris claro'
    };

    const isHex = /^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/.test(c);
    const label = isHex ? (colorNames[c.toLowerCase()] || c) : c;

    // Devolver HTML con swatch + etiqueta
    const safeColor = isHex ? c : '#ffffff';
    return `<span style="display:inline-flex;align-items:center;gap:6px;"><span style="width:12px;height:12px;background:${safeColor};border:1px solid rgba(0,0,0,0.12);display:inline-block;border-radius:2px;"></span><span>${label}</span></span>`;
  }

  function normalizarBodega(b) {
    return (b || '').toString().trim();
  }

  async function cargarInventarioDesdeSupabase() {
    if (!supa) return;

    const cont = document.getElementById('tabla-inventario-bodega');
    cont.innerHTML = '<p style="color:#cbd5e1; text-align:center; margin-top: 40px;">Cargando inventario‚Ä¶</p>';

    const [{ data: stockAudioData, error: stockAudioError }, { data: stockHierroData, error: stockHierroError }, { data: stockConsumibleData, error: stockConsumibleError }] = await Promise.all([
      supa
        .from('stock_audiovisual')
        .select('material_codigo, material_nombre, bodega_principal, bodega_secundaria, ubicacion_nombre, stock_actual, existencia, fuera, tipo_material, color'),
      supa
        .from('stock_hierros')
        .select('material_codigo, material_nombre, bodega_principal, bodega_secundaria, ubicacion_nombre, stock_actual, existencia, fuera, tipo_material, color'),
      supa
        .from('stock_consumibles')
        .select('material_codigo, material_nombre, bodega_principal, bodega_secundaria, ubicacion_nombre, stock_actual, existencia, fuera, tipo_material, color'),
    ]);

    // Verificar errores en stock
    if (stockAudioError && stockHierroError && stockConsumibleError) {
      console.error('Error cargando stock:', stockAudioError, stockHierroError, stockConsumibleError);
      cont.innerHTML = `<p style="color:#ef4444; text-align:center; margin-top: 40px;">Error al cargar stock: ${stockAudioError?.message || stockHierroError?.message || stockConsumibleError?.message}</p>`;
      return;
    }

    const inventarioMap = new Map();
    function makeKey(codigo, principal, secundaria) {
      return `${String(codigo || '').trim()}||${normalizarBodega(principal) || 'Principal'}||${normalizarBodega(secundaria) || 'General'}`;
    }

    // Agregar stock de las 3 tablas
    function addStockToMap(data, tipo) {
      (data || []).forEach(s => {
        const key = `${s.material_codigo}||${s.bodega_principal || 'Principal'}||${s.bodega_secundaria || 'General'}||${s.ubicacion_codigo || 'Sin Contenedor'}`;
        inventarioMap.set(key, {
          material_codigo: s.material_codigo,
          material_nombre: s.material_nombre || s.material_codigo,
          bodega_principal: s.bodega_principal || 'Principal',
          bodega_secundaria: s.bodega_secundaria || 'General',
          ubicacion_codigo: s.ubicacion_codigo || 'Sin Contenedor',
          ubicacion_nombre: s.ubicacion_nombre || 'Sin Contenedor',
          stock_actual: Number(s.stock_actual) || 0,
          existencia: Number(s.existencia) || 0,
          fuera: Number(s.fuera) || 0,
          tipo_material: s.tipo_material || '‚Äì',
          color: s.color || '‚Äì',
          tabla_origen: tipo
        });
      });
    }

    addStockToMap(stockAudioData, 'audiovisual');
    addStockToMap(stockHierroData, 'hierros');
    addStockToMap(stockConsumibleData, 'consumibles');

    const inventario = Array.from(inventarioMap.values());

    estado.inventario = inventario;
    estado.bodegasPrincipales = Array.from(new Set(inventario.map(i => i.bodega_principal).filter(Boolean))).sort();
    estado.bodegasSecundarias = Array.from(new Set(inventario.map(i => i.bodega_secundaria).filter(Boolean))).sort();

    // Mapear secundarias por principal
    estado.secundariasPorPrincipal = new Map();
    inventario.forEach(it => {
      const p = (it.bodega_principal || '').toString().trim();
      const s = (it.bodega_secundaria || '').toString().trim();
      if (!p || !s) return;
      const set = estado.secundariasPorPrincipal.get(p) || new Set();
      set.add(s);
      estado.secundariasPorPrincipal.set(p, set);
    });

    poblarSelectBodegaPrincipal(estado.bodegasPrincipales);
    poblarSelectBodegaSecundaria(document.getElementById('filtro-bodega-principal')?.value || 'todas');
  }

  async function cargarMovimientosRecientes() {
    if (!supa) return;

    try {
      // Consultar las 3 tablas de movimientos por separado y combinar
      console.log('Cargando movimientos de las 3 bodegas...');

      const [audioResult, hierroResult, consumibleResult] = await Promise.allSettled([
        supa
          .from('movimientos_bodega_audiovisual')
          .select(`
            id,
            material_codigo,
            material_nombre,
            bodega_principal,
            bodega_secundaria,
            ubicacion_nombre,
            tipo_movimiento,
            cantidad,
            signo,
            referencia_tipo,
            fecha_movimiento,
            observaciones,
            estado,
            created_at
          `)
          .order('created_at', { ascending: false })
          .limit(25),

        supa
          .from('movimientos_bodega_hierros')
          .select(`
            id,
            material_codigo,
            material_nombre,
            bodega_principal,
            bodega_secundaria,
            ubicacion_nombre,
            tipo_movimiento,
            cantidad,
            signo,
            referencia_tipo,
            fecha_movimiento,
            observaciones,
            estado,
            created_at
          `)
          .order('created_at', { ascending: false })
          .limit(25),

        supa
          .from('movimientos_bodega_consumibles')
          .select(`
            id,
            material_codigo,
            material_nombre,
            bodega_principal,
            bodega_secundaria,
            ubicacion_nombre,
            tipo_movimiento,
            cantidad,
            signo,
            referencia_tipo,
            fecha_movimiento,
            observaciones,
            estado,
            created_at
          `)
          .order('created_at', { ascending: false })
          .limit(25)
      ]);

      // Procesar resultados y manejar errores individuales
      const processResult = (result, tipo) => {
        if (result.status === 'fulfilled' && result.value.data) {
          return result.value.data.map(m => ({ ...m, tabla_origen: tipo }));
        } else {
          const error = result.reason || result.value?.error;
          console.warn(`Error cargando movimientos de ${tipo}:`, error);
          // Check for connection errors
          if (error && (error.message?.includes('ERR_CONNECTION_CLOSED') || error.message?.includes('Failed to fetch') || error.code === 'NETWORK_ERROR')) {
            estado.connectionErrorCount++;
            console.warn(`Connection error count: ${estado.connectionErrorCount}`);
            if (estado.connectionErrorCount >= 3) {
              console.warn('Too many connection errors, stopping auto refresh');
              detenerAutoRefresh();
              actualizarIndicadorEstado('error', 'Conexi√≥n perdida', 'Auto-refresh detenido');
            }
          }
          return [];
        }
      };

      const movimientosAudio = processResult(audioResult, 'audiovisual');
      const movimientosHierro = processResult(hierroResult, 'hierros');
      const movimientosConsumible = processResult(consumibleResult, 'consumibles');

      // Combinar y ordenar por fecha (m√°s recientes primero)
      const allMovimientos = [
        ...movimientosAudio,
        ...movimientosHierro,
        ...movimientosConsumible
      ].sort((a, b) => {
        const fechaA = new Date(a.created_at || a.fecha_movimiento || 0);
        const fechaB = new Date(b.created_at || b.fecha_movimiento || 0);
        return fechaB - fechaA;
      });

      estado.movimientos = allMovimientos.slice(0, 50);
      renderizarMovimientos();

      // Actualizar indicador de estado
      actualizarIndicadorEstado('success', 'Conectado', `${allMovimientos.length} movimientos cargados`);

      // Reset connection error count on success
      estado.connectionErrorCount = 0;

    } catch (err) {
      console.error('Error general en cargarMovimientosRecientes:', err);
      document.getElementById('panel-movimientos').innerHTML = `<div style="text-align: center; color: #ef4444;">Error al cargar movimientos</div>`;
      actualizarIndicadorEstado('error', 'Error de conexi√≥n', 'No se pudieron cargar los movimientos');
      // Check for connection errors
      if (err.message?.includes('ERR_CONNECTION_CLOSED') || err.message?.includes('Failed to fetch') || err.code === 'NETWORK_ERROR') {
        estado.connectionErrorCount++;
        console.warn(`Connection error count: ${estado.connectionErrorCount}`);
        if (estado.connectionErrorCount >= 3) {
          detenerAutoRefresh();
          actualizarIndicadorEstado('error', 'Conexi√≥n perdida', 'Auto-refresh detenido');
        }
      }
    }
  }

  // === EXPORTAR INVENTARIO A EXCEL (.xlsx) ===
  function loadXlsxLib(){
    return new Promise((resolve, reject)=>{
      if(window.XLSX) return resolve(window.XLSX);
      const s = document.createElement('script');
      s.src = 'https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js';
      s.onload = ()=> resolve(window.XLSX);
      s.onerror = (e)=> reject(e);
      document.head.appendChild(s);
    });
  }

  async function exportXbodegaExcel(){
    try{
      await loadXlsxLib();
      let inventario = estado.inventario || [];
      if(!inventario.length) return alert('No hay datos de inventario para exportar');

      // Aplicar filtros actuales
      const filtroPrincipal = document.getElementById('filtro-bodega-principal')?.value || 'todas';
      const filtroSecundaria = document.getElementById('filtro-bodega-secundaria')?.value || 'todas';
      if (filtroPrincipal !== 'todas') {
        inventario = inventario.filter(item => item.bodega_principal === filtroPrincipal);
      }
      if (filtroSecundaria !== 'todas') {
        inventario = inventario.filter(item => item.bodega_secundaria === filtroSecundaria);
      }

      // Agrupar por bodega_principal, bodega_secundaria, ubicacion_nombre
      const grouped = {};
      inventario.forEach(item => {
        const pri = item.bodega_principal || 'Sin Principal';
        const sec = item.bodega_secundaria || 'Sin Secundaria';
        const cont = item.ubicacion_nombre || 'Sin Contenedor';
        if (!grouped[pri]) grouped[pri] = {};
        if (!grouped[pri][sec]) grouped[pri][sec] = {};
        if (!grouped[pri][sec][cont]) grouped[pri][sec][cont] = [];
        grouped[pri][sec][cont].push(item);
      });

      const wb = XLSX.utils.book_new();
      let sheetIndex = 0;

      for (const pri in grouped) {
        for (const sec in grouped[pri]) {
          for (const cont in grouped[pri][sec]) {
            const items = grouped[pri][sec][cont];
            const rows = [];

            // Header de secci√≥n
            rows.push({ '': `Bodega Principal: ${pri}` });
            rows.push({ '': `Bodega Secundaria: ${sec}` });
            rows.push({ '': `Contenedor: ${cont}` });
            rows.push({}); // fila vac√≠a

            // Header de tabla
            rows.push({
              'C√≥digo': 'C√≥digo',
              'Nombre': 'Nombre',
              'Tipo Material': 'Tipo Material',
              'Color': 'Color',
              'Contenedor': 'Contenedor',
              'En Bodega': 'En Bodega',
              'Fuera': 'Fuera'
            });

            // Filas de datos
            items.forEach(item => {
              rows.push({
                'C√≥digo': item.material_codigo || '',
                'Nombre': item.material_nombre || '',
                'Tipo Material': item.tipo_material || '',
                'Color': item.color || '',
                'Contenedor': item.ubicacion_nombre || 'Sin Contenedor',
                'En Bodega': item.stock_actual || 0,
                'Fuera': item.fuera || 0
              });
            });

            rows.push({}); // fila vac√≠a al final

            const ws = XLSX.utils.json_to_sheet(rows, { skipHeader: true });
            const sheetName = `${pri.substring(0,5)}_${sec.substring(0,5)}_${cont.substring(0,5)}`.replace(/[^a-zA-Z0-9]/g, '_').substring(0,31);
            XLSX.utils.book_append_sheet(wb, ws, sheetName || `Sheet${sheetIndex++}`);
          }
        }
      }

      const filename = `Inventario_Bodega_${new Date().toISOString().slice(0,10)}.xlsx`;
      XLSX.writeFile(wb, filename);
    }catch(err){
      console.error('Error exportando XLSX xbodega:', err);
      alert('Error exportando Excel. Revisa la consola.');
    }
  }

  // === EXPORTAR INVENTARIO A PDF ===
  async function exportXbodegaPDF(){
    const btn = document.getElementById('btn-exportar-xbodega');
    if (btn) btn.disabled = true; // Deshabilitar bot√≥n durante exportaci√≥n

    // Mapa de colores hex a nombres
    const colorMap = {
      '#94a3b8': 'Sin Color',
      '#000000': 'Negro',
      '#ffffff': 'Blanco',
      '#ef4444': 'Rojo',
      '#b91c1c': 'Rojo Oscuro',
      '#3b82f6': 'Azul',
      '#1e40af': 'Azul Oscuro',
      '#22c55e': 'Verde',
      '#166534': 'Verde Oscuro',
      '#fde047': 'Amarillo',
      '#f97316': 'Naranja',
      '#9ca3af': 'Gris',
      '#4b5563': 'Gris Oscuro',
      '#8b5cf6': 'Violeta',
      '#d946ef': 'Fucsia',
      '#0f172a': 'Azul Oscuro',
      '#ff0000': 'Rojo',
      '#00ff00': 'Verde',
      '#0000ff': 'Azul',
      '#ffff00': 'Amarillo',
      '#ff00ff': 'Magenta',
      '#00ffff': 'Cian',
      '#808080': 'Gris',
      '#eab308': 'Amarillo Dorado',
      '#6366f1': '√çndigo',
      '#64748b': 'Gris Pizarra',
      // Agregar m√°s seg√∫n necesidad
    };

    function getColorName(hex) {
      if (!hex || !hex.startsWith('#')) return hex || '';
      return colorMap[hex.toLowerCase()] || hex;
    }

    try{
      if(!window.jspdf || !window.jspdf.jsPDF) throw new Error('jsPDF no cargado');
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      // Agregar logo
      try {
        const logoImg = new Image();
        logoImg.src = 'assets/logo.png';
        doc.addImage(logoImg, 'PNG', 10, 10, 50, 30); // Ajustar tama√±o para que no se vea contra√≠do
      } catch (e) {
        console.warn('No se pudo cargar el logo:', e);
      }

      let inventario = estado.inventario || [];
      if(!inventario.length) return alert('No hay datos de inventario para exportar');

      // Aplicar filtros actuales
      const filtroPrincipal = document.getElementById('filtro-bodega-principal')?.value || 'todas';
      const filtroSecundaria = document.getElementById('filtro-bodega-secundaria')?.value || 'todas';
      if (filtroPrincipal !== 'todas') {
        inventario = inventario.filter(item => item.bodega_principal === filtroPrincipal);
      }
      if (filtroSecundaria !== 'todas') {
        inventario = inventario.filter(item => item.bodega_secundaria === filtroSecundaria);
      }

      // Header del documento
      doc.setFontSize(18);
      doc.text('Inventario de Bodega', 105, 20, { align: 'center' });
      doc.setFontSize(12);
      doc.text(`Fecha: ${new Date().toLocaleDateString('es-NI')}`, 105, 30, { align: 'center' });
      if (filtroPrincipal !== 'todas') {
        doc.text(`Bodega Principal: ${filtroPrincipal}`, 105, 35, { align: 'center' });
      }
      if (filtroSecundaria !== 'todas') {
        doc.text(`Bodega Secundaria: ${filtroSecundaria}`, 105, 40, { align: 'center' });
      }

      // KPIs del inventario
      let yPosition = 50;
      const pageHeight = doc.internal.pageSize.height;
      const margin = 15; // Mantener margen original para t√≠tulos
      const tableMargin = 6; // Margen a√∫n m√°s reducido para tablas

      // Agrupar por ubicacion_nombre (contenedor)
      const grouped = {};
      inventario.forEach(item => {
        const cont = item.ubicacion_nombre || 'Sin Contenedor';
        if (!grouped[cont]) grouped[cont] = [];
        grouped[cont].push(item);
      });

      doc.setFontSize(14);
      doc.text('Resumen del Inventario:', margin, yPosition);
      yPosition += 6;

      const numContenedores = Object.keys(grouped).length;
      const numMateriales = inventario.length;
      const tiposUnicos = new Set(inventario.map(i => i.tipo_material)).size;

      // Contenedor moderno para KPIs
      const kpiHeight = 15;
      doc.setFillColor(240, 248, 255); // Azul muy claro
      doc.setDrawColor(59, 130, 246); // Azul
      doc.setLineWidth(0.5);
      doc.rect(tableMargin - 3, yPosition - 3, 180, kpiHeight, 'FD'); // Usar tableMargin

      doc.setFontSize(10);
      const kpiText = `Contenedores: ${numContenedores} | Materiales: ${numMateriales} | Tipos de Material: ${tiposUnicos}`;
      doc.setTextColor(0, 0, 0); // Negro
      doc.text(kpiText, tableMargin, yPosition + 5); // Usar tableMargin

      yPosition += kpiHeight + 4;

      // Ordenar contenedores alfab√©ticamente
      const sortedContainers = Object.keys(grouped).sort();

      for (const cont of sortedContainers) {
        const items = grouped[cont].sort((a, b) => a.material_codigo.localeCompare(b.material_codigo)); // Ordenar alfab√©ticamente por c√≥digo

        // T√≠tulo del contenedor
        if (yPosition + 18 > pageHeight - 3) {
          doc.addPage();
          yPosition = 12;
        }
        yPosition += 3; // Espacio en blanco ANTES del t√≠tulo para separarlo de la tabla anterior
        doc.setFontSize(14);
        doc.text(`Contenedor: ${cont}`, tableMargin, yPosition);
        yPosition += 2; // Espacio reducido DESPU√âS del t√≠tulo

        // Preparar datos para la tabla
        const tableData = items.map(item => [
          item.material_codigo || '',
          item.material_nombre || '',
          item.tipo_material || '',
          getColorName(item.color) || '',
          item.existencia || 0, // Agregar Existencia Total
          item.stock_actual || 0,
          item.fuera || 0
        ]);

        // Agregar tabla con autoTable
        doc.autoTable({
          startY: yPosition,
          head: [['C√≥digo', 'Nombre', 'Tipo Material', 'Color', 'Existencia Total', 'En Bodega', 'Fuera']],
          body: tableData,
          tableWidth: 'auto', // Ocupar todo el ancho disponible
          margin: { 
            top: tableMargin, 
            left: tableMargin, 
            right: tableMargin + 4, // Margen derecho mayor para evitar desbordamiento
            bottom: tableMargin + 2 // Margen inferior reducido por pie de p√°gina cercano
          },
          styles: { fontSize: 5, cellPadding: 0.5 }, // Fuente a√∫n m√°s peque√±a y padding m√≠nimo
          headStyles: { fillColor: [59, 130, 246], fontSize: 6 },
          alternateRowStyles: { fillColor: [245, 245, 245] },
          columnStyles: {
            0: { cellWidth: 45 }, // C√≥digo - aumentado para c√≥digos m√°s largos
            1: { cellWidth: 58 }, // Nombre - reducido para dar m√°s espacio al c√≥digo
            2: { cellWidth: 25 }, // Tipo Material
            3: { cellWidth: 20 }, // Color
            4: { cellWidth: 18 }, // Existencia Total
            5: { cellWidth: 16 }, // En Bodega
            6: { cellWidth: 14 }  // Fuera
          },
          didDrawPage: (data) => {
            yPosition = data.cursor.y + 1; // Espacio m√≠nimo entre p√°ginas, ajustado por pie cercano
          }
        });

        yPosition = doc.lastAutoTable.finalY + 1; // Espacio m√≠nimo despu√©s de tabla

        // Espacio m√≠nimo entre contenedores
        if (yPosition + 13 > pageHeight - 3) {
          doc.addPage();
          yPosition = 12;
        } else {
          yPosition += 1; // Espacio m√≠nimo entre contenedores
        }
      }

      // Footer
      const pageCount = doc.internal.getNumberOfPages();
      for (let i = 1; i <= pageCount; i++) {
        doc.setPage(i);
        doc.setFontSize(8);
        doc.text(`P√°gina ${i} de ${pageCount}`, 105, pageHeight - 1.5, { align: 'center' });
      }

      const filename = `Inventario_Bodega_${new Date().toISOString().slice(0,10)}.pdf`;
      doc.save(filename);
    }catch(err){
      console.error('Error exportando PDF xbodega:', err);
      alert('Error exportando PDF. Revisa la consola.');
    } finally {
      const btn = document.getElementById('btn-exportar-xbodega');
      if (btn) btn.disabled = false; // Rehabilitar bot√≥n
    }
  }

  document.getElementById('btn-exportar-xbodega')?.addEventListener('click', exportXbodegaPDF);

  function renderizarMovimientos() {
    const container = document.getElementById('panel-movimientos');
    if (!container) return;

    if (!estado.movimientos || estado.movimientos.length === 0) {
      container.innerHTML = `<div style="text-align: center; color: #888; margin-top: 20px;">No hay movimientos recientes</div>`;
      return;
    }

    let html = '<div style="display: flex; flex-direction: column; gap: 6px; max-height: 100%; overflow-y: auto;">';

    estado.movimientos.slice(0, 20).forEach(mov => { // Mostrar solo los 20 m√°s recientes
      const fecha = new Date(mov.created_at || mov.fecha_movimiento).toLocaleString('es-NI', {
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });

      const tipoIcon = mov.tipo_movimiento === 'ingreso' ? 'üì•' : 'üì§';
      const tipoColor = mov.tipo_movimiento === 'ingreso' ? '#4ade80' : '#f87171';
      const cantidadDisplay = `${mov.signo > 0 ? '+' : ''}${mov.cantidad}`;

      const referencia = mov.referencia_tipo ? ` ‚Ä¢ ${mov.referencia_tipo.replace(/_/g, ' ')}` : '';
      const ubicacion = mov.ubicacion_nombre ? ` ‚Üí ${mov.ubicacion_nombre}` : '';

      // Indicador de tipo de bodega
      const bodegaIcon = mov.tabla_origen === 'audiovisual' ? 'üé•' :
                        mov.tabla_origen === 'hierros' ? 'üîß' :
                        mov.tabla_origen === 'consumibles' ? 'üõ†Ô∏è' : 'üì¶';
      const bodegaLabel = mov.tabla_origen === 'audiovisual' ? 'Audio' :
                         mov.tabla_origen === 'hierros' ? 'Hierros' :
                         mov.tabla_origen === 'consumibles' ? 'Consumibles' : 'Gen√©rico';

      html += `
        <div style="background: rgba(30, 40, 70, 0.5); border: 1px solid rgba(99, 102, 241, 0.1); border-radius: 6px; padding: 8px; font-size: 12px; transition: background-color 0.2s;">
          <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 4px;">
            <div style="flex: 1; min-width: 0;">
              <div style="font-weight: bold; color: #cbd5e1; font-size: 11px; word-break: break-all;">${mov.material_codigo}</div>
              <div style="color: #94a3b8; font-size: 10px; margin-top: 2px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${mov.material_nombre || 'Sin nombre'}</div>
            </div>
            <div style="text-align: right; margin-left: 8px;">
              <div style="color: ${tipoColor}; font-weight: bold; font-size: 13px;">${tipoIcon} ${cantidadDisplay}</div>
              <div style="color: #64748b; font-size: 9px;">${fecha}</div>
            </div>
          </div>
          <div style="color: #64748b; font-size: 10px; margin-top: 4px;">
            <span style="color: #475569;">${bodegaIcon} ${bodegaLabel}</span> ‚Ä¢
            <span style="color: #64748b;">${mov.bodega_secundaria || mov.bodega_principal || 'Bodega'}</span>${ubicacion}${referencia}
          </div>
        </div>
      `;
    });

    html += '</div>';
    container.innerHTML = html;
  }

  function iniciarAutoRefresh() {
    // Reset connection error count
    estado.connectionErrorCount = 0;
    // Actualizar movimientos cada 30 segundos
    estado.autoRefreshInterval = setInterval(async () => {
      actualizarIndicadorEstado('loading', 'Actualizando...', 'Sincronizando bodegas');
      await cargarMovimientosRecientes();
    }, 30000);
  }

  function detenerAutoRefresh() {
    if (estado.autoRefreshInterval) {
      clearInterval(estado.autoRefreshInterval);
      estado.autoRefreshInterval = null;
    }
  }

  function actualizarIndicadorEstado(tipo, texto, detalle = '') {
    const contenedor = document.getElementById('estado-conexion');
    const icono = document.getElementById('estado-icono');
    const textoEl = document.getElementById('estado-texto');
    const detalleEl = document.getElementById('estado-detalle');

    if (!contenedor || !icono || !textoEl) return;

    // Configurar colores y iconos seg√∫n el tipo
    let color, icon;
    switch (tipo) {
      case 'success':
        color = 'rgba(34, 197, 94, 0.2)';
        icon = '‚úÖ';
        break;
      case 'error':
        color = 'rgba(239, 68, 68, 0.2)';
        icon = '‚ùå';
        break;
      case 'warning':
        color = 'rgba(251, 191, 36, 0.2)';
        icon = '‚ö†Ô∏è';
        break;
      case 'loading':
      default:
        color = 'rgba(59, 130, 246, 0.2)';
        icon = 'üîÑ';
        break;
    }

    contenedor.style.background = color;
    contenedor.style.borderColor = tipo === 'success' ? 'rgba(34, 197, 94, 0.3)' :
                                  tipo === 'error' ? 'rgba(239, 68, 68, 0.3)' :
                                  tipo === 'warning' ? 'rgba(251, 191, 36, 0.3)' :
                                  'rgba(59, 130, 246, 0.3)';

    icono.textContent = icon;
    textoEl.textContent = texto;

    if (detalleEl) {
      detalleEl.textContent = detalle;
      detalleEl.style.display = detalle ? 'block' : 'none';
    }
  }

  function poblarSelectBodegaPrincipal(principales = []) {
    const select = document.getElementById('filtro-bodega-principal');
    if (!select) return;
    const actual = select.value || 'todas';

    const opciones = ['<option value="todas">Todas</option>'];
    principales.forEach(b => {
      const safe = String(b).replace(/"/g, '&quot;');
      opciones.push(`<option value="${safe}">${safe}</option>`);
    });

    select.innerHTML = opciones.join('');
    const disponibles = new Set(['todas', ...principales]);
    select.value = disponibles.has(actual) ? actual : 'todas';
  }

  function poblarSelectBodegaSecundaria(principalSeleccionada) {
    const select = document.getElementById('filtro-bodega-secundaria');
    if (!select) return;
    const actual = select.value || 'todas';

    let secundarias = [];
    if ((principalSeleccionada || 'todas') === 'todas') {
      secundarias = estado.bodegasSecundarias || [];
    } else {
      const set = estado.secundariasPorPrincipal.get(principalSeleccionada) || new Set();
      secundarias = Array.from(set).sort();
    }

    const opciones = ['<option value="todas">Todas</option>'];
    secundarias.forEach(b => {
      const safe = String(b).replace(/"/g, '&quot;');
      opciones.push(`<option value="${safe}">${safe}</option>`);
    });

    select.innerHTML = opciones.join('');
    const disponibles = new Set(['todas', ...secundarias]);
    select.value = disponibles.has(actual) ? actual : 'todas';
  }

  function renderizarTabla(bodegaPrincipalFiltro, bodegaSecundariaFiltro) {
    let itemsFiltrados = [...(estado.inventario || [])];

    if ((bodegaPrincipalFiltro || 'todas') !== 'todas') {
      itemsFiltrados = itemsFiltrados.filter(item => item.bodega_principal === bodegaPrincipalFiltro);
    }
    if ((bodegaSecundariaFiltro || 'todas') !== 'todas') {
      itemsFiltrados = itemsFiltrados.filter(item => item.bodega_secundaria === bodegaSecundariaFiltro);
    }

    // Agregar per material
    const materialMap = new Map();
    itemsFiltrados.forEach(item => {
      const codigo = item.material_codigo;
      if (!materialMap.has(codigo)) {
        materialMap.set(codigo, {
          codigo,
          nombre: item.material_nombre,
          tipo: item.tipo_material,
          color: item.color,
          existencia: item.existencia,
          contenedor: item.ubicacion_nombre || 'Sin Contenedor',
          en_bodega: 0,
          fuera: 0,
          tabla_origen: item.tabla_origen
        });
      }
      materialMap.get(codigo).en_bodega += item.stock_actual;
      materialMap.get(codigo).fuera += item.fuera;
    });

    const materiales = Array.from(materialMap.values()).sort((a, b) => a.codigo.localeCompare(b.codigo));

    let totalUnidades = 0, agotados = 0;
    let filas = '';

    materiales.forEach(item => {
      const totalExistencia = Number(item.existencia) || 0;
      totalUnidades += totalExistencia;
      if (totalExistencia <= 0) agotados++;
      filas += `
        <tr>
          <td>${item.codigo}</td>
          <td>${item.nombre}</td>
          <td>${item.tipo}</td>
          <td>${renderColorLabel(item.color)}</td>
          <td>${item.contenedor}</td>
          <td>${totalExistencia}</td>
          <td>${item.en_bodega}</td>
          <td>${item.fuera}</td>
        </tr>
      `;
    });

    document.getElementById('kpi-unicos').textContent = materiales.length;
    document.getElementById('kpi-unidades').textContent = totalUnidades;
    document.getElementById('kpi-agotados').textContent = agotados;

    document.getElementById('tabla-inventario-bodega').innerHTML = `
      <table class="bodega-table">
        <thead>
          <tr>
            <th>C√≥digo</th>
            <th>Nombre</th>
            <th>Tipo</th>
            <th>Color</th>
            <th>Contenedor</th>
            <th>Existencia Total</th>
            <th>En Bodega</th>
            <th>Fuera</th>
          </tr>
        </thead>
        <tbody>
          ${filas || '<tr><td colspan="8" style="text-align:center;color:#aaa;">No hay materiales</td></tr>'}
        </tbody>
      </table>
    `;
  }

  // === INICIALIZAR ===
  (async function init() {
    actualizarIndicadorEstado('loading', 'Cargando datos...', 'Conectando a bodegas');

    await Promise.all([
      cargarInventarioDesdeSupabase(),
      cargarMovimientosRecientes()
    ]);

    renderizarTabla(
      document.getElementById('filtro-bodega-principal')?.value || 'todas',
      document.getElementById('filtro-bodega-secundaria')?.value || 'todas'
    );

    // Iniciar actualizaci√≥n autom√°tica de movimientos
    iniciarAutoRefresh();
  })();

  // === EVENTOS ===
  document.getElementById('filtro-bodega-principal').addEventListener('change', (e) => {
    const principal = e.target.value;
    poblarSelectBodegaSecundaria(principal);
    renderizarTabla(principal, document.getElementById('filtro-bodega-secundaria')?.value || 'todas');
  });

  document.getElementById('filtro-bodega-secundaria').addEventListener('change', (e) => {
    renderizarTabla(
      document.getElementById('filtro-bodega-principal')?.value || 'todas',
      e.target.value
    );
  });

  // Detener auto-refresh cuando se cierre la p√°gina
  window.addEventListener('beforeunload', () => {
    detenerAutoRefresh();
  });

  // Tambi√©n detener cuando se cambie de vista (si hay navegaci√≥n)
  document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
      detenerAutoRefresh();
    } else {
      // Re-iniciar si vuelve a ser visible
      if (!estado.autoRefreshInterval) {
        iniciarAutoRefresh();
      }
    }
  });

  // Bot√≥n de refresh manual
  document.getElementById('btn-refresh-movimientos').addEventListener('click', async () => {
    const btn = document.getElementById('btn-refresh-movimientos');
    const originalText = btn.textContent;
    btn.textContent = '‚ü≥';
    btn.disabled = true;

    actualizarIndicadorEstado('loading', 'Actualizando...', 'Refresco manual');
    await cargarMovimientosRecientes();

    btn.textContent = originalText;
    btn.disabled = false;
  });

  document.getElementById('btn-exportar-xbodega').addEventListener('click', async () => {
    const selectPrincipal = document.getElementById('filtro-bodega-principal');
    const selectSecundaria = document.getElementById('filtro-bodega-secundaria');
    const valorPrincipal = selectPrincipal?.value || 'todas';
    const valorSecundaria = selectSecundaria?.value || 'todas';
    const textoPrincipal = selectPrincipal?.selectedOptions?.[0]?.text || 'Todas';
    const textoSecundaria = selectSecundaria?.selectedOptions?.[0]?.text || 'Todas';
    const fecha = new Date().toLocaleDateString('es-NI');

    let inventario = estado.inventario || [];
    if(!inventario.length) return alert('No hay datos de inventario para exportar');

    // Aplicar filtros
    if (valorPrincipal !== 'todas') {
      inventario = inventario.filter(item => item.bodega_principal === valorPrincipal);
    }
    if (valorSecundaria !== 'todas') {
      inventario = inventario.filter(item => item.bodega_secundaria === valorSecundaria);
    }

    // Agrupar por bodega_secundaria, luego por ubicacion_codigo
    const grouped = {};
    inventario.forEach(item => {
      const sec = item.bodega_secundaria || 'Sin Bodega Secundaria';
      const cont = item.ubicacion_codigo || 'Sin Contenedor';
      if (!grouped[sec]) grouped[sec] = {};
      if (!grouped[sec][cont]) grouped[sec][cont] = [];
      grouped[sec][cont].push(item);
    });

    let contenido = '';
    for (const sec in grouped) {
      contenido += `<div class="grupo-bodega">Bodega Secundaria: ${sec}</div>`;
      for (const cont in grouped[sec]) {
        contenido += `<div style="margin:10px 0 5px; font-size:12px; color:#374151; border-left:3px solid #6b7280; padding-left:6px;">Contenedor: ${cont}</div>`;
        const items = grouped[sec][cont];
        let filas = '';
        items.forEach(item => {
          filas += `
            <tr>
              <td>${item.material_codigo}</td>
              <td>${item.material_nombre}</td>
              <td>${item.tipo_material}</td>
              <td>${item.color}</td>
              <td style="text-align:center;">${item.stock_actual}</td>
              <td style="text-align:center;">${item.fuera}</td>
            </tr>
          `;
        });
        contenido += `
          <table>
            <thead>
              <tr>
                <th>C√≥digo</th>
                <th>Nombre</th>
                <th>Tipo Material</th>
                <th>Color</th>
                <th>En Bodega</th>
                <th>Fuera</th>
              </tr>
            </thead>
            <tbody>${filas}</tbody>
          </table>
        `;
      }
    }

    const html = `
    <style>
      body { font-family: Arial, sans-serif; color:#1f2937; margin-bottom:70px; }
      .header { text-align:center; border-bottom:2px solid #2563eb; padding-bottom:8px; margin-bottom:18px; }
      .header h1 { margin:0; font-size:18px; color:#1e3a8a; }
      .header p { margin:4px 0 0; font-size:11px; color:#555; }
      .grupo-bodega { margin:22px 0 8px; font-size:14px; color:#1e40af; border-left:4px solid #2563eb; padding-left:8px; page-break-inside: avoid; }
      table { width:100%; border-collapse:collapse; font-size:10.5px; margin-bottom:18px; }
      thead th { background:#2563eb; color:#fff; padding:6px; text-align:left; }
      tbody td { padding:5px 6px; border-bottom:1px solid #e5e7eb; }
      tbody tr:nth-child(even) { background:#f8fafc; }
      .ok { color:#166534; font-weight:bold; }
      .bad { color:#991b1b; font-weight:bold; }
      .footer { position: fixed; bottom: 0; left: 0; right: 0; font-size:10px; color:#555; text-align:center; border-top:1px solid #e5e7eb; padding:6px 0; background:#fff; }
    </style>

    <div>
      <div class="header">
        <img src="assets/logo.png" style="height:48px;margin-bottom:4px;">
        <h1>Inventario por Bodega y Contenedor</h1>
        <p>Filtros: ${valorPrincipal === 'todas' && valorSecundaria === 'todas' ? 'Todas las bodegas' : valorPrincipal !== 'todas' && valorSecundaria === 'todas' ? `Bodega Principal: ${textoPrincipal}` : valorPrincipal === 'todas' && valorSecundaria !== 'todas' ? `Bodega Secundaria: ${textoSecundaria}` : `Bodega Principal: ${textoPrincipal} ‚Ä¢ Secundaria: ${textoSecundaria}`} | Fecha: ${fecha}</p>
      </div>

      ${contenido}

      <div class="footer">Absolute de Nicaragua ¬∑ Inventario generado autom√°ticamente</div>
    </div>
    `;

    // Generar PDF nativo via Electron (preserva texto y carga im√°genes relativas)
    try {
      const filename = `Inventario_${
        valorPrincipal === 'todas' && valorSecundaria === 'todas'
          ? 'General'
          : valorPrincipal !== 'todas' && valorSecundaria === 'todas'
            ? textoPrincipal.replace(/ /g,'_')
            : valorPrincipal === 'todas' && valorSecundaria !== 'todas'
              ? textoSecundaria.replace(/ /g,'_')
              : (textoPrincipal + '_' + textoSecundaria).replace(/ /g,'_')
      }.pdf`;

      // Envolver en documento HTML completo y pasar baseUrl para resolver rutas relativas
      const fullHtml = `<!doctype html><html><head><meta charset="utf-8"></head><body>${html}</body></html>`;
      const result = await window.electronAPI.renderHtmlToPdf({ filename, html: fullHtml, baseUrl: document.baseURI });
      if (result && result.canceled === false) {
        alert('PDF guardado en: ' + result.filePath);
      } else {
        console.log('Generaci√≥n de PDF cancelada o no completada', result);
      }
    } catch (err) {
      console.error('Error generando PDF nativo:', err);
      alert('Error al generar PDF nativo. Revisa la consola para m√°s detalles.');
    }
  });



  // === NAVEGACI√ìN R√ÅPIDA ===
  document.querySelectorAll('.bodega-nav-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const eventoFake = { target: { dataset: { vista: btn.dataset.vista } } };
      if (typeof manejarClicVista === 'function') {
        manejarClicVista(eventoFake);
      } else {
        console.warn('manejarClicVista no est√° disponible');
      }
    });
  });

  // Detener auto-refresh cuando la ventana se cierre
  window.addEventListener('beforeunload', detenerAutoRefresh);
})();
</script>
