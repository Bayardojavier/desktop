<!-- listareventos.html (fragmento para cargar en ventas) -->

<div class="ventas-area-dinamica">

  <!-- T√çTULO -->
  <div style="margin-bottom: 20px; padding-bottom: 12px; border-bottom: 2px solid var(--accent);">
    <h2 style="font-size: 18pt; margin: 0; color: #1e1e1e; display: flex; align-items: center; gap: 8px;">
      <span>üìã</span>
      Lista de Eventos
    </h2>
    <p style="color: #4a5568; font-size: 13px; margin-top: 6px;">
      Gestiona los eventos creados desde cotizaciones.
    </p>
  </div>

  <!-- BOT√ìN CREAR NUEVO EVENTO -->
  <div style="margin-bottom: 20px;">
    <button id="btn-nuevo-evento" class="ventas-btn-guardar" style="padding: 10px 16px;">
      ‚ûï Crear Nuevo Evento
    </button>
  </div>

  <!-- CONTENEDOR PRINCIPAL CON SIDEBAR -->
  <div style="display: flex; gap: 20px;">
    <!-- LISTA DE EVENTOS (IZQUIERDA) -->
    <div id="contenedor-lista" style="flex: 1;">
      <div id="lista-eventos" style="display: block;">
        <!-- Los eventos se cargar√°n aqu√≠ -->
      </div>
    </div>

    <!-- PANEL DE DETALLES (DERECHA) -->
    <div id="panel-detalles" style="width: 400px; background: var(--panel-bg); border: 1px solid var(--border); border-radius: 8px; padding: 20px; display: none; position: sticky; top: 20px; height: fit-content; color: var(--panel-text);">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
        <h3 style="margin: 0; color: var(--accent); font-size: 16px;">Detalles del Evento</h3>
        <button id="btn-cerrar-panel" style="background: none; border: none; color: var(--panel-text); font-size: 18px; cursor: pointer;">‚úï</button>
      </div>
      <div id="contenido-detalles">
        <!-- Detalles se cargar√°n aqu√≠ -->
      </div>
    </div>
  </div>

  <!-- MODAL PARA EDITAR EVENTO -->
  <div id="modal-editar-evento" class="ventas-modal-overlay" style="display: none;">
    <div class="ventas-modal-content">
      <div class="ventas-modal-header">
        <h3 class="ventas-modal-title">Editar Evento</h3>
        <button id="btn-cerrar-modal-editar" class="ventas-modal-close">‚úï</button>
      </div>
      <div class="ventas-modal-body">
        <form id="form-editar-evento">
          <input type="hidden" id="edit-evento-id">

          <div style="margin-bottom: 16px;">
            <label style="font-size: 12px; margin-bottom: 4px; display: block; color: var(--panel-text);">* Nombre del Evento</label>
            <input type="text" id="edit-nombre" class="ventas-input" required>
          </div>

          <div style="margin-bottom: 16px;">
            <label style="font-size: 12px; margin-bottom: 4px; display: block; color: var(--panel-text);">Cliente</label>
            <input type="text" id="edit-cliente" class="ventas-input" readonly>
          </div>

          <div style="margin-bottom: 16px;">
            <label style="font-size: 12px; margin-bottom: 4px; display: block; color: var(--panel-text);">* Lugar del Evento</label>
            <input type="text" id="edit-lugar" class="ventas-input" required>
          </div>

          <div style="margin-bottom: 16px;">
            <label style="font-size: 12px; margin-bottom: 4px; display: block; color: var(--panel-text);">Contacto del Evento</label>
            <input type="text" id="edit-contacto" class="ventas-input">
          </div>

          <div style="margin-bottom: 16px;">
            <label style="font-size: 12px; margin-bottom: 4px; display: block; color: var(--panel-text);">Tel√©fono del Evento</label>
            <input type="text" id="edit-telefono" class="ventas-input">
          </div>

          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 16px; margin-bottom: 16px;">
            <div>
              <label style="font-size: 12px; margin-bottom: 4px; display: block; color: var(--panel-text);">* Fecha Montaje</label>
              <input type="date" id="edit-fecha-montaje" class="ventas-input" required>
            </div>
            <div>
              <label style="font-size: 12px; margin-bottom: 4px; display: block; color: var(--panel-text);">* Hora Montaje</label>
              <input type="time" id="edit-hora-montaje" class="ventas-input" required>
            </div>
            <div>
              <label style="font-size: 12px; margin-bottom: 4px; display: block; color: var(--panel-text);">Fecha Desmontaje</label>
              <input type="date" id="edit-fecha-desmontaje" class="ventas-input">
            </div>
            <div>
              <label style="font-size: 12px; margin-bottom: 4px; display: block; color: var(--panel-text);">Hora Desmontaje</label>
              <input type="time" id="edit-hora-desmontaje" class="ventas-input">
            </div>
          </div>

          <div style="margin-bottom: 16px;">
            <label style="font-size: 12px; margin-bottom: 4px; display: block; color: var(--panel-text);">Estado</label>
            <select id="edit-estado" class="ventas-input">
              <option value="activo">Activo</option>
              <option value="completado">Completado</option>
              <option value="cancelado">Cancelado</option>
            </select>
          </div>

          <div style="display: flex; gap: 12px; justify-content: flex-end;">
            <button type="button" id="btn-cancelar-editar" class="ventas-btn-nav">Cancelar</button>
            <button type="submit" class="ventas-btn-guardar">üíæ Guardar Cambios</button>
          </div>
        </form>
      </div>
    </div>
  </div>

</div>

<script>
  // =============================================================================
  // üîπ CARGAR EVENTOS DESDE SUPABASE
  // =============================================================================
  async function cargarEventos() {
    const contenedor = document.getElementById('lista-eventos');

    try {
      const { data: eventos, error } = await window.supabaseClient
        .from('eventos')
        .select('*')
        .order('fecha_montaje', { ascending: false });

      if (error) {
        console.error('Error al cargar eventos:', error);
        contenedor.innerHTML = `
          <div style="padding: 20px; text-align: center; color: #ef4444;">
            Error al cargar eventos: ${error.message}
          </div>
        `;
        return;
      }

      if (!eventos || eventos.length === 0) {
        contenedor.innerHTML = `
          <div style="padding: 20px; text-align: center; color: #64748b;">
            No hay eventos registrados.
          </div>
        `;
        return;
      }

      contenedor.innerHTML = eventos.map(evento => {
        const fechaMontaje = evento.fecha_montaje ? new Date(evento.fecha_montaje).toLocaleDateString('es-ES') : '‚Äî';
        const horaMontaje = evento.hora_montaje || '‚Äî';
        const estadoColor = evento.estado === 'activo' ? '#10b981' : evento.estado === 'completado' ? '#3b82f6' : '#ef4444';
        const estadoTexto = evento.estado === 'activo' ? 'Activo' : evento.estado === 'completado' ? 'Completado' : 'Cancelado';

        return `
          <div style="background: var(--panel-bg); padding: 16px; border-radius: 8px; margin-bottom: 12px; border: 1px solid var(--border);">
            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
              <div>
                <h3 style="margin: 0; color: var(--accent); font-size: 14pt;">${evento.nombre}</h3>
                <p style="color: var(--panel-text); margin: 6px 0 0 0; font-size: 12px;">
                  Cliente: ${evento.cliente || '‚Äî'}<br>
                  Lugar: ${evento.lugar || '‚Äî'}<br>
                  Fecha: ${fechaMontaje} ${horaMontaje}
                </p>
                <span style="background: ${estadoColor}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; margin-top: 4px; display: inline-block;">
                  ${estadoTexto}
                </span>
              </div>
              <div style="display: flex; gap: 8px;">
                <button data-id="${evento.id}" class="ventas-btn-nav btn-ver" style="padding: 6px 12px; font-size: 12px;">
                  üëÅÔ∏è Ver
                </button>
                <button data-id="${evento.id}" class="ventas-btn-guardar btn-editar" style="padding: 6px 12px; font-size: 12px;">
                  ‚úèÔ∏è Editar
                </button>
                <button data-id="${evento.id}" class="ventas-btn-eliminar btn-eliminar" style="padding: 6px 12px; font-size: 12px;">
                  üóëÔ∏è Eliminar
                </button>
              </div>
            </div>
          </div>
        `;
      }).join('');

      // Eventos para botones
      contenedor.querySelectorAll('.btn-ver').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const id = e.currentTarget.dataset.id;
          verEvento(id);
        });
      });

      contenedor.querySelectorAll('.btn-editar').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const id = e.currentTarget.dataset.id;
          editarEvento(id);
        });
      });

      contenedor.querySelectorAll('.btn-eliminar').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const id = e.currentTarget.dataset.id;
          eliminarEvento(id);
        });
      });

    } catch (err) {
      console.error('Error:', err);
      contenedor.innerHTML = `
        <div style="padding: 20px; text-align: center; color: #ef4444;">
          Error al cargar eventos.
        </div>
      `;
    }
  }

  // =============================================================================
  // üîπ VER DETALLES DEL EVENTO
  // =============================================================================
  async function verEvento(id) {
    try {
      const { data: evento, error } = await window.supabaseClient
        .from('eventos')
        .select('*')
        .eq('id', id)
        .single();

      if (error || !evento) {
        alert("‚ùå Evento no encontrado.");
        return;
      }

      // Obtener servicios con cantidades desde la cotizaci√≥n
      let serviciosTexto = 'Sin servicios';
      if (evento.cotizacion_id) {
        try {
          const { data: cotizacion, error: cotError } = await window.supabaseClient
            .from('cotizaciones')
            .select('servicios')
            .eq('id', evento.cotizacion_id)
            .single();

          if (!cotError && cotizacion?.servicios && cotizacion.servicios.length > 0) {
            serviciosTexto = cotizacion.servicios.map(s => {
              const cantidad = s.cantidad || 1;
              const nombre = s.nombre || 'Servicio sin nombre';
              return `${cantidad} ${nombre}`;
            }).join(', ');
          }
        } catch (cotErr) {
          console.warn('Error al cargar servicios de cotizaci√≥n:', cotErr);
          // Fallback a la descripci√≥n guardada en el evento
          serviciosTexto = evento.descripcion && evento.descripcion.length > 0 ? evento.descripcion.join(', ') : 'Sin servicios';
        }
      } else {
        // Fallback a la descripci√≥n guardada en el evento
        serviciosTexto = evento.descripcion && evento.descripcion.length > 0 ? evento.descripcion.join(', ') : 'Sin servicios';
      }

      const detalles = document.getElementById('contenido-detalles');
      detalles.innerHTML = `
        <div style="font-size: 14px;">
          <h4 style="margin: 0 0 16px 0; color: var(--accent); font-size: 18px;">${evento.nombre}</h4>
          <div style="display: grid; grid-template-columns: 1fr; gap: 12px;">
            <div>
              <strong style="color: var(--accent);">Cliente:</strong><br>
              <span>${evento.cliente || '‚Äî'}</span>
            </div>
            <div>
              <strong style="color: var(--accent);">Lugar:</strong><br>
              <span>${evento.lugar || '‚Äî'}</span>
            </div>
            <div>
              <strong style="color: var(--accent);">Contacto:</strong><br>
              <span>${evento.contacto_evento || '‚Äî'}</span>
            </div>
            <div>
              <strong style="color: var(--accent);">Tel√©fono:</strong><br>
              <span>${evento.telefono_evento || '‚Äî'}</span>
            </div>
            <div>
              <strong style="color: var(--accent);">Fecha Montaje:</strong><br>
              <span>${evento.fecha_montaje ? new Date(evento.fecha_montaje).toLocaleDateString('es-ES') : '‚Äî'} ${evento.hora_montaje || ''}</span>
            </div>
            <div>
              <strong style="color: var(--accent);">Fecha Desmontaje:</strong><br>
              <span>${evento.fecha_desmontaje ? new Date(evento.fecha_desmontaje).toLocaleDateString('es-ES') : '‚Äî'} ${evento.hora_desmontaje || ''}</span>
            </div>
            <div>
              <strong style="color: var(--accent);">Estado:</strong><br>
              <span style="background: ${evento.estado === 'activo' ? '#10b981' : evento.estado === 'completado' ? '#3b82f6' : '#ef4444'}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px;">
                ${evento.estado === 'activo' ? 'Activo' : evento.estado === 'completado' ? 'Completado' : 'Cancelado'}
              </span>
            </div>
            <div>
              <strong style="color: var(--accent);">Servicios:</strong><br>
              <span>${serviciosTexto}</span>
            </div>
            <div>
              <strong style="color: var(--accent);">ID Cotizaci√≥n:</strong><br>
              <span>${evento.cotizacion_id || '‚Äî'}</span>
            </div>
          </div>
        </div>
      `;

      document.getElementById('panel-detalles').style.display = 'block';

    } catch (err) {
      console.error('Error:', err);
      alert("‚ùå Error al cargar detalles del evento.");
    }
  }

  // =============================================================================
  // üîπ EDITAR EVENTO
  // =============================================================================
  async function editarEvento(id) {
    try {
      const { data: evento, error } = await window.supabaseClient
        .from('eventos')
        .select('*')
        .eq('id', id)
        .single();

      if (error || !evento) {
        alert("‚ùå Evento no encontrado.");
        return;
      }

      // Llenar formulario
      document.getElementById('edit-evento-id').value = evento.id;
      document.getElementById('edit-nombre').value = evento.nombre || '';
      document.getElementById('edit-cliente').value = evento.cliente || '';
      document.getElementById('edit-lugar').value = evento.lugar || '';
      document.getElementById('edit-contacto').value = evento.contacto_evento || '';
      document.getElementById('edit-telefono').value = evento.telefono_evento || '';
      document.getElementById('edit-fecha-montaje').value = evento.fecha_montaje || '';
      document.getElementById('edit-hora-montaje').value = evento.hora_montaje || '';
      document.getElementById('edit-fecha-desmontaje').value = evento.fecha_desmontaje || '';
      document.getElementById('edit-hora-desmontaje').value = evento.hora_desmontaje || '';
      document.getElementById('edit-estado').value = evento.estado || 'activo';

      document.getElementById('modal-editar-evento').style.display = 'flex';

    } catch (err) {
      console.error('Error:', err);
      alert("‚ùå Error al cargar evento para editar.");
    }
  }

  // =============================================================================
  // üîπ GUARDAR CAMBIOS DEL EVENTO
  // =============================================================================
  async function guardarCambiosEvento(e) {
    e.preventDefault();

    const id = document.getElementById('edit-evento-id').value;
    const nombre = document.getElementById('edit-nombre').value.trim();
    const lugar = document.getElementById('edit-lugar').value.trim();
    const fechaMontaje = document.getElementById('edit-fecha-montaje').value;
    const horaMontaje = document.getElementById('edit-hora-montaje').value;

    if (!nombre || !lugar || !fechaMontaje || !horaMontaje) {
      alert("‚ö†Ô∏è Los campos marcados con * son obligatorios.");
      return;
    }

    try {
      const eventoActualizado = {
        nombre: nombre,
        lugar: lugar,
        contacto_evento: document.getElementById('edit-contacto').value.trim(),
        telefono_evento: document.getElementById('edit-telefono').value.trim(),
        fecha_montaje: fechaMontaje,
        hora_montaje: horaMontaje,
        fecha_desmontaje: document.getElementById('edit-fecha-desmontaje').value || null,
        hora_desmontaje: document.getElementById('edit-hora-desmontaje').value || null,
        estado: document.getElementById('edit-estado').value
      };

      const { error } = await window.supabaseClient
        .from('eventos')
        .update(eventoActualizado)
        .eq('id', id);

      if (error) {
        console.error('Error al actualizar evento:', error);
        alert('‚ùå Error al guardar cambios.');
        return;
      }

      alert('‚úÖ Evento actualizado exitosamente.');
      document.getElementById('modal-editar-evento').style.display = 'none';
      await cargarEventos();

    } catch (err) {
      console.error('Error:', err);
      alert('‚ùå Error al guardar cambios.');
    }
  }

  // =============================================================================
  // üîπ ELIMINAR EVENTO
  // =============================================================================
  async function eliminarEvento(id) {
    if (!confirm("¬øEst√°s seguro de que deseas eliminar este evento? Esta acci√≥n no se puede deshacer.")) {
      return;
    }

    try {
      // Primero, marcar la cotizaci√≥n como no usada
      const { data: evento, error: fetchError } = await window.supabaseClient
        .from('eventos')
        .select('cotizacion_id')
        .eq('id', id)
        .single();

      if (!fetchError && evento?.cotizacion_id) {
        await window.supabaseClient
          .from('cotizaciones')
          .update({ eventocreado: false, eventoid: null })
          .eq('id', evento.cotizacion_id);
      }

      // Eliminar evento
      const { error } = await window.supabaseClient
        .from('eventos')
        .delete()
        .eq('id', id);

      if (error) {
        console.error('Error al eliminar evento:', error);
        alert('‚ùå Error al eliminar el evento.');
        return;
      }

      alert('‚úÖ Evento eliminado exitosamente.');
      await cargarEventos();

    } catch (err) {
      console.error('Error:', err);
      alert('‚ùå Error al eliminar el evento.');
    }
  }

  // =============================================================================
  // üîπ INICIALIZACI√ìN
  // =============================================================================
  setTimeout(async () => {
    await cargarEventos();

    // Bot√≥n nuevo evento
    document.getElementById('btn-nuevo-evento').addEventListener('click', () => {
      // Cambiar a la vista de crear evento
      const event = new CustomEvent('cambiarVista', { detail: 'eventos-creareventos' });
      document.dispatchEvent(event);
    });

    // Cerrar panel de detalles
    document.getElementById('btn-cerrar-panel').addEventListener('click', () => {
      document.getElementById('panel-detalles').style.display = 'none';
    });

    // Cerrar modales
    document.getElementById('btn-cerrar-modal-editar').addEventListener('click', () => {
      document.getElementById('modal-editar-evento').style.display = 'none';
    });

    document.getElementById('btn-cancelar-editar').addEventListener('click', () => {
      document.getElementById('modal-editar-evento').style.display = 'none';
    });

    // Formulario editar
    document.getElementById('form-editar-evento').addEventListener('submit', guardarCambiosEvento);

    // Cerrar modal al hacer clic fuera
    document.getElementById('modal-editar-evento').addEventListener('click', (e) => {
      if (e.target.id === 'modal-editar-evento') {
        document.getElementById('modal-editar-evento').style.display = 'none';
      }
    });

  }, 50);
</script>
